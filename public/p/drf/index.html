<!DOCTYPE html>
<html lang="zh-cn" dir="ltr">
    <head><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content="pythonåç«¯APIå¼€å‘çš„åˆ©å™¨">
<title>Drf</title>

<link rel='canonical' href='https://yn0t1me.github.io/p/drf/'>

<link rel="stylesheet" href="/scss/style.min.b9c8156d464c343bdacaf14a871581fb94cbbdb9dd5cbce4ba017361187cc930.css"><meta property='og:title' content="Drf">
<meta property='og:description' content="pythonåç«¯APIå¼€å‘çš„åˆ©å™¨">
<meta property='og:url' content='https://yn0t1me.github.io/p/drf/'>
<meta property='og:site_name' content='yn0t1meçš„åšå®¢'>
<meta property='og:type' content='article'><meta property='article:section' content='Post' /><meta property='article:tag' content='Django' /><meta property='article:tag' content='DRF' /><meta property='article:tag' content='python' /><meta property='article:published_time' content='2025-02-27T18:16:40&#43;08:00'/><meta property='article:modified_time' content='2025-02-27T18:16:40&#43;08:00'/>
<meta name="twitter:title" content="Drf">
<meta name="twitter:description" content="pythonåç«¯APIå¼€å‘çš„åˆ©å™¨">
    <link rel="shortcut icon" href="/favicon.ico" />

    </head>
    <body class="
    article-page
    ">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky ">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="åˆ‡æ¢èœå•">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header>
        
            
            <figure class="site-avatar">
                <a href="/">
                
                    
                    
                    
                        
                        <img src="/img/avatar_hu_901763171188d896.png" width="300"
                            height="284" class="site-logo" loading="lazy" alt="Avatar">
                    
                
                </a>
                
                    <span class="emoji">ğŸ§</span>
                
            </figure>
            
        
        
        <div class="site-meta">
            <h1 class="site-name"><a href="/">yn0t1meçš„åšå®¢</a></h1>
            <h2 class="site-description">äººç”ŸèŒ«èŒ«ï¼Œå”¯æ­»äº¡ä¸çˆ±è€Œå·²</h2>
        </div>
    </header><ol class="menu-social">
            
                <li>
                    <a 
                        href='https://github.com/yn0t1me'
                        target="_blank"
                        title="GitHub"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5" />
</svg>



                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='https://twitter.com'
                        target="_blank"
                        title="Twitter"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M22 4.01c-1 .49 -1.98 .689 -3 .99c-1.121 -1.265 -2.783 -1.335 -4.38 -.737s-2.643 2.06 -2.62 3.737v1c-3.245 .083 -6.135 -1.395 -8 -4c0 0 -4.182 7.433 4 11c-1.872 1.247 -3.739 2.088 -6 2c3.308 1.803 6.913 2.423 10.034 1.517c3.58 -1.04 6.522 -3.723 7.651 -7.742a13.84 13.84 0 0 0 .497 -3.753c-.002 -.249 1.51 -2.772 1.818 -4.013z" />
</svg>



                        
                    </a>
                </li>
            
        </ol><ol class="menu" id="main-menu">
        
        
        
        <li >
            <a href='/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="5 12 3 12 12 3 21 12 19 12" />
  <path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7" />
  <path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6" />
</svg>



                
                <span>ä¸»é¡µ</span>
            </a>
        </li>
        
        
        <li >
            <a href='/about/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="7" r="4" />
  <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2" />
</svg>



                
                <span>å…³äº</span>
            </a>
        </li>
        
        
        <li >
            <a href='/archives/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <rect x="3" y="4" width="18" height="4" rx="2" />
  <path d="M5 8v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-10" />
  <line x1="10" y1="12" x2="14" y2="12" />
</svg>



                
                <span>å½’æ¡£</span>
            </a>
        </li>
        
        
        <li >
            <a href='/search/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="10" cy="10" r="7" />
  <line x1="21" y1="21" x2="15" y2="15" />
</svg>



                
                <span>æœç´¢</span>
            </a>
        </li>
        
        
        <li >
            <a href='/links/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M10 14a3.5 3.5 0 0 0 5 0l4 -4a3.5 3.5 0 0 0 -5 -5l-.5 .5" />
  <path d="M14 10a3.5 3.5 0 0 0 -5 0l-4 4a3.5 3.5 0 0 0 5 5l.5 -.5" />
</svg>



                
                <span>å‹é“¾</span>
            </a>
        </li>
        
        <li class="menu-bottom-section">
            <ol class="menu">

                
                    <li id="dark-mode-toggle">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="8" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="16" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <span>æš—è‰²æ¨¡å¼</span>
                    </li>
                
            </ol>
        </li>
    </ol>
</aside>

    <aside class="sidebar right-sidebar sticky">
        
            
                
    <section class="widget archives">
        <div class="widget-icon">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <line x1="5" y1="9" x2="19" y2="9" />
  <line x1="5" y1="15" x2="19" y2="15" />
  <line x1="11" y1="4" x2="7" y2="20" />
  <line x1="17" y1="4" x2="13" y2="20" />
</svg>



        </div>
        <h2 class="widget-title section-title">ç›®å½•</h2>
        
        <div class="widget--toc">
            <nav id="TableOfContents">
  <ol>
    <li><a href="#å‰è¨€">å‰è¨€</a>
      <ol>
        <li><a href="#å‰åç«¯åˆ†ç¦»">å‰åç«¯åˆ†ç¦»</a></li>
        <li><a href="#djangoçš„fbvå’Œcbv">djangoçš„FBVå’ŒCBV</a></li>
        <li><a href="#drf">drf</a></li>
      </ol>
    </li>
    <li><a href="#åˆ›å»ºé¡¹ç›®">åˆ›å»ºé¡¹ç›®</a>
      <ol>
        <li><a href="#djangoé…ç½®">djangoé…ç½®</a></li>
        <li><a href="#é…ç½®drf">é…ç½®drf</a></li>
      </ol>
    </li>
    <li><a href="#request">request</a>
      <ol>
        <li><a href="#oopçŸ¥è¯†">oopçŸ¥è¯†</a></li>
        <li><a href="#å‚æ•°">å‚æ•°</a></li>
        <li><a href="#æºç åˆ†æ">æºç åˆ†æ</a></li>
        <li><a href="#requestå¯¹è±¡">requestå¯¹è±¡</a></li>
      </ol>
    </li>
    <li><a href="#è®¤è¯">è®¤è¯</a>
      <ol>
        <li><a href="#å¿«é€Ÿä½¿ç”¨">å¿«é€Ÿä½¿ç”¨</a>
          <ol>
            <li><a href="#æ¡ˆä¾‹1">æ¡ˆä¾‹1</a></li>
            <li><a href="#æ¡ˆä¾‹2">æ¡ˆä¾‹2</a></li>
            <li><a href="#æ¡ˆä¾‹3">æ¡ˆä¾‹3</a></li>
            <li><a href="#æ¡ˆä¾‹4">æ¡ˆä¾‹4</a></li>
          </ol>
        </li>
        <li><a href="#é¢å‘å¯¹è±¡-ç»§æ‰¿">é¢å‘å¯¹è±¡-ç»§æ‰¿</a></li>
        <li><a href="#ç»„ä»¶æºç ">ç»„ä»¶æºç </a></li>
        <li><a href="#æ‹“å±•-å­ç±»çº¦æŸ">æ‹“å±•-å­ç±»çº¦æŸ</a></li>
        <li><a href="#æ¡ˆä¾‹-ç”¨æˆ·ç™»å½•å’Œè®¤è¯">æ¡ˆä¾‹-ç”¨æˆ·ç™»å½•å’Œè®¤è¯</a>
          <ol>
            <li><a href="#åˆ›å»ºæ•°æ®è¡¨">åˆ›å»ºæ•°æ®è¡¨</a></li>
            <li><a href="#è·¯ç”±ç³»ç»Ÿ">è·¯ç”±ç³»ç»Ÿ</a></li>
            <li><a href="#è®¤è¯ç»„ä»¶">è®¤è¯ç»„ä»¶</a></li>
            <li><a href="#è§†å›¾å‡½æ•°">è§†å›¾å‡½æ•°</a></li>
            <li><a href="#è®¿é—®æ•ˆæœ">è®¿é—®æ•ˆæœ</a></li>
          </ol>
        </li>
        <li><a href="#æ€»ç»“">æ€»ç»“</a></li>
      </ol>
    </li>
    <li><a href="#æƒé™">æƒé™</a>
      <ol>
        <li><a href="#å¿«é€Ÿä½¿ç”¨-1">å¿«é€Ÿä½¿ç”¨</a></li>
        <li><a href="#é”™è¯¯ä¿¡æ¯å’Œå¤šä¸ªæƒé™ç±»">é”™è¯¯ä¿¡æ¯å’Œå¤šä¸ªæƒé™ç±»</a></li>
        <li><a href="#æºç æµç¨‹">æºç æµç¨‹</a></li>
        <li><a href="#ç»„ä»¶çš„æ‹“å±•">ç»„ä»¶çš„æ‹“å±•</a></li>
        <li><a href="#æ¡ˆä¾‹-æƒé™å¤„ç†">æ¡ˆä¾‹-æƒé™å¤„ç†</a>
          <ol>
            <li><a href="#åˆ›å»ºæ•°æ®è¡¨-1">åˆ›å»ºæ•°æ®è¡¨</a></li>
            <li><a href="#è·¯ç”±ç³»ç»Ÿ-1">è·¯ç”±ç³»ç»Ÿ</a></li>
            <li><a href="#è®¤è¯ç»„ä»¶-1">è®¤è¯ç»„ä»¶</a></li>
            <li><a href="#æƒé™ç»„ä»¶">æƒé™ç»„ä»¶</a></li>
            <li><a href="#è§†å›¾å‡½æ•°-1">è§†å›¾å‡½æ•°</a></li>
            <li><a href="#è®¿é—®æ•ˆæœ-1">è®¿é—®æ•ˆæœ</a></li>
          </ol>
        </li>
        <li><a href="#æ€è€ƒ">æ€è€ƒ</a></li>
        <li><a href="#æ€»ç»“-1">æ€»ç»“</a></li>
      </ol>
    </li>
    <li><a href="#é™æµ">é™æµ</a>
      <ol>
        <li><a href="#åŸºæœ¬é€»è¾‘">åŸºæœ¬é€»è¾‘</a></li>
        <li><a href="#å¿«é€Ÿä½¿ç”¨-2">å¿«é€Ÿä½¿ç”¨</a></li>
        <li><a href="#æºç æµç¨‹-1">æºç æµç¨‹</a></li>
        <li><a href="#æ¡ˆä¾‹-é™æµçš„åº”ç”¨">æ¡ˆä¾‹-é™æµçš„åº”ç”¨</a></li>
        <li><a href="#æ€»ç»“-2">æ€»ç»“</a></li>
      </ol>
    </li>
    <li><a href="#ç‰ˆæœ¬">ç‰ˆæœ¬</a>
      <ol>
        <li><a href="#getå‚æ•°ä¼ é€’">GETå‚æ•°ä¼ é€’</a></li>
        <li><a href="#åå‘ç”Ÿæˆurl">åå‘ç”ŸæˆURL</a></li>
        <li><a href="#æºç è§£è¯»">æºç è§£è¯»</a></li>
        <li><a href="#urlè·¯å¾„ä¼ é€’">URLè·¯å¾„ä¼ é€’</a></li>
        <li><a href="#acceptè¯·æ±‚å¤´ä¼ é€’">Acceptè¯·æ±‚å¤´ä¼ é€’</a></li>
        <li><a href="#æ€»ç»“-3">æ€»ç»“</a></li>
      </ol>
    </li>
    <li><a href="#è§£æå™¨">è§£æå™¨</a>
      <ol>
        <li><a href="#æµç¨‹æ¦‚è¿°">æµç¨‹æ¦‚è¿°</a></li>
        <li><a href="#å¸¸è§åº”ç”¨">å¸¸è§åº”ç”¨</a>
          <ol>
            <li><a href="#jsonparser">JSONParser</a></li>
            <li><a href="#formparser">FormParser</a></li>
            <li><a href="#multipartparser">MultiPartParser</a></li>
            <li><a href="#fileuploadparser">FileUploadParser</a></li>
          </ol>
        </li>
        <li><a href="#æºç æµç¨‹-2">æºç æµç¨‹</a></li>
        <li><a href="#è§£æå™¨å…¨å±€é…ç½®">è§£æå™¨å…¨å±€é…ç½®</a></li>
        <li><a href="#æ€»ç»“-4">æ€»ç»“</a></li>
      </ol>
    </li>
    <li><a href="#å…ƒç±»">å…ƒç±»</a>
      <ol>
        <li><a href="#ç±»å’Œå¯¹è±¡çš„åŸºç¡€çŸ¥è¯†">ç±»å’Œå¯¹è±¡çš„åŸºç¡€çŸ¥è¯†</a></li>
        <li><a href="#åˆ›å»ºç±»çš„ä¸¤ç§æ–¹å¼">åˆ›å»ºç±»çš„ä¸¤ç§æ–¹å¼</a></li>
        <li><a href="#mytypeåˆ›å»ºç±»ä¸æ‹“å±•">MyTypeåˆ›å»ºç±»ä¸æ‹“å±•</a></li>
        <li><a href="#ç»§æ‰¿å…³ç³»">ç»§æ‰¿å…³ç³»</a></li>
        <li><a href="#drfåºåˆ—åŒ–æºç æ¡ˆä¾‹">drfåºåˆ—åŒ–æºç æ¡ˆä¾‹</a></li>
        <li><a href="#æ‰©å±•">æ‰©å±•</a></li>
      </ol>
    </li>
    <li><a href="#åºåˆ—åŒ–å™¨">åºåˆ—åŒ–å™¨</a>
      <ol>
        <li><a href="#åºåˆ—åŒ–">åºåˆ—åŒ–</a>
          <ol>
            <li><a href="#serializer">Serializer</a></li>
            <li><a href="#modelserializer">ModelSerializer</a></li>
            <li><a href="#å­—æ®µå’Œå‚æ•°">å­—æ®µå’Œå‚æ•°</a></li>
            <li><a href="#åµŒå¥—ä¸ç»§æ‰¿">åµŒå¥—ä¸ç»§æ‰¿</a></li>
          </ol>
        </li>
        <li><a href="#æºç æµç¨‹-3">æºç æµç¨‹</a>
          <ol>
            <li><a href="#æµç¨‹æ¦‚è¿°-1">æµç¨‹æ¦‚è¿°</a></li>
            <li><a href="#åˆ›å»ºå­—æ®µå¯¹è±¡">åˆ›å»ºå­—æ®µå¯¹è±¡</a></li>
            <li><a href="#åˆ›å»ºç±»">åˆ›å»ºç±»</a></li>
            <li><a href="#å®ä¾‹åŒ–ç±»">å®ä¾‹åŒ–ç±»</a></li>
            <li><a href="#åºåˆ—åŒ–è¿‡ç¨‹">åºåˆ—åŒ–è¿‡ç¨‹</a></li>
          </ol>
        </li>
        <li><a href="#æ•°æ®æ ¡éªŒ">æ•°æ®æ ¡éªŒ</a>
          <ol>
            <li><a href="#åŸºæœ¬æ ¡éªŒ">åŸºæœ¬æ ¡éªŒ</a></li>
            <li><a href="#å†…ç½®å’Œæ­£åˆ™æ ¡éªŒ">å†…ç½®å’Œæ­£åˆ™æ ¡éªŒ</a></li>
            <li><a href="#é’©å­æ ¡éªŒ">é’©å­æ ¡éªŒ</a></li>
            <li><a href="#modelæ ¡éªŒ">Modelæ ¡éªŒ</a></li>
            <li><a href="#ä¿å­˜æ•°æ®ä¹‹æ™®é€šå­—æ®µ">ä¿å­˜æ•°æ®ä¹‹æ™®é€šå­—æ®µ</a></li>
            <li><a href="#ä¿å­˜æ•°æ®ä¹‹fkå’Œm2må­—æ®µ">ä¿å­˜æ•°æ®ä¹‹FKå’ŒM2Må­—æ®µ</a></li>
            <li><a href="#æ•°æ®æ ¡éªŒæ€»ç»“">æ•°æ®æ ¡éªŒæ€»ç»“</a></li>
            <li><a href="#æ ¡éªŒå’Œåºåˆ—åŒ–äºŒåˆä¸€">æ ¡éªŒå’Œåºåˆ—åŒ–äºŒåˆä¸€</a></li>
            <li><a href="#æ‹“å±•">æ‹“å±•</a></li>
          </ol>
        </li>
        <li><a href="#åšå®¢ç³»ç»Ÿæ¡ˆä¾‹">åšå®¢ç³»ç»Ÿæ¡ˆä¾‹</a>
          <ol>
            <li><a href="#è¡¨ç»“æ„">è¡¨ç»“æ„</a></li>
            <li><a href="#åŠŸèƒ½å®ç°">åŠŸèƒ½å®ç°</a></li>
            <li><a href="#æ€»ç»“-5">æ€»ç»“</a></li>
          </ol>
        </li>
      </ol>
    </li>
    <li><a href="#åˆ†é¡µ">åˆ†é¡µ</a>
      <ol>
        <li><a href="#pagenumberpagination">PageNumberPagination</a>
          <ol>
            <li><a href="#åˆæ­¥ä½¿ç”¨">åˆæ­¥ä½¿ç”¨</a></li>
            <li><a href="#1212-è‡ªå®šä¹‰pagenumberpaginationç±»">12.1.2 è‡ªå®šä¹‰PageNumberPaginationç±»</a></li>
            <li><a href="#1213-åˆ†é¡µçš„è¿”å›å€¼å¤„ç†">12.1.3 åˆ†é¡µçš„è¿”å›å€¼å¤„ç†</a></li>
            <li><a href="#1214-ç»ˆæä½¿ç”¨">12.1.4 ç»ˆæä½¿ç”¨</a></li>
          </ol>
        </li>
        <li><a href="#limitoffsetpagination">LimitOffsetPagination</a>
          <ol>
            <li><a href="#åŸºæœ¬ä½¿ç”¨åŠæ‹“å±•">åŸºæœ¬ä½¿ç”¨åŠæ‹“å±•</a></li>
            <li><a href="#å®é™…ä½¿ç”¨">å®é™…ä½¿ç”¨</a></li>
          </ol>
        </li>
      </ol>
    </li>
    <li><a href="#è§†å›¾">è§†å›¾</a>
      <ol>
        <li><a href="#viewapiviewå›é¡¾">Viewã€APIViewå›é¡¾</a></li>
        <li><a href="#genericapiview">GenericAPIVIew</a></li>
        <li><a href="#genericviewset">GenericViewSet</a></li>
        <li><a href="#äº”å¤§ç±»">äº”å¤§ç±»</a>
          <ol>
            <li><a href="#listmodelmixin">ListModelMixin</a></li>
            <li><a href="#retrievemodelmixin">RetrieveModelMixin</a></li>
            <li><a href="#åºåˆ—åŒ–å™¨çš„åˆ‡æ¢">åºåˆ—åŒ–å™¨çš„åˆ‡æ¢</a></li>
            <li><a href="#createmodelmixin">CreateModelMixin</a></li>
            <li><a href="#updatemodelmixin">UpdateModelMixin</a></li>
            <li><a href="#destroymodelmixin">DestroyModelMixin</a></li>
            <li><a href="#æ’åˆ—ç»„åˆç±»">æ’åˆ—ç»„åˆç±»</a></li>
          </ol>
        </li>
        <li><a href="#è§†å›¾æ€»ç»“">è§†å›¾æ€»ç»“</a></li>
      </ol>
    </li>
    <li><a href="#è·¯ç”±">è·¯ç”±</a>
      <ol>
        <li><a href="#è‡ªåŠ¨ç”Ÿæˆå¯¹åº”å…³ç³»">è‡ªåŠ¨ç”Ÿæˆå¯¹åº”å…³ç³»</a></li>
        <li><a href="#è·¯ç”±æ€»ç»“">è·¯ç”±æ€»ç»“</a></li>
        <li><a href="#æ‹“å±•url">æ‹“å±•URL</a></li>
      </ol>
    </li>
    <li><a href="#ç­›é€‰å™¨">ç­›é€‰å™¨</a>
      <ol>
        <li><a href="#ç­›é€‰å™¨çš„ä½¿ç”¨åœºæ™¯">ç­›é€‰å™¨çš„ä½¿ç”¨åœºæ™¯</a></li>
        <li><a href="#å¦‚ä½•ä½¿ç”¨">å¦‚ä½•ä½¿ç”¨</a></li>
        <li><a href="#ç¬¬ä¸‰æ–¹filter">ç¬¬ä¸‰æ–¹filter</a></li>
        <li><a href="#å¦‚ä½•ä½¿ç”¨-1">å¦‚ä½•ä½¿ç”¨</a>
          <ol>
            <li><a href="#æ¡ˆä¾‹ä¸€">æ¡ˆä¾‹ä¸€</a></li>
            <li><a href="#æ¡ˆä¾‹äºŒ">æ¡ˆä¾‹äºŒ</a></li>
            <li><a href="#æ¡ˆä¾‹ä¸‰">æ¡ˆä¾‹ä¸‰</a></li>
          </ol>
        </li>
      </ol>
    </li>
  </ol>
</nav>
        </div>
    </section>

            
        
    </aside>


            <main class="main full-width">
    <article class="main-article">
    <header class="article-header">

    <div class="article-details">
    
    <header class="article-category">
        
            <a href="/categories/python/" style="background-color: #2a9d8f; color: #fff;">
                Python
            </a>
        
    </header>
    

    <div class="article-title-wrapper">
        <h2 class="article-title">
            <a href="/p/drf/">Drf</a>
        </h2>
    
        
        <h3 class="article-subtitle">
            pythonåç«¯APIå¼€å‘çš„åˆ©å™¨
        </h3>
        
    </div>

    
    
    
    
    <footer class="article-time">
        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                <time class="article-time--published">Feb 27, 2025</time>
            </div>
        

        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



                <time class="article-time--reading">
                    é˜…è¯»æ—¶é•¿: 103 åˆ†é’Ÿ
                </time>
            </div>
        
    </footer>
    

    
</div>

</header>

    <section class="article-content">
    
    
    <h2 id="å‰è¨€">å‰è¨€
</h2><h3 id="å‰åç«¯åˆ†ç¦»">å‰åç«¯åˆ†ç¦»
</h3><p><img src="/post/python/DRF/1733982054512-99900304-27f3-48bb-aa08-adf52759a427.png"
	
	
	
	loading="lazy"
	
	
></p>
<p><img src="/post/python/DRF/1733982078114-e0b608b9-4f16-4e15-a508-747a37443a76.png"
	
	
	
	loading="lazy"
	
	
></p>
<h3 id="djangoçš„fbvå’Œcbv">djangoçš„FBVå’ŒCBV
</h3><ul>
<li><code>FBVï¼šfunction base views</code>ï¼Œå³ç¼–å†™å‡½æ•°æ¥å¤„ç†ä¸šåŠ¡è¯·æ±‚ï¼ˆå‡½æ•°ï¼‰</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">django.contrib</span> <span class="kn">import</span> <span class="n">admin</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">django.urls</span> <span class="kn">import</span> <span class="n">path</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">app01</span> <span class="kn">import</span> <span class="n">views</span>
</span></span><span class="line"><span class="cl"><span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="n">path</span><span class="p">(</span><span class="s1">&#39;users/&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">users</span><span class="p">),</span>
</span></span><span class="line"><span class="cl"><span class="p">]</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">django.http</span> <span class="kn">import</span> <span class="n">JsonResponse</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">users</span><span class="p">(</span><span class="n">request</span><span class="p">,</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&#34;GET&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s2">&#34;code&#34;</span><span class="p">:</span><span class="mi">1000</span><span class="p">,</span><span class="s2">&#34;data&#34;</span><span class="p">:</span><span class="s2">&#34;xxx&#34;</span><span class="p">})</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s2">&#34;code&#34;</span><span class="p">:</span><span class="mi">1000</span><span class="p">,</span><span class="s2">&#34;data&#34;</span><span class="p">:</span><span class="s2">&#34;xxx&#34;</span><span class="p">})</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li><code>CBVï¼Œclass base views</code>ï¼Œå³ç¼–å†™ç±»æ¥å¤„ç†ä¸šåŠ¡è¯·æ±‚ï¼ˆç±»åŠ åå°„ï¼‰</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">django.contrib</span> <span class="kn">import</span> <span class="n">admin</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">django.urls</span> <span class="kn">import</span> <span class="n">path</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">app01</span> <span class="kn">import</span> <span class="n">views</span>
</span></span><span class="line"><span class="cl"><span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="n">path</span><span class="p">(</span><span class="s1">&#39;users/&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">UserView</span><span class="o">.</span><span class="n">as_view</span><span class="p">()),</span>
</span></span><span class="line"><span class="cl"><span class="p">]</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">django.views</span> <span class="kn">import</span> <span class="n">View</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">UserView</span><span class="p">(</span><span class="n">View</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s2">&#34;code&#34;</span><span class="p">:</span> <span class="mi">1000</span><span class="p">,</span> <span class="s2">&#34;data&#34;</span><span class="p">:</span> <span class="s2">&#34;xxx&#34;</span><span class="p">})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s2">&#34;code&#34;</span><span class="p">:</span> <span class="mi">1000</span><span class="p">,</span> <span class="s2">&#34;data&#34;</span><span class="p">:</span> <span class="s2">&#34;xxx&#34;</span><span class="p">})</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>å…¶å®ï¼Œ<code>CBV</code>å’Œ<code>FBV</code>çš„åº•å±‚å®ç°æœ¬è´¨ä¸Šç›¸åŒçš„ã€‚</p>
<h3 id="drf">drf
</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># djangoä¸­çš„CBV</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">View</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="c1"># drfæ¡†æ¶ä¸­çš„CBV</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">APIViews</span><span class="p">(</span><span class="n">View</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># è‡ªå®šä¹‰çš„ç±»</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">UserInfo</span><span class="p">(</span><span class="n">APIViews</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="åˆ›å»ºé¡¹ç›®">åˆ›å»ºé¡¹ç›®
</h2><h3 id="djangoé…ç½®">djangoé…ç½®
</h3><ul>
<li>åˆ›å»ºçº¯å‡€pythoné¡¹ç›®å¹¶é…ç½®è™šæ‹Ÿç¯å¢ƒ</li>
</ul>
<p><img src="/post/python/DRF/1733983824945-78126a3b-6ded-4f6c-aeb6-8cc02cb2da76.png"
	
	
	
	loading="lazy"
	
	
></p>
<ul>
<li>å®‰è£…djangoåº“å¹¶å®ŒæˆåŸºç¡€çš„é¡¹ç›®é…ç½®</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># å®‰è£…djangoåº“</span>
</span></span><span class="line"><span class="cl"><span class="n">pip</span> <span class="n">install</span> <span class="n">django</span><span class="o">==</span><span class="mf">3.2</span>
</span></span><span class="line"><span class="cl"><span class="c1"># åˆ›å»ºé¡¹ç›®ç›®å½•</span>
</span></span><span class="line"><span class="cl"><span class="n">django</span><span class="o">-</span><span class="n">admin</span> <span class="n">startproject</span> <span class="n">day13</span> <span class="o">.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># åˆ›å»ºä¸€ä¸ªapp</span>
</span></span><span class="line"><span class="cl"><span class="n">python</span> <span class="n">manage</span><span class="o">.</span><span class="n">py</span> <span class="n">startapp</span> <span class="n">api</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>çº¯å‡€ç‰ˆdjangoé¡¹ç›®ï¼ˆå¯¹settings.pyæ–‡ä»¶æ“ä½œï¼‰</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">INSTALLED_APPS</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># &#39;django.contrib.admin&#39;,</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># &#39;django.contrib.auth&#39;,</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># &#39;django.contrib.contenttypes&#39;,</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># &#39;django.contrib.sessions&#39;,</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># &#39;django.contrib.messages&#39;,</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;django.contrib.staticfiles&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">MIDDLEWARE</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;django.middleware.security.SecurityMiddleware&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># &#39;django.contrib.sessions.middleware.SessionMiddleware&#39;,</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;django.middleware.common.CommonMiddleware&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># &#39;django.middleware.csrf.CsrfViewMiddleware&#39;,</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># &#39;django.contrib.auth.middleware.AuthenticationMiddleware&#39;,</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># &#39;django.contrib.messages.middleware.MessageMiddleware&#39;,</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;django.middleware.clickjacking.XFrameOptionsMiddleware&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">TEMPLATES</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;BACKEND&#39;</span><span class="p">:</span> <span class="s1">&#39;django.template.backends.django.DjangoTemplates&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;DIRS&#39;</span><span class="p">:</span> <span class="p">[],</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;APP_DIRS&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;OPTIONS&#39;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;context_processors&#39;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;django.template.context_processors.debug&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;django.template.context_processors.request&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># &#39;django.contrib.auth.context_processors.auth&#39;,</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># &#39;django.contrib.messages.context_processors.messages&#39;,</span>
</span></span><span class="line"><span class="cl">            <span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl"><span class="p">]</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>é…ç½®é¡¹ç›®å¯åŠ¨æŒ‰é’®</li>
</ul>
<p><img src="/post/python/DRF/1733984751636-3187b259-2c2d-4914-965a-e45893bd79ed.png"
	
	
	
	loading="lazy"
	
	
></p>
<p><img src="/post/python/DRF/1733984879376-354e1923-5d2a-46e1-bbc4-1f33db967ac0.png"
	
	
	
	loading="lazy"
	
	
></p>
<p><img src="/post/python/DRF/1733984996746-4c8d1633-72c5-4cd2-8848-5adf2d7cdf34.png"
	
	
	
	loading="lazy"
	
	
></p>
<p><img src="/post/python/DRF/1733985045978-a462498f-b2ba-4da9-803c-29176ef07abc.png"
	
	
	
	loading="lazy"
	
	
></p>
<ul>
<li>æµ‹è¯•ç®€å•å®ä¾‹</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># api/views.py</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">django.shortcuts</span> <span class="kn">import</span> <span class="n">render</span><span class="p">,</span> <span class="n">HttpResponse</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">home</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s2">&#34;æˆåŠŸ&#34;</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># day13/urls.py</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># from django.contrib import admin</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">django.urls</span> <span class="kn">import</span> <span class="n">path</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">api</span> <span class="kn">import</span> <span class="n">views</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># path(&#39;admin/&#39;, admin.site.urls),</span>
</span></span><span class="line"><span class="cl">    <span class="n">path</span><span class="p">(</span><span class="s1">&#39;home/&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">home</span><span class="p">),</span>
</span></span><span class="line"><span class="cl"><span class="p">]</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="é…ç½®drf">é…ç½®drf
</h3><ul>
<li>å®‰è£…drfæ¡†æ¶</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">pip</span> <span class="n">install</span> <span class="n">djangorestframework</span><span class="o">==</span><span class="mf">3.13.1</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>settings.pyé…ç½®</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">INSTALLED_APPS</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># &#39;django.contrib.admin&#39;,</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># &#39;django.contrib.auth&#39;,</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># &#39;django.contrib.contenttypes&#39;,</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># &#39;django.contrib.sessions&#39;,</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># &#39;django.contrib.messages&#39;,</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;django.contrib.staticfiles&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;api.apps.ApiConfig&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;rest_framework&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">MIDDLEWARE</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;django.middleware.security.SecurityMiddleware&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># &#39;django.contrib.sessions.middleware.SessionMiddleware&#39;,</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;django.middleware.common.CommonMiddleware&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;django.middleware.csrf.CsrfViewMiddleware&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># &#39;django.contrib.auth.middleware.AuthenticationMiddleware&#39;,</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># &#39;django.contrib.messages.middleware.MessageMiddleware&#39;,</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;django.middleware.clickjacking.XFrameOptionsMiddleware&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">TEMPLATES</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;BACKEND&#39;</span><span class="p">:</span> <span class="s1">&#39;django.template.backends.django.DjangoTemplates&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;DIRS&#39;</span><span class="p">:</span> <span class="p">[],</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;APP_DIRS&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;OPTIONS&#39;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;context_processors&#39;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;django.template.context_processors.debug&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;django.template.context_processors.request&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># &#39;django.contrib.auth.context_processors.auth&#39;,</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># &#39;django.contrib.messages.context_processors.messages&#39;,</span>
</span></span><span class="line"><span class="cl">            <span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl"><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">################## drfåŒ¿åç”¨æˆ·  ##################</span>
</span></span><span class="line"><span class="cl"><span class="c1"># åœ¨requestä¸­æºç å¯ä»¥æ‰¾åˆ°</span>
</span></span><span class="line"><span class="cl"><span class="n">REST_FRAMEWORK</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;UNAUTHENTICATED_USER&#34;</span><span class="p">:</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>ç®€å•å®ä¾‹</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># from django.contrib import admin</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">django.urls</span> <span class="kn">import</span> <span class="n">path</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">api</span> <span class="kn">import</span> <span class="n">views</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># path(&#39;admin/&#39;, admin.site.urls),</span>
</span></span><span class="line"><span class="cl">    <span class="n">path</span><span class="p">(</span><span class="s1">&#39;home/&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">home</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="n">path</span><span class="p">(</span><span class="s1">&#39;user/&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">UserView</span><span class="o">.</span><span class="n">as_view</span><span class="p">()),</span>
</span></span><span class="line"><span class="cl"><span class="p">]</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">django.shortcuts</span> <span class="kn">import</span> <span class="n">render</span><span class="p">,</span> <span class="n">HttpResponse</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">rest_framework.views</span> <span class="kn">import</span> <span class="n">APIView</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">rest_framework.response</span> <span class="kn">import</span> <span class="n">Response</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">home</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s2">&#34;æˆåŠŸ&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">UserView</span><span class="p">(</span><span class="n">APIView</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="s2">&#34;è¿”å›æˆåŠŸ&#34;</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="request">request
</h2><h3 id="oopçŸ¥è¯†">oopçŸ¥è¯†
</h3><ul>
<li>
<p><code>getattr</code>ï¼š</p>
</li>
<li>
<p><code>__getattr__</code>ï¼š</p>
<ul>
<li>åªæœ‰åœ¨å±æ€§æŸ¥æ‰¾å¤±è´¥æ—¶æ‰ä¼šè¢«è°ƒç”¨ï¼ˆå³åœ¨å¯¹è±¡çš„ <code>__dict__</code> å’Œç±»çš„ <code>__dict__</code> ä¸­éƒ½æ‰¾ä¸åˆ°å±æ€§æ—¶ï¼‰ã€‚</li>
<li>å®ƒæ˜¯ä¸€ä¸ªâ€œåå¤‡â€æ–¹æ³•ï¼Œé€šå¸¸ç”¨äºåŠ¨æ€åœ°æä¾›å±æ€§æˆ–æ–¹æ³•ã€‚</li>
</ul>
</li>
<li>
<p><code>__getattribute__</code>ï¼š</p>
<ul>
<li>æ˜¯ä¸€ä¸ªæ›´åº•å±‚çš„æ–¹æ³•ï¼Œä¼šåœ¨æ¯æ¬¡å±æ€§è®¿é—®æ—¶è¢«è°ƒç”¨ï¼Œæ— è®ºå±æ€§æ˜¯å¦å­˜åœ¨ã€‚</li>
<li>å®ƒçš„ä¼˜å…ˆçº§é«˜äº <code>__getattr__</code>ï¼Œå¹¶ä¸”å¯ä»¥å®Œå…¨æ§åˆ¶å±æ€§çš„è®¿é—®è¡Œä¸ºã€‚</li>
</ul>
</li>
</ul>
<ul>
<li>ç›´æ¥è®¿é—®æˆ–åˆ©ç”¨åå°„</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Foo</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">age</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">age</span> <span class="o">=</span> <span class="n">age</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">show</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="mi">123</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">obj</span> <span class="o">=</span> <span class="n">Foo</span><span class="p">(</span><span class="s2">&#34;å°ä¸‰&#34;</span><span class="p">,</span> <span class="mi">19</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># obj.name</span>
</span></span><span class="line"><span class="cl"><span class="c1"># obj.age</span>
</span></span><span class="line"><span class="cl"><span class="c1"># obj.show()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># v1=obj.show</span>
</span></span><span class="line"><span class="cl"><span class="n">v1</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s1">&#39;show&#39;</span><span class="p">)</span>  <span class="c1"># &lt;bound method Foo.show of &lt;__main__.Foo object at 0x000001D9870DBFD0&gt;&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="n">v1</span><span class="p">())</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li><code>__getattr__</code>
<ul>
<li>å½“å¯¹è±¡.ä¸€ä¸ªä¸å­˜åœ¨çš„æˆå‘˜æ—¶è§¦å‘</li>
</ul>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Foo</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">age</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">age</span> <span class="o">=</span> <span class="n">age</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">show</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="mi">123</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;-----&gt;&#34;</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="mi">999</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">obj</span> <span class="o">=</span> <span class="n">Foo</span><span class="p">(</span><span class="s2">&#34;å°ä¸‰&#34;</span><span class="p">,</span> <span class="mi">19</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># ä¸è§¦å‘ __getattr</span>
</span></span><span class="line"><span class="cl"><span class="c1"># obj.name</span>
</span></span><span class="line"><span class="cl"><span class="c1"># obj.age</span>
</span></span><span class="line"><span class="cl"><span class="c1"># obj.show()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># è§¦å‘ __getattr__ (ä¸å­˜åœ¨çš„æˆå‘˜)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># print(obj.xxx)</span>
</span></span><span class="line"><span class="cl"><span class="n">v2</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&#34;xxxx&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="n">v2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># -----&gt; xxxx</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 999</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li><strong>getattribute</strong>
<ul>
<li>åªè¦æ‰§è¡Œ å¯¹è±¡.xxxéƒ½ä¼šæ‰§è¡Œ__getattribute__</li>
<li>çˆ¶ç±»objectä¸­çš„__getattribute__çš„å¤„ç†æœºåˆ¶
<ul>
<li>å¯¹è±¡ä¸­æœ‰å€¼ï¼Œè¿”å›</li>
<li>å¯¹è±¡ä¸­æ— å€¼ï¼ŒæŠ¥é”™</li>
</ul>
</li>
</ul>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Foo</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">age</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">age</span> <span class="o">=</span> <span class="n">age</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">show</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="mi">123</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__getattribute__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;-----&gt;&#34;</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="mi">999</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">obj</span> <span class="o">=</span> <span class="n">Foo</span><span class="p">(</span><span class="s2">&#34;å°ä¸‰&#34;</span><span class="p">,</span> <span class="mi">19</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">age</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">xxx</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># -----&gt; name</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 999</span>
</span></span><span class="line"><span class="cl"><span class="c1"># -----&gt; age</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 999</span>
</span></span><span class="line"><span class="cl"><span class="c1"># -----&gt; xxx</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 999</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>ç±»åˆ†æ</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">HttpRequest</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">pass</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">v1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;v1&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">v2</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;v2&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Request</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">xx</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">_request</span> <span class="o">=</span> <span class="n">req</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">xx</span> <span class="o">=</span> <span class="n">xx</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">req</span> <span class="o">=</span> <span class="n">HttpRequest</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">req</span><span class="o">.</span><span class="n">v1</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">req</span><span class="o">.</span><span class="n">v2</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">request</span> <span class="o">=</span> <span class="n">Request</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="mi">111</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">request</span><span class="o">.</span><span class="n">_request</span><span class="o">.</span><span class="n">v1</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">request</span><span class="o">.</span><span class="n">_request</span><span class="o">.</span><span class="n">v2</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">HttpRequest</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">pass</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">v1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;v1&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">v2</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;v2&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Request</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">xx</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">_request</span> <span class="o">=</span> <span class="n">req</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">xx</span> <span class="o">=</span> <span class="n">xx</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># å¯¹è±¡ä¸­æ— çš„æˆå‘˜ï¼Œä¼šè§¦å‘</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># attr=&#34;v1&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__getattribute__</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">req</span> <span class="o">=</span> <span class="n">HttpRequest</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">request</span> <span class="o">=</span> <span class="n">Request</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="mi">111</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># request._request.v1()</span>
</span></span><span class="line"><span class="cl"><span class="n">request</span><span class="o">.</span><span class="n">v1</span><span class="p">()</span>  <span class="c1"># request.v1=request._request.v1</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>requestçš„ç®€å•å®ç°åŸç†ï¼ˆå±æ€§ä»£ç†ï¼‰</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">HttpRequest</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">pass</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">method</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;v1&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">path_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;v2&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">DrfRequest</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">xx</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">_request</span> <span class="o">=</span> <span class="n">req</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">xx</span> <span class="o">=</span> <span class="n">xx</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__getattribute__</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">request</span> <span class="o">=</span> <span class="n">HttpRequest</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">request</span> <span class="o">=</span> <span class="n">DrfRequest</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="mi">123123</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># æ™®é€šå†™æ³•</span>
</span></span><span class="line"><span class="cl"><span class="n">request</span><span class="o">.</span><span class="n">_request</span><span class="o">.</span><span class="n">method</span>
</span></span><span class="line"><span class="cl"><span class="c1"># åˆ©ç”¨__getattr__å’Œ__getattribute__</span>
</span></span><span class="line"><span class="cl"><span class="n">request</span><span class="o">.</span><span class="n">method</span>
</span></span><span class="line"><span class="cl"><span class="n">request</span><span class="o">.</span><span class="n">path_info</span>
</span></span><span class="line"><span class="cl"><span class="c1"># æŠ¥é”™</span>
</span></span><span class="line"><span class="cl"><span class="n">request</span><span class="o">.</span><span class="n">uuuu</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="å‚æ•°">å‚æ•°
</h3><p>æ™®é€šåŒ¹é…ï¼š<code>&lt;æ•°æ®ç±»å‹:å‚æ•°å&gt;</code>ï¼Œè§†å›¾ç›´æ¥ç”¨<code>å‚æ•°</code>æ¥æ”¶ï¼Œæˆ–è€…<code>self.kwargs</code>ä¸­è·å–</p>
<p><img src="/post/python/DRF/1734150636720-5cac42a1-7030-46db-950d-cda1559234b2.png"
	
	
	
	loading="lazy"
	
	
></p>
<p>ä¸æŒ‡å®šå‚æ•°åæ­£åˆ™åŒ¹é…ï¼ˆå¯¼å…¥re_pathï¼‰ï¼š<code>(æ­£åˆ™è¡¨è¾¾å¼)</code>ï¼Œè§†å›¾ç›´æ¥ç”¨<code>å‚æ•°</code>æ¥æ”¶ï¼Œæˆ–è€…<code>self.args</code>ä¸­è·å–</p>
<p><img src="/post/python/DRF/1734150642488-23de7af7-4501-423a-a4ce-35d03662d913.png"
	
	
	
	loading="lazy"
	
	
></p>
<p>æŒ‡å®šå‚æ•°åæ­£åˆ™åŒ¹é…ï¼š<code>(?P&lt;å‚æ•°å&gt;æ­£åˆ™è¡¨è¾¾å¼)</code>ï¼Œè§†å›¾ç›´æ¥ç”¨<code>å‚æ•°</code>æ¥æ”¶ï¼Œæˆ–è€…<code>self.kwargs</code>ä¸­è·å–</p>
<p>å‘½åæ•è·ç»„ï¼ˆNamed Capture Groupï¼‰ï¼š<code>(?P&lt;å‚æ•°å&gt;æ­£åˆ™è¡¨è¾¾å¼)</code></p>
<p><img src="/post/python/DRF/1734150651203-61c81235-6ac7-49d7-ae8d-32234589fdfe.png"
	
	
	
	loading="lazy"
	
	
></p>
<ul>
<li><code>æµ‹è¯•ä»£ç </code></li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">django.contrib</span> <span class="kn">import</span> <span class="n">admin</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">django.urls</span> <span class="kn">import</span> <span class="n">path</span><span class="p">,</span> <span class="n">re_path</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">api</span> <span class="kn">import</span> <span class="n">views</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># path(&#39;admin/&#39;, admin.site.urls),</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># path(&#39;users/&lt;str:version&gt;/&lt;int:pid&gt;/&#39;, views.UserView.as_view()),</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># re_path(&#39;users/(\w+)/(\d+)/&#39;, views.UserView.as_view()),</span>
</span></span><span class="line"><span class="cl">    <span class="n">re_path</span><span class="p">(</span><span class="s1">&#39;users/(?P&lt;version&gt;\w+)/(?P&lt;pid&gt;\d+)/&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">UserView</span><span class="o">.</span><span class="n">as_view</span><span class="p">()),</span>
</span></span><span class="line"><span class="cl"><span class="p">]</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">rest_framework.views</span> <span class="kn">import</span> <span class="n">APIView</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">rest_framework.response</span> <span class="kn">import</span> <span class="n">Response</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">UserView</span><span class="p">(</span><span class="n">APIView</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">version</span><span class="p">,</span> <span class="n">pid</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="n">version</span><span class="p">,</span> <span class="n">pid</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="s2">&#34;...&#34;</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="æºç åˆ†æ">æºç åˆ†æ
</h3><p><img src="/post/python/DRF/1734153342930-18d2c2fe-47b0-4bdf-a768-d6145989fd3b.png"
	
	
	
	loading="lazy"
	
	
></p>
<ul>
<li><code>æµç¨‹æ¢³ç†-æ–‡å­—ç‰ˆ</code></li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">æ³¨æ„ï¼šä¸‹åˆ—è°ƒç”¨æ–¹æ³•çš„æ‰¾å¯»è·¯çº¿éµå¾ªå…ˆUserViewç±»ï¼ŒåAPIViewç±»ï¼Œæœ€åæ˜¯Viewç±»ï¼Œå°±ä¸å†è¯¦ç»†èµ˜è¿°æ‰¾å¯»è¿‡ç¨‹
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">é¦–å…ˆå…¥å£æ˜¯è·¯ç”±ä¸­è°ƒç”¨UserViewç±»çš„as_View()æ–¹æ³•ï¼Œæ‰¾åˆ°APIViewç±»çš„as_view()æ–¹æ³•ï¼Œåˆè°ƒç”¨Viewç±»çš„as_view()æ–¹æ³•
</span></span><span class="line"><span class="cl">Viewç±»çš„as_view()æ–¹æ³•è°ƒç”¨APIViewç±»çš„dispatchæ–¹æ³•
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">dispatch()æ–¹æ³•è°ƒç”¨initialize_request()æ–¹æ³•ï¼Œå°†djangoçš„requestä¼ ç»™drfçš„Requestç±»ï¼ŒRequest çš„æ„é€ å‡½æ•°æ¥æ”¶ä¸Šè¿°å‚æ•°ï¼Œå¹¶å°†å®ƒä»¬å­˜å‚¨åœ¨å®ä¾‹ä¸­ï¼Œå¹¶ä¸”å®šä¹‰äº†__getattr__æ–¹æ³•ï¼Œç”¨äºåœ¨drfçš„requestä¸­æ— ç¼è®¿é—®åŸç”Ÿdjangoçš„request
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">æ­¤æ—¶initialize_request()æ–¹æ³•è°ƒç”¨å®Œæ¯•ï¼Œå›åˆ°dispatch()æ–¹æ³•
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">dispatch()é€šè¿‡getattråå°„è·å–è¯·æ±‚æ–¹æ³•ï¼Œå¹¶è°ƒç”¨ï¼Œå°†ç»“æœä¸€æ­¥æ­¥è¿”å›
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li><code>æºä»£ç åˆ†æ-ç²¾ç®€ç‰ˆ</code></li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">APIView</span><span class="p">(</span><span class="n">View</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">as_view</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">**</span><span class="n">initkwargs</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">view</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">as_view</span><span class="p">(</span><span class="o">**</span><span class="n">initkwargs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">csrf_exempt</span><span class="p">(</span><span class="n">view</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">initialize_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">parser_context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_parser_context</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">Request</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">request</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">parsers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_parsers</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">            <span class="n">authenticators</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_authenticators</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">            <span class="n">negotiator</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_content_negotiator</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">            <span class="n">parser_context</span><span class="o">=</span><span class="n">parser_context</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">dispatch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="n">args</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span> <span class="o">=</span> <span class="n">kwargs</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># requestè¿˜æ˜¯djangoä¸­çš„request</span>
</span></span><span class="line"><span class="cl">        <span class="n">request</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">initialize_request</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># æ­¤æ—¶çš„requestæ—¶drfçš„requestï¼Œrequest._requestå°±æ˜¯åŸç”Ÿdjangoçš„request</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># request._request.method</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># request.method  # __getattr__</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">request</span> <span class="o">=</span> <span class="n">request</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">headers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_response_headers</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">http_method_names</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># è·å–get/post/putç­‰æ–¹æ³•</span>
</span></span><span class="line"><span class="cl">            <span class="n">handler</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span><span class="bp">self</span><span class="o">.</span><span class="n">http_method_not_allowed</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># è°ƒç”¨get/postç­‰æ–¹æ³•(UserViewä¸­)</span>
</span></span><span class="line"><span class="cl">        <span class="n">response</span> <span class="o">=</span> <span class="n">handler</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">finalize_response</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">View</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">as_view</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">**</span><span class="n">initkwargs</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">def</span> <span class="nf">view</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dispatch</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">view</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Request</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">parsers</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">authenticators</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                 <span class="n">negotiator</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">parser_context</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">_request</span> <span class="o">=</span> <span class="n">request</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__getattribute__</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">UserView</span><span class="p">(</span><span class="n">APIView</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">version</span><span class="p">,</span> <span class="n">pid</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="n">version</span><span class="p">,</span> <span class="n">pid</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="s2">&#34;...&#34;</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="requestå¯¹è±¡">requestå¯¹è±¡
</h3><ul>
<li>
<p>Django åŸç”Ÿ <code>HttpRequest</code></p>
<ul>
<li><code>django.core.handlers.wsgi.WSGIRequest</code></li>
<li>åŒ…å«äº†è¯·æ±‚çš„æ‰€æœ‰æ•°æ®
<ul>
<li><code>request.method</code>ï¼šè¯·æ±‚æ–¹æ³•ï¼ˆGETã€POST ç­‰ï¼‰</li>
<li><code>request.GET</code> å’Œ <code>request.POST</code>ï¼šæŸ¥è¯¢å‚æ•°å’Œè¡¨å•æ•°æ®</li>
<li><code>request.body</code>ï¼šè¯·æ±‚ä½“çš„åŸå§‹æ•°æ®</li>
</ul>
</li>
</ul>
</li>
<li>
<p>DRF çš„ <code>Request</code> å¯¹è±¡</p>
<ul>
<li><code>rest_framework.request.Request</code></li>
<li>æä¾›äº†æ›´çµæ´»çš„æ–¹å¼æ¥å¤„ç†è¯·æ±‚æ•°æ®
<ul>
<li><code>self._request</code>ï¼šå­˜å‚¨ Django çš„åŸç”Ÿ <code>HttpRequest</code> å¯¹è±¡</li>
<li><code>request.query_params</code>ï¼šç”¨äºè·å– URL æŸ¥è¯¢å‚æ•°ï¼ˆ<code>GET</code> è¯·æ±‚çš„å‚æ•°ï¼‰</li>
<li><code>request.data</code>ï¼šç”¨äºè·å–è¯·æ±‚ä½“ä¸­çš„æ•°æ®ï¼Œæ”¯æŒå¤šç§æ ¼å¼ï¼ˆå¦‚ JSONã€è¡¨å•æ•°æ®ç­‰ï¼‰</li>
<li><code>request.method</code>ï¼šè·å–è¯·æ±‚æ–¹æ³•ï¼ˆå¦‚ GETã€POSTã€PUT ç­‰ï¼‰ï¼Œä¸ Django çš„ <code>request.method</code> åŠŸèƒ½ç›¸åŒ</li>
<li><code>request.user</code> å’Œ <code>request.auth</code>ï¼šå½“å‰è¯·æ±‚çš„ç”¨æˆ·å¯¹è±¡ï¼Œç»è¿‡è®¤è¯åçš„ç”¨æˆ·ä¿¡æ¯å’Œè®¤è¯ç›¸å…³çš„é¢å¤–ä¿¡æ¯ï¼Œä¾‹å¦‚ Token</li>
<li><code>request.parsers</code>ï¼šå½“å‰è¯·æ±‚ä½¿ç”¨çš„è§£æå™¨åˆ—è¡¨ï¼Œç”¨äºè§£æè¯·æ±‚ä½“æ•°æ®</li>
<li><code>request.authenticators</code>ï¼šå½“å‰è¯·æ±‚ä½¿ç”¨çš„è®¤è¯å™¨åˆ—è¡¨</li>
<li><code>request.is_ajax()</code>ï¼šåˆ¤æ–­è¯·æ±‚æ˜¯å¦ä¸º AJAX è¯·æ±‚</li>
<li><code>request.accepted_renderer</code>ï¼šè·å–å½“å‰è¯·æ±‚çš„æ¸²æŸ“å™¨ï¼Œç”¨äºå†³å®šå“åº”æ•°æ®çš„æ ¼å¼</li>
<li><code>request.accepted_media_type</code>ï¼šè·å–å®¢æˆ·ç«¯è¯·æ±‚çš„ <code>Accept</code> å¤´éƒ¨ä¿¡æ¯ï¼Œç”¨äºå†…å®¹åå•†</li>
<li><code>request.stream</code>ï¼šè·å–è¯·æ±‚ä½“çš„åŸå§‹æµæ•°æ®</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>drfä¸­çš„requestå…¶å®æ˜¯å¯¹è¯·æ±‚çš„å†æ¬¡å°è£…ï¼Œå…¶ç›®çš„å°±æ˜¯åœ¨åŸæ¥çš„requestå¯¹è±¡åŸºç¡€ä¸­å†è¿›è¡Œå°è£…ä¸€äº›drfä¸­éœ€è¦ç”¨åˆ°çš„å€¼</p>
<p><img src="/post/python/DRF/1734153473029-fd2d91cd-6312-4f75-9888-afc49b5dfc8f.png"
	
	
	
	loading="lazy"
	
	
></p>
<ul>
<li><code>æµ‹è¯•ä»£ç </code></li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">django.contrib</span> <span class="kn">import</span> <span class="n">admin</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">django.urls</span> <span class="kn">import</span> <span class="n">path</span><span class="p">,</span> <span class="n">re_path</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">api</span> <span class="kn">import</span> <span class="n">views</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># path(&#39;admin/&#39;, admin.site.urls),</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># path(&#39;users/&lt;str:version&gt;/&lt;int:pid&gt;/&#39;, views.UserView.as_view()),</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># re_path(&#39;users/(\w+)/(\d+)/&#39;, views.UserView.as_view()),</span>
</span></span><span class="line"><span class="cl">    <span class="n">re_path</span><span class="p">(</span><span class="s1">&#39;users/(?P&lt;version&gt;\w+)/(?P&lt;pid&gt;\d+)/&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">UserView</span><span class="o">.</span><span class="n">as_view</span><span class="p">()),</span>
</span></span><span class="line"><span class="cl"><span class="p">]</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">rest_framework.views</span> <span class="kn">import</span> <span class="n">APIView</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">rest_framework.response</span> <span class="kn">import</span> <span class="n">Response</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">rest_framework.request</span> <span class="kn">import</span> <span class="n">Request</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">UserView</span><span class="p">(</span><span class="n">APIView</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">version</span><span class="p">,</span> <span class="n">pid</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># drfçš„requestå¯¹è±¡</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">query_params</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">auth</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># djangoçš„requestå¯¹è±¡</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">method</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path_info</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="s2">&#34;...&#34;</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="è®¤è¯">è®¤è¯
</h2><p>åœ¨å¼€å‘APIè¿‡ç¨‹ä¸­ï¼Œæœ‰äº›åŠŸèƒ½éœ€è¦ç™»å½•æ‰èƒ½è®¿é—®ï¼Œæœ‰äº›æ— éœ€ç™»å½•ã€‚drfä¸­çš„è®¤è¯ç»„ä»¶ä¸»è¦å°±æ˜¯ç”¨æ¥å®ç°æ­¤åŠŸèƒ½</p>
<h3 id="å¿«é€Ÿä½¿ç”¨">å¿«é€Ÿä½¿ç”¨
</h3><p>é€šè¿‡ç¼–å†™ç±»çš„å½¢å¼å®ç°ï¼Œä¸€ä¸ªç±»å°±æ˜¯ä¸€ä¸ªè®¤è¯ç»„ä»¶</p>
<ul>
<li>ç¼–å†™ç±» -&gt; è®¤è¯ç»„ä»¶</li>
<li>åº”ç”¨ç»„ä»¶</li>
</ul>
<h4 id="æ¡ˆä¾‹1">æ¡ˆä¾‹1
</h4><blockquote>
<p>é¡¹ç›®è¦å¼€å‘3ä¸ªæ¥å£ï¼Œå…¶ä¸­1ä¸ªæ— éœ€ç™»å½•æ¥å£ã€2ä¸ªå¿…é¡»ç™»å½•æ‰èƒ½è®¿é—®çš„æ¥å£ã€‚</p>
<p>å±€éƒ¨é…ç½® authentication_classes = []</p></blockquote>
<p>æ— éœ€ç™»å½•çš„ä¸é…ç½®è®¤è¯ç±»ï¼Œé»˜è®¤æ˜¯åŒ¿åç”¨æˆ·ï¼Œéœ€è¦ç™»é™†çš„é…ç½®è®¤è¯ç±»ï¼Œé€šè¿‡è¿”å›å…ƒç»„èµ‹å€¼<code>request.user</code> å’Œ <code>request.auth</code>ï¼Œæœªé€šè¿‡æŠ›å‡ºå¼‚å¸¸ã€‚è‹¥è¿”å›Noneåˆ™æ˜¯åŒ¿åç”¨æˆ·ï¼Œä¸ç¬¦åˆéœ€æ±‚</p>
<ul>
<li>è®¤è¯å¤±è´¥ä¿¡æ¯å®šåˆ¶</li>
</ul>
<p><img src="/post/python/DRF/1734157419487-92ad7693-d15f-46a1-af5a-f403b0e0358b.png"
	
	
	
	loading="lazy"
	
	
></p>
<ul>
<li>åŒ¿åç”¨æˆ·</li>
</ul>
<p><img src="/post/python/DRF/1734157650997-6ee13a51-5b0b-4f8b-bf96-c8e051217c05.png"
	
	
	
	loading="lazy"
	
	
></p>
<ul>
<li>è®¤è¯ç»„ä»¶ä¸­è¿”å›çš„ä¸¤ä¸ªå€¼ï¼Œåˆ†åˆ«èµ‹å€¼ç»™ï¼š<code>request.user</code> å’Œ <code>request.auth</code></li>
</ul>
<p><img src="/post/python/DRF/1734157774032-eab61203-3c75-47c0-9b85-9273a5af1fbf.png"
	
	
	
	loading="lazy"
	
	
></p>
<ul>
<li><code>urls.py</code></li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">django.urls</span> <span class="kn">import</span> <span class="n">path</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">api</span> <span class="kn">import</span> <span class="n">views</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="n">path</span><span class="p">(</span><span class="s1">&#39;login/&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">LoginView</span><span class="o">.</span><span class="n">as_view</span><span class="p">()),</span>
</span></span><span class="line"><span class="cl">    <span class="n">path</span><span class="p">(</span><span class="s1">&#39;user/&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">UserView</span><span class="o">.</span><span class="n">as_view</span><span class="p">()),</span>
</span></span><span class="line"><span class="cl">    <span class="n">path</span><span class="p">(</span><span class="s1">&#39;order/&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">OrderView</span><span class="o">.</span><span class="n">as_view</span><span class="p">()),</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">]</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li><code>views.py</code></li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">rest_framework.views</span> <span class="kn">import</span> <span class="n">APIView</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">rest_framework.response</span> <span class="kn">import</span> <span class="n">Response</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">rest_framework.request</span> <span class="kn">import</span> <span class="n">Request</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">rest_framework.authentication</span> <span class="kn">import</span> <span class="n">BaseAuthentication</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">rest_framework.exceptions</span> <span class="kn">import</span> <span class="n">AuthenticationFailed</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">MyAuthentication</span><span class="p">(</span><span class="n">BaseAuthentication</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">authenticate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># /xxx/xxx/xxx?token=123123123</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># token = request._request.GET.get(&#39;token&#39;)</span>
</span></span><span class="line"><span class="cl">        <span class="n">token</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">query_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;token&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">token</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="s2">&#34;user&#34;</span><span class="p">,</span> <span class="n">token</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># raise AuthenticationFailed(&#34;è®¤è¯å¤±è´¥&#34;)</span>
</span></span><span class="line"><span class="cl">        <span class="k">raise</span> <span class="n">AuthenticationFailed</span><span class="p">({</span><span class="s2">&#34;code&#34;</span><span class="p">:</span> <span class="mi">20000</span><span class="p">,</span> <span class="s2">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;è®¤è¯å¤±è´¥&#34;</span><span class="p">})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">LoginView</span><span class="p">(</span><span class="n">APIView</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">authentication_classes</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">auth</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="s2">&#34;LoginView&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">UserView</span><span class="p">(</span><span class="n">APIView</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">authentication_classes</span> <span class="o">=</span> <span class="p">[</span><span class="n">MyAuthentication</span><span class="p">,</span> <span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">auth</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="s2">&#34;UserView&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">OrderView</span><span class="p">(</span><span class="n">APIView</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">authentication_classes</span> <span class="o">=</span> <span class="p">[</span><span class="n">MyAuthentication</span><span class="p">,</span> <span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">auth</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="s2">&#34;OrderView&#34;</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="æ¡ˆä¾‹2">æ¡ˆä¾‹2
</h4><blockquote>
<p>é¡¹ç›®è¦å¼€å‘100ä¸ªæ¥å£ï¼Œå…¶ä¸­1ä¸ªæ— éœ€ç™»å½•æ¥å£ã€99ä¸ªå¿…é¡»ç™»å½•æ‰èƒ½è®¿é—®çš„æ¥å£ã€‚</p>
<p>æ­¤æ—¶ï¼Œå°±éœ€è¦ç”¨åˆ°drfçš„å…¨å±€é…ç½®ï¼ˆè®¤è¯ç»„ä»¶çš„ç±»ä¸èƒ½æ”¾åœ¨è§†å›¾view.pyä¸­ï¼Œä¼šå› ä¸ºå¯¼å…¥APIViewå¯¼è‡´å¾ªç¯å¼•ç”¨ï¼Œè¯¥æ¡ˆä¾‹æ”¾ç½®åœ¨ext/auth.pyä¸­ï¼‰</p>
<p>drfä¼šå…ˆåŠ è½½å…¨å±€é…ç½®ï¼Œåœ¨åŠ è½½å±€éƒ¨é…ç½®ï¼Œå±€éƒ¨é…ç½®ä¼šè¦†ç›–å…¨å±€é…ç½®</p></blockquote>
<ul>
<li><code>ext\auth.py</code></li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">rest_framework.authentication</span> <span class="kn">import</span> <span class="n">BaseAuthentication</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">rest_framework.exceptions</span> <span class="kn">import</span> <span class="n">AuthenticationFailed</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">MyAuthentication</span><span class="p">(</span><span class="n">BaseAuthentication</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">authenticate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># /xxx/xxx/xxx?token=123123123</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># token = request._request.GET.get(&#39;token&#39;)</span>
</span></span><span class="line"><span class="cl">        <span class="n">token</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">query_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;token&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">token</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="s2">&#34;user&#34;</span><span class="p">,</span> <span class="n">token</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># raise AuthenticationFailed(&#34;è®¤è¯å¤±è´¥&#34;)</span>
</span></span><span class="line"><span class="cl">        <span class="k">raise</span> <span class="n">AuthenticationFailed</span><span class="p">({</span><span class="s2">&#34;code&#34;</span><span class="p">:</span> <span class="mi">20000</span><span class="p">,</span> <span class="s2">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;è®¤è¯å¤±è´¥&#34;</span><span class="p">})</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li><code>urls.py</code></li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">django.urls</span> <span class="kn">import</span> <span class="n">path</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">api</span> <span class="kn">import</span> <span class="n">views</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="n">path</span><span class="p">(</span><span class="s1">&#39;login/&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">LoginView</span><span class="o">.</span><span class="n">as_view</span><span class="p">()),</span>
</span></span><span class="line"><span class="cl">    <span class="n">path</span><span class="p">(</span><span class="s1">&#39;user/&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">UserView</span><span class="o">.</span><span class="n">as_view</span><span class="p">()),</span>
</span></span><span class="line"><span class="cl">    <span class="n">path</span><span class="p">(</span><span class="s1">&#39;order/&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">OrderView</span><span class="o">.</span><span class="n">as_view</span><span class="p">()),</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">]</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li><code>views.py</code></li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">rest_framework.views</span> <span class="kn">import</span> <span class="n">APIView</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">rest_framework.response</span> <span class="kn">import</span> <span class="n">Response</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">ext.auth</span> <span class="kn">import</span> <span class="n">MyAuthentication</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">LoginView</span><span class="p">(</span><span class="n">APIView</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">authentication_classes</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">auth</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="s2">&#34;LoginView&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">UserView</span><span class="p">(</span><span class="n">APIView</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">auth</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="s2">&#34;UserView&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">OrderView</span><span class="p">(</span><span class="n">APIView</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">auth</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="s2">&#34;OrderView&#34;</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="æ¡ˆä¾‹3">æ¡ˆä¾‹3
</h4><blockquote>
<p>çŠ¶æ€ç ä¸€è‡´æ€§é—®é¢˜ï¼š
å¦‚æœè®¤è¯ç»„ä»¶ä¸­æœªå®šä¹‰ï¼Œåˆ™ç»Ÿä¸€ä¸º HTTP_403_FORBIDDEN</p>
<p>å¦‚æœè‡ªå®šä¹‰äº†ï¼Œè¿˜ä¼šåŠ ä¸Šä¸€ä¸ªå“åº”å¤´</p></blockquote>
<p>å®šä¹‰<code>get_authenticate_header</code>æ–¹æ³•</p>
<p><img src="/post/python/DRF/image-20241215160350164.png"
	
	
	
	loading="lazy"
	
		alt="image-20241215160350164"
	
	
></p>
<p><img src="/post/python/DRF/image-20241215162322059.png"
	
	
	
	loading="lazy"
	
		alt="image-20241215162322059"
	
	
></p>
<ul>
<li>å‚è€ƒæºç </li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">handle_exception</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exc</span><span class="p">,</span> <span class="p">(</span><span class="n">exceptions</span><span class="o">.</span><span class="n">NotAuthenticated</span><span class="p">,</span><span class="n">exceptions</span><span class="o">.</span><span class="n">AuthenticationFailed</span><span class="p">)):</span>
</span></span><span class="line"><span class="cl">            <span class="n">auth_header</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_authenticate_header</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">auth_header</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">exc</span><span class="o">.</span><span class="n">auth_header</span> <span class="o">=</span> <span class="n">auth_header</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">exc</span><span class="o">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="n">status</span><span class="o">.</span><span class="n">HTTP_403_FORBIDDEN</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">response</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get_authenticate_header</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">authenticators</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_authenticators</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">authenticators</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">authenticators</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">authenticate_header</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="æ¡ˆä¾‹4">æ¡ˆä¾‹4
</h4><blockquote>
<p>é¡¹ç›®è¦å¼€å‘100ä¸ªæ¥å£ï¼Œå…¶ä¸­1ä¸ªæ— éœ€ç™»å½•æ¥å£ã€98ä¸ªå¿…é¡»ç™»å½•æ‰èƒ½è®¿é—®çš„æ¥å£ã€1ä¸ªå…¬å…±æ¥å£ï¼ˆæœªç™»å½•æ—¶æ˜¾ç¤ºå…¬å…±/å·²ç™»å½•æ—¶æ˜¾ç¤ºä¸ªäººä¿¡æ¯ï¼‰ã€‚</p>
<p>åŸæ¥çš„è®¤è¯ä¿¡æ¯åªèƒ½æ”¾åœ¨URLä¸­ä¼ é€’ï¼Œå¦‚æœç¨‹åºä¸­æ”¯æŒæ”¾åœ¨å¾ˆå¤šåœ°æ–¹ï¼Œä¾‹å¦‚ï¼šURLä¸­ã€è¯·æ±‚å¤´ä¸­ç­‰ã€‚</p>
<p>è®¤è¯ç»„ä»¶ä¸­ï¼Œå¦‚æœæ˜¯ä½¿ç”¨äº†å¤šä¸ªè®¤è¯ç±»ï¼Œä¼šæŒ‰ç…§é¡ºåºé€ä¸€æ‰§è¡Œå…¶ä¸­çš„<code>authenticate</code>æ–¹æ³•</p>
<ul>
<li>è¿”å›Noneæˆ–æ— è¿”å›å€¼ï¼Œè¡¨ç¤ºç»§ç»­æ‰§è¡Œåç»­çš„è®¤è¯ç±»</li>
<li>è¿”å›   (user, auth) å…ƒç»„ï¼Œåˆ™ä¸å†ç»§ç»­å¹¶å°†å€¼èµ‹å€¼ç»™request.userå’Œrequest.auth</li>
<li>æŠ›å‡ºå¼‚å¸¸ <code>AuthenticationFailed(...)</code>ï¼Œè®¤è¯å¤±è´¥ï¼Œä¸å†ç»§ç»­å‘åèµ°ã€‚</li>
</ul>
<p>å¤šä¸ªè®¤è¯ç»„ä»¶æ¯ä¸€ä¸ªéƒ½è¿”å›Noneï¼Œéƒ½æ²¡æœ‰è®¤è¯æˆåŠŸï¼Œè§†å›¾å‡½æ•°ä¹Ÿä¼šè¢«æ‰§è¡Œï¼Œåªä¸è¿‡<code>self.userï¼Œself.auth</code>ä¸ºNone</p></blockquote>
<ul>
<li><code>ext\auth.py</code></li>
</ul>
<p>è®¾ç½®ä¸€ä¸ªæ£€æŸ¥å‚æ•°çš„è®¤è¯ç±»ï¼Œä¸€ä¸ªæ£€æŸ¥è¯·æ±‚å¤´çš„è®¤è¯ç±»ï¼Œé€šè¿‡ä¸€ä¸ªå³ä¸ºè®¤è¯æˆåŠŸï¼Œç„¶åè®¾ç½®ä¸€ä¸ªè®¤è¯ç±»ç›´æ¥æŠ›å‡ºå¼‚å¸¸</p>
<p>å¯¹äºæ— éœ€ç™»é™†çš„ï¼Œå±€éƒ¨è®¾ç½®æ— è®¤è¯ç±»</p>
<p>å¯¹äºéœ€è¦ç™»é™†çš„ï¼Œåˆ™å°†æ‰€æœ‰è®¤è¯ç±»åŠ ä¸Šï¼Œè‹¥ç±»1ä¸ç±»2æœªé€šè¿‡ï¼Œèµ°åˆ°ç±»3ä¼šç›´æ¥æŠ›å‡ºå¼‚å¸¸å³è®¤è¯ä¸é€šè¿‡</p>
<p>å¯¹äºå…¬å…±æ¥å£ï¼Œå±€éƒ¨è®¾ç½®å‰ä¸¤ä¸ªè®¤è¯ç±»ï¼Œè‹¥æœªé€šè¿‡åˆ™ä»¥åŒ¿åç”¨æˆ·è®¿é—®</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">rest_framework.authentication</span> <span class="kn">import</span> <span class="n">BaseAuthentication</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">rest_framework.exceptions</span> <span class="kn">import</span> <span class="n">AuthenticationFailed</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">ParamAuthentication</span><span class="p">(</span><span class="n">BaseAuthentication</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">authenticate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">token</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">query_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;token&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">token</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="s2">&#34;user&#34;</span><span class="p">,</span> <span class="n">token</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">authenticate_header</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="s1">&#39;Token&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">HeaderAuthentication</span><span class="p">(</span><span class="n">BaseAuthentication</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">authenticate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">token</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;HTTP_AUTHORIZATION&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">token</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="s2">&#34;user&#34;</span><span class="p">,</span> <span class="n">token</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">authenticate_header</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="s1">&#39;Token&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">NotAuthentication</span><span class="p">(</span><span class="n">BaseAuthentication</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">authenticate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">raise</span> <span class="n">AuthenticationFailed</span><span class="p">({</span><span class="s2">&#34;code&#34;</span><span class="p">:</span> <span class="mi">20000</span><span class="p">,</span> <span class="s2">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;è®¤è¯å¤±è´¥&#34;</span><span class="p">})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">authenticate_header</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="s1">&#39;Token&#39;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li><code>views.py</code></li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">rest_framework.views</span> <span class="kn">import</span> <span class="n">APIView</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">rest_framework.response</span> <span class="kn">import</span> <span class="n">Response</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">ext.auth</span> <span class="kn">import</span> <span class="n">ParamAuthentication</span><span class="p">,</span> <span class="n">HeaderAuthentication</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># æ— éœ€ç™»å½•</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">UserView</span><span class="p">(</span><span class="n">APIView</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">authentication_classes</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="s2">&#34;ç”¨æˆ·ä¿¡æ¯&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># å…¬å…±æ¥å£</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">OrderView</span><span class="p">(</span><span class="n">APIView</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">authentication_classes</span> <span class="o">=</span> <span class="p">[</span><span class="n">ParamAuthentication</span><span class="p">,</span> <span class="n">HeaderAuthentication</span><span class="p">,</span> <span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="si">}</span><span class="s2">çš„è®¢å•ä¿¡æ¯&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">message</span> <span class="o">=</span> <span class="s2">&#34;å…¬å…±è®¢å•ä¿¡æ¯&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># å¿…é¡»ç™»å½•</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">InfoView</span><span class="p">(</span><span class="n">APIView</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="si">}</span><span class="s2">çš„ç”¨æˆ·ä¿¡æ¯&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li><code>settings.py</code></li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">REST_FRAMEWORK</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;UNAUTHENTICATED_USER&#34;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># æœªç™»å½•æ—¶ï¼Œrequest.user=None</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;UNAUTHENTICATED_TOKEN&#34;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># æœªç™»å½•æ—¶ï¼Œrequest.auth=None</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;DEFAULT_AUTHENTICATION_CLASSES&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;ext.auth.ParamAuthentication&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;ext.auth.HeaderAuthentication&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;ext.auth.NotAuthentication&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="é¢å‘å¯¹è±¡-ç»§æ‰¿">é¢å‘å¯¹è±¡-ç»§æ‰¿
</h3><p>å±€éƒ¨é…ç½®ä¸å…¨å±€é…ç½®çš„ä¼˜å…ˆå…³ç³»</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">APIView</span><span class="p">(</span><span class="n">View</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">authentication_classes</span> <span class="o">=</span> <span class="n">è¯»å–é…ç½®æ–‡ä»¶ä¸­çš„åˆ—è¡¨</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">dispatch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">authentication_classes</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">UserView</span><span class="p">(</span><span class="n">APIView</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">authentication_classes</span> <span class="o">=</span> <span class="p">[</span><span class="mi">11</span><span class="p">,</span><span class="mi">22</span><span class="p">,</span><span class="mi">33</span><span class="p">,</span><span class="mi">44</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">obj</span> <span class="o">=</span> <span class="n">UserView</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">obj</span><span class="o">.</span><span class="n">dispatch</span><span class="p">()</span>  <span class="c1"># authentication_classes = [11,22,33,44]</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="ç»„ä»¶æºç ">ç»„ä»¶æºç 
</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">åœ¨requestçš„åˆå§‹åŒ–é˜¶æ®µåŠ è½½è®¤è¯ç»„ä»¶ï¼Œå³è°ƒç”¨initialize_requestæ–¹æ³•æ—¶ï¼Œé€šè¿‡get_authenticatorsæ–¹æ³•è·å–è®¤è¯ç±»å®ä¾‹å¯¹è±¡åˆ—è¡¨authenticators
</span></span><span class="line"><span class="cl">	get_authenticatorsæ–¹æ³•å¾ªç¯authentication_classesï¼Œå®ä¾‹åŒ–ç”Ÿæˆè®¤è¯ç±»å®ä¾‹å¯¹è±¡å­˜å‚¨åœ¨åˆ—è¡¨ä¸­
</span></span><span class="line"><span class="cl">	authentication_classesè¯»å–çš„å±€éƒ¨é…ç½®å’Œå…¨å±€é…ç½®
</span></span><span class="line"><span class="cl">åŠ è½½å®Œæˆåï¼Œè®¤è¯è¿‡ç¨‹ï¼Œå³è°ƒç”¨initialæ–¹æ³•æ—¶ï¼Œè°ƒç”¨perform_authenticationæ–¹æ³•ï¼Œè·å–request.userçš„å€¼
</span></span><span class="line"><span class="cl">	userä¸ºç©ºå€¼å³æœªè®¤è¯ï¼Œè§¦å‘_authenticateæ–¹æ³•ï¼Œå¾ªç¯è®¤è¯ç±»å®ä¾‹å¯¹è±¡åˆ—è¡¨authenticatorsï¼Œè°ƒç”¨è‡ªå·±çš„è®¤è¯æ–¹æ³•ï¼Œè¿”å›å…ƒç»„å°±èµ‹å€¼userå’Œauthï¼Œé€€å‡ºå¾ªç¯ï¼›è¿”å›Noneç»§ç»­å¾ªç¯ï¼›æŠ›å‡ºå¼‚å¸¸å°±æ•è·å¼‚å¸¸ï¼Œåœ¨dispatchä¸­æ•è·ï¼›å¦‚æœå¾ªç¯å®Œæ²¡è¿”å›å…ƒç»„ä¹Ÿæ²¡å¼‚å¸¸ï¼Œæ‰§è¡Œ_not_authenticatedæ–¹æ³•å¤„ç†åŒ¿åç”¨æˆ·
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="/post/python/DRF/%e6%97%a0%e6%a0%87%e9%a2%98-2024-11-16-0939.png"
	
	
	
	loading="lazy"
	
		alt="æ— æ ‡é¢˜-2024-11-16-0939"
	
	
></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Request</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">authenticators</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">_request</span> <span class="o">=</span> <span class="n">request</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">authenticators</span> <span class="o">=</span> <span class="n">authenticators</span> <span class="ow">or</span> <span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@property</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">user</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_user&#39;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">with</span> <span class="n">wrap_attributeerrors</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">_authenticate</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_user</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@user.setter</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">_user</span> <span class="o">=</span> <span class="n">value</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">value</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">_authenticate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># authenticatoræ˜¯è®¤è¯ç±»å®ä¾‹åŒ–åçš„å¯¹è±¡ï¼Œå¾ªç¯é€ä¸€è®¤è¯</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># å¦‚æœè®¤è¯è¿‡ç¨‹æŠ›å‡ºå¼‚å¸¸ï¼Œè®¤è¯ä¸é€šè¿‡</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># è‹¥è®¤è¯è¿‡ç¨‹æ²¡æœ‰æŠ›å‡ºå¼‚å¸¸ï¼Œä¹Ÿæ²¡æœ‰è¿”å›self.user, self.authï¼Œåˆ™åŒ¿åæ‰§è¡Œè§†å›¾å‡½æ•°</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">authenticator</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">authenticators</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">user_auth_tuple</span> <span class="o">=</span> <span class="n">authenticator</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>  <span class="c1"># è°ƒç”¨è®¤è¯ç±»çš„authenticateæ–¹æ³•ï¼Œè¿”å›å…ƒç»„</span>
</span></span><span class="line"><span class="cl">            <span class="k">except</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">APIException</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">_not_authenticated</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                <span class="k">raise</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">user_auth_tuple</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">_authenticator</span> <span class="o">=</span> <span class="n">authenticator</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">auth</span> <span class="o">=</span> <span class="n">user_auth_tuple</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">_not_authenticated</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">_not_authenticated</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">_authenticator</span> <span class="o">=</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">api_settings</span><span class="o">.</span><span class="n">UNAUTHENTICATED_USER</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">api_settings</span><span class="o">.</span><span class="n">UNAUTHENTICATED_USER</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">api_settings</span><span class="o">.</span><span class="n">UNAUTHENTICATED_TOKEN</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">auth</span> <span class="o">=</span> <span class="n">api_settings</span><span class="o">.</span><span class="n">UNAUTHENTICATED_TOKEN</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">auth</span> <span class="o">=</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">APIView</span><span class="p">(</span><span class="n">View</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">authentication_classes</span> <span class="o">=</span> <span class="n">api_settings</span><span class="o">.</span><span class="n">DEFAULT_AUTHENTICATION_CLASSES</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">as_view</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">**</span><span class="n">initkwargs</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">view</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">as_view</span><span class="p">(</span><span class="o">**</span><span class="n">initkwargs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">csrf_exempt</span><span class="p">(</span><span class="n">view</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">dispatch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># ç¬¬ä¸€æ­¥ï¼šè¯·æ±‚çš„å°è£…(djangoçš„ request + drfçš„ authenticatorsè®¤è¯ç»„ä»¶)  --&gt; åŠ è½½è®¤è¯ç»„ä»¶è¿‡ç¨‹</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># request.authenticators  [å¯¹è±¡1ï¼Œå¯¹è±¡2ï¼Œ...]</span>
</span></span><span class="line"><span class="cl">        <span class="n">request</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">initialize_request</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">request</span> <span class="o">=</span> <span class="n">request</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># ç¬¬äºŒæ­¥ï¼šè®¤è¯è¿‡ç¨‹</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">initial</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">handler</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">http_method_not_allowed</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># ç¬¬ä¸‰æ­¥ï¼šæ‰§è¡Œè§†å›¾å‡½æ•°</span>
</span></span><span class="line"><span class="cl">            <span class="n">response</span> <span class="o">=</span> <span class="n">handler</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>  <span class="c1"># è®¤è¯æ—¶æŠ›å‡ºé”™è¯¯åœ¨è¿™é‡Œè¢«æ•è·</span>
</span></span><span class="line"><span class="cl">            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_exception</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">finalize_response</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">initialize_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">Request</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">request</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">authenticators</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_authenticators</span><span class="p">(),</span>  <span class="c1"># [å¯¹è±¡1ï¼Œå¯¹è±¡2ï¼Œ...]</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">initial</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">perform_authentication</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">check_permissions</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">check_throttles</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">perform_authentication</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">request</span><span class="o">.</span><span class="n">user</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get_authenticators</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># è¿”å›ä¸€ä¸ªåˆ—è¡¨æ¯ä¸€ä¸ªå…ƒç´ éƒ½æ˜¯è®¤è¯ç±»å¯¹è±¡ [å¯¹è±¡1ï¼Œå¯¹è±¡2ï¼Œ...]</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">[</span><span class="n">auth</span><span class="p">()</span> <span class="k">for</span> <span class="n">auth</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">authentication_classes</span><span class="p">]</span>  <span class="c1"># ä¼˜å…ˆè¯»å–å±€éƒ¨é…ç½®ï¼Œåå…¨å±€é…ç½®</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">handle_exception</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exc</span><span class="p">,</span> <span class="p">(</span><span class="n">exceptions</span><span class="o">.</span><span class="n">NotAuthenticated</span><span class="p">,</span><span class="n">exceptions</span><span class="o">.</span><span class="n">AuthenticationFailed</span><span class="p">)):</span>
</span></span><span class="line"><span class="cl">            <span class="n">auth_header</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_authenticate_header</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">auth_header</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">exc</span><span class="o">.</span><span class="n">auth_header</span> <span class="o">=</span> <span class="n">auth_header</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">exc</span><span class="o">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="n">status</span><span class="o">.</span><span class="n">HTTP_403_FORBIDDEN</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">response</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get_authenticate_header</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">authenticators</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_authenticators</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">authenticators</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">authenticators</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">authenticate_header</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">View</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">as_view</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">**</span><span class="n">initkwargs</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">def</span> <span class="nf">view</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dispatch</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">view</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">UserView</span><span class="p">(</span><span class="n">APIView</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">auth</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="s2">&#34;UserView&#34;</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="æ‹“å±•-å­ç±»çº¦æŸ">æ‹“å±•-å­ç±»çº¦æŸ
</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Foo</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># å¯¹å­ç±»è¿›è¡Œçº¦æŸï¼Œçº¦æŸå­ç±»ä¸­å¿…é¡»è¦å®šä¹‰è¯¥æ–¹æ³•ï¼Œä¸ç„¶å°±æŠ¥é”™</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">f1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&#34;...&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Bar</span><span class="p">(</span><span class="n">Foo</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">f1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;123&#34;</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li><code>BaseAuthenticationç±»å®šä¹‰</code></li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">BaseAuthentication</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    All authentication classes should extend BaseAuthentication.
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">authenticate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">        Authenticate the request and return a two-tuple of (user, token).
</span></span></span><span class="line"><span class="cl"><span class="s2">        &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&#34;.authenticate() must be overridden.&#34;</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="æ¡ˆä¾‹-ç”¨æˆ·ç™»å½•å’Œè®¤è¯">æ¡ˆä¾‹-ç”¨æˆ·ç™»å½•å’Œè®¤è¯
</h3><h4 id="åˆ›å»ºæ•°æ®è¡¨">åˆ›å»ºæ•°æ®è¡¨
</h4><blockquote>
<p>ä¸é…ç½®å…¶ä»–æ•°æ®åº“ï¼Œé‡‡ç”¨é»˜è®¤çš„<code>sqlite</code>åšç®€å•æµ‹è¯•</p></blockquote>
<ul>
<li><code>æ³¨å†Œapp --&gt; settings.py</code></li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">INSTALLED_APPS</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># &#39;django.contrib.admin&#39;,</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># &#39;django.contrib.auth&#39;,</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># &#39;django.contrib.contenttypes&#39;,</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># &#39;django.contrib.sessions&#39;,</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># &#39;django.contrib.messages&#39;,</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;django.contrib.staticfiles&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;rest_framework&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;api.apps.ApiConfig&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">]</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li><code>api/models.py</code></li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">models</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Create your models here.</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">UserInfo</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;ç”¨æˆ·è¡¨&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">username</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">verbose_name</span><span class="o">=</span><span class="s2">&#34;ç”¨æˆ·å&#34;</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">32</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">password</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">verbose_name</span><span class="o">=</span><span class="s2">&#34;ç”¨æˆ·å&#34;</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">64</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># ä¸´æ—¶å½¢å¼ã€åç»­å¯ä»¥ä½¿ç”¨jwtç­‰</span>
</span></span><span class="line"><span class="cl">    <span class="n">token</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">verbose_name</span><span class="o">=</span><span class="s2">&#34;TOKEN&#34;</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>åˆ›å»ºæ•°æ®åº“</li>
</ul>
<p><img src="/post/python/DRF/image-20241215214124221.png"
	
	
	
	loading="lazy"
	
		alt="image-20241215214124221"
	
	
></p>
<ul>
<li>æ‰‹åŠ¨æ·»åŠ æ•°æ®åšæµ‹è¯•</li>
</ul>
<p><img src="/post/python/DRF/image-20241215214406794.png"
	
	
	
	loading="lazy"
	
		alt="image-20241215214406794"
	
	
></p>
<h4 id="è·¯ç”±ç³»ç»Ÿ">è·¯ç”±ç³»ç»Ÿ
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">django.urls</span> <span class="kn">import</span> <span class="n">path</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">api</span> <span class="kn">import</span> <span class="n">views</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="n">path</span><span class="p">(</span><span class="s1">&#39;login/&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">LoginView</span><span class="o">.</span><span class="n">as_view</span><span class="p">()),</span>
</span></span><span class="line"><span class="cl">    <span class="n">path</span><span class="p">(</span><span class="s1">&#39;user/&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">UserView</span><span class="o">.</span><span class="n">as_view</span><span class="p">()),</span>
</span></span><span class="line"><span class="cl">    <span class="n">path</span><span class="p">(</span><span class="s1">&#39;order/&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">OrderView</span><span class="o">.</span><span class="n">as_view</span><span class="p">()),</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">]</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="è®¤è¯ç»„ä»¶">è®¤è¯ç»„ä»¶
</h4><blockquote>
<p>å®é™…å¼€å‘è¿‡ç¨‹ä¸­åº”å®šåˆ¶å“åº”çŠ¶æ€ç ï¼Œè¯¥æ¡ˆä¾‹ä½¿ç”¨ç®€å•çš„Trueå’ŒFalseæ ‡è¯†çŠ¶æ€</p></blockquote>
<ul>
<li><code>settings.pyå…¨å±€é…ç½®</code></li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">REST_FRAMEWORK</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;UNAUTHENTICATED_USER&#34;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># æœªç™»å½•æ—¶ï¼Œrequest.user=None</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;UNAUTHENTICATED_TOKEN&#34;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># æœªç™»å½•æ—¶ï¼Œrequest.auth=None</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;DEFAULT_AUTHENTICATION_CLASSES&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;ext.auth.QueryParamsAuthentication&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;ext.auth.HeaderAuthentication&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;ext.auth.NoAuthentication&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li><code>ext/auth.py</code></li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">rest_framework.authentication</span> <span class="kn">import</span> <span class="n">BaseAuthentication</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">rest_framework.exceptions</span> <span class="kn">import</span> <span class="n">AuthenticationFailed</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">api</span> <span class="kn">import</span> <span class="n">models</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">QueryParamsAuthentication</span><span class="p">(</span><span class="n">BaseAuthentication</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">authenticate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># è·å–è¯·æ±‚å‚æ•°å€¼</span>
</span></span><span class="line"><span class="cl">        <span class="n">token</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">query_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;token&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">token</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span>
</span></span><span class="line"><span class="cl">        <span class="n">user_object</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">UserInfo</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">token</span><span class="o">=</span><span class="n">token</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">user_object</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">user_object</span><span class="p">,</span> <span class="n">token</span>  <span class="c1"># request.user = ç”¨æˆ·å¯¹è±¡ï¼Œrequest.auth = token</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">authenticate_header</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="s1">&#39;Token&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">HeaderAuthentication</span><span class="p">(</span><span class="n">BaseAuthentication</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">authenticate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># è·å–è¯·æ±‚å¤´</span>
</span></span><span class="line"><span class="cl">        <span class="n">token</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;HTTP_AUTHORIZATION&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">token</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span>
</span></span><span class="line"><span class="cl">        <span class="n">user_object</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">UserInfo</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">token</span><span class="o">=</span><span class="n">token</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">user_object</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">user_object</span><span class="p">,</span> <span class="n">token</span>  <span class="c1"># request.user = ç”¨æˆ·å¯¹è±¡ï¼Œrequest.auth = token</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">authenticate_header</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="s1">&#39;Token&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">NoAuthentication</span><span class="p">(</span><span class="n">BaseAuthentication</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">authenticate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">raise</span> <span class="n">AuthenticationFailed</span><span class="p">({</span><span class="s2">&#34;status&#34;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&#34;msg&#34;</span><span class="p">:</span> <span class="s2">&#34;è®¤è¯å¤±è´¥&#34;</span><span class="p">})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">authenticate_header</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="s1">&#39;Token&#39;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="è§†å›¾å‡½æ•°">è§†å›¾å‡½æ•°
</h4><ul>
<li>postmanå‘é€postè¯·æ±‚æµ‹è¯•æ¥å£ç¤ºä¾‹</li>
</ul>
<p><img src="/post/python/DRF/image-20241215215621539.png"
	
	
	
	loading="lazy"
	
		alt="image-20241215215621539"
	
	
></p>
<ul>
<li>ç™»å½•ç”Ÿæˆtokenæ¥å£</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">uuid</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">rest_framework.views</span> <span class="kn">import</span> <span class="n">APIView</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">rest_framework.response</span> <span class="kn">import</span> <span class="n">Response</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">rest_framework.request</span> <span class="kn">import</span> <span class="n">Request</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">api</span> <span class="kn">import</span> <span class="n">models</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">LoginView</span><span class="p">(</span><span class="n">APIView</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">authentication_classes</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># å±€éƒ¨é…ç½®ï¼Œè¯¥å‡½æ•°æ— éœ€ç™»å½•</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 1.æ¥æ”¶ç”¨æˆ·postæäº¤çš„ç”¨æˆ·åå¯†ç </span>
</span></span><span class="line"><span class="cl">        <span class="c1"># request.dataç›´æ¥æ˜¯ä¸€ä¸ªå­—å…¸ç±»å‹</span>
</span></span><span class="line"><span class="cl">        <span class="n">user</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;username&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">pwd</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;password&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 2.æ•°æ®åº“æ ¡éªŒ</span>
</span></span><span class="line"><span class="cl">        <span class="n">user_object</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">UserInfo</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">user</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="n">pwd</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">user_object</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s2">&#34;status&#34;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&#34;msg&#34;</span><span class="p">:</span> <span class="s2">&#34;ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯&#34;</span><span class="p">})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 3.ç™»é™†æˆåŠŸ</span>
</span></span><span class="line"><span class="cl">        <span class="n">token</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">        <span class="n">user_object</span><span class="o">.</span><span class="n">token</span> <span class="o">=</span> <span class="n">token</span>
</span></span><span class="line"><span class="cl">        <span class="n">user_object</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s2">&#34;status&#34;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&#34;data&#34;</span><span class="p">:</span> <span class="n">token</span><span class="p">})</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="/post/python/DRF/image-20241215221444282.png"
	
	
	
	loading="lazy"
	
		alt="image-20241215221444282"
	
	
></p>
<ul>
<li>éœ€è¦è®¤è¯çš„è§†å›¾å‡½æ•°</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">UserView</span><span class="p">(</span><span class="n">APIView</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="s2">&#34;UserView&#34;</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="è®¿é—®æ•ˆæœ">è®¿é—®æ•ˆæœ
</h4><blockquote>
<p>åœ¨è¯·æ±‚å¤´ä¸­æºå¸¦å’Œåœ¨è¯·æ±‚å‚æ•°ä¸­æºå¸¦å‡å¯ï¼Œæœ‰å¯¹åº”çš„è®¤è¯ç»„ä»¶æ ¡éªŒ</p></blockquote>
<p><img src="/post/python/DRF/image-20241215223514300.png"
	
	
	
	loading="lazy"
	
		alt="image-20241215223514300"
	
	
></p>
<h3 id="æ€»ç»“">æ€»ç»“
</h3><p>ç¼–å†™ç»„ä»¶</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># ext/auth.py</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">rest_framework.authentication</span> <span class="kn">import</span> <span class="n">BaseAuthentication</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">rest_framework.exceptions</span> <span class="kn">import</span> <span class="n">AuthenticationFailed</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">MyAuthentication</span><span class="p">(</span><span class="n">BaseAuthentication</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">authenticate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># å»åšç”¨æˆ·è®¤è¯</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 1.è¯»å–è¯·æ±‚ä¼ é€’çš„token</span>
</span></span><span class="line"><span class="cl">        <span class="n">token</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">query_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;token&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 2.æ ¡éªŒåˆæ³•æ€§</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 3.è¿”å›å€¼</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 3.1 è¿”å›å…ƒç»„ (111,222) è®¤è¯æˆåŠŸ request.user request.auth</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 3.2 æŠ›å‡ºå¼‚å¸¸           è®¤è¯å¤±è´¥ -&gt; è¿”å›é”™è¯¯ä¿¡æ¯</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 3.1 è¿”å›None          å¤šä¸ªè®¤è¯ç±» [ç±»1ï¼Œç±»2ï¼Œç±»3ï¼Œç±»4ï¼Œï¼Œï¼Œ] -&gt; åŒ¿åç”¨æˆ·</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">token</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="s2">&#34;user&#34;</span><span class="p">,</span> <span class="n">token</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">authenticate_header</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="s1">&#39;Token&#39;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">NotAuthentication</span><span class="p">(</span><span class="n">BaseAuthentication</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">authenticate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">raise</span> <span class="n">AuthenticationFailed</span><span class="p">({</span><span class="s2">&#34;code&#34;</span><span class="p">:</span> <span class="mi">20000</span><span class="p">,</span> <span class="s2">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;è®¤è¯å¤±è´¥&#34;</span><span class="p">})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">authenticate_header</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="s1">&#39;Token&#39;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>å…¨å±€é…ç½®åŒ¿åç”¨æˆ·å’Œè®¤è¯ç±»</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># settings.py</span>
</span></span><span class="line"><span class="cl"><span class="n">REST_FRAMEWORK</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;UNAUTHENTICATED_USER&#34;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># æœªç™»å½•æ—¶ï¼Œrequest.user=None</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;UNAUTHENTICATED_TOKEN&#34;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># æœªç™»å½•æ—¶ï¼Œrequest.auth=None</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;DEFAULT_AUTHENTICATION_CLASSES&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;ext.auth.ParamAuthentication&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;ext.auth.HeaderAuthentication&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;ext.auth.NotAuthentication&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>å±€éƒ¨é…ç½®è®¤è¯ç±»</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># views.py</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">OrderView</span><span class="p">(</span><span class="n">APIView</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">authentication_classes</span> <span class="o">=</span> <span class="p">[</span><span class="o">...</span> <span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>è§£å†³å¤šè®¤è¯å‚æ•°ä¼ é€’ï¼ˆè¯·æ±‚å‚æ•°å’Œè¯·æ±‚å¤´ç­‰ç­‰ï¼‰å’Œ å¿…é¡»è®¤è¯ï¼Œå…¬å…±æ¥å£ï¼ˆå¯è®¤è¯å¯åŒ¿åï¼‰ï¼Œæ— éœ€è®¤è¯ä¸‰ç§ç±»å‹æ¥å£ &ndash;&gt;  è§æ¡ˆä¾‹4</p>
<h2 id="æƒé™">æƒé™
</h2><blockquote>
<ul>
<li>
<p>è®¤è¯ç»„ä»¶ = [è®¤è¯ç±»ï¼Œè®¤è¯ç±»ï¼Œè®¤è¯ç±»ï¼Œ]		-&gt;	æ‰§è¡Œæ¯ä¸€ä¸ªè®¤è¯ç±»çš„authenticateæ–¹æ³•</p>
<ul>
<li>
<p>è®¤è¯æˆåŠŸæˆ–å¤±è´¥ï¼Œä¸ä¼šå†æ‰§è¡Œåç»­çš„è®¤è¯ç±»</p>
</li>
<li>
<p>è¿”å›Noneï¼Œæ‰§è¡Œåç»­è®¤è¯ç±»</p>
</li>
</ul>
</li>
<li>
<p>æƒé™ç»„ä»¶ = [æƒé™ç±»ï¼Œæƒé™ç±»ï¼Œæƒé™ç±»ï¼Œ]        -&gt;    æ‰§è¡Œæ‰€æœ‰æƒé™ç±»çš„has_permissionæ–¹æ³•ï¼Œè¿”å›Trueé€šè¿‡ï¼Œè¿”å›Falseä¸é€šè¿‡</p>
<ul>
<li>æ‰§è¡Œæ‰€æœ‰çš„æƒé™ç±»</li>
</ul>
</li>
</ul>
<p>é»˜è®¤æƒ…å†µä¸‹ï¼Œè¦ä¿è¯æ‰€æœ‰çš„æƒé™ç±»ä¸­çš„has_permissionæ–¹æ³•éƒ½è¿”å›Trueï¼Œå³<code>ä¸</code>çš„å…³ç³»</p>
<p>æŒæ¡æºç æµç¨‹åï¼Œå¯ä»¥æ‰©å±•+è‡ªå®šä¹‰ï¼Œå®ç°å…¶ä»–é€»è¾‘</p></blockquote>
<h3 id="å¿«é€Ÿä½¿ç”¨-1">å¿«é€Ÿä½¿ç”¨
</h3><ul>
<li>ç¼–å†™ç±»</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">BasePermission</span><span class="p">(</span><span class="n">metaclass</span><span class="o">=</span><span class="n">BasePermissionMetaclass</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    A base class from which all permission classes should inherit.
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">has_permission</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">view</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">        Return `True` if permission is granted, `False` otherwise.
</span></span></span><span class="line"><span class="cl"><span class="s2">        &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">True</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>é˜…è¯»æºç å¯çŸ¥ï¼Œè‡ªå®šä¹‰çš„æƒé™ç±»çš„<code>has_permission</code>åº”è¿”å›<code>Trueæˆ–False</code>æ¥è¡¨ç¤ºæ˜¯å¦æœ‰æƒé™</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># ext/per.py</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">rest_framework.permissions</span> <span class="kn">import</span> <span class="n">BasePermission</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">random</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">MyPermission</span><span class="p">(</span><span class="n">BasePermission</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">has_permission</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">view</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># è·å–è¯·æ±‚ä¸­çš„æ•°æ®ï¼Œç„¶åè¿›è¡Œæ ¡éªŒ...</span>
</span></span><span class="line"><span class="cl">        <span class="n">v1</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">v1</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">False</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>åº”ç”¨ç±»</li>
</ul>
<blockquote>
<p>å…¨å±€åº”ç”¨	åœ¨<code>settings.py</code>ä¸­é…ç½®</p>
<p>å±€éƒ¨åº”ç”¨	åœ¨è§†å›¾å‡½æ•°ä¸­å®šä¹‰<code>permission_classes = []</code>å‚æ•°</p>
<p>æ ¹æ®ä¸šåŠ¡éœ€æ±‚çµæ´»é…ç½®</p></blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">REST_FRAMEWORK</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;UNAUTHENTICATED_USER&#34;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># æœªç™»å½•æ—¶ï¼Œrequest.user=None</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;UNAUTHENTICATED_TOKEN&#34;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># æœªç™»å½•æ—¶ï¼Œrequest.auth=None</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;DEFAULT_AUTHENTICATION_CLASSES&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;ext.auth.ParamAuthentication&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;ext.auth.HeaderAuthentication&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;ext.auth.NotAuthentication&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;DEFAULT_PERMISSION_CLASSES&#34;</span><span class="p">:[</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;ext.per.Mypermission&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="/post/python/DRF/image-20241217125147471.png"
	
	
	
	loading="lazy"
	
		alt="image-20241217125147471"
	
	
></p>
<h3 id="é”™è¯¯ä¿¡æ¯å’Œå¤šä¸ªæƒé™ç±»">é”™è¯¯ä¿¡æ¯å’Œå¤šä¸ªæƒé™ç±»
</h3><ul>
<li>åœ¨æƒé™ç±»ä¸­è‡ªå®šä¹‰é”™è¯¯ä¿¡æ¯<code>message</code></li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">MyPermission</span><span class="p">(</span><span class="n">BasePermission</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&#34;status&#34;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&#34;msg&#34;</span><span class="p">:</span> <span class="s2">&#34;æ— æƒè®¿é—®&#34;</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">has_permission</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">view</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># è·å–è¯·æ±‚ä¸­çš„æ•°æ®ï¼Œç„¶åè¿›è¡Œæ ¡éªŒ...</span>
</span></span><span class="line"><span class="cl">        <span class="n">v1</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">v1</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">False</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>å·¦å›¾ä¸ºé»˜è®¤é”™è¯¯ä¿¡æ¯ï¼Œå³å›¾ä¸ºè‡ªå®šä¹‰é”™è¯¯ä¿¡æ¯</p>
<p><img src="/post/python/DRF/image-20241217131658811.png"
	
	
	
	loading="lazy"
	
		alt="image-20241217131658811"
	
	
></p>
<ul>
<li>å¤šä¸ªæƒé™ç±»</li>
</ul>
<p><code>api/per.py</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">rest_framework.permissions</span> <span class="kn">import</span> <span class="n">BasePermission</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">MyPermission1</span><span class="p">(</span><span class="n">BasePermission</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&#34;status&#34;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&#34;msg&#34;</span><span class="p">:</span> <span class="s2">&#34;æ— æƒè®¿é—®&#34;</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">has_permission</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">view</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;MyPermission1&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">MyPermission2</span><span class="p">(</span><span class="n">BasePermission</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&#34;status&#34;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&#34;msg&#34;</span><span class="p">:</span> <span class="s2">&#34;æ— æƒè®¿é—®&#34;</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">has_permission</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">view</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;MyPermission2&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">MyPermission3</span><span class="p">(</span><span class="n">BasePermission</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&#34;status&#34;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&#34;msg&#34;</span><span class="p">:</span> <span class="s2">&#34;æ— æƒè®¿é—®&#34;</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">has_permission</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">view</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;MyPermission3&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">False</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>api/views.py</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">rest_framework.views</span> <span class="kn">import</span> <span class="n">APIView</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">rest_framework.response</span> <span class="kn">import</span> <span class="n">Response</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">ext.per</span> <span class="kn">import</span> <span class="n">MyPermission1</span><span class="p">,</span> <span class="n">MyPermission2</span><span class="p">,</span> <span class="n">MyPermission3</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">OrderView</span><span class="p">(</span><span class="n">APIView</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">authentication_classes</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">    <span class="n">permission_classes</span> <span class="o">=</span> <span class="p">[</span><span class="n">MyPermission1</span><span class="p">,</span> <span class="n">MyPermission2</span><span class="p">,</span> <span class="n">MyPermission3</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">auth</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s2">&#34;status&#34;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&#34;data&#34;</span><span class="p">:</span> <span class="p">[</span><span class="mi">11</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">33</span><span class="p">,</span> <span class="mi">44</span><span class="p">]})</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ç»ˆç«¯åªæ‰“å°äº†<code>MyPermission1</code></p>
<p><img src="/post/python/DRF/image-20241217140459678.png"
	
	
	
	loading="lazy"
	
		alt="image-20241217140459678"
	
	
></p>
<blockquote>
<p>è¯´æ˜ç¨‹åºä¼šæŒ‰é¡ºåºæ ¡éªŒæ¯ä¸ªæƒé™ç±»ï¼Œä¸€æ—¦æœ‰ä¸€ä¸ªè¿”å›Falseå³æ ¡éªŒä¸é€šè¿‡ï¼Œåˆ™ä¸å†æ ¡éªŒåç»­æƒé™ç±»ï¼Œåªæœ‰é€šè¿‡æ¯ä¸€ä¸ªæƒé™ç±»çš„æ ¡éªŒæ‰ç®—æœ‰æƒé™è®¿é—®</p></blockquote>
<h3 id="æºç æµç¨‹">æºç æµç¨‹
</h3><blockquote>
<p>as_view()ç­‰æ–¹æ³•çš„è°ƒç”¨åœ¨è®¤è¯ç»„ä»¶ä¸­å·²è¯¦ç»†é˜æ˜ï¼Œæ­¤å¤„ç›´æ¥ä»dispatch()æ–¹æ³•å¼€å§‹</p>
<p>åˆå§‹åŒ–çš„initialize_requestæ— æ¶‰åŠï¼Œç›´æ¥æ¥åˆ°initialæ–¹æ³•ï¼Œè°ƒç”¨check_permissionsæ–¹æ³•</p>
<p>check_permissionsæ–¹æ³•å¾ªç¯æƒé™ç±»å®ä¾‹å¯¹è±¡åˆ—è¡¨permission_classesï¼Œè°ƒç”¨has_permissionæ–¹æ³•ï¼Œä¸€æ—¦è¿”å›Falseï¼Œå°±è°ƒç”¨permission_deniedæ–¹æ³•ï¼Œå¹¶ä¼ å…¥é”™è¯¯ä¿¡æ¯messageå’Œcode</p></blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">APIView</span><span class="p">(</span><span class="n">View</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">permission_classes</span> <span class="o">=</span> <span class="n">api_settings</span><span class="o">.</span><span class="n">DEFAULT_PERMISSION_CLASSES</span>  <span class="c1"># æƒé™ç»„ä»¶çš„å…¨å±€é…ç½®</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">permission_denied</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">code</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">authenticators</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">successful_authenticator</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">NotAuthenticated</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">PermissionDenied</span><span class="p">(</span><span class="n">detail</span><span class="o">=</span><span class="n">message</span><span class="p">,</span> <span class="n">code</span><span class="o">=</span><span class="n">code</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get_permissions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># è·å–æƒé™ç±»å¯¹è±¡çš„åˆ—è¡¨</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">[</span><span class="n">permission</span><span class="p">()</span> <span class="k">for</span> <span class="n">permission</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">permission_classes</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">check_permissions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># å¾ªç¯æ¯ä¸€ä¸ªæƒé™ç±»å¯¹è±¡ï¼Œåˆ¤æ–­æƒé™æ ¡éªŒæ˜¯å¦é€šè¿‡</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">permission</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_permissions</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># å¦‚æœæœªé€šè¿‡ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸åœ¨dispatchä¸­æ•è·</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="ow">not</span> <span class="n">permission</span><span class="o">.</span><span class="n">has_permission</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">permission_denied</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                    <span class="n">request</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">message</span><span class="o">=</span><span class="nb">getattr</span><span class="p">(</span><span class="n">permission</span><span class="p">,</span> <span class="s1">&#39;message&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                    <span class="n">code</span><span class="o">=</span><span class="nb">getattr</span><span class="p">(</span><span class="n">permission</span><span class="p">,</span> <span class="s1">&#39;code&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">initial</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">perform_authentication</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>  <span class="c1"># è®¤è¯ç»„ä»¶çš„è¿‡ç¨‹ï¼Œå¾ªç¯æ‰§è¡Œæ¯ä¸ªauthenticateæ–¹æ³•ï¼›å¤±è´¥åˆ™æŠ›å‡ºå¼‚å¸¸ä¸å‘ä¸‹æ‰§è¡Œ</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">check_permissions</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>  <span class="c1"># æƒé™çš„æ ¡éªŒ</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">check_throttles</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">dispatch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># å°è£…drfçš„request</span>
</span></span><span class="line"><span class="cl">        <span class="n">request</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">initialize_request</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">request</span> <span class="o">=</span> <span class="n">request</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">headers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_response_headers</span>  <span class="c1"># deprecate?</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">initial</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># åå°„è·å–get/postç­‰æ–¹æ³•</span>
</span></span><span class="line"><span class="cl">            <span class="n">handler</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">http_method_not_allowed</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># æ‰§è¡Œç›¸åº”æ–¹æ³•</span>
</span></span><span class="line"><span class="cl">            <span class="n">response</span> <span class="o">=</span> <span class="n">handler</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># å¼‚å¸¸å¤„ç†</span>
</span></span><span class="line"><span class="cl">        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_exception</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">finalize_response</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">OrderView</span><span class="p">(</span><span class="n">APIView</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">permission_classes</span> <span class="o">=</span> <span class="p">[</span><span class="n">MyPermission1</span><span class="p">,</span> <span class="n">MyPermission2</span><span class="p">,</span> <span class="n">MyPermission3</span><span class="p">]</span>  <span class="c1"># æƒé™ç»„ä»¶çš„å±€éƒ¨é…ç½®</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">auth</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s2">&#34;status&#34;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&#34;data&#34;</span><span class="p">:</span> <span class="p">[</span><span class="mi">11</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">33</span><span class="p">,</span> <span class="mi">44</span><span class="p">]})</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="ç»„ä»¶çš„æ‹“å±•">ç»„ä»¶çš„æ‹“å±•
</h3><blockquote>
<p>é€šè¿‡æºç å¯ä»¥çŸ¥é“ï¼Œåœ¨<code>check_permissions</code>ä¸­ï¼Œåªè¦æœ‰ä¸€ä¸ªæƒé™ç±»æ ¡éªŒä¸é€šè¿‡å°±æ˜¯æ— æƒè®¿é—®ï¼Œé‚£ä¹ˆå¦‚ä½•æ‰èƒ½å®ç°æ‹“å±•ï¼Œä½¿å…¶æ»¡è¶³åªè¦æœ‰ä¸€ä¸ªæƒé™ç±»é€šè¿‡å°±æ˜¯æœ‰æƒé™å‘¢ï¼Ÿæ˜¾è€Œæ˜“è§éœ€è¦é‡å†™<code>check_permissions</code>æ–¹æ³•</p></blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">OrderView</span><span class="p">(</span><span class="n">APIView</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">authentication_classes</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">    <span class="n">permission_classes</span> <span class="o">=</span> <span class="p">[</span><span class="n">MyPermission1</span><span class="p">,</span> <span class="n">MyPermission2</span><span class="p">,</span> <span class="n">MyPermission3</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">auth</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s2">&#34;status&#34;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&#34;data&#34;</span><span class="p">:</span> <span class="p">[</span><span class="mi">11</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">33</span><span class="p">,</span> <span class="mi">44</span><span class="p">]})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">check_permissions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">no_permission_objects_list</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">permission</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_permissions</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">permission</span><span class="o">.</span><span class="n">has_permission</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">no_permission_objects_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">permission</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">permission_denied</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="n">request</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">message</span><span class="o">=</span><span class="nb">getattr</span><span class="p">(</span><span class="n">no_permission_objects_list</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;message&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                <span class="n">code</span><span class="o">=</span><span class="nb">getattr</span><span class="p">(</span><span class="n">no_permission_objects_list</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;code&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>åœ¨<code>OrderView</code>è§†å›¾ä¸­é‡å†™<code>check_permissions</code>æ–¹æ³•ï¼Œåˆ™åœ¨æƒé™æ ¡éªŒçš„ç”Ÿå‘½å‘¨æœŸä¸­ï¼Œè‡ªå®šä¹‰çš„<code>check_permissions</code>ä¾¿è¦†ç›–äº†<code>APIView</code>ä¸­çš„é»˜è®¤<code>check_permissions</code>å®ç°é€»è¾‘ï¼Œè¾¾åˆ°è‡ªå®šä¹‰æ‹“å±•çš„æ•ˆæœ</p>
<p>è‡ªå®šä¹‰çš„<code>check_permissions</code>å®ç°äº†ä¸€æ—¦æŸä¸€æƒé™ç±»æ ¡éªŒé€šè¿‡ï¼Œå°±ä¸å†è¿›è¡Œåç»­æ ¡éªŒã€‚è‹¥æ‰€æœ‰ç±»å‡æœªé€šè¿‡ï¼Œåˆ™è¿”å›ç¬¬ä¸€ä¸ªæœªé€šè¿‡çš„ç±»çš„é”™è¯¯ä¿¡æ¯</p>
<p>ç”±æ­¤å¯è§å­¦ä¹ æºç çš„é‡è¦æ€§ï¼Œä¸ä»…å¯ä»¥å­¦ä¹ æºç ä¸­ä¼˜ç§€çš„ä»£ç ç¼–å†™æ–¹å¼ï¼Œè¿˜å¯ä»¥åœ¨åŸæœ‰é€»è¾‘çš„åŸºç¡€ä¸Šè¿›è¡Œæ‹“å±•</p></blockquote>
<p>ä¸Šè¿°æ˜¯ä¿®æ”¹ä¸€ä¸ªè§†å›¾å‡½æ•°çš„æƒé™æ ¡éªŒé€»è¾‘ï¼Œå¦‚ä½•åº”ç”¨åˆ°å…¶ä»–è§†å›¾å‘¢ï¼Ÿ</p>
<blockquote>
<p>å¯ä»¥è‡ªå®šä¹‰ä¸€ä¸ª<code>NbApiView</code>çš„ç±»ï¼Œç»§æ‰¿<code>APIView</code>å¹¶ä¸”é‡å†™<code>check_permissions</code>ï¼Œä¹‹åè¦å®ç°æˆ–é€»è¾‘çš„æƒé™è®¤è¯çš„è§†å›¾åªéœ€ç»§æ‰¿<code>NbApiView</code>å³å¯</p></blockquote>
<ul>
<li><code>ext/view.py</code></li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">rest_framework.views</span> <span class="kn">import</span> <span class="n">APIView</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">NbApiView</span><span class="p">(</span><span class="n">APIView</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">check_permissions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">no_permission_objects_list</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">permission</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_permissions</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">permission</span><span class="o">.</span><span class="n">has_permission</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">no_permission_objects_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">permission</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">permission_denied</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="n">request</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">message</span><span class="o">=</span><span class="nb">getattr</span><span class="p">(</span><span class="n">no_permission_objects_list</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;message&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                <span class="n">code</span><span class="o">=</span><span class="nb">getattr</span><span class="p">(</span><span class="n">no_permission_objects_list</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;code&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>api/views.py</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">rest_framework.views</span> <span class="kn">import</span> <span class="n">APIView</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">rest_framework.response</span> <span class="kn">import</span> <span class="n">Response</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">ext.per</span> <span class="kn">import</span> <span class="n">MyPermission1</span><span class="p">,</span> <span class="n">MyPermission2</span><span class="p">,</span> <span class="n">MyPermission3</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">ext.view</span> <span class="kn">import</span> <span class="n">NbApiView</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">OrderView</span><span class="p">(</span><span class="n">NbApiView</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">authentication_classes</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">    <span class="n">permission_classes</span> <span class="o">=</span> <span class="p">[</span><span class="n">MyPermission1</span><span class="p">,</span> <span class="n">MyPermission2</span><span class="p">,</span> <span class="n">MyPermission3</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">auth</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s2">&#34;status&#34;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&#34;data&#34;</span><span class="p">:</span> <span class="p">[</span><span class="mi">11</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">33</span><span class="p">,</span> <span class="mi">44</span><span class="p">]})</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="æ¡ˆä¾‹-æƒé™å¤„ç†">æ¡ˆä¾‹-æƒé™å¤„ç†
</h3><h4 id="åˆ›å»ºæ•°æ®è¡¨-1">åˆ›å»ºæ•°æ®è¡¨
</h4><p><img src="/post/python/DRF/image-20241217171036327.png"
	
	
	
	loading="lazy"
	
		alt="image-20241217171036327"
	
	
></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">UserInfo</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;ç”¨æˆ·è¡¨&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">role</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">IntegerField</span><span class="p">(</span><span class="n">verbose_name</span><span class="o">=</span><span class="s2">&#34;è§’è‰²&#34;</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&#34;æ€»ç›‘&#34;</span><span class="p">),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s2">&#34;ç»ç†&#34;</span><span class="p">),</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s2">&#34;å‘˜å·¥&#34;</span><span class="p">)),</span> <span class="n">default</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">username</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">verbose_name</span><span class="o">=</span><span class="s2">&#34;ç”¨æˆ·å&#34;</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">32</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">password</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">verbose_name</span><span class="o">=</span><span class="s2">&#34;ç”¨æˆ·å&#34;</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">64</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># ä¸´æ—¶å½¢å¼ã€åç»­å¯ä»¥ä½¿ç”¨jwtç­‰</span>
</span></span><span class="line"><span class="cl">    <span class="n">token</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">verbose_name</span><span class="o">=</span><span class="s2">&#34;TOKEN&#34;</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">makemigrations</span>
</span></span><span class="line"><span class="cl"><span class="n">migrate</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ‰‹åŠ¨æ·»åŠ æ•°æ®</p>
<p><img src="/post/python/DRF/image-20241217172759096.png"
	
	
	
	loading="lazy"
	
		alt="image-20241217172759096"
	
	
></p>
<h4 id="è·¯ç”±ç³»ç»Ÿ-1">è·¯ç”±ç³»ç»Ÿ
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">django.urls</span> <span class="kn">import</span> <span class="n">path</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">api</span> <span class="kn">import</span> <span class="n">views</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="n">path</span><span class="p">(</span><span class="s1">&#39;login/&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">LoginView</span><span class="o">.</span><span class="n">as_view</span><span class="p">()),</span>
</span></span><span class="line"><span class="cl">    <span class="n">path</span><span class="p">(</span><span class="s1">&#39;user/&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">UserView</span><span class="o">.</span><span class="n">as_view</span><span class="p">()),</span>
</span></span><span class="line"><span class="cl">    <span class="n">path</span><span class="p">(</span><span class="s1">&#39;order/&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">OrderView</span><span class="o">.</span><span class="n">as_view</span><span class="p">()),</span>
</span></span><span class="line"><span class="cl">    <span class="n">path</span><span class="p">(</span><span class="s1">&#39;avatar/&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">AvatarView</span><span class="o">.</span><span class="n">as_view</span><span class="p">())</span>
</span></span><span class="line"><span class="cl"><span class="p">]</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="è®¤è¯ç»„ä»¶-1">è®¤è¯ç»„ä»¶
</h4><blockquote>
<p>æ ¹æ®ä¼ å…¥tokenè¿”å›ç”¨æˆ·å¯¹è±¡</p></blockquote>
<p><code>ext/auth.py</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">rest_framework.authentication</span> <span class="kn">import</span> <span class="n">BaseAuthentication</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">rest_framework.exceptions</span> <span class="kn">import</span> <span class="n">AuthenticationFailed</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">api</span> <span class="kn">import</span> <span class="n">models</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">QueryParamsAuthentication</span><span class="p">(</span><span class="n">BaseAuthentication</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">authenticate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">token</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">query_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;token&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">token</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span>
</span></span><span class="line"><span class="cl">        <span class="n">user_object</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">UserInfo</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">token</span><span class="o">=</span><span class="n">token</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">user_object</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">user_object</span><span class="p">,</span> <span class="n">token</span>  <span class="c1"># request.user = ç”¨æˆ·å¯¹è±¡ï¼Œrequest.auth = token</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">authenticate_header</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="s1">&#39;Token&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">HeaderAuthentication</span><span class="p">(</span><span class="n">BaseAuthentication</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">authenticate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">token</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;HTTP_AUTHORIZATION&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">token</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span>
</span></span><span class="line"><span class="cl">        <span class="n">user_object</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">UserInfo</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">token</span><span class="o">=</span><span class="n">token</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">user_object</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">user_object</span><span class="p">,</span> <span class="n">token</span>  <span class="c1"># request.user = ç”¨æˆ·å¯¹è±¡ï¼Œrequest.auth = token</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">authenticate_header</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="s1">&#39;Token&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">NoAuthentication</span><span class="p">(</span><span class="n">BaseAuthentication</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">authenticate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">raise</span> <span class="n">AuthenticationFailed</span><span class="p">({</span><span class="s2">&#34;status&#34;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&#34;msg&#34;</span><span class="p">:</span> <span class="s2">&#34;è®¤è¯å¤±è´¥&#34;</span><span class="p">})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">authenticate_header</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="s1">&#39;Token&#39;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="æƒé™ç»„ä»¶">æƒé™ç»„ä»¶
</h4><p><code>ext/per.py</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">rest_framework.permissions</span> <span class="kn">import</span> <span class="n">BasePermission</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">UserPermission</span><span class="p">(</span><span class="n">BasePermission</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&#34;status&#34;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&#34;msg&#34;</span><span class="p">:</span> <span class="s2">&#34;æ— æƒè®¿é—®1&#34;</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">has_permission</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">view</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">role</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">ManagerPermission</span><span class="p">(</span><span class="n">BasePermission</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&#34;status&#34;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&#34;msg&#34;</span><span class="p">:</span> <span class="s2">&#34;æ— æƒè®¿é—®1&#34;</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">has_permission</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">view</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">role</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">BossPermission</span><span class="p">(</span><span class="n">BasePermission</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&#34;status&#34;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&#34;msg&#34;</span><span class="p">:</span> <span class="s2">&#34;æ— æƒè®¿é—®1&#34;</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">has_permission</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">view</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">role</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">False</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>ext/view.py</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">rest_framework.views</span> <span class="kn">import</span> <span class="n">APIView</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">NbApiView</span><span class="p">(</span><span class="n">APIView</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">check_permissions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">no_permission_objects_list</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">permission</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_permissions</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">permission</span><span class="o">.</span><span class="n">has_permission</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">no_permission_objects_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">permission</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">permission_denied</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="n">request</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">message</span><span class="o">=</span><span class="nb">getattr</span><span class="p">(</span><span class="n">no_permission_objects_list</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;message&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                <span class="n">code</span><span class="o">=</span><span class="nb">getattr</span><span class="p">(</span><span class="n">no_permission_objects_list</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;code&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="è§†å›¾å‡½æ•°-1">è§†å›¾å‡½æ•°
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">uuid</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">rest_framework.views</span> <span class="kn">import</span> <span class="n">APIView</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">rest_framework.response</span> <span class="kn">import</span> <span class="n">Response</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">api</span> <span class="kn">import</span> <span class="n">models</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">ext.per</span> <span class="kn">import</span> <span class="n">UserPermission</span><span class="p">,</span> <span class="n">ManagerPermission</span><span class="p">,</span> <span class="n">BossPermission</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">ext.view</span> <span class="kn">import</span> <span class="n">NbApiView</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">LoginView</span><span class="p">(</span><span class="n">APIView</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">authentication_classes</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 1.æ¥æ”¶ç”¨æˆ·postæäº¤çš„ç”¨æˆ·åå¯†ç </span>
</span></span><span class="line"><span class="cl">        <span class="c1"># print(request.query_params)  # è·å–getè¯·æ±‚æäº¤çš„å‚æ•°</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># request.dataç›´æ¥æ˜¯ä¸€ä¸ªå­—å…¸ç±»å‹</span>
</span></span><span class="line"><span class="cl">        <span class="n">user</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;username&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">pwd</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;password&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 2.æ•°æ®åº“æ ¡éªŒ</span>
</span></span><span class="line"><span class="cl">        <span class="n">user_object</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">UserInfo</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">user</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="n">pwd</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">user_object</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s2">&#34;status&#34;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&#34;msg&#34;</span><span class="p">:</span> <span class="s2">&#34;ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯&#34;</span><span class="p">})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 3.ç™»é™†æˆåŠŸ</span>
</span></span><span class="line"><span class="cl">        <span class="n">token</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">        <span class="n">user_object</span><span class="o">.</span><span class="n">token</span> <span class="o">=</span> <span class="n">token</span>
</span></span><span class="line"><span class="cl">        <span class="n">user_object</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s2">&#34;status&#34;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&#34;data&#34;</span><span class="p">:</span> <span class="n">token</span><span class="p">})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">UserView</span><span class="p">(</span><span class="n">NbApiView</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># ç»ç†ã€æ€»æ£€ã€æ™®é€šç”¨æˆ·éƒ½å¯ä»¥è®¿é—®</span>
</span></span><span class="line"><span class="cl">    <span class="n">permission_classes</span> <span class="o">=</span> <span class="p">[</span><span class="n">BossPermission</span><span class="p">,</span> <span class="n">ManagerPermission</span><span class="p">,</span> <span class="n">UserPermission</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">auth</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="s2">&#34;UserView&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">OrderView</span><span class="p">(</span><span class="n">NbApiView</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># ç»ç†ã€æ€»ç›‘å¯ä»¥è®¿é—®</span>
</span></span><span class="line"><span class="cl">    <span class="n">permission_classes</span> <span class="o">=</span> <span class="p">[</span><span class="n">BossPermission</span><span class="p">,</span> <span class="n">ManagerPermission</span><span class="p">,</span> <span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">auth</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s2">&#34;status&#34;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&#34;data&#34;</span><span class="p">:</span> <span class="p">[</span><span class="mi">11</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">33</span><span class="p">,</span> <span class="mi">44</span><span class="p">]})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">AvatarView</span><span class="p">(</span><span class="n">NbApiView</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># æ€»ç›‘ã€å‘˜å·¥å¯ä»¥è®¿é—®</span>
</span></span><span class="line"><span class="cl">    <span class="n">permission_classes</span> <span class="o">=</span> <span class="p">[</span><span class="n">BossPermission</span><span class="p">,</span> <span class="n">UserPermission</span><span class="p">,</span> <span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">auth</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s2">&#34;status&#34;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&#34;data&#34;</span><span class="p">:</span> <span class="p">[</span><span class="mi">11</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">33</span><span class="p">,</span> <span class="mi">44</span><span class="p">]})</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="è®¿é—®æ•ˆæœ-1">è®¿é—®æ•ˆæœ
</h4><blockquote>
<p><code>token2</code>å¯¹åº”<code>ç»ç†</code></p>
<p><code>token3</code>å¯¹åº”<code>å‘˜å·¥</code></p>
<p>å‘˜å·¥å¯ä»¥è®¿é—®<code>/avatar</code>,è®¿é—®ä¸äº†<code>/order</code></p>
<p>ç»ç†å¯ä»¥è®¿é—®<code>/order</code>,è®¿é—®ä¸äº†<code>/avatar</code></p></blockquote>
<p><img src="/post/python/DRF/image-20241217173736707.png"
	
	
	
	loading="lazy"
	
		alt="image-20241217173736707"
	
	
></p>
<h3 id="æ€è€ƒ">æ€è€ƒ
</h3><blockquote>
<p>åœ¨å¼€å‘è¿‡ç¨‹ä¸­,å‘ç°drfä¸­çš„requestå¯¹è±¡ä¸å¥½ç”¨,åº”è¯¥å¦‚ä½•æ¢æˆå¦ä¸€ä¸ªrequestç±»å¯¹è±¡?</p></blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">AvatarView</span><span class="p">(</span><span class="n">NbApiView</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># æ€»ç›‘ã€å‘˜å·¥å¯ä»¥è®¿é—®</span>
</span></span><span class="line"><span class="cl">    <span class="n">permission_classes</span> <span class="o">=</span> <span class="p">[</span><span class="n">BossPermission</span><span class="p">,</span> <span class="n">UserPermission</span><span class="p">,</span> <span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">auth</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s2">&#34;status&#34;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&#34;data&#34;</span><span class="p">:</span> <span class="p">[</span><span class="mi">11</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">33</span><span class="p">,</span> <span class="mi">44</span><span class="p">]})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">initialize_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># super().initialize_request()</span>
</span></span><span class="line"><span class="cl">        <span class="n">parser_context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_parser_context</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">Request</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">request</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">parsers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_parsers</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">            <span class="n">authenticators</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_authenticators</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">            <span class="n">negotiator</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_content_negotiator</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">            <span class="n">parser_context</span><span class="o">=</span><span class="n">parser_context</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># å†è‡ªå·±å®šä¹‰ä¸€ä¸ªRequestç±»å³å¯å®Œæˆæ¥ç®¡,é½æ´»!</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>drfä¸­çš„è®¤è¯/æƒé™ç»„ä»¶ä¸djangoä¸­çš„ä¸­é—´ä»¶æœ‰ä»€ä¹ˆå…³ç³»?</p>
<p>è®¤è¯/æƒé™ç»„ä»¶åœ¨ä¸­é—´ä»¶ä¹‹å</p></blockquote>
<p><img src="/post/python/DRF/image-20241217182023566.png"
	
	
	
	loading="lazy"
	
		alt="image-20241217182023566"
	
	
></p>
<h3 id="æ€»ç»“-1">æ€»ç»“
</h3><p>é»˜è®¤æŒ‰æƒé™ç±»åˆ—è¡¨å®šä¹‰çš„é¡ºåºåˆ¤æ–­æ¯ä¸€ä¸ªæƒé™ï¼Œè¿”å›Trueç»§ç»­åˆ¤æ–­ï¼ŒçŸ¥é“æ‰€æœ‰æƒé™ç±»å‡é€šè¿‡ï¼›è¿”å›Falseç›´æ¥é€€å‡ºï¼Œæ— æƒé™</p>
<p>é€šè¿‡ä¿®æ”¹check_permissionsçš„é€»è¾‘å¯ä»¥å®ç°ï¼Œè¿”å›Trueç›´æ¥é€€å‡ºï¼Œæœ‰æƒé™ï¼›è¿”å›Falseç»§ç»­åˆ¤æ–­ï¼ŒçŸ¥é“æœ‰Trueï¼Œè‹¥å…¨ä¸ºFalseï¼Œæ— æƒé™</p>
<p>å…¨å±€é…ç½®</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">REST_FRAMEWORK</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;UNAUTHENTICATED_USER&#34;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># æœªç™»å½•æ—¶ï¼Œrequest.user=None</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;UNAUTHENTICATED_TOKEN&#34;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># æœªç™»å½•æ—¶ï¼Œrequest.auth=None</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;DEFAULT_AUTHENTICATION_CLASSES&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;ext.auth.ParamAuthentication&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;ext.auth.HeaderAuthentication&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;ext.auth.NotAuthentication&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;DEFAULT_PERMISSION_CLASSES&#34;</span><span class="p">:[</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;ext.per.Mypermission&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ext/per.py</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">rest_framework.permissions</span> <span class="kn">import</span> <span class="n">BasePermission</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">UserPermission</span><span class="p">(</span><span class="n">BasePermission</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># å­å®šä¹‰é”™è¯¯ä¿¡æ¯</span>
</span></span><span class="line"><span class="cl">    <span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&#34;status&#34;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&#34;msg&#34;</span><span class="p">:</span> <span class="s2">&#34;æ— æƒè®¿é—®1&#34;</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="c1"># æƒé™åˆ¤æ–­ï¼ŒTrueæˆ–False</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">has_permission</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">view</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">role</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">False</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ext/view.py</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">rest_framework.views</span> <span class="kn">import</span> <span class="n">APIView</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">NbApiView</span><span class="p">(</span><span class="n">APIView</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">check_permissions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">no_permission_objects_list</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">permission</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_permissions</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">permission</span><span class="o">.</span><span class="n">has_permission</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">no_permission_objects_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">permission</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">permission_denied</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="n">request</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">message</span><span class="o">=</span><span class="nb">getattr</span><span class="p">(</span><span class="n">no_permission_objects_list</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;message&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                <span class="n">code</span><span class="o">=</span><span class="nb">getattr</span><span class="p">(</span><span class="n">no_permission_objects_list</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;code&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>è§†å›¾å‡½æ•°</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">ext.per</span> <span class="kn">import</span> <span class="n">UserPermission</span><span class="p">,</span> <span class="n">ManagerPermission</span><span class="p">,</span> <span class="n">BossPermission</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">ext.view</span> <span class="kn">import</span> <span class="n">NbApiView</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># ç»§æ‰¿è‡ªå®šä¹‰è¯•å›¾ç±»ï¼Œæ”¹å˜æƒé™é€»è¾‘</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">UserView</span><span class="p">(</span><span class="n">NbApiView</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">	<span class="c1"># å±€éƒ¨é…ç½®</span>
</span></span><span class="line"><span class="cl">    <span class="n">permission_classes</span> <span class="o">=</span> <span class="p">[</span><span class="n">BossPermission</span><span class="p">,</span> <span class="n">ManagerPermission</span><span class="p">,</span> <span class="n">UserPermission</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="é™æµ">é™æµ
</h2><h3 id="åŸºæœ¬é€»è¾‘">åŸºæœ¬é€»è¾‘
</h3><blockquote>
<p>å¼€å‘è¿‡ç¨‹ä¸­ï¼ŒæŸä¸ªæ¥å£ä¸æƒ³è®©ç”¨æˆ·è®¿é—®è¿‡äºé¢‘ç¹ï¼Œéœ€è¦é™æµæœºåˆ¶</p>
<p>ä¾‹å¦‚ï¼šå¹³å°å‘é€éªŒè¯ç ï¼Œé™¤äº†äº‘å‚å•†æä¾›çš„é™åˆ¶ï¼Œå¯èƒ½è¿˜éœ€è¦åšå…¶ä»–é™åˆ¶ï¼Œå¦‚IPé™åˆ¶ã€éªŒè¯ç ç­‰ç­‰</p>
<p>é™åˆ¶è®¿é—®é¢‘ç‡éœ€è¦æ‰¾åˆ°å”¯ä¸€æ ‡è¯†:</p>
<pre><code>  - å·²ç™»å½•ç”¨æˆ·ï¼Œå¯ä»¥ä½¿ç”¨ç”¨æˆ·ä¿¡æ¯ä¸»é”®ï¼ŒIDï¼Œç”¨æˆ·å
  - æœªç™»å½•ç”¨æˆ·ï¼Œå¯ä»¥é‡‡ç”¨IPä½œä¸ºå”¯ä¸€æ ‡è¯†
</code></pre></blockquote>
<p>å¦‚ä½•é™åˆ¶ï¼Ÿ</p>
<p>ç»´æŠ¤ä¸€ä¸ª<code>å”¯ä¸€æ ‡è¯†ï¼šè®¿é—®è®°å½•åˆ—è¡¨</code></p>
<blockquote>
<p><code>&quot;121&quot;ï¼š[ 20:35  20:32  20:22  20:12 ]</code>     é™åˆ¶10åˆ†é’Ÿ3æ¬¡</p>
<ol>
<li>
<p>è·å–å½“å‰æ—¶é—´  20:36</p>
</li>
<li>
<p>å½“å‰æ—¶é—´-10åˆ†é’Ÿ=è®¡æ•°å¼€å§‹æ—¶é—´  20ï¼š26</p>
</li>
<li>
<p>åˆ é™¤å°äº20ï¼š26çš„è®°å½•</p>
</li>
<li>
<p>è®¡ç®—é•¿åº¦</p>
<p>4.1 è¶…è¿‡ï¼ŒæŠ¥é”™</p>
<p>4.2 æœªè¶…è¿‡ï¼Œè®¿é—®</p>
</li>
</ol></blockquote>
<h3 id="å¿«é€Ÿä½¿ç”¨-2">å¿«é€Ÿä½¿ç”¨
</h3><ul>
<li>ç¼–å†™ç±»</li>
</ul>
<blockquote>
<p>é‡å†™äº†è·å–å”¯ä¸€æ ‡è¯†çš„get_cache_keyæ–¹æ³•ï¼Œä¼˜å…ˆä½¿ç”¨ç”¨æˆ·idï¼Œè‹¥æ²¡æœ‰å†é‡‡ç”¨é»˜è®¤çš„è·å–è¯·æ±‚ipåšå”¯ä¸€æ ‡è¯†</p>
<p>åç»­å¯ä»¥è¿æ¥rediså°†æ ‡è¯†åšé”®ï¼Œè®¿é—®è®°å½•å­˜å‚¨ä¸ºå¯¹åº”çš„å€¼è¿›è¡Œè”åŠ¨</p></blockquote>
<ul>
<li><code>ext/throttle.py</code></li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">rest_framework.throttling</span> <span class="kn">import</span> <span class="n">SimpleRateThrottle</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">django.core.cache</span> <span class="kn">import</span> <span class="n">cache</span> <span class="k">as</span> <span class="n">default_cache</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">MyThrottle</span><span class="p">(</span><span class="n">SimpleRateThrottle</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">scope</span> <span class="o">=</span> <span class="s2">&#34;XXX&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">THROTTLE_RATES</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&#34;XXX&#34;</span><span class="p">:</span> <span class="s2">&#34;5/m&#34;</span><span class="p">}</span>  <span class="c1"># é™åˆ¶é¢‘ç‡</span>
</span></span><span class="line"><span class="cl">    <span class="n">cache</span> <span class="o">=</span> <span class="n">default_cache</span>  <span class="c1"># redisé…ç½®</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># è·å–å”¯ä¸€æ ‡è¯†ï¼Œåç»­å¯ä»¥è¿æ¥redisåšæ“ä½œ</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get_cache_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">view</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">ident</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">pk</span>  <span class="c1"># ç”¨æˆ·ID</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">ident</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ident</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>  <span class="c1"># è·å–è¯·æ±‚ç”¨æˆ·IPï¼ˆå»requestä¸­æ‰¾è¯·æ±‚å¤´ï¼‰</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># cache_format = &#39;throttle_%(scope)s_%(ident)s&#39;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_format</span> <span class="o">%</span> <span class="p">{</span><span class="s1">&#39;scope&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="p">,</span> <span class="s1">&#39;ident&#39;</span><span class="p">:</span> <span class="n">ident</span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>redisé…ç½®</li>
</ul>
<blockquote>
<p>1.django-redisé…ç½® 	-&gt;	settings.py
2.å®‰è£…django-redis	pip install django-redis
3.å¯åŠ¨redisæœåŠ¡</p></blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># settings.py</span>
</span></span><span class="line"><span class="cl"><span class="n">CACHES</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;default&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;BACKEND&#34;</span><span class="p">:</span> <span class="s2">&#34;django_redis.cache.RedisCache&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;LOCATION&#34;</span><span class="p">:</span> <span class="s2">&#34;redis://127.0.0.1:6379&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;OPTIONS&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;CLIENT_CLASS&#34;</span><span class="p">:</span> <span class="s2">&#34;django_redis.client.DefaultClient&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;PASSWORD&#34;</span><span class="p">:</span> <span class="s2">&#34;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>åº”ç”¨ç±»</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">ext.throttle</span> <span class="kn">import</span> <span class="n">MyThrottle</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">LoginView</span><span class="p">(</span><span class="n">APIView</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">authentication_classes</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">    <span class="n">throttle_classes</span> <span class="o">=</span> <span class="p">[</span><span class="n">MyThrottle</span><span class="p">,]</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="/post/python/DRF/image-20241218093359538.png"
	
	
	
	loading="lazy"
	
		alt="image-20241218093359538"
	
	
></p>
<h3 id="æºç æµç¨‹-1">æºç æµç¨‹
</h3><blockquote>
<ol>
<li>
<p>å¯¹è±¡åŠ è½½</p>
<p>è·å–æ¯ä¸ªé™æµç±»å¯¹è±¡ï¼Œåˆå§‹åŒ–ï¼ˆè¯»å–é™æµé…ç½®ï¼Œè·å–æ—¶é—´é—´éš”å’Œè®¿é—®æ¬¡æ•°ï¼‰</p>
</li>
<li>
<p>allow_requeståˆ¤æ–­æ˜¯å¦é™æµ</p>
</li>
</ol></blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">ä»dispatchæ–¹æ³•çš„initialæ–¹æ³•å¼€å§‹ï¼Œè°ƒç”¨äº†check_throttlesæ–¹æ³•
</span></span><span class="line"><span class="cl">check_throttlesæ–¹æ³•ä¸­ï¼š
</span></span><span class="line"><span class="cl">	self.get_throttles()ï¼Œä»å±€éƒ¨é…ç½®æˆ–å…¨å±€é…ç½®è¯»å–é™æµç±»åˆ—è¡¨throttle_classesï¼Œç„¶åé€ä¸€å®ä¾‹åŒ–ï¼Œè¿”å›ä¸€ä¸ªé™æµç±»å¯¹è±¡åˆ—è¡¨
</span></span><span class="line"><span class="cl">	å¾ªç¯ä¸Šè¿°åˆ—è¡¨ï¼Œè°ƒç”¨æ¯ä¸€ä¸ªç±»çš„allow_requestæ–¹æ³•ï¼Œå¦‚æœè¿”å›Falseå³è¢«é™æµï¼Œå°†ç­‰å¾…æ—¶é—´æ·»åŠ åˆ°åˆ—è¡¨throttle_durationsä¸­ï¼Œå¹¶è·å–æœ€å¤§ç­‰å¾…æ—¶é—´durationï¼Œç„¶åæŠ›å‡ºå¼‚å¸¸
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">å¯¹äºæ¯ä¸€ä¸ªé™æµç±»ï¼Œå¾ªç¯throttle_classeså®ä¾‹åŒ–æ—¶ï¼Œé‡å†™äº†scopeï¼ŒTHROTTLE_RATESï¼Œcacheï¼Œget_cache_keyç­‰ç­‰å±æ€§æ–¹æ³•ï¼Œå¹¶è°ƒç”¨__init__åˆå§‹åŒ–
</span></span><span class="line"><span class="cl">	è°ƒç”¨get_rateæ–¹æ³•ï¼Œè·å–THROTTLE_RATES[self.scope]ä½œä¸ºrateï¼Œå¦‚5/m
</span></span><span class="line"><span class="cl">	è°ƒç”¨parse_rateæ–¹æ³•ï¼Œå°†rateä½œä¸ºå‚æ•°ï¼Œè¿”å›æ¬¡æ•°ä¸é—´éš”ç»™num_requestså’Œduration
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">æ¯ä¸€ä¸ªç±»æ‰§è¡Œallow_requestæ—¶ï¼Œè°ƒç”¨get_cache_keyè·å–å”¯ä¸€æ ‡è¯†keyï¼Œä»cacheä¸­æ ¹æ®keyè·å–å¯¹åº”ç»´æŠ¤çš„è®°å½•åˆ—è¡¨ç»™historyï¼Œè·å–å½“å‰æ—¶é—´nowï¼Œå¾ªç¯historyï¼Œå°†æ—¶é—´å°äºnow-durationå³è®¡æ•°èµ·ç‚¹çš„è®°å½•popæ‰ï¼Œæ¯”è¾ƒåˆ—è¡¨å‰©ä½™é•¿åº¦ä¸num_requests
</span></span><span class="line"><span class="cl">	å¦‚æœè¶…è¿‡é™åˆ¶ï¼Œè°ƒç”¨throttle_failure
</span></span><span class="line"><span class="cl">	æ­£å¸¸è®¿é—®ï¼Œè°ƒç”¨throttle_success
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">æ­£å¸¸è®¿é—®ï¼Œthrottle_successå°†æœ¬æ¬¡è®°å½•åŠ å…¥historyï¼Œå¹¶æ›´æ–°ç¼“å­˜ï¼Œè¿”å›True
</span></span><span class="line"><span class="cl">è¶…è¿‡é™åˆ¶ï¼Œè°ƒç”¨throttle_failureè¿”å›False
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">BaseThrottle</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">allow_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">view</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;.allow_request() must be overridden&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get_ident</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">pass</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">wait</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">SimpleRateThrottle</span><span class="p">(</span><span class="n">BaseThrottle</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">cache</span> <span class="o">=</span> <span class="n">default_cache</span>
</span></span><span class="line"><span class="cl">    <span class="n">timer</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span>
</span></span><span class="line"><span class="cl">    <span class="n">cache_format</span> <span class="o">=</span> <span class="s1">&#39;throttle_</span><span class="si">%(scope)s</span><span class="s1">_</span><span class="si">%(ident)s</span><span class="s1">&#39;</span>
</span></span><span class="line"><span class="cl">    <span class="n">scope</span> <span class="o">=</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># å…¨å±€é…ç½®çš„scopeä¸THROTTLE_RATESå¯¹åº”å…³ç³»ï¼Œå¯ä»¥åœ¨settings.pyä¸­é…ç½®DEFAULT_THROTTLE_RATESï¼Œåœ¨è‡ªå®šä¹‰é™æµç±»ä¸­åªéœ€æŒ‡å®šscopeå³å¯</span>
</span></span><span class="line"><span class="cl">    <span class="n">THROTTLE_RATES</span> <span class="o">=</span> <span class="n">api_settings</span><span class="o">.</span><span class="n">DEFAULT_THROTTLE_RATES</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># åˆå§‹åŒ–è®¿é—®é™åˆ¶çš„æ¬¡æ•°ä¸æ—¶é—´</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;rate&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">rate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_rate</span><span class="p">()</span>  <span class="c1"># &#34;5/m&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">num_requests</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">duration</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_rate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rate</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get_cache_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">view</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;.get_cache_key() must be overridden&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get_rate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;scope&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&#34;You must set either `.scope` or `.rate` for &#39;</span><span class="si">%s</span><span class="s2">&#39; throttle&#34;</span> <span class="o">%</span>
</span></span><span class="line"><span class="cl">                   <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">raise</span> <span class="n">ImproperlyConfigured</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># THROTTLE_RATES = {&#34;XXX&#34;: &#34;5/m&#34;}  # é™åˆ¶é¢‘ç‡</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># scope = &#34;XXX&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">THROTTLE_RATES</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&#34;No default throttle rate set for &#39;</span><span class="si">%s</span><span class="s2">&#39; scope&#34;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope</span>
</span></span><span class="line"><span class="cl">            <span class="k">raise</span> <span class="n">ImproperlyConfigured</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># å°†THROTTLE_RATESåˆ‡å‰²ä¸ºæ¬¡æ•°å’Œå¯¹åº”æ—¶é—´èŒƒå›´</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">parse_rate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rate</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># &#34;5/m&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">rate</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">num</span><span class="p">,</span> <span class="n">period</span> <span class="o">=</span> <span class="n">rate</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">num_requests</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">num</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># period[0]å–å‡ºsã€mæˆ–hï¼Œå› æ­¤è‡ªå®šä¹‰THROTTLE_RATESæ—¶ä¹Ÿå¯ä»¥å°†hå†™æˆhourï¼Œå› ä¸ºå®ƒåªè¯»å–ç´¢å¼•ä¸ºé›¶çš„å­—ç¬¦</span>
</span></span><span class="line"><span class="cl">        <span class="n">duration</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;s&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;m&#39;</span><span class="p">:</span> <span class="mi">60</span><span class="p">,</span> <span class="s1">&#39;h&#39;</span><span class="p">:</span> <span class="mi">3600</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">:</span> <span class="mi">86400</span><span class="p">}[</span><span class="n">period</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">(</span><span class="n">num_requests</span><span class="p">,</span> <span class="n">duration</span><span class="p">)</span>  <span class="c1"># è¿”å› 5 60</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">allow_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">view</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rate</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># è·å–å”¯ä¸€æ ‡è¯†</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_cache_key</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">view</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># è·å–å†å²è®¿é—®è®°å½•[20:35  20:32  20:22  20:12]</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">history</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="p">[])</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># è·å–å½“å‰æ—¶é—´</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">now</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">timer</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># å¾ªç¯ å°†å°äºè®¡æ•°å¼€å§‹æ—¶é—´å‰”é™¤</span>
</span></span><span class="line"><span class="cl">        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">history</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">now</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">duration</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># è®¡ç®—é•¿åº¦</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_requests</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">throttle_failure</span><span class="p">()</span>  <span class="c1"># è¶…è¿‡é™åˆ¶ï¼Œè¿”å›False</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">throttle_success</span><span class="p">()</span>  <span class="c1"># æ­£å¸¸è®¿é—®ï¼Œè¿”å›True</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">throttle_success</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># å°†æœ¬æ¬¡è¯·æ±‚äº‹ä»¶åŠ å…¥å†å²è®¿é—®è®°å½•ä¸­</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">now</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">duration</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">throttle_failure</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">wait</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">remaining_duration</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">duration</span> <span class="o">-</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">now</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>  <span class="c1"># è¿˜éœ€è¦ç­‰å¾…çš„æ—¶é—´</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">remaining_duration</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">duration</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">available_requests</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_requests</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">available_requests</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">remaining_duration</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">available_requests</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">MyThrottle</span><span class="p">(</span><span class="n">SimpleRateThrottle</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">scope</span> <span class="o">=</span> <span class="s2">&#34;XXX&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">THROTTLE_RATES</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&#34;XXX&#34;</span><span class="p">:</span> <span class="s2">&#34;5/m&#34;</span><span class="p">}</span>  <span class="c1"># é™åˆ¶é¢‘ç‡</span>
</span></span><span class="line"><span class="cl">    <span class="n">cache</span> <span class="o">=</span> <span class="n">default_cache</span>  <span class="c1"># redisé…ç½®</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># è·å–å”¯ä¸€æ ‡è¯†ï¼Œåç»­å¯ä»¥è¿æ¥redisåšæ“ä½œ</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get_cache_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">view</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">ident</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">pk</span>  <span class="c1"># ç”¨æˆ·ID</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">ident</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ident</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>  <span class="c1"># è·å–è¯·æ±‚ç”¨æˆ·IPï¼ˆå»requestä¸­æ‰¾è¯·æ±‚å¤´ï¼‰</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># cache_format = &#39;throttle_%(scope)s_%(ident)s&#39;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_format</span> <span class="o">%</span> <span class="p">{</span><span class="s1">&#39;scope&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="p">,</span> <span class="s1">&#39;ident&#39;</span><span class="p">:</span> <span class="n">ident</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">APIView</span><span class="p">(</span><span class="n">View</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">throttle_classes</span> <span class="o">=</span> <span class="n">api_settings</span><span class="o">.</span><span class="n">DEFAULT_THROTTLE_CLASSES</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get_throttles</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># åˆ›å»ºé™æµç±»å®ä¾‹å¯¹è±¡ï¼Œè¿”å›é™æµç±»å¯¹è±¡åˆ—è¡¨ï¼Œå±€éƒ¨é…ç½®ä¼˜å…ˆäºå…¨å±€</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">[</span><span class="n">throttle</span><span class="p">()</span> <span class="k">for</span> <span class="n">throttle</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">throttle_classes</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">check_throttles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">throttle_durations</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># å¾ªç¯æ¯ä¸ªå¯¹è±¡  -&gt;  allow_requeståˆ°åº•å¦‚ä½•å®ç°çš„</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">throttle</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_throttles</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># è¶…è¿‡é¢‘ç‡é™åˆ¶ï¼Œä¸å…è®¸è®¿é—®</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="ow">not</span> <span class="n">throttle</span><span class="o">.</span><span class="n">allow_request</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># å°†ç­‰å¾…æ—¶é—´æ·»åŠ è¿›åˆ—è¡¨</span>
</span></span><span class="line"><span class="cl">                <span class="n">throttle_durations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">throttle</span><span class="o">.</span><span class="n">wait</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">throttle_durations</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">durations</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">                <span class="n">duration</span> <span class="k">for</span> <span class="n">duration</span> <span class="ow">in</span> <span class="n">throttle_durations</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">duration</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">            <span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># è·å–æœ€å¤§ç­‰å¾…æ—¶é—´</span>
</span></span><span class="line"><span class="cl">            <span class="n">duration</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">durations</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># æŠ›å‡ºå¼‚å¸¸</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">throttled</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">duration</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">throttled</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">wait</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">Throttled</span><span class="p">(</span><span class="n">wait</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">initial</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">perform_authentication</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>  <span class="c1"># è®¤è¯ç»„ä»¶çš„è¿‡ç¨‹ï¼Œå¾ªç¯æ‰§è¡Œæ¯ä¸ªauthenticateæ–¹æ³•ï¼›å¤±è´¥åˆ™æŠ›å‡ºå¼‚å¸¸ä¸å‘ä¸‹æ‰§è¡Œ</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">check_permissions</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>  <span class="c1"># æƒé™çš„æ ¡éªŒ</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">check_throttles</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">dispatch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># å°è£…drfçš„request</span>
</span></span><span class="line"><span class="cl">        <span class="n">request</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">initialize_request</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">request</span> <span class="o">=</span> <span class="n">request</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">headers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_response_headers</span>  <span class="c1"># deprecate?</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">initial</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># åå°„è·å–get/postç­‰æ–¹æ³•</span>
</span></span><span class="line"><span class="cl">            <span class="n">handler</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">http_method_not_allowed</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># æ‰§è¡Œç›¸åº”æ–¹æ³•</span>
</span></span><span class="line"><span class="cl">            <span class="n">response</span> <span class="o">=</span> <span class="n">handler</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># å¼‚å¸¸å¤„ç†</span>
</span></span><span class="line"><span class="cl">        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_exception</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">finalize_response</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">MyThrottle</span><span class="p">(</span><span class="n">SimpleRateThrottle</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">scope</span> <span class="o">=</span> <span class="s2">&#34;XXX&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">THROTTLE_RATES</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&#34;XXX&#34;</span><span class="p">:</span> <span class="s2">&#34;5/m&#34;</span><span class="p">}</span>  <span class="c1"># é™åˆ¶é¢‘ç‡</span>
</span></span><span class="line"><span class="cl">    <span class="n">cache</span> <span class="o">=</span> <span class="n">default_cache</span>  <span class="c1"># redisé…ç½®</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># è·å–å”¯ä¸€æ ‡è¯†ï¼Œåç»­å¯ä»¥è¿æ¥redisåšæ“ä½œ</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get_cache_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">view</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">ident</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">pk</span>  <span class="c1"># ç”¨æˆ·ID</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">ident</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ident</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>  <span class="c1"># è·å–è¯·æ±‚ç”¨æˆ·IPï¼ˆå»requestä¸­æ‰¾è¯·æ±‚å¤´ï¼‰</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># cache_format = &#39;throttle_%(scope)s_%(ident)s&#39;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_format</span> <span class="o">%</span> <span class="p">{</span><span class="s1">&#39;scope&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="p">,</span> <span class="s1">&#39;ident&#39;</span><span class="p">:</span> <span class="n">ident</span><span class="p">}</span>    
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">OrderView</span><span class="p">(</span><span class="n">APIView</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">permission_classes</span> <span class="o">=</span> <span class="p">[</span><span class="n">MyPermission1</span><span class="p">,</span> <span class="n">MyPermission2</span><span class="p">,</span> <span class="n">MyPermission3</span><span class="p">]</span>  <span class="c1"># æƒé™ç»„ä»¶çš„å±€éƒ¨é…ç½®</span>
</span></span><span class="line"><span class="cl">    <span class="n">throttle_classes</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">auth</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s2">&#34;status&#34;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&#34;data&#34;</span><span class="p">:</span> <span class="p">[</span><span class="mi">11</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">33</span><span class="p">,</span> <span class="mi">44</span><span class="p">]})</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="æ¡ˆä¾‹-é™æµçš„åº”ç”¨">æ¡ˆä¾‹-é™æµçš„åº”ç”¨
</h3><p>åœ¨å‰å‡ ä¸ªç»„ä»¶æ¡ˆä¾‹çš„åŸºç¡€ä¸Šå®ç°ï¼Œä¸‹åˆ—éå®Œæ•´ä»£ç ï¼Œä¸»è¦æ˜¯é™æµåŠŸèƒ½çš„å®ç°</p>
<blockquote>
<ul>
<li>æ— éœ€ç™»å½•ï¼Œé™æµ 10/m</li>
<li>ç™»å½•ï¼Œé™æµ 5/m</li>
</ul></blockquote>
<ul>
<li><code>settings.py</code></li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">REST_FRAMEWORK</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;UNAUTHENTICATED_USER&#34;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># æœªç™»å½•æ—¶ï¼Œrequest.user=None</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;UNAUTHENTICATED_TOKEN&#34;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># æœªç™»å½•æ—¶ï¼Œrequest.auth=None</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;DEFAULT_AUTHENTICATION_CLASSES&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;ext.auth.QueryParamsAuthentication&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;ext.auth.HeaderAuthentication&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;ext.auth.NoAuthentication&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;DEFAULT_PERMISSION_CLASSES&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;DEFAULT_THROTTLE_RATES&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;Ip&#34;</span><span class="p">:</span> <span class="s2">&#34;10/m&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;user&#34;</span><span class="p">:</span> <span class="s2">&#34;5/m&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li><code>ext/throttle.py</code></li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">rest_framework.throttling</span> <span class="kn">import</span> <span class="n">SimpleRateThrottle</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">django.core.cache</span> <span class="kn">import</span> <span class="n">cache</span> <span class="k">as</span> <span class="n">default_cache</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">IpThrottle</span><span class="p">(</span><span class="n">SimpleRateThrottle</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">scope</span> <span class="o">=</span> <span class="s2">&#34;Ip&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">cache</span> <span class="o">=</span> <span class="n">default_cache</span>  <span class="c1"># redisé…ç½®</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># ç¡®å®šæ˜¯åŒ¿åçš„ï¼Œå› æ­¤ç›´æ¥è·å–ipåšæ ‡è¯†å³å¯</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get_cache_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">view</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">ident</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ident</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>  <span class="c1"># è·å–è¯·æ±‚ç”¨æˆ·IPï¼ˆå»requestä¸­æ‰¾è¯·æ±‚å¤´ï¼‰</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># cache_format = &#39;throttle_%(scope)s_%(ident)s&#39;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_format</span> <span class="o">%</span> <span class="p">{</span><span class="s1">&#39;scope&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="p">,</span> <span class="s1">&#39;ident&#39;</span><span class="p">:</span> <span class="n">ident</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">UserThrottle</span><span class="p">(</span><span class="n">SimpleRateThrottle</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">scope</span> <span class="o">=</span> <span class="s2">&#34;user&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">cache</span> <span class="o">=</span> <span class="n">default_cache</span>  <span class="c1"># redisé…ç½®</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get_cache_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">view</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">ident</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">pk</span>  <span class="c1"># ç”¨æˆ·ID</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_format</span> <span class="o">%</span> <span class="p">{</span><span class="s1">&#39;scope&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="p">,</span> <span class="s1">&#39;ident&#39;</span><span class="p">:</span> <span class="n">ident</span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li><code>api/views.py</code></li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">LoginView</span><span class="p">(</span><span class="n">APIView</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">authentication_classes</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">    <span class="n">throttle_classes</span> <span class="o">=</span> <span class="p">[</span><span class="n">IpThrottle</span><span class="p">,</span> <span class="p">]</span>
</span></span><span class="line"><span class="cl">	<span class="o">...</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">AvatarView</span><span class="p">(</span><span class="n">NbApiView</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># æ€»ç›‘ã€å‘˜å·¥å¯ä»¥è®¿é—®</span>
</span></span><span class="line"><span class="cl">    <span class="n">permission_classes</span> <span class="o">=</span> <span class="p">[</span><span class="n">BossPermission</span><span class="p">,</span> <span class="n">UserPermission</span><span class="p">,</span> <span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">throttle_classes</span> <span class="o">=</span> <span class="p">[</span><span class="n">UserThrottle</span><span class="p">,</span> <span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="æ€»ç»“-2">æ€»ç»“
</h3><p>å…¨å±€é…ç½®é™æµé¢‘ç‡<code>settings.py</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">REST_FRAMEWORK</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;UNAUTHENTICATED_USER&#34;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># æœªç™»å½•æ—¶ï¼Œrequest.user=None</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;UNAUTHENTICATED_TOKEN&#34;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># æœªç™»å½•æ—¶ï¼Œrequest.auth=None</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;DEFAULT_AUTHENTICATION_CLASSES&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;ext.auth.QueryParamsAuthentication&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;ext.auth.HeaderAuthentication&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;ext.auth.NoAuthentication&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;DEFAULT_PERMISSION_CLASSES&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;ext.per.Mypermission&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;DEFAULT_THROTTLE_RATES&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;Ip&#34;</span><span class="p">:</span> <span class="s2">&#34;10/m&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;user&#34;</span><span class="p">:</span> <span class="s2">&#34;5/m&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>é™æµç»„ä»¶çš„å®šä¹‰<code>ext/throttle.py</code>ï¼Œå±€éƒ¨é…ç½®å¯è¦†ç›–å…¨å±€å®šä¹‰çš„é¢‘ç‡</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">rest_framework.throttling</span> <span class="kn">import</span> <span class="n">SimpleRateThrottle</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">django.core.cache</span> <span class="kn">import</span> <span class="n">cache</span> <span class="k">as</span> <span class="n">default_cache</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">IpThrottle</span><span class="p">(</span><span class="n">SimpleRateThrottle</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># å±€éƒ¨é…ç½®</span>
</span></span><span class="line"><span class="cl">    <span class="n">scope</span> <span class="o">=</span> <span class="s2">&#34;Ip&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">THROTTLE_RATES</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&#34;Ip&#34;</span><span class="p">:</span> <span class="s2">&#34;5/m&#34;</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">cache</span> <span class="o">=</span> <span class="n">default_cache</span>  <span class="c1"># redisé…ç½®</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># ç¡®å®šæ˜¯åŒ¿åçš„ï¼Œå› æ­¤ç›´æ¥è·å–ipåšæ ‡è¯†å³å¯</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get_cache_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">view</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">ident</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ident</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>  <span class="c1"># è·å–è¯·æ±‚ç”¨æˆ·IPï¼ˆå»requestä¸­æ‰¾è¯·æ±‚å¤´ï¼‰</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># cache_format = &#39;throttle_%(scope)s_%(ident)s&#39;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_format</span> <span class="o">%</span> <span class="p">{</span><span class="s1">&#39;scope&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="p">,</span> <span class="s1">&#39;ident&#39;</span><span class="p">:</span> <span class="n">ident</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">UserThrottle</span><span class="p">(</span><span class="n">SimpleRateThrottle</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># é‡‡ç”¨å…¨å±€</span>
</span></span><span class="line"><span class="cl">    <span class="n">scope</span> <span class="o">=</span> <span class="s2">&#34;user&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">cache</span> <span class="o">=</span> <span class="n">default_cache</span>  <span class="c1"># redisé…ç½®</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get_cache_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">view</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">ident</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">pk</span>  <span class="c1"># ç”¨æˆ·ID</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_format</span> <span class="o">%</span> <span class="p">{</span><span class="s1">&#39;scope&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="p">,</span> <span class="s1">&#39;ident&#39;</span><span class="p">:</span> <span class="n">ident</span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>è§†å›¾å‡½æ•°åº”ç”¨é™æµç±»</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">ext.throttle</span> <span class="kn">import</span> <span class="n">MyThrottle</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">LoginView</span><span class="p">(</span><span class="n">APIView</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">throttle_classes</span> <span class="o">=</span> <span class="p">[</span><span class="n">MyThrottle</span><span class="p">,</span> <span class="p">]</span>
</span></span><span class="line"><span class="cl">	<span class="o">...</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="ç‰ˆæœ¬">ç‰ˆæœ¬
</h2><blockquote>
<p>APIç‰ˆæœ¬æ§åˆ¶æ˜¯ä¸€ä¸ªå…³é”®çš„å®è·µï¼Œå®ƒæœ‰åŠ©äºç¡®ä¿APIçš„ç¨³å®šæ€§ã€å¯é æ€§å’Œå…¼å®¹æ€§ï¼ŒåŒæ—¶ä¸ºAPIçš„é•¿æœŸç»´æŠ¤å’Œæ¼”è¿›æä¾›æ”¯æŒã€‚é€šè¿‡åœ¨è¯·æ±‚ä¸­æºå¸¦ç‰ˆæœ¬å·ï¼Œå¼€å‘è€…å¯ä»¥æ›´å¥½åœ°ç®¡ç†APIçš„ä¸åŒç‰ˆæœ¬ï¼Œå¹¶ç¡®ä¿å¯¹å®¢æˆ·ç«¯çš„å½±å“æœ€å°åŒ–</p></blockquote>
<h3 id="getå‚æ•°ä¼ é€’">GETå‚æ•°ä¼ é€’
</h3><blockquote>
<p>é…ç½®æ–‡ä»¶ä¸­çš„<code>VERSION_PARAM</code>å†³å®šå“ªä¸ªå‚æ•°è¡¨ç¤ºç‰ˆæœ¬ä¿¡æ¯</p>
<p>å‚æ•°æºå¸¦çš„ç‰ˆæœ¬ä¿¡æ¯ä¼šè¢«å°è£…åˆ°<code>request.version</code></p></blockquote>
<p><img src="/post/python/DRF/image-20241219203724421.png"
	
	
	
	loading="lazy"
	
		alt="image-20241219203724421"
	
	
></p>
<ul>
<li><code>settings.py</code></li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">REST_FRAMEWORK</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># æºå¸¦ç‰ˆæœ¬ä¿¡æ¯çš„è¯·æ±‚å‚æ•°å</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;VERSION_PARAM&#39;</span><span class="p">:</span> <span class="s1">&#39;version&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># æœªä¼ å…¥ç‰ˆæœ¬å‚æ•°æ—¶çš„é»˜è®¤ç‰ˆæœ¬</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;DEFAULT_VERSION&#39;</span><span class="p">:</span> <span class="s2">&#34;v1&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># ç‰ˆæœ¬èŒƒå›´åˆ—è¡¨</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;ALLOWED_VERSIONS&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&#34;v1&#34;</span><span class="p">,</span> <span class="s2">&#34;v2&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># é»˜è®¤ç‰ˆæœ¬ç±»</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;DEFAULT_VERSIONING_CLASS&#39;</span><span class="p">:</span> <span class="s1">&#39;rest_framework.versioning.QueryParameterVersioning&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="åå‘ç”Ÿæˆurl">åå‘ç”ŸæˆURL
</h3><blockquote>
<p>ä¸djangoä¸­çš„åå‘ç”ŸæˆURLä¸åŒï¼Œdrfåå‘ç”Ÿæˆçš„URLå¯ä»¥æºå¸¦ç›¸å…³ç‰ˆæœ¬ä¿¡æ¯</p></blockquote>
<p><img src="/post/python/DRF/image-20241220092026291.png"
	
	
	
	loading="lazy"
	
		alt="image-20241220092026291"
	
	
></p>
<p>GETè¯·æ±‚æºå¸¦çš„å…¶ä»–å‚æ•°ä¸ä¼šè‡ªåŠ¨ç”Ÿæˆ</p>
<h3 id="æºç è§£è¯»">æºç è§£è¯»
</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">1 å…¥å£åœ¨APIViewç±»çš„initial()æ–¹æ³•ï¼Œè°ƒç”¨determine_versionæ–¹æ³•ï¼Œå°†ç‰ˆæœ¬ä¿¡æ¯å’Œç‰ˆæœ¬ç±»å°è£…åˆ°requestä¸­versionï¼Œversioning_scheme
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">2 determine_versionæ–¹æ³•ï¼Œå¦‚æœæ²¡æœ‰å®šä¹‰ç‰ˆæœ¬ç±»ï¼Œè¿”å›(None, None)ï¼Œå®šä¹‰äº†ç‰ˆæœ¬ç±»ï¼Œå°†å…¶å®ä¾‹åŒ–èµ‹å€¼ç»™versioning_schemeï¼Œè°ƒç”¨schemeçš„determine_versionï¼Œè¿”å›ç»“æœèµ‹å€¼versionã€‚
</span></span><span class="line"><span class="cl">	2.1 ç‰ˆæœ¬ç±»å®ä¾‹åŒ–æ—¶ï¼Œç»§æ‰¿çˆ¶ç±»ï¼Œè¯»å–å…¨å±€é…ç½®default_versionï¼Œallowed_versionsï¼Œversion_paramï¼Œå®ä¾‹åŒ–åèµ‹å€¼ç»™versioning_scheme
</span></span><span class="line"><span class="cl">	2.2 è°ƒç”¨schemeçš„determine_versionï¼Œä»è¯·æ±‚å‚æ•°ä¸­è¯»å–ç‰ˆæœ¬ä¿¡æ¯versionï¼Œå¹¶ä¸”è°ƒç”¨is_allowed_versionæ–¹æ³•ï¼Œåˆ¤æ–­versionå€¼æ˜¯å¦åˆæ³•ï¼šallowed_versionsä¸ºç©ºæˆ–versionæ˜¯é»˜è®¤å€¼æˆ–åœ¨allowed_versionsèŒƒå›´å†…ï¼Œåˆæ³•ï¼šè¿”å›ç»™version
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">å½“è§†å›¾å‡½æ•°ä¸­è¦åå‘ç”Ÿæˆurlæ—¶ï¼Œrequest.versioning_scheme.reverse(&#34;hm&#34;,request=request)
</span></span><span class="line"><span class="cl">1 è°ƒç”¨ç‰ˆæœ¬ç±»çš„reverseæ–¹æ³•ï¼Œå¹¶ä¼ å…¥è·¯ç”±çš„åˆ«å
</span></span><span class="line"><span class="cl">	1.1 è°ƒç”¨çˆ¶ç±»çš„reverseï¼Œä¼ å…¥è·¯ç”±åˆ«åï¼Œåå‘ç”Ÿæˆurlï¼ˆå°±æ˜¯djangoä¸­çš„ï¼‰
</span></span><span class="line"><span class="cl">	1.2 è°ƒç”¨replace_query_paramï¼Œé€šè¿‡query_dictå’Œurlencodeå°†ç‰ˆæœ¬ä¿¡æ¯æ’å…¥åˆ°urlä¸­
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">BaseVersioning</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">default_version</span> <span class="o">=</span> <span class="n">api_settings</span><span class="o">.</span><span class="n">DEFAULT_VERSION</span>
</span></span><span class="line"><span class="cl">    <span class="n">allowed_versions</span> <span class="o">=</span> <span class="n">api_settings</span><span class="o">.</span><span class="n">ALLOWED_VERSIONS</span>
</span></span><span class="line"><span class="cl">    <span class="n">version_param</span> <span class="o">=</span> <span class="n">api_settings</span><span class="o">.</span><span class="n">VERSION_PARAM</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">determine_version</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{cls}</span><span class="s1">.determine_version() must be implemented.&#39;</span>
</span></span><span class="line"><span class="cl">        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="bp">cls</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
</span></span><span class="line"><span class="cl">        <span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">reverse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">viewname</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">request</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">extra</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">_reverse</span><span class="p">(</span><span class="n">viewname</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="nb">format</span><span class="p">,</span> <span class="o">**</span><span class="n">extra</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">is_allowed_version</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">version</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># åˆ—è¡¨ä¸ºç©º -&gt; æ‰€æœ‰ç‰ˆæœ¬å‡å¯</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">allowed_versions</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># versionæ˜¯é»˜è®¤å€¼æˆ–è€…åœ¨allowed_versionsåˆ—è¡¨èŒƒå›´å†…</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">((</span><span class="n">version</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">version</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_version</span><span class="p">)</span> <span class="ow">or</span>
</span></span><span class="line"><span class="cl">                <span class="p">(</span><span class="n">version</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">allowed_versions</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">QueryParameterVersioning</span><span class="p">(</span><span class="n">BaseVersioning</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    GET /something/?version=0.1 HTTP/1.1
</span></span></span><span class="line"><span class="cl"><span class="s2">    Host: example.com
</span></span></span><span class="line"><span class="cl"><span class="s2">    Accept: application/json
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">invalid_version_message</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;Invalid version in query parameter.&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">determine_version</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># å»è¯·æ±‚å‚æ•°ä¸­è·å–é”®ä¸ºversion_paramçš„å€¼å³ä¸ºç‰ˆæœ¬ï¼Œè‹¥ä¸å­˜åœ¨åˆ™è¯»å–settings.pyä¸­çš„é»˜è®¤å€¼</span>
</span></span><span class="line"><span class="cl">        <span class="n">version</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">query_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">version_param</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_version</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_allowed_version</span><span class="p">(</span><span class="n">version</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">NotFound</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">invalid_version_message</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">version</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># ä¼ å…¥è§†å›¾åç§°å’Œrequest</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">reverse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">viewname</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">request</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">extra</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># æœ¬è´¨ä¸Šå°±æ˜¯è°ƒç”¨djangoçš„reverseåå‘ç”ŸæˆURL</span>
</span></span><span class="line"><span class="cl">        <span class="n">url</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">reverse</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">viewname</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="nb">format</span><span class="p">,</span> <span class="o">**</span><span class="n">extra</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># å°†ç‰ˆæœ¬ä¿¡æ¯æ·»åŠ æˆ–æ›¿æ¢è¿›å»</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">version</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">replace_query_param</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">version_param</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">version</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">url</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">replace_query_param</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="n">scheme</span><span class="p">,</span> <span class="n">netloc</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">fragment</span><span class="p">)</span> <span class="o">=</span> <span class="n">parse</span><span class="o">.</span><span class="n">urlsplit</span><span class="p">(</span><span class="n">force_str</span><span class="p">(</span><span class="n">url</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">query_dict</span> <span class="o">=</span> <span class="n">parse</span><span class="o">.</span><span class="n">parse_qs</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">keep_blank_values</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">query_dict</span><span class="p">[</span><span class="n">force_str</span><span class="p">(</span><span class="n">key</span><span class="p">)]</span> <span class="o">=</span> <span class="p">[</span><span class="n">force_str</span><span class="p">(</span><span class="n">val</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">    <span class="n">query</span> <span class="o">=</span> <span class="n">parse</span><span class="o">.</span><span class="n">urlencode</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">query_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()),</span> <span class="n">doseq</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">parse</span><span class="o">.</span><span class="n">urlunsplit</span><span class="p">((</span><span class="n">scheme</span><span class="p">,</span> <span class="n">netloc</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">fragment</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">APIView</span><span class="p">(</span><span class="n">View</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">versioning_class</span> <span class="o">=</span> <span class="n">api_settings</span><span class="o">.</span><span class="n">DEFAULT_VERSIONING_CLASS</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">determine_version</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">versioning_class</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># å®ä¾‹åŒ–ç±»å¯¹è±¡ï¼Œå³QueryParameterVersioning(),ï¼Œæ¬¸æœ‰__init__æ–¹æ³•</span>
</span></span><span class="line"><span class="cl">        <span class="n">scheme</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">versioning_class</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># è¿”å›ç‰ˆæœ¬ä¿¡æ¯ä¸ç‰ˆæœ¬ç±»å¯¹è±¡</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">(</span><span class="n">scheme</span><span class="o">.</span><span class="n">determine_version</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">),</span> <span class="n">scheme</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">initial</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># å°†ç‰ˆæœ¬ä¿¡æ¯ä¸ç‰ˆæœ¬ç±»å°è£…åˆ°requestä¸­</span>
</span></span><span class="line"><span class="cl">        <span class="n">version</span><span class="p">,</span> <span class="n">scheme</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">determine_version</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">request</span><span class="o">.</span><span class="n">version</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">versioning_scheme</span> <span class="o">=</span> <span class="n">version</span><span class="p">,</span> <span class="n">scheme</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># Ensure that the incoming request is permitted</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">perform_authentication</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">check_permissions</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">check_throttles</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">dispatch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="n">args</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span> <span class="o">=</span> <span class="n">kwargs</span>
</span></span><span class="line"><span class="cl">        <span class="n">request</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">initialize_request</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">request</span> <span class="o">=</span> <span class="n">request</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">headers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_response_headers</span>  <span class="c1"># deprecate?</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">initial</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">handler</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">http_method_not_allowed</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">response</span> <span class="o">=</span> <span class="n">handler</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_exception</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">finalize_response</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">HomeView</span><span class="p">(</span><span class="n">APIView</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># é…ç½®æ–‡ä»¶ VERSION_PARAM</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># http://127.0.0.1:8000/home/?xx=123&amp;page=44&amp;vertion=v1     -&gt;    request.version</span>
</span></span><span class="line"><span class="cl">    <span class="n">versioning_class</span> <span class="o">=</span> <span class="n">QueryParameterVersioning</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">version</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="s2">&#34;...&#34;</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="urlè·¯å¾„ä¼ é€’">URLè·¯å¾„ä¼ é€’
</h3><blockquote>
<p>urls.pyä¸­pathå’Œre_pathä¸¤ç§æ–¹å¼å‡å¯</p></blockquote>
<p><img src="/post/python/DRF/image-20241220114016697.png"
	
	
	
	loading="lazy"
	
		alt="image-20241220114016697"
	
	
></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># æºç </span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">URLPathVersioning</span><span class="p">(</span><span class="n">BaseVersioning</span><span class="p">):</span>    
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">determine_version</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">version</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">version_param</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_version</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">version</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">version</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_version</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_allowed_version</span><span class="p">(</span><span class="n">version</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">NotFound</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">invalid_version_message</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">version</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>ä»<code>kwargs</code>ä¸­è¯»å–ç‰ˆæœ¬ï¼Œå› æ­¤è§†å›¾å‡½æ•°è¦ç”¨<code>*args</code>å’Œ<code>**kwargs</code>æ¥æ”¶ï¼Œå…¶ä»–æºç é€»è¾‘ä¸GETå‚æ•°ä¼ é€’åŸºæœ¬ç›¸åŒ</p>
<p>URLå‚æ•°ä¼ é€’ä¸éœ€è¦<code>*args</code>å’Œ<code>**kwargs</code>æ¥æ”¶æ˜¯å› ä¸ºä¼ å‚å¯ä»¥ä»requestä¸­å¯ä»¥å–å‡º</p></blockquote>
<h3 id="acceptè¯·æ±‚å¤´ä¼ é€’">Acceptè¯·æ±‚å¤´ä¼ é€’
</h3><blockquote>
<p>åå‘ç”Ÿæˆçš„URLä¸å«ç‰ˆæœ¬ï¼Œå› ä¸ºä»–æœ¬æ¥å°±ä¸å‡ºç°åœ¨urlä¸­</p></blockquote>
<p><img src="/post/python/DRF/image-20241220121052593.png"
	
	
	
	loading="lazy"
	
		alt="image-20241220121052593"
	
	
></p>
<p><strong>å‚è€ƒä»£ç </strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># urls.py</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">django.urls</span> <span class="kn">import</span> <span class="n">path</span><span class="p">,</span> <span class="n">re_path</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">api</span> <span class="kn">import</span> <span class="n">views</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># path(&#39;admin/&#39;, admin.site.urls),</span>
</span></span><span class="line"><span class="cl">    <span class="n">path</span><span class="p">(</span><span class="s1">&#39;home/&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">HomeView</span><span class="o">.</span><span class="n">as_view</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;hm&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># path(&#39;api/&lt;str:version&gt;/home/&#39;, views.HomeView.as_view(), name=&#39;hm&#39;),</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># re_path(r&#39;^api/(?P&lt;version&gt;\w+)/home/$&#39;, views.HomeView.as_view(), name=&#39;hm&#39;),</span>
</span></span><span class="line"><span class="cl"><span class="p">]</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># views.py</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">rest_framework.views</span> <span class="kn">import</span> <span class="n">APIView</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">rest_framework.response</span> <span class="kn">import</span> <span class="n">Response</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">rest_framework.versioning</span> <span class="kn">import</span> <span class="n">QueryParameterVersioning</span><span class="p">,</span> <span class="n">URLPathVersioning</span><span class="p">,</span> <span class="n">AcceptHeaderVersioning</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Create your views here.</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">HomeView</span><span class="p">(</span><span class="n">APIView</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># é…ç½®æ–‡ä»¶ VERSION_PARAM</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># http://127.0.0.1:8000/home/?xx=123&amp;page=44&amp;vertion=v1     -&gt;    request.version</span>
</span></span><span class="line"><span class="cl">    <span class="n">versioning_class</span> <span class="o">=</span> <span class="n">AcceptHeaderVersioning</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">version</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">versioning_scheme</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">url</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">versioning_scheme</span><span class="o">.</span><span class="n">reverse</span><span class="p">(</span><span class="s1">&#39;hm&#39;</span><span class="p">,</span> <span class="n">request</span><span class="o">=</span><span class="n">request</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;åå‘ç”Ÿæˆçš„url:&#34;</span><span class="p">,</span> <span class="n">url</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="s2">&#34;...&#34;</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="æ€»ç»“-3">æ€»ç»“
</h3><blockquote>
<p>åç»­å¼€å‘æ—¶ï¼Œä¸€èˆ¬éƒ½é‡‡ç”¨URLè·¯å¾„ä¼ é€’çš„å½¢å¼ï¼Œä¸‹åˆ—ç»™å‡ºå¼€å‘ç¤ºä¾‹</p></blockquote>
<ul>
<li><code>settings.pyè¿›è¡Œå…¨å±€é…ç½®</code></li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">REST_FRAMEWORK</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;UNAUTHENTICATED_USER&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;VERSION_PARAM&#39;</span><span class="p">:</span> <span class="s1">&#39;version&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;DEFAULT_VERSION&#39;</span><span class="p">:</span> <span class="s2">&#34;v1&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;ALLOWED_VERSIONS&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&#34;v1&#34;</span><span class="p">,</span> <span class="s2">&#34;v2&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># å…¨å±€é…ç½®</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;DEFAULT_VERSIONING_CLASS&#39;</span><span class="p">:</span> <span class="s1">&#39;rest_framework.versioning.URLPathVersioning&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li><code>views.py</code></li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">rest_framework.views</span> <span class="kn">import</span> <span class="n">APIView</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">rest_framework.response</span> <span class="kn">import</span> <span class="n">Response</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">rest_framework.versioning</span> <span class="kn">import</span> <span class="n">QueryParameterVersioning</span><span class="p">,</span> <span class="n">URLPathVersioning</span><span class="p">,</span> <span class="n">AcceptHeaderVersioning</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">HomeView</span><span class="p">(</span><span class="n">APIView</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># å±€éƒ¨é…ç½®</span>
</span></span><span class="line"><span class="cl">    <span class="n">versioning_class</span> <span class="o">=</span> <span class="n">URLPathVersioning</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">version</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">versioning_scheme</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># åå‘ç”Ÿæˆurl</span>
</span></span><span class="line"><span class="cl">        <span class="n">url</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">versioning_scheme</span><span class="o">.</span><span class="n">reverse</span><span class="p">(</span><span class="s1">&#39;hm&#39;</span><span class="p">,</span> <span class="n">request</span><span class="o">=</span><span class="n">request</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;åå‘ç”Ÿæˆçš„url:&#34;</span><span class="p">,</span> <span class="n">url</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="s2">&#34;...&#34;</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li><code>urls.py</code></li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">django.urls</span> <span class="kn">import</span> <span class="n">path</span><span class="p">,</span> <span class="n">re_path</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">api</span> <span class="kn">import</span> <span class="n">views</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="n">path</span><span class="p">(</span><span class="s1">&#39;api/&lt;str:version&gt;/home/&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">HomeView</span><span class="o">.</span><span class="n">as_view</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;hm&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl"><span class="p">]</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="è§£æå™¨">è§£æå™¨
</h2><p>åœ¨ <code>Django REST Frameworkï¼ˆDRFï¼‰</code>ä¸­ï¼Œè§£æå™¨ï¼ˆParserï¼‰æ˜¯ç”¨äºå¤„ç†ä¼ å…¥è¯·æ±‚æ•°æ®çš„ç»„ä»¶ã€‚è§£æå™¨è´Ÿè´£å°†åŸå§‹è¯·æ±‚æ•°æ®<code>request.body</code>ï¼ˆå¦‚ JSONã€è¡¨å•æ•°æ®ã€XML ç­‰ï¼‰è§£ææˆ Python æ•°æ®ç»“æ„ï¼Œä½¿å¾—è§†å›¾å‡½æ•°å¯ä»¥æ–¹ä¾¿åœ°è®¿é—®å’Œæ“ä½œè¯·æ±‚æ•°æ®ï¼Œè®©åºåˆ—åŒ–å™¨å¯ä»¥è¿›ä¸€æ­¥å¤„ç†è¿™äº›æ•°æ®</p>
<h3 id="æµç¨‹æ¦‚è¿°">æµç¨‹æ¦‚è¿°
</h3><p>è§£æå™¨ä¸€èˆ¬ç”¨äºè§£æPOSTè¯·æ±‚è¯·æ±‚ä½“ä¸­çš„æ•°æ®ï¼Œä¸å†…å®¹åå•†æœºåˆ¶ï¼ˆContent Negotiationï¼‰é…åˆï¼Œ<code>content-type</code>ä¸åŒï¼Œå®¢æˆ·ç«¯ä¼ é€’æ¥çš„æ•°æ®æ ¼å¼ä¹Ÿä¸åŒï¼Œæ ¹æ®å®¢æˆ·ç«¯çš„ <code>Content-Type</code> å¤´éƒ¨é€‰æ‹©åˆé€‚çš„è§£æå™¨æ¥è§£æè¯·æ±‚ä½“</p>
<p>å¤§ä½“çš„æµç¨‹ä¸ºï¼š</p>
<ol>
<li>è¯»å–è¯·æ±‚å¤´</li>
<li>æ ¹æ®è¯·æ±‚å¤´è§£ææ•°æ®
<ul>
<li>æ ¹æ®è¯·æ±‚å¤´è·å–è§£æå™¨ -&gt; å¦‚JSONè§£æå™¨</li>
<li>request.data = JSONè§£æå™¨.parse</li>
</ul>
</li>
<li>request.dataè·å–å¤„ç†åçš„æ•°æ®</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Form</span> <span class="n">è§£æå™¨</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">content</span><span class="o">-</span><span class="nb">type</span><span class="p">:</span><span class="s2">&#34;urlencode&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">JSON</span> <span class="n">è§£æå™¨</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">content</span><span class="o">-</span><span class="nb">type</span><span class="p">:</span><span class="s2">&#34;application/json&#34;</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">parse</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    	<span class="o">...</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl"><span class="n">è¯·æ±‚è€…</span><span class="err">ï¼š</span>
</span></span><span class="line"><span class="cl">	<span class="n">GET</span>
</span></span><span class="line"><span class="cl">    	<span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">127.0.0.1</span><span class="p">:</span><span class="mi">8000</span><span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="err">?</span><span class="n">xxx</span><span class="o">=</span><span class="mi">123</span><span class="o">&amp;</span><span class="n">abc</span><span class="o">=</span><span class="n">xxx</span>   <span class="o">--&gt;</span>  <span class="n">request</span><span class="o">.</span><span class="n">query_params</span>
</span></span><span class="line"><span class="cl">        <span class="n">è¯·æ±‚å¤´</span>
</span></span><span class="line"><span class="cl">    <span class="n">POST</span>
</span></span><span class="line"><span class="cl">    	<span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">127.0.0.1</span><span class="p">:</span><span class="mi">8000</span><span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">home</span><span class="o">/</span>
</span></span><span class="line"><span class="cl">        <span class="n">è¯·æ±‚å¤´</span>
</span></span><span class="line"><span class="cl">        	<span class="n">content</span><span class="o">-</span><span class="nb">type</span><span class="p">:</span><span class="s2">&#34;urlencode...&#34;</span>
</span></span><span class="line"><span class="cl">    		<span class="n">content</span><span class="o">-</span><span class="nb">type</span><span class="p">:</span><span class="s2">&#34;application/json&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">è¯·æ±‚ä½“</span>
</span></span><span class="line"><span class="cl">        	<span class="n">name</span><span class="o">=</span><span class="n">zhangs</span><span class="o">&amp;</span><span class="n">age</span><span class="o">=</span><span class="mi">18</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;zhangs&#34;</span><span class="p">,</span><span class="s2">&#34;age&#34;</span><span class="p">:</span><span class="mi">19</span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="å¸¸è§åº”ç”¨">å¸¸è§åº”ç”¨
</h3><h4 id="jsonparser">JSONParser
</h4><p>è§£æ<code>JSON</code>æ ¼å¼çš„è¯·æ±‚æ•°æ®ï¼ˆ<code>application/json</code>ï¼‰ï¼Œè¿”å›pythonä¸­çš„<code>å­—å…¸</code>ç±»å‹</p>
<p><img src="/post/python/DRF/image-20241221095817376.png"
	
	
	
	loading="lazy"
	
		alt="image-20241221095817376"
	
	
></p>
<h4 id="formparser">FormParser
</h4><p>è§£æ<code>è¡¨å•</code>ï¼ˆ<code>application/x-www-form-urlencoded</code>ï¼‰æ•°æ®ä¸º<code>QueryDictï¼ˆå­—å…¸ï¼‰</code>ç±»å‹æ•°æ®</p>
<p><img src="/post/python/DRF/image-20241221100042471.png"
	
	
	
	loading="lazy"
	
		alt="image-20241221100042471"
	
	
></p>
<h4 id="multipartparser">MultiPartParser
</h4><p>è§£æ<code>å¤šéƒ¨åˆ†è¡¨å•æ•°æ®</code>ï¼ˆ<code>multipart/form-data</code>ï¼‰ï¼Œæ”¯æŒåŒæ—¶è§£ææ–‡ä»¶å’Œè¡¨å•å­—æ®µï¼Œé€šå¸¸ç”¨äºæ–‡ä»¶ä¸Šä¼ </p>
<p><img src="/post/python/DRF/image-20241221100114196.png"
	
	
	
	loading="lazy"
	
		alt="image-20241221100114196"
	
	
></p>
<h4 id="fileuploadparser">FileUploadParser
</h4><p>åªèƒ½å¤„ç†<code>æ–‡ä»¶</code>ä¸Šä¼ è¯·æ±‚<code>application/octet-stream</code></p>
<p><img src="/post/python/DRF/image-20241221100143428.png"
	
	
	
	loading="lazy"
	
		alt="image-20241221100143428"
	
	
></p>
<h3 id="æºç æµç¨‹-2">æºç æµç¨‹
</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="n">dispatch</span><span class="p">()</span><span class="err">çš„æµç¨‹èµ°å®Œä»…ä»…å®ç°</span><span class="n">parsers</span><span class="err">ï¼Œ</span><span class="n">negotiator</span><span class="err">ï¼Œ</span><span class="n">parser_contextç­‰å€¼çš„å°è£…</span><span class="err">ï¼ŒçœŸæ­£çš„è§£æå‘ç”Ÿåœ¨è°ƒç”¨</span><span class="n">request</span><span class="o">.</span><span class="n">dataæ—¶</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="err">åŠ è½½æ—¶è§¦å‘</span><span class="n">dispatch</span><span class="p">()</span><span class="err">æ–¹æ³•ï¼Œè°ƒç”¨</span><span class="n">initialize_request</span>
</span></span><span class="line"><span class="cl">	<span class="err">è°ƒç”¨</span><span class="n">get_parser_contextæ–¹æ³•</span><span class="err">ï¼Œå°†è§†å›¾å¯¹è±¡ï¼Œ</span><span class="n">URLè·¯ç”±å‚æ•°å°è£…æˆå¯¹è±¡èµ‹å€¼ç»™parser_context</span>
</span></span><span class="line"><span class="cl">	<span class="err">è°ƒç”¨</span><span class="n">get_parsers</span><span class="err">ï¼Œå¾ªç¯è§£æå™¨ç±»å¯¹è±¡åˆ—è¡¨</span><span class="n">parser_classesåˆ›å»ºå®ä¾‹åˆ—è¡¨parsers</span>
</span></span><span class="line"><span class="cl">	<span class="err">è°ƒç”¨</span><span class="n">get_content_negotiator</span><span class="err">ï¼Œå°†åå•†å™¨</span><span class="n">content_negotiation_classå®ä¾‹åŒ–åçš„å¯¹è±¡èµ‹å€¼ç»™negotiator</span>
</span></span><span class="line"><span class="cl">	<span class="err">å°†</span><span class="n">parser_context</span><span class="err">ï¼Œ</span><span class="n">parsers</span><span class="err">ï¼Œ</span><span class="n">negotiatorä¸€å¹¶å°è£…è¿›Requestä¸­</span>
</span></span><span class="line"><span class="cl">	<span class="err">åœ¨</span><span class="n">Requestçš„initæ–¹æ³•ä¸­</span><span class="err">ï¼šå¾€</span><span class="n">parser_contextä¸­è¿›ä¸€æ­¥æ·»åŠ äº†requestå’Œencodingæ•°æ®</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl"><span class="n">initialize_requestæ‰§è¡Œå®Œ</span><span class="err">ï¼Œè°ƒç”¨</span><span class="n">initialæ–¹æ³•</span>
</span></span><span class="line"><span class="cl">	<span class="err">è°ƒç”¨</span><span class="n">perform_content_negotiationæ–¹æ³•</span><span class="err">ï¼Œå°†è¢«é€‰æ‹©çš„æ¸²æŸ“å™¨å®ä¾‹èµ‹å€¼ç»™</span><span class="n">accepted_renderer</span><span class="err">ï¼Œå°†å¯¹åº”çš„åª’ä½“ç±»å‹å­—ç¬¦ä¸²èµ‹å€¼ç»™</span><span class="n">accepted_media_type</span>
</span></span><span class="line"><span class="cl">		<span class="err">å¾ªç¯å®ä¾‹åŒ–è·å–æ¸²æŸ“å™¨å®ä¾‹åŒ–å¯¹è±¡åˆ—è¡¨</span><span class="n">renderers</span><span class="err">ï¼Œ</span><span class="n">connegä¸ºåå•†å™¨å¯¹è±¡</span><span class="err">ï¼Œè°ƒç”¨</span><span class="n">connegçš„select_rendereræ–¹æ³•</span><span class="err">ï¼Œæ ¹æ®å®¢æˆ·ç«¯çš„</span> <span class="n">Accept</span> <span class="err">è¯·æ±‚å¤´å’Œæ¸²æŸ“å™¨çš„ä¼˜å…ˆçº§é€‰æ‹©ä¸€ä¸ªåˆé€‚çš„æ¸²æŸ“å™¨</span>
</span></span><span class="line"><span class="cl">		
</span></span><span class="line"><span class="cl"><span class="err">å½“è°ƒç”¨</span><span class="n">request</span><span class="o">.</span><span class="n">dataæ—¶</span><span class="err">ï¼Œæ‰çœŸæ­£åœ°è§£ææ•°æ®</span>
</span></span><span class="line"><span class="cl">	<span class="err">å¦‚æœ</span><span class="n">_full_dataæœ‰å€¼</span><span class="err">ï¼Œç›´æ¥è¿”å›ï¼Œæ— å€¼ï¼Œè°ƒç”¨</span><span class="n">_load_data_and_filesåŠ è½½å€¼</span>
</span></span><span class="line"><span class="cl">	<span class="err">è°ƒç”¨</span><span class="n">_parse</span><span class="err">ï¼Œ</span>
</span></span><span class="line"><span class="cl">		<span class="err">å¾ªç¯è§£æå™¨åˆ—è¡¨</span><span class="n">parsers</span><span class="err">ï¼Œè°ƒç”¨åå•†å™¨çš„</span><span class="n">select_parseræ–¹æ³•</span><span class="err">ï¼Œå°†è¯·æ±‚ä¸­çš„</span><span class="n">content_typeä¸è§£æå™¨å†…éƒ¨çš„media_typeåŒ¹é…</span><span class="err">ï¼Œæ‰¾åˆ°åŒ¹é…çš„è§£æå™¨</span><span class="n">parser</span>
</span></span><span class="line"><span class="cl">		<span class="err">è°ƒç”¨è§£æå™¨çš„</span><span class="n">parseæ–¹æ³•</span><span class="err">ï¼Œå°†æ•°æ®è§£ææˆç›®æ ‡æ ¼å¼ï¼Œèµ‹å€¼ç»™</span><span class="n">parsed</span><span class="err">ï¼Œè¿”å›</span><span class="p">(</span><span class="n">parsed</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">parsed</span><span class="o">.</span><span class="n">files</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="err">ç”¨</span><span class="n">_dataå’Œ_filesæ¥æ”¶è§£æåçš„æ•°æ®</span><span class="err">ï¼Œå¤„ç†æˆå®Œæ•´çš„æ•°æ®èµ‹å€¼ç»™</span><span class="n">_full_data</span><span class="err">ï¼Œä¸‹æ¬¡è°ƒç”¨</span><span class="n">request</span><span class="o">.</span><span class="n">dataå¯ä»¥ç›´æ¥è¿”å›</span>
</span></span><span class="line"><span class="cl">	
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">DefaultContentNegotiation</span><span class="p">(</span><span class="n">BaseContentNegotiation</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># æ ¹æ®è¯·æ±‚å¤´ç±»å‹ä¸è§£æå™¨å†…å®šä¹‰çš„media_typeåŒ¹é…å‡ºå¯¹åº”çš„è§£æå™¨</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">select_parser</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">parsers</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">parser</span> <span class="ow">in</span> <span class="n">parsers</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">media_type_matches</span><span class="p">(</span><span class="n">parser</span><span class="o">.</span><span class="n">media_type</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">content_type</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="n">parser</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">FormParser</span><span class="p">(</span><span class="n">BaseParser</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">media_type</span> <span class="o">=</span> <span class="s1">&#39;application/x-www-form-urlencoded&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stream</span><span class="p">,</span> <span class="n">media_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">parser_context</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">parser_context</span> <span class="o">=</span> <span class="n">parser_context</span> <span class="ow">or</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">        <span class="n">encoding</span> <span class="o">=</span> <span class="n">parser_context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;encoding&#39;</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">DEFAULT_CHARSET</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">QueryDict</span><span class="p">(</span><span class="n">stream</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="n">encoding</span><span class="o">=</span><span class="n">encoding</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">JSONParser</span><span class="p">(</span><span class="n">BaseParser</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">media_type</span> <span class="o">=</span> <span class="s1">&#39;application/json&#39;</span>
</span></span><span class="line"><span class="cl">    <span class="n">renderer_class</span> <span class="o">=</span> <span class="n">renderers</span><span class="o">.</span><span class="n">JSONRenderer</span>
</span></span><span class="line"><span class="cl">    <span class="n">strict</span> <span class="o">=</span> <span class="n">api_settings</span><span class="o">.</span><span class="n">STRICT_JSON</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stream</span><span class="p">,</span> <span class="n">media_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">parser_context</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">parser_context</span> <span class="o">=</span> <span class="n">parser_context</span> <span class="ow">or</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">        <span class="n">encoding</span> <span class="o">=</span> <span class="n">parser_context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;encoding&#39;</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">DEFAULT_CHARSET</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">decoded_stream</span> <span class="o">=</span> <span class="n">codecs</span><span class="o">.</span><span class="n">getreader</span><span class="p">(</span><span class="n">encoding</span><span class="p">)(</span><span class="n">stream</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">parse_constant</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">strict_constant</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">strict</span> <span class="k">else</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">decoded_stream</span><span class="p">,</span> <span class="n">parse_constant</span><span class="o">=</span><span class="n">parse_constant</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">raise</span> <span class="n">ParseError</span><span class="p">(</span><span class="s1">&#39;JSON parse error - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">exc</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Request</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">parsers</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">authenticators</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">negotiator</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">parser_context</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">_request</span> <span class="o">=</span> <span class="n">request</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">parsers</span> <span class="o">=</span> <span class="n">parsers</span> <span class="ow">or</span> <span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">authenticators</span> <span class="o">=</span> <span class="n">authenticators</span> <span class="ow">or</span> <span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">negotiator</span> <span class="o">=</span> <span class="n">negotiator</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default_negotiator</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">parser_context</span> <span class="o">=</span> <span class="n">parser_context</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="n">Empty</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">_files</span> <span class="o">=</span> <span class="n">Empty</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">_full_data</span> <span class="o">=</span> <span class="n">Empty</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">_content_type</span> <span class="o">=</span> <span class="n">Empty</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">_stream</span> <span class="o">=</span> <span class="n">Empty</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser_context</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">parser_context</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">parser_context</span><span class="p">[</span><span class="s1">&#39;request&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">parser_context</span><span class="p">[</span><span class="s1">&#39;encoding&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">encoding</span> <span class="ow">or</span> <span class="n">settings</span><span class="o">.</span><span class="n">DEFAULT_CHARSET</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@property</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">_hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_full_data&#39;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># åŠ è½½å€¼</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">_load_data_and_files</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_full_data</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">_load_data_and_files</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">_hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_data&#39;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_files</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">_full_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">_full_data</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_files</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">_full_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">is_form_media_type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">content_type</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="o">.</span><span class="n">_post</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">POST</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="o">.</span><span class="n">_files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">FILES</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@property</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">content_type</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">meta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="o">.</span><span class="n">META</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">meta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;CONTENT_TYPE&#39;</span><span class="p">,</span> <span class="n">meta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;HTTP_CONTENT_TYPE&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">_parse</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># è·å–è¯·æ±‚å¤´ä¸­çš„content_type</span>
</span></span><span class="line"><span class="cl">        <span class="n">media_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">content_type</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># è¯·æ±‚å‘é€è¿‡æ¥çš„åŸå§‹æ•°æ®</span>
</span></span><span class="line"><span class="cl">        <span class="n">stream</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stream</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># DefaultContentNegotiation.select_parser()</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># å¾ªç¯è§£æå™¨åˆ—è¡¨ï¼Œæ‰¾åˆ°content-typeç¬¦åˆçš„è§£æå™¨å¹¶è¿”å›</span>
</span></span><span class="line"><span class="cl">        <span class="n">parser</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">negotiator</span><span class="o">.</span><span class="n">select_parser</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parsers</span><span class="p">)</span>  <span class="c1"># request [JSONParserm,FormParser]</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># æ‰§è¡Œè§£æå™¨çš„parseæ–¹æ³•</span>
</span></span><span class="line"><span class="cl">        <span class="n">parsed</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="n">media_type</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser_context</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="p">(</span><span class="n">parsed</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">parsed</span><span class="o">.</span><span class="n">files</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">empty_files</span> <span class="o">=</span> <span class="n">MultiValueDict</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="p">(</span><span class="n">parsed</span><span class="p">,</span> <span class="n">empty_files</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">APIView</span><span class="p">(</span><span class="n">View</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">renderer_classes</span> <span class="o">=</span> <span class="n">api_settings</span><span class="o">.</span><span class="n">DEFAULT_RENDERER_CLASSES</span>
</span></span><span class="line"><span class="cl">    <span class="n">parser_classes</span> <span class="o">=</span> <span class="n">api_settings</span><span class="o">.</span><span class="n">DEFAULT_PARSER_CLASSES</span>
</span></span><span class="line"><span class="cl">    <span class="n">content_negotiation_class</span> <span class="o">=</span> <span class="n">api_settings</span><span class="o">.</span><span class="n">DEFAULT_CONTENT_NEGOTIATION_CLASS</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get_parser_context</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">http_request</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;view&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;args&#39;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;args&#39;</span><span class="p">,</span> <span class="p">()),</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;kwargs&#39;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;kwargs&#39;</span><span class="p">,</span> <span class="p">{})</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get_parsers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">[</span><span class="n">parser</span><span class="p">()</span> <span class="k">for</span> <span class="n">parser</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser_classes</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get_content_negotiator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_negotiator&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">_negotiator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">content_negotiation_class</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_negotiator</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">initialize_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># {è§†å›¾å¯¹è±¡ï¼ŒURLè·¯ç”±å‚æ•°}</span>
</span></span><span class="line"><span class="cl">        <span class="n">parser_context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_parser_context</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">Request</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">request</span><span class="p">,</span>  <span class="c1"># djangoçš„request</span>
</span></span><span class="line"><span class="cl">            <span class="n">parsers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_parsers</span><span class="p">(),</span>  <span class="c1"># è§£æå™¨ [JSONParser(),FormParser(),]</span>
</span></span><span class="line"><span class="cl">            <span class="n">authenticators</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_authenticators</span><span class="p">(),</span>  <span class="c1"># è®¤è¯ç»„ä»¶ [è®¤è¯å¯¹è±¡1ï¼Œè®¤è¯å¯¹è±¡2]</span>
</span></span><span class="line"><span class="cl">            <span class="n">negotiator</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_content_negotiator</span><span class="p">(),</span>  <span class="c1"># DefaultContentNegotiation()</span>
</span></span><span class="line"><span class="cl">            <span class="n">parser_context</span><span class="o">=</span><span class="n">parser_context</span>  <span class="c1"># {è§†å›¾å¯¹è±¡ï¼ŒURLè·¯ç”±å‚æ•° + drfçš„request,encoding}</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">dispatch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="n">args</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span> <span class="o">=</span> <span class="n">kwargs</span>
</span></span><span class="line"><span class="cl">        <span class="n">request</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">initialize_request</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">request</span> <span class="o">=</span> <span class="n">request</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">headers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_response_headers</span>  <span class="c1"># deprecate?</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">initial</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">handler</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">http_method_not_allowed</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">response</span> <span class="o">=</span> <span class="n">handler</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_exception</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">finalize_response</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">initial</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">neg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">perform_content_negotiation</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># ç¬¬ä¸€ä¸ªå…ƒç´ æ˜¯è¢«é€‰æ‹©çš„æ¸²æŸ“å™¨å®ä¾‹ï¼Œç¬¬äºŒä¸ªå…ƒç´ æ˜¯å¯¹åº”çš„åª’ä½“ç±»å‹å­—ç¬¦ä¸²</span>
</span></span><span class="line"><span class="cl">        <span class="n">request</span><span class="o">.</span><span class="n">accepted_renderer</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">accepted_media_type</span> <span class="o">=</span> <span class="n">neg</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">version</span><span class="p">,</span> <span class="n">scheme</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">determine_version</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">request</span><span class="o">.</span><span class="n">version</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">versioning_scheme</span> <span class="o">=</span> <span class="n">version</span><span class="p">,</span> <span class="n">scheme</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># Ensure that the incoming request is permitted</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">perform_authentication</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">check_permissions</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">check_throttles</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="c1"># è¯¥æ–¹æ³•è´Ÿè´£æ ¹æ®å®¢æˆ·ç«¯çš„ Accept è¯·æ±‚å¤´æ¥ç¡®å®šå“åº”çš„å†…å®¹ç±»å‹ã€‚è¿™ä¸ªæ–¹æ³•ä¼šæ£€æŸ¥å®¢æˆ·ç«¯æ¥å—å“ªäº›åª’ä½“ç±»å‹ï¼Œå¹¶æ ¹æ®æœåŠ¡å™¨èƒ½å¤Ÿæä¾›çš„åª’ä½“ç±»å‹æ¥é€‰æ‹©ä¸€ä¸ªåˆé€‚çš„æ¸²æŸ“å™¨ï¼ˆRendererï¼‰</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">perform_content_negotiation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">renderers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_renderers</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">conneg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_content_negotiator</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">conneg</span><span class="o">.</span><span class="n">select_renderer</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">renderers</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">format_kwarg</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">force</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="p">(</span><span class="n">renderers</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">renderers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">media_type</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">raise</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get_renderers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">[</span><span class="n">renderer</span><span class="p">()</span> <span class="k">for</span> <span class="n">renderer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">renderer_classes</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get_content_negotiator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_negotiator&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">_negotiator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">content_negotiation_class</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_negotiator</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">HomeView</span><span class="p">(</span><span class="n">APIView</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># æ‰€æœ‰çš„è§£æå™¨</span>
</span></span><span class="line"><span class="cl">    <span class="n">parser_classes</span> <span class="o">=</span> <span class="p">[</span><span class="n">JSONParser</span><span class="p">,</span> <span class="n">FormParser</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># æ ¹æ®è¯·æ±‚ï¼ŒåŒ¹é…å¯¹åº”çš„è§£æå™¨</span>
</span></span><span class="line"><span class="cl">    <span class="n">content_negotiation</span> <span class="o">=</span> <span class="n">DefaultContentNegotiation</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="s2">&#34;è¯·æ±‚æ¥äº†&#34;</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="è§£æå™¨å…¨å±€é…ç½®">è§£æå™¨å…¨å±€é…ç½®
</h3><p>å¦‚å›¾ï¼Œé»˜è®¤è§£æå™¨æœ‰<code>JSONParser,FormParser,MutiPartParser</code>ä¸‰ç§</p>
<p><img src="/post/python/DRF/image-20241221100502285.png"
	
	
	
	loading="lazy"
	
		alt="image-20241221100502285"
	
	
></p>
<p>ä½†ä¸ºäº†é˜²æ­¢ä¸èƒ½ä¸Šä¼ å›¾ç‰‡ç­‰åŠŸèƒ½ç‚¹å› ä¸ºé»˜è®¤è§£æå™¨å¯ä»¥ä¸Šä¼ å›¾ç‰‡ï¼Œå¯¼è‡´<code>request.data</code>çš„ç±»å‹çš„ä¸ç¡®å®šæ€§ï¼Œå»ºè®®å±€éƒ¨é…ç½®</p>
<p>ä¿®æ”¹å…¨å±€é…ç½®</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">REST_FRAMEWORK</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;UNAUTHENTICATED_USER&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;VERSION_PARAM&#39;</span><span class="p">:</span> <span class="s1">&#39;version&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;DEFAULT_VERSION&#39;</span><span class="p">:</span> <span class="s2">&#34;v1&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;ALLOWED_VERSIONS&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&#34;v1&#34;</span><span class="p">,</span> <span class="s2">&#34;v2&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;DEFAULT_VERSIONING_CLASS&#39;</span><span class="p">:</span> <span class="s1">&#39;rest_framework.versioning.QueryParameterVersioning&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;DEFAULT_PARSER_CLASSES&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;rest_framework.parsers.JSONParser&#39;</span><span class="p">,</span> <span class="p">]</span>  <span class="c1"># è®¾ç½®é»˜è®¤è§£æå™¨åªæœ‰JSONParser</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;DEFAULT_RENDERER_CLASSES&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;DEFAULT_CONTENT_NEGOTIATION_CLASS&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>åç»­å¦‚æœæœ‰ä¸Šä¼ å›¾ç‰‡çš„åŠŸèƒ½ç‚¹ï¼Œå†å±€éƒ¨é…ç½®å…¶è§£æå™¨å³å¯</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">parser_classes</span> <span class="o">=</span> <span class="p">[</span><span class="n">MutiPartParser</span><span class="p">,]</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="æ€»ç»“-4">æ€»ç»“
</h3><ul>
<li>è§£æå™¨è´Ÿè´£å°†å®¢æˆ·ç«¯å‘é€çš„è¯·æ±‚ä½“è§£æä¸º Python å¯æ“ä½œçš„æ•°æ®ç»“æ„ã€‚DRF æä¾›äº†å¤šç§é»˜è®¤è§£æå™¨ï¼Œä¾‹å¦‚ <code>JSONParser</code>ï¼Œ<code>FormParser</code> å’Œ <code>MultiPartParser</code></li>
<li>æ¸²æŸ“å™¨è´Ÿè´£å°†å“åº”æ•°æ®è½¬æ¢ä¸ºå®¢æˆ·ç«¯å¯è¯»çš„æ ¼å¼ã€‚DRF æä¾›äº†å¤šç§é»˜è®¤æ¸²æŸ“å™¨ï¼Œä¾‹å¦‚ <code>JSONRenderer</code> å’Œ <code>BrowsableAPIRenderer</code></li>
<li>å†…å®¹åå•†å™¨è´Ÿè´£æ ¹æ®å®¢æˆ·ç«¯çš„ <code>Accept</code> è¯·æ±‚å¤´å’ŒæœåŠ¡å™¨æ”¯æŒçš„æ¸²æŸ“å™¨é€‰æ‹©åˆé€‚çš„æ¸²æŸ“å™¨ã€‚DRF é»˜è®¤ä½¿ç”¨ <code>DefaultContentNegotiation</code></li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">REST_FRAMEWORK</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;DEFAULT_PARSER_CLASSES&#39;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;rest_framework.parsers.JSONParser&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;rest_framework.parsers.FormParser&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;rest_framework.parsers.MultiPartParser&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;DEFAULT_RENDERER_CLASSES&#39;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;rest_framework.renderers.JSONRenderer&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;rest_framework.renderers.BrowsableAPIRenderer&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;DEFAULT_CONTENT_NEGOTIATION_CLASS&#39;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;rest_framework.negotiation.DefaultContentNegotiation&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">rest_framework.parsers</span> <span class="kn">import</span> <span class="n">JSONParser</span><span class="p">,</span> <span class="n">FormParser</span><span class="p">,</span> <span class="n">MultiPartParser</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">rest_framework.renderers</span> <span class="kn">import</span> <span class="n">JSONRenderer</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">rest_framework.negotiation</span> <span class="kn">import</span> <span class="n">DefaultContentNegotiation</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">MyUploadView</span><span class="p">(</span><span class="n">APIView</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">	<span class="n">parser_classes</span> <span class="o">=</span> <span class="p">[</span><span class="n">JSONParser</span><span class="p">,</span> <span class="n">FormParser</span><span class="p">,</span> <span class="n">MultiPartParser</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">	<span class="n">renderer_classes</span> <span class="o">=</span> <span class="p">[</span><span class="n">JSONRenderer</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">content_negotiation_class</span> <span class="o">=</span> <span class="n">DefaultContentNegotiation</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="å…ƒç±»">å…ƒç±»
</h2><p>åœ¨Pythonä¸­ï¼Œä¸€åˆ‡çš†å¯¹è±¡ã€‚ç±»æœ¬èº«ä¹Ÿæ˜¯å¯¹è±¡ï¼Œè€Œ<strong>å…ƒç±»å°±æ˜¯ç”¨æ¥åˆ›å»ºç±»çš„ç±»</strong>ã€‚å…ƒç±»ï¼ˆmetaclassï¼‰å¯ä»¥å¹²é¢„ç±»çš„åˆ›å»ºï¼Œæ§åˆ¶ç±»çš„å®ä¾‹åŒ–</p>
<p>æ™®é€šçš„ç±»ç”¨æ¥å®šä¹‰ä¸€èˆ¬å¯¹è±¡çš„å±æ€§å’Œè¡Œä¸ºï¼Œå…ƒç±»ç”¨æ¥å®šä¹‰æ™®é€šçš„ç±»åŠå…¶å®ä¾‹å¯¹è±¡çš„å±æ€§å’Œè¡Œä¸º</p>
<h3 id="ç±»å’Œå¯¹è±¡çš„åŸºç¡€çŸ¥è¯†">ç±»å’Œå¯¹è±¡çš„åŸºç¡€çŸ¥è¯†
</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># ç±»å’Œå¯¹è±¡ï¼ŒåŸºäºç±»å®ä¾‹åŒ–å¯¹è±¡</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># ç±»</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Foo</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># ç±»å˜é‡</span>
</span></span><span class="line"><span class="cl">    <span class="n">v1</span> <span class="o">=</span> <span class="mi">123</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># å®ä¾‹å˜é‡</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># ç±»æ–¹æ³•</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">pass</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># å¯¹è±¡</span>
</span></span><span class="line"><span class="cl"><span class="n">obj1</span> <span class="o">=</span> <span class="n">Foo</span><span class="p">(</span><span class="s1">&#39;test&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">obj2</span> <span class="o">=</span> <span class="n">Foo</span><span class="p">(</span><span class="s1">&#39;test2&#39;</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="åˆ›å»ºç±»çš„ä¸¤ç§æ–¹å¼">åˆ›å»ºç±»çš„ä¸¤ç§æ–¹å¼
</h3><p>æ–¹å¼ä¸€å°±æ˜¯æˆ‘ä»¬å¹³å¸¸ä¹¦å†™çš„å½¢å¼ï¼Œè€Œæ–¹å¼äºŒå°±æ˜¾ç¤ºåœ°å±•ç¤ºäº†å…ƒç±»åˆ›å»ºç±»çš„è¿‡ç¨‹ï¼Œæœ¬è´¨ä¸Šæ–¹å¼ä¸€ç»è¿‡å¤„ç†åå°±æ˜¯é€šè¿‡æ–¹å¼äºŒåˆ›å»ºç±»çš„ï¼Œåªæ˜¯æ–¹å¼ä¸€æ›´åŠ ç›´è§‚ä¸”æ˜“äºä¹¦å†™</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># åˆ›å»ºç±»ï¼šæ–¹å¼1</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Foo</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">v1</span> <span class="o">=</span> <span class="mi">123</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="mi">999</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># åˆ›å»ºç±»ï¼šæ–¹å¼2</span>
</span></span><span class="line"><span class="cl"><span class="c1"># ç±»å = type(&#34;ç±»å&#34;,(çˆ¶ç±»,),{æˆå‘˜})</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Foo = type(&#34;Foo&#34;, (object,), {&#34;v1&#34;: 123, &#34;func&#34;: lambda self: 999})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">obj1</span> <span class="o">=</span> <span class="n">Foo</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="n">obj1</span><span class="o">.</span><span class="n">v1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="n">obj1</span><span class="o">.</span><span class="n">func</span><span class="p">())</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="mytypeåˆ›å»ºç±»ä¸æ‹“å±•">MyTypeåˆ›å»ºç±»ä¸æ‹“å±•
</h3><p>ä½¿ç”¨å…ƒç±»ï¼Œæœ€å¸¸è§æ–¹å¼æ˜¯è‡ªå®šä¹‰ä¸€ä¸ªå…ƒç±»ï¼Œç»§æ‰¿typeï¼Œç„¶åä½¿ç”¨è‡ªå®šä¹‰çš„å…ƒç±»åˆ›å»ºç±»</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">MyType</span><span class="p">(</span><span class="nb">type</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">xx</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;åˆ›å»ºç±»&#34;</span><span class="p">,</span> <span class="n">xx</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">xx</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">Foo</span> <span class="o">=</span> <span class="n">MyType</span><span class="p">(</span><span class="s2">&#34;Foo&#34;</span><span class="p">,</span> <span class="p">(</span><span class="nb">object</span><span class="p">,),</span> <span class="p">{</span><span class="s2">&#34;v1&#34;</span><span class="p">:</span> <span class="mi">123</span><span class="p">,</span> <span class="s2">&#34;func&#34;</span><span class="p">:</span> <span class="k">lambda</span> <span class="bp">self</span><span class="p">:</span> <span class="mi">999</span><span class="p">})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">obj1</span> <span class="o">=</span> <span class="n">Foo</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="n">obj1</span><span class="o">.</span><span class="n">v1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="n">obj1</span><span class="o">.</span><span class="n">func</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># åˆ›å»ºç±» &lt;class &#39;__main__.Foo&#39;&gt;</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 123</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 999</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>åº”ç”¨åœ¨æˆ‘ä»¬å¸¸ç”¨çš„ç±»çš„åˆ›å»ºæ–¹å¼æ—¶ï¼Œå°±æ˜¯è¦å°†å…ƒç±»æŒ‡å®šä¸ºç±»çš„<code>metaclass</code>å…³é”®å­—å‚æ•°ï¼Œå‘Šè¯‰Pythonåœ¨åˆ›å»ºç±»æ—¶ä½¿ç”¨æŒ‡å®šçš„å…ƒç±»</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># åŸºäºtypeåˆ›å»º</span>
</span></span><span class="line"><span class="cl"><span class="c1"># class Foo:</span>
</span></span><span class="line"><span class="cl"><span class="c1">#     v1 = 123</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1">#     def func(self):</span>
</span></span><span class="line"><span class="cl"><span class="c1">#         pass</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># åŸºäºMyTypeåˆ›å»º</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">MyType</span><span class="p">(</span><span class="nb">type</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">xx</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;åˆ›å»ºç±»&#34;</span><span class="p">,</span> <span class="n">xx</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">xx</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Foo</span><span class="p">(</span><span class="nb">object</span><span class="p">,</span> <span class="n">metaclass</span><span class="o">=</span><span class="n">MyType</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">v1</span> <span class="o">=</span> <span class="mi">123</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">pass</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="n">Foo</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>å…ƒç±»ä¸­å¯ä»¥é‡å†™<code>__new__</code>å’Œ<code>__init__</code>æ–¹æ³•æ¥æ§åˆ¶ç±»çš„åˆ›å»ºå’Œåˆå§‹åŒ–è¿‡ç¨‹ã€‚<code>__new__</code>æ–¹æ³•åœ¨ç±»åˆ›å»ºä¹‹å‰è°ƒç”¨ï¼Œ<code>__init__</code>æ–¹æ³•åœ¨ç±»åˆ›å»ºä¹‹åè°ƒç”¨ã€‚</p>
<p><code>__new__</code>ä¼ å…¥çš„name, bases, attrså…¶å®å°±æ˜¯æˆ‘ä»¬ä½¿ç”¨æ–¹å¼äºŒåˆ›å»ºæ—¶ä¼ å…¥çš„ç±»åï¼Œçˆ¶ç±»åŠåŠå±æ€§ï¼Œå› æ­¤å°±å¯ä»¥åœ¨è°ƒç”¨typeçš„<code>__new__</code>åˆ›å»ºç±»ä¹‹å‰ï¼Œå¯¹ä¼ å…¥çš„name, bases, attrsè¿›è¡Œä¿®æ”¹ï¼Œä»è€Œå¹²é¢„ç±»çš„åˆ›å»º</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">MyType</span><span class="p">(</span><span class="nb">type</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">attrs</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># Foo (&lt;class &#39;object&#39;&gt;,) {&#39;__module__&#39;: &#39;__main__&#39;, &#39;__qualname__&#39;: &#39;Foo&#39;, &#39;v1&#39;: 123, &#39;func&#39;: &lt;function Foo.func at 0x000002209BA9C310&gt;}</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">attrs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># å¯ä»¥åœ¨åˆ›å»ºç©ºé—´å‰å¯¹ç±»è¿›è¡Œæ›´æ”¹ï¼Œå¦‚æ·»åŠ /åˆ é™¤å±æ€§ç­‰ç­‰</span>
</span></span><span class="line"><span class="cl">        <span class="k">del</span> <span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;v1&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;add&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;xxx&#39;</span>
</span></span><span class="line"><span class="cl">        <span class="n">xx</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">attrs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">xx</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Foo</span><span class="p">(</span><span class="nb">object</span><span class="p">,</span> <span class="n">metaclass</span><span class="o">=</span><span class="n">MyType</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">v1</span> <span class="o">=</span> <span class="mi">123</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">pass</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="n">Foo</span><span class="o">.</span><span class="n">add</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="n">Foo</span><span class="o">.</span><span class="n">v1</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="ç»§æ‰¿å…³ç³»">ç»§æ‰¿å…³ç³»
</h3><p>æŒ‡å®š<code>metaclass</code>çš„ç±»ä»¥åŠä»–æ‰€æœ‰çš„å­ç±»éƒ½å°†ç”±æŒ‡å®šçš„<code>metaclass</code>åˆ›å»º</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">MyType</span><span class="p">(</span><span class="nb">type</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">attrs</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">attrs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">xx</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">attrs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">xx</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Info</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">pass</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Foo</span><span class="p">(</span><span class="nb">object</span><span class="p">,</span> <span class="n">metaclass</span><span class="o">=</span><span class="n">MyType</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">pass</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Bar</span><span class="p">(</span><span class="n">Foo</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">pass</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">Info</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">Foo</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">Bar</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="/post/python/DRF/image-20241221113024024.png"
	
	
	
	loading="lazy"
	
		alt="image-20241221113024024"
	
	
></p>
<h3 id="drfåºåˆ—åŒ–æºç æ¡ˆä¾‹">drfåºåˆ—åŒ–æºç æ¡ˆä¾‹
</h3><p>å› ä¸ºUserSerializeræ˜¯Serializerçš„å­ç±»ï¼Œè€ŒSerializeræŒ‡å®šäº†metaclass=SerializerMetaclassï¼Œå› æ­¤ç”±ä¸Šä¸€å°èŠ‚çš„ç»§æ‰¿å…³ç³»çš„ä»‹ç»å¯çŸ¥ï¼ŒUserSerializerä¹Ÿå°†ç”±å…ƒç±»SerializerMetaclassåˆ›å»ºï¼Œå› æ­¤ä»–çš„å®ä¾‹ç©ºé—´ä¸­æœ‰_declared_fieldså±æ€§</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">SerializerMetaclass</span><span class="p">(</span><span class="nb">type</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">attrs</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">attrs</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>  <span class="c1"># {&#34;v1&#34;:123,&#34;v2&#34;:123,&#34;v3&#34;:123}</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="n">data_dict</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">attrs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;_declared_fields&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_dict</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">attrs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">BaseSerializer</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">pass</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Serializer</span><span class="p">(</span><span class="n">BaseSerializer</span><span class="p">,</span> <span class="n">metaclass</span><span class="o">=</span><span class="n">SerializerMetaclass</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">pass</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">ModelSerializer</span><span class="p">(</span><span class="n">Serializer</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">pass</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">UserSerializer</span><span class="p">(</span><span class="n">ModelSerializer</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">v1</span> <span class="o">=</span> <span class="mi">123</span>
</span></span><span class="line"><span class="cl">    <span class="n">v2</span> <span class="o">=</span> <span class="mi">456</span>
</span></span><span class="line"><span class="cl">    <span class="n">v3</span> <span class="o">=</span> <span class="s2">&#34;å“ˆå“ˆå“ˆ&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="n">UserSerializer</span><span class="o">.</span><span class="n">v3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="n">UserSerializer</span><span class="o">.</span><span class="n">_declared_fields</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¿è¡Œç»“æœï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">å“ˆå“ˆå“ˆ</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span><span class="s1">&#39;v1&#39;</span><span class="p">:</span> <span class="mi">123</span><span class="p">,</span> <span class="s1">&#39;v2&#39;</span><span class="p">:</span> <span class="mi">456</span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="æ‰©å±•">æ‰©å±•
</h3><p>ç±»æ˜¯ç”±MyTypeåˆ›å»ºå‡ºæ¥ï¼Œæ‰€ä»¥ç±»å…¶å®æ˜¯MyTypeç±»å®ä¾‹åŒ–çš„å¯¹è±¡ã€‚</p>
<p>Baseæ˜¯ç±»ï¼Œä¹Ÿæ˜¯MyTypeç±»çš„å¯¹è±¡å³Mytype()ï¼›  Base()æ˜¯Baseç±»å®ä¾‹åŒ–çš„å¯¹è±¡ï¼Œç›¸å½“äºMyType()()</p>
<ul>
<li>å› æ­¤Baseç±»å®ä¾‹åŒ–çš„å¯¹è±¡å°±ä¼šæ‰§è¡ŒMyTypeç±»çš„<code>__call__</code></li>
<li>è€Œobj()ä¾¿ä¼šæ‰§è¡ŒBaseç±»çš„<code>__call__</code></li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">MyType</span><span class="p">(</span><span class="nb">type</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">attrs</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">attrs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">xx</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">attrs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">xx</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;æ‰§è¡Œtypeçš„call&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">obj</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;----&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">cls</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">obj</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Base</span><span class="p">(</span><span class="nb">object</span><span class="p">,</span> <span class="n">metaclass</span><span class="o">=</span><span class="n">MyType</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;åˆå§‹åŒ–&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;å®ä¾‹åŒ–ç±»çš„å¯¹è±¡&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nb">object</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Base.call&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">obj</span> <span class="o">=</span> <span class="n">Base</span><span class="p">()</span>  <span class="c1"># æ‰§è¡ŒMyTypeçš„__call__</span>
</span></span><span class="line"><span class="cl"><span class="n">obj</span><span class="p">()</span>  <span class="c1"># æ‰§è¡ŒBaseçš„__call__</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="åºåˆ—åŒ–å™¨">åºåˆ—åŒ–å™¨
</h2><p>åºåˆ—åŒ–å™¨æ˜¯Djangoæ¡†æ¶ä¸­çš„ä¸€ä¸ªé‡è¦æ¦‚å¿µï¼Œç”¨äºåœ¨Pythonå¯¹è±¡å’ŒJSONç­‰æ ¼å¼ä¹‹é—´è¿›è¡Œç›¸äº’è½¬æ¢ã€‚é€šè¿‡åºåˆ—åŒ–å™¨ï¼Œæˆ‘ä»¬å¯ä»¥æ–¹ä¾¿åœ°å°†æ¨¡å‹å®ä¾‹è½¬æ¢ä¸ºJSONæ ¼å¼çš„æ•°æ®ï¼Œå¹¶ä¸”è¿˜å¯ä»¥å¯¹æ•°æ®è¿›è¡ŒéªŒè¯ã€åˆ›å»ºå’Œæ›´æ–°ç­‰æ“ä½œã€‚</p>
<ul>
<li>è§£æå™¨ï¼š
<ul>
<li>å°†å®¢æˆ·ç«¯å‘é€çš„è¯·æ±‚ä½“ï¼ˆå¦‚JSONï¼‰è§£æä¸º Python æ•°æ®ç»“æ„ï¼ˆå¦‚å­—å…¸æˆ–åˆ—è¡¨ï¼‰</li>
<li>è§£æåçš„æ•°æ®å­˜å‚¨åœ¨ <code>request.data</code> ä¸­ï¼Œä¾›è§†å›¾å’Œåºåˆ—åŒ–å™¨ä½¿ç”¨</li>
</ul>
</li>
<li>åºåˆ—åŒ–å™¨ï¼š
<ul>
<li>åœ¨è§†å›¾ä¸­ï¼Œ<code>request.data</code> è¢«ä¼ é€’ç»™åºåˆ—åŒ–å™¨ï¼ŒéªŒè¯è§£æåçš„æ•°æ®æ˜¯å¦ç¬¦åˆæ¨¡å‹å­—æ®µçš„è¦æ±‚</li>
<li>å°†éªŒè¯åçš„æ•°æ®è½¬æ¢ä¸ºæ¨¡å‹å®ä¾‹ï¼Œä¿å­˜åˆ°æ•°æ®åº“</li>
<li>å“åº”é˜¶æ®µï¼Œåºåˆ—åŒ–å™¨å°†æ¨¡å‹å®ä¾‹åºåˆ—åŒ–ä¸ºPython æ•°æ®ç»“æ„ï¼ˆé€šå¸¸æ˜¯å­—å…¸ï¼Œåˆ—è¡¨ï¼Œæœ‰åºå­—å…¸ï¼‰</li>
</ul>
</li>
<li>æ¸²æŸ“å™¨ï¼š
<ul>
<li>å°†Python æ•°æ®ç»“æ„ï¼ˆé€šå¸¸æ˜¯å­—å…¸ï¼Œåˆ—è¡¨ï¼Œæœ‰åºå­—å…¸ï¼‰è¿›ä¸€æ­¥è½¬æ¢ä¸ºJSONã€XML æˆ–å…¶ä»–æ ¼å¼</li>
<li>å°†åºåˆ—åŒ–åçš„æ•°æ®è½¬æ¢ä¸ºå­—èŠ‚æµï¼Œæœ€ç»ˆè¿”å›ç»™å®¢æˆ·ç«¯</li>
</ul>
</li>
</ul>
<h3 id="åºåˆ—åŒ–">åºåˆ—åŒ–
</h3><p>åºåˆ—åŒ–è¿‡ç¨‹ æ˜¯å°†ä»ORMä¸­è·å–çš„å¤æ‚çš„æ•°æ®ç±»å‹ï¼ˆå¦‚ Django æ¨¡å‹å®ä¾‹æˆ–æŸ¥è¯¢é›†ï¼‰è½¬æ¢ä¸º Python æ•°æ®ç»“æ„ï¼ˆé€šå¸¸æ˜¯å­—å…¸ï¼Œåˆ—è¡¨ï¼Œæœ‰åºå­—å…¸ï¼‰ï¼Œç„¶åè¿›ä¸€æ­¥è½¬æ¢ä¸º JSONã€XML æˆ–å…¶ä»–æ ¼å¼çš„è¿‡ç¨‹ï¼ˆæ¸²æŸ“å™¨ä½œç”¨ï¼‰</p>
<h4 id="serializer">Serializer
</h4><p><code>Serializer</code>æ˜¯åŸºç¡€åºåˆ—åŒ–å™¨ï¼Œéœ€è¦æ‰‹åŠ¨å®šä¹‰æ¯ä¸ªå­—æ®µ</p>
<p>å…ˆåˆ›å»ºæ•°æ®åº“ï¼Œä»¥ä¾¿åç»­æµ‹è¯•è·å–æ•°æ®</p>
<p><img src="/post/python/DRF/image-20241221182140560.png"
	
	
	
	loading="lazy"
	
		alt="image-20241221182140560"
	
	
></p>
<p>æ‰‹åŠ¨æ·»åŠ ä¸¤ç»„æ•°æ®</p>
<p><img src="/post/python/DRF/image-20241221182452157.png"
	
	
	
	loading="lazy"
	
		alt="image-20241221182452157"
	
	
></p>
<p>æ¨¡å‹å®ä¾‹å¯¹è±¡</p>
<p><img src="/post/python/DRF/image-20241221184453282.png"
	
	
	
	loading="lazy"
	
		alt="image-20241221184453282"
	
	
></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">DepartSerializer</span><span class="p">(</span><span class="n">serializers</span><span class="o">.</span><span class="n">Serializer</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">title</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">CharField</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">count</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">IntegerField</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">DepartView</span><span class="p">(</span><span class="n">APIView</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 1.æ•°æ®åº“ä¸­è·å–æ•°æ® obj.title  obj.order  obj.count</span>
</span></span><span class="line"><span class="cl">        <span class="n">depart_object</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Depart</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>  <span class="c1"># æ¨¡å‹å®ä¾‹</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 2.åºåˆ—åŒ–å™¨è½¬æ¢JSONæ ¼å¼</span>
</span></span><span class="line"><span class="cl">        <span class="n">ser</span> <span class="o">=</span> <span class="n">DepartSerializer</span><span class="p">(</span><span class="n">instance</span><span class="o">=</span><span class="n">depart_object</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># {&#39;title&#39;: &#39;æŠ€æœ¯éƒ¨&#39;, &#39;count&#39;: 10}</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="n">ser</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>  <span class="c1"># å­—å…¸</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># è¿”å›ç»™ç”¨æˆ·</span>
</span></span><span class="line"><span class="cl">        <span class="n">context</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&#34;status&#34;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&#34;data&#34;</span><span class="p">:</span> <span class="n">ser</span><span class="o">.</span><span class="n">data</span><span class="p">}</span>  <span class="c1"># å­—å…¸</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>  <span class="c1"># Responseå¯¹è±¡é€šè¿‡æ¸²æŸ“å™¨å°†å­—å…¸å¯¹è±¡zhuanè½¬æ¢ä¸ºJSONå¯¹è±¡</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Querysetæ•°æ®é›†å¯¹è±¡</p>
<p><img src="/post/python/DRF/image-20241221185028899.png"
	
	
	
	loading="lazy"
	
		alt="image-20241221185028899"
	
	
></p>
<h4 id="modelserializer">ModelSerializer
</h4><p><code>ModelSerializer</code>æ˜¯<code>Serializer</code>çš„å­ç±»ï¼Œä¸“é—¨ä¸ºæ¨¡å‹æ•°æ®è®¾è®¡ï¼Œæä¾›äº†åŸºäºæ¨¡å‹ç±»è‡ªåŠ¨ç”Ÿæˆå­—æ®µçš„åŠŸèƒ½</p>
<p>å¦‚ä¸‹å›¾ï¼ŒæŒ‡å®šmodelä¸ºDepartç±»å¹¶æŒ‡å®šfieldså³å¯åŸºäºæ¨¡å‹ç±»Departçš„å­—æ®µè‡ªåŠ¨ç”Ÿæˆå­—æ®µ</p>
<p><img src="/post/python/DRF/image-20241221185924204.png"
	
	
	
	loading="lazy"
	
		alt="image-20241221185924204"
	
	
></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">DepartSerializer</span><span class="p">(</span><span class="n">serializers</span><span class="o">.</span><span class="n">ModelSerializer</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Depart</span>
</span></span><span class="line"><span class="cl">        <span class="n">fields</span> <span class="o">=</span> <span class="s1">&#39;__all__&#39;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="å­—æ®µå’Œå‚æ•°">å­—æ®µå’Œå‚æ•°
</h4><p>ä¸Šé¢æˆ‘ä»¬å·²ç»å­¦ä¹ äº†<code>Serializer</code>å’Œ<code>ModelSerializer</code>ä¸¤ç§åºåˆ—åŒ–å™¨ï¼Œä½†æ˜¯ä»…ä»…å¦‚æ­¤è¿œè¿œè¾¾ä¸åˆ°æˆ‘ä»¬å¼€å‘æ—¶éœ€è¦çš„çµæ´»çš„ï¼Œå› æ­¤ï¼Œè¿™ä¸€éƒ¨åˆ†å°†ä»‹ç»å¯¹å­—æ®µåŠå‚æ•°çš„è‡ªå®šä¹‰ï¼Œæ¥å®ç°çµæ´»å¼€å‘</p>
<p>å‰ç½®æ•°æ®å‡†å¤‡</p>
<p><img src="/post/python/DRF/image-20241221194402180-17347814432471.png"
	
	
	
	loading="lazy"
	
		alt="image-20241221194402180"
	
	
></p>
<p><img src="/post/python/DRF/image-20241221194618320.png"
	
	
	
	loading="lazy"
	
		alt="image-20241221194618320"
	
	
></p>
<h5 id="è¿”å›æ‰€æœ‰å­—æ®µ">è¿”å›æ‰€æœ‰å­—æ®µ
</h5><p>è¿”å›æ¨¡å‹ç±»ä¸­å®šä¹‰çš„æ‰€æœ‰å­—æ®µ</p>
<p><img src="/post/python/DRF/image-20241221195330516.png"
	
	
	
	loading="lazy"
	
		alt="image-20241221195330516"
	
	
></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">UserSerializer</span><span class="p">(</span><span class="n">serializers</span><span class="o">.</span><span class="n">ModelSerializer</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">UserInfo</span>
</span></span><span class="line"><span class="cl">        <span class="n">fields</span> <span class="o">=</span> <span class="s1">&#39;__all__&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">UserView</span><span class="p">(</span><span class="n">APIView</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">models</span><span class="o">.</span><span class="n">UserInfo</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">ctime</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 1.è·å–æ•°æ®</span>
</span></span><span class="line"><span class="cl">        <span class="n">queryset</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">UserInfo</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 2.åºåˆ—åŒ–</span>
</span></span><span class="line"><span class="cl">        <span class="n">ser</span> <span class="o">=</span> <span class="n">UserSerializer</span><span class="p">(</span><span class="n">queryset</span><span class="p">,</span> <span class="n">many</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 3.è¿”å›ç»™ç”¨æˆ·</span>
</span></span><span class="line"><span class="cl">        <span class="n">context</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&#34;status&#34;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&#34;data&#34;</span><span class="p">:</span> <span class="n">ser</span><span class="o">.</span><span class="n">data</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="æŒ‡å®šå­—æ®µè¿”å›">æŒ‡å®šå­—æ®µè¿”å›
</h5><p>æœ‰æ—¶æˆ‘ä»¬ä¸éœ€è¦å°†ç±»ä¸­å®šä¹‰çš„å…¨éƒ¨å­—æ®µè¿”å›ï¼Œäºæ˜¯å°±éœ€è¦è‡ªå®šä¹‰å­—æ®µè¿”å›</p>
<p><img src="/post/python/DRF/image-20241222160835246.png"
	
	
	
	loading="lazy"
	
		alt="image-20241222160835246"
	
	
></p>
<p>æˆ‘ä»¬å‘ç°genderè¿”å›çš„æ˜¯æ•°æ®åº“ä¸­çœŸå®å­˜å‚¨çš„1å’Œ2ï¼Œé‚£åº”è¯¥å¦‚ä½•è®©ä»–è¿”å›ç”·å’Œå¥³å‘¢ï¼Ÿ</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># æˆ‘ä»¬å¯ä»¥è‡ªå®šä¹‰å­—æ®µ</span>
</span></span><span class="line"><span class="cl"><span class="n">gender</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="s1">&#39;gender&#39;</span><span class="p">)</span>  <span class="c1"># ç­‰åŒäºç›´æ¥åœ¨fieldsä¸­æ·»åŠ  &#39;gender&#39;ï¼Œæ‹¿åˆ°çš„è¿˜æ˜¯1å’Œ2</span>
</span></span><span class="line"><span class="cl"><span class="c1"># å®ƒæ‹¿åˆ°æ¯ä¸€ä¸ªå¯¹è±¡éƒ½ä¼š.source ï¼Œä¸Šè¿°è¯­å¥å³obj.genderå³å¯æ‹¿åˆ°æ•°æ®åº“ä¸­çš„å€¼ï¼Œé‚£ä¹ˆçŸ¥é“äº†è¿™ä¸ªï¼Œæˆ‘ä»¬å°±å¯ä»¥è‡ªå®šä¹‰å­—æ®µæŒ‡å®šå…¶sourceæ¥æ‹¿åˆ°æˆ‘ä»¬æƒ³è¦çš„æ•°æ®</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="å­å®šä¹‰å­—æ®µè¿”å›">å­å®šä¹‰å­—æ®µè¿”å›
</h5><ul>
<li>
<p><code>choiceså±•ç¤º</code></p>
<ul>
<li><code>obj.get_gender_display</code>å³å¯è·å–choicesä¸­çš„ç”·æˆ–å¥³</li>
</ul>
</li>
<li>
<p><code>foreignkeyè·¨è¡¨æŸ¥è¯¢</code></p>
<ul>
<li>é€šè¿‡FKè¿›è¡Œè·¨è¡¨æŸ¥è¯¢</li>
</ul>
</li>
<li>
<p><code>æ—¶é—´æ•°æ®æ ¼å¼è®¾ç½®</code></p>
</li>
</ul>
<p><img src="/post/python/DRF/image-20241222161854882.png"
	
	
	
	loading="lazy"
	
		alt="image-20241222161854882"
	
	
></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">UserSerializer</span><span class="p">(</span><span class="n">serializers</span><span class="o">.</span><span class="n">ModelSerializer</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">gender_text</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="s1">&#39;get_gender_display&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">depart</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="s1">&#39;depart.title&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">ctime</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="nb">format</span><span class="o">=</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">UserInfo</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># fields = &#39;__all__&#39;</span>
</span></span><span class="line"><span class="cl">        <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;age&#39;</span><span class="p">,</span> <span class="s1">&#39;gender&#39;</span><span class="p">,</span> <span class="s1">&#39;gender_text&#39;</span><span class="p">,</span> <span class="s1">&#39;depart&#39;</span><span class="p">,</span> <span class="s1">&#39;ctime&#39;</span><span class="p">]</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>æˆ‘ä»¬å·²ç»èƒ½åšåˆ°è·å–æ•°æ®åº“ä¸­ä»»ä½•æˆ‘ä»¬æƒ³è¦çš„æ•°æ®ï¼Œé‚£æˆ‘ä»¬å¯ä»¥æ·»åŠ éæ•°æ®åº“å­—æ®µå—ï¼Ÿ</p>
<h5 id="è‡ªå®šä¹‰æ–¹æ³•">è‡ªå®šä¹‰æ–¹æ³•
</h5><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">xxx</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">SerializerMethodField</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="c1"># å½“å®šä¹‰äº†ä¸€ä¸ªåä¸ºxxxçš„SerializerMethodFieldå­—æ®µæ—¶ï¼Œä¼šå¯»æ‰¾get_xxxæ–¹æ³•ï¼Œå°†å…¶è¿”å›å€¼ä½œä¸ºè¯¥å­—æ®µçš„å€¼</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">get_xxx</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="s2">&#34;123&#34;</span> <span class="o">+</span> <span class="n">obj</span><span class="o">.</span><span class="n">name</span>
</span></span><span class="line"><span class="cl"><span class="c1"># ä¼ å…¥çš„objä¸ºæ¯æ¬¡å¾ªç¯çš„æ•°æ®åº“å¯¹è±¡ï¼Œobj.nameå³å¯è·å–å¯¹åº”çš„æ•°æ®åº“å†…çš„æ•°æ®</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="/post/python/DRF/image-20241222162904065.png"
	
	
	
	loading="lazy"
	
		alt="image-20241222162904065"
	
	
></p>
<h4 id="åµŒå¥—ä¸ç»§æ‰¿">åµŒå¥—ä¸ç»§æ‰¿
</h4><p>è€æ ·å­ï¼Œå…ˆæ‹“å±•ä¸€ä¸‹æˆ‘ä»¬çš„æ•°æ®è¡¨ï¼Œæ·»åŠ ä¸€ä¸ªæ ‡ç­¾ï¼Œè®©å®ƒä¸ç”¨æˆ·æ„å»ºå¤šå¯¹å¤šçš„å…³ç³»</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">models</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Create your models here.</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Depart</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">title</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">verbose_name</span><span class="o">=</span><span class="s2">&#34;éƒ¨é—¨&#34;</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">32</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">order</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">IntegerField</span><span class="p">(</span><span class="n">verbose_name</span><span class="o">=</span><span class="s2">&#34;é¡ºåº&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">count</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">IntegerField</span><span class="p">(</span><span class="n">verbose_name</span><span class="o">=</span><span class="s2">&#34;äººæ•°&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Tag</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">caption</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">verbose_name</span><span class="o">=</span><span class="s2">&#34;æ ‡ç­¾&#34;</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">32</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">UserInfo</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">verbose_name</span><span class="o">=</span><span class="s2">&#34;å§“å&#34;</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">32</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">age</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">IntegerField</span><span class="p">(</span><span class="n">verbose_name</span><span class="o">=</span><span class="s2">&#34;å¹´é¾„&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">gender</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">SmallIntegerField</span><span class="p">(</span><span class="n">verbose_name</span><span class="o">=</span><span class="s2">&#34;æ€§åˆ«&#34;</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&#34;ç”·&#34;</span><span class="p">),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s2">&#34;å¥³&#34;</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">    <span class="n">depart</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">verbose_name</span><span class="o">=</span><span class="s2">&#34;éƒ¨é—¨&#34;</span><span class="p">,</span> <span class="n">to</span><span class="o">=</span><span class="s2">&#34;Depart&#34;</span><span class="p">,</span> <span class="n">on_delete</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">CASCADE</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">ctime</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="n">verbose_name</span><span class="o">=</span><span class="s2">&#34;æ—¶é—´&#34;</span><span class="p">,</span> <span class="n">auto_now_add</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">tags</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ManyToManyField</span><span class="p">(</span><span class="n">verbose_name</span><span class="o">=</span><span class="s2">&#34;æ ‡ç­¾&#34;</span><span class="p">,</span> <span class="n">to</span><span class="o">=</span><span class="s2">&#34;Tag&#34;</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ç„¶ååˆ›å»ºå¹¶åº”ç”¨è¿ç§»å¯¹è±¡å®ç°å¯¹æ•°æ®åº“çš„æ“ä½œ</p>
<p>æ·»åŠ å¦‚ä¸‹æ•°æ®ä»¥ä¾¿åç»­æµ‹è¯•</p>
<p><img src="/post/python/DRF/image-20241222191532495.png"
	
	
	
	loading="lazy"
	
		alt="image-20241222191532495"
	
	
></p>
<h5 id="åµŒå¥—">åµŒå¥—
</h5><p>é‚£ä¹ˆéœ€æ±‚æ¥äº†ï¼Œæˆ‘ä»¬å¦‚ä½•è¿”å›ä¸€ä¸ªç”¨æˆ·å¯¹åº”çš„æ‰€æœ‰æ ‡ç­¾å‘¢ï¼Ÿ</p>
<p>æœ€å¤§çš„Querysetå¯¹è±¡å­˜æ”¾çš„æ˜¯ä¸€ä¸ªä¸€ä¸ªçš„ç”¨æˆ·å¯¹è±¡objï¼Œ<code>obj.tags.all()</code>å³å¯è·å¾—æ‰€æœ‰çš„æ ‡ç­¾å¯¹è±¡[Tag1,Tag2,&hellip;.]</p>
<p>é‚£ä¹ˆæ€è·¯æœ‰äº†æˆ‘ä»¬å°±å¯ä»¥ç”¨ä¸Šé¢å­¦ä¼šçš„è‡ªå®šä¹‰æ–¹æ³•å®ç°</p>
<p><img src="/post/python/DRF/image-20241222192549232.png"
	
	
	
	loading="lazy"
	
		alt="image-20241222192549232"
	
	
></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get_xxx</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">queryset</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">tags</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">result</span> <span class="o">=</span> <span class="p">[{</span><span class="s2">&#34;id&#34;</span><span class="p">:</span> <span class="n">tag</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="s2">&#34;caption&#34;</span><span class="p">:</span> <span class="n">tag</span><span class="o">.</span><span class="n">caption</span><span class="p">}</span> <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">queryset</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">result</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>æˆ‘ä»¬é€šè¿‡è‡ªå®šä¹‰æ–¹æ³•å¯ä»¥å®ç°è¯¥éœ€æ±‚ï¼Œä½†ä»éœ€è¦è‡ªå·±ä¹¦å†™é€»è¾‘ï¼Œå…¶å®DRFçš„åºåˆ—åŒ–æ”¯æŒåµŒå¥—ï¼Œä¸‹é¢å°±æ¥çœ‹çœ‹å¦‚ä½•åˆ©ç”¨åµŒå¥—å®ç°</p>
<p><img src="/post/python/DRF/image-20241222193614643.png"
	
	
	
	loading="lazy"
	
		alt="image-20241222193614643"
	
	
></p>
<p>å¦‚ä¸Šå›¾ï¼Œä¸€ä¸ªåºåˆ—åŒ–å™¨å¯ä»¥åµŒå¥—å­åºåˆ—åŒ–å™¨ï¼Œå­åºåˆ—åŒ–å™¨ä¸­çš„æ“ä½œä¸ä¸Šä¸€èŠ‚ä»‹ç»çš„æ— å¼‚ï¼Œæ”¯æŒè‡ªå®šä¹‰å­—æ®µï¼Œè‡ªå®šä¹‰æ–¹æ³•ç­‰ç­‰ï¼Œè¿™æ ·å°±å¿«æ·åœ°å®ç°äº†æˆ‘ä»¬çš„éœ€æ±‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">D1</span><span class="p">(</span><span class="n">serializers</span><span class="o">.</span><span class="n">ModelSerializer</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Depart</span>
</span></span><span class="line"><span class="cl">        <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;id&#34;</span><span class="p">,</span> <span class="s2">&#34;title&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">D2</span><span class="p">(</span><span class="n">serializers</span><span class="o">.</span><span class="n">ModelSerializer</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">ex</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">SerializerMethodField</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Tag</span>
</span></span><span class="line"><span class="cl">        <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;caption&#34;</span><span class="p">,</span> <span class="s2">&#34;ex&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get_ex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="s2">&#34;xxx&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">UserSerializer</span><span class="p">(</span><span class="n">serializers</span><span class="o">.</span><span class="n">ModelSerializer</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">depart</span> <span class="o">=</span> <span class="n">D1</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">tags</span> <span class="o">=</span> <span class="n">D2</span><span class="p">(</span><span class="n">many</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">UserInfo</span>
</span></span><span class="line"><span class="cl">        <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;age&#39;</span><span class="p">,</span> <span class="s2">&#34;depart&#34;</span><span class="p">,</span> <span class="s2">&#34;tags&#34;</span><span class="p">]</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ€»ç»“ï¼šä¸€èˆ¬åœ¨æœ‰<code>foreignkey</code>æˆ–è€…<code>manytomany</code>æ—¶ä½¿ç”¨</p>
<h5 id="ç»§æ‰¿">ç»§æ‰¿
</h5><p><img src="/post/python/DRF/image-20241222194350380.png"
	
	
	
	loading="lazy"
	
		alt="image-20241222194350380"
	
	
></p>
<p>å¦‚ä¸Šå›¾ï¼ŒBaseåºåˆ—åŒ–å™¨å®šä¹‰äº†ä¸€ä¸ªxxå­—æ®µï¼Œè€ŒUserSerializeråºåˆ—åŒ–å™¨ç»§æ‰¿äº†Baseï¼Œå°±å¯ä»¥ç›´æ¥ä½¿ç”¨xxå­—æ®µ</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Base</span><span class="p">(</span><span class="n">serializers</span><span class="o">.</span><span class="n">Serializer</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">xx</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="s2">&#34;name&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">UserSerializer</span><span class="p">(</span><span class="n">serializers</span><span class="o">.</span><span class="n">ModelSerializer</span><span class="p">,</span> <span class="n">Base</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">UserInfo</span>
</span></span><span class="line"><span class="cl">        <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;age&#39;</span><span class="p">,</span> <span class="s2">&#34;xx&#34;</span><span class="p">]</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>è‡³æ­¤ï¼Œåºåˆ—åŒ–æ•°æ®çš„å®ç°å°±å·²ç»å…¨éƒ¨ä»‹ç»äº†ï¼Œç»è¿‡ä¸Šé¢çš„å­¦ä¹ ï¼Œæˆ‘ä»¬åº”è¯¥èƒ½å¤Ÿå…·å¤‡ï¼Œæ— è®ºæ˜¯æ•°æ®åº“ä¸­ä»»ä½•è¡¨ç»“æ„å…³ç³»ï¼Œè·å–åˆ°æ¨¡å‹å¯¹è±¡æˆ–è€…æ˜¯QuerySetæ—¶ï¼Œå¯ä»¥å°†å…¶è¿›è¡Œåºåˆ—åŒ–è½¬ä¸ºJSONæ•°æ®è¿”å›</strong></p>
<h3 id="æºç æµç¨‹-3">æºç æµç¨‹
</h3><h4 id="æµç¨‹æ¦‚è¿°-1">æµç¨‹æ¦‚è¿°
</h4><p>ç¬¬ä¸€æ­¥ï¼šåŠ è½½å­—æ®µï¼Œåˆ›å»ºç±»</p>
<ul>
<li>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">BaseSerializer</span><span class="p">(</span><span class="n">serializers</span><span class="o">.</span><span class="n">Serializer</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">xx</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="s2">&#34;name&#34;</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<ol>
<li>åœ¨ç±»æˆå‘˜ä¸­æå–å‡ºxxå­—æ®µå¹¶åˆ é™¤</li>
</ol>
</li>
<li>
<ol start="2">
<li>æ±‡æ€»åˆ° <code>BaseSerializer._declared_fields = {&quot;xx&quot;:å¯¹è±¡}</code></li>
</ol>
</li>
<li>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">UserSerializer</span><span class="p">(</span><span class="n">serializers</span><span class="o">.</span><span class="n">ModelSerializer</span><span class="p">,</span> <span class="n">BaseSerializer</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">yy</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="s2">&#34;name&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">UserInfo</span>
</span></span><span class="line"><span class="cl">        <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;age&#39;</span><span class="p">,</span> <span class="s2">&#34;yy&#34;</span> <span class="p">,</span><span class="s2">&#34;xx&#34;</span><span class="p">]</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<ol>
<li>åœ¨ç±»æˆå‘˜ä¸­æå–å‡ºyyå­—æ®µå¹¶åˆ é™¤</li>
<li>å°†è‡ªå·±å³ç»§æ‰¿ç±»ä¸­çš„å­—æ®µéƒ½æ±‡æ€»åˆ°<code>UserSerializer._declared_fields = {&quot;yy&quot;:å¯¹è±¡,&quot;xx&quot;:å¯¹è±¡,&quot;name&quot;:å¯¹è±¡...}</code></li>
</ol>
</li>
</ul>
<p>ç¬¬äºŒæ­¥ï¼šåºåˆ—åŒ–</p>
<ul>
<li>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">queryset</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">UserInfo</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">ser</span> <span class="o">=</span> <span class="n">UserSerializer</span><span class="p">(</span><span class="n">queryset</span><span class="p">,</span> <span class="n">many</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># ListSerizlizerå¯¹è±¡ã€‚å¾ªç¯querysetä¸­çš„æ¯ä¸€ä¸ªå¯¹è±¡ï¼Œå¯¹å…¶è°ƒç”¨UserSerializerè¿›è¡Œå®ä¾‹åŒ–</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p><code>db-&gt;queryset = [{id:xxx,name:xxx,age:xxx},{id:xxx,name:xxx,age:xxx},]</code></p>
</li>
<li>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">instance</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">UserInfo</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">ser</span> <span class="o">=</span> <span class="n">UserSerializer</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">many</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># UserSerializerå¯¹è±¡</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p><code>db-&gt;instance = {id:xxx,name:xxx,age:xxx}</code></p>
</li>
<li>
<p>åºåˆ—åŒ–è¿‡ç¨‹</p>
<ul>
<li><code>instance = models.UserInfo.objects.all().first()</code></li>
<li><code>ser = UserSerializer(instance, many=False)</code></li>
<li>å½“æ‰§è¡Œ<code>ser.data</code>æ—¶è§¦å‘
<ul>
<li>å†…éƒ¨å¯»æ‰¾å¯¹åº”å…³ç³»
<ul>
<li>å°†UserSerializer._declared_fieldsä¸­çš„å­—æ®µä¸ä»æ•°æ®åº“ä¸­çš„æŸ¥åˆ°çš„æ•°æ®çš„æ¨¡å‹ç±»å­—æ®µä¸€ä¸€å¯¹åº”</li>
</ul>
</li>
<li>é€ä¸€è¿›è¡Œåºåˆ—åŒ–</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="åˆ›å»ºå­—æ®µå¯¹è±¡">åˆ›å»ºå­—æ®µå¯¹è±¡
</h4><p>é¦–å…ˆæ¥æ€è€ƒä¸€ä¸ªé—®é¢˜</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Foo</span><span class="p">(</span><span class="nb">object</span><span class="p">,</span><span class="n">metaclass</span><span class="o">=</span><span class="nb">type</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">v1</span> <span class="o">=</span> <span class="mi">123</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="mi">999</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä¸Šè¿°ä»£ç çš„ç±»ï¼Œåœ¨åˆ›å»ºæ—¶ï¼Œæ˜¯å…ˆåŠ è½½å­—æ®µv1å’Œfuncè¿˜æ˜¯å…ˆåˆ›å»ºFooè¿™ä¸ªç±»</p>
<p>å¦‚æœçœ‹ä¸å‡ºæ¥ï¼Œæˆ‘ä»¬ä¸å¦¨æ¢ä¸ªå½¢å¼</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">Foo</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="s2">&#34;Foo&#34;</span><span class="p">,</span> <span class="p">(</span><span class="nb">object</span><span class="p">,),</span> <span class="p">{</span><span class="s2">&#34;v1&#34;</span><span class="p">:</span> <span class="mi">123</span><span class="p">,</span> <span class="s2">&#34;func&#34;</span><span class="p">:</span> <span class="k">lambda</span> <span class="bp">self</span><span class="p">:</span> <span class="mi">999</span><span class="p">})</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ç°åœ¨æƒ³å¿…å¾ˆæ¸…æ™°äº†ï¼Œä¸€å®šæ˜¯å…ˆåŠ è½½å®Œv1,funcè¿™ä¸¤ä¸ªå­—æ®µï¼Œæ‰èƒ½æŠŠä»–ä»¬å½“æˆå‚æ•°ä¼ é€’ç»™typeå»åˆ›å»ºFooç±»</p>
<p>å› æ­¤å¯¹äºä¸‹åˆ—ä»£ç </p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">InfoSerializer</span><span class="p">(</span><span class="n">serializers</span><span class="o">.</span><span class="n">Serializer</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="nb">id</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">IntegerField</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">title</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">CharField</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">order</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">IntegerField</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä¸€å®šä¹Ÿæ˜¯å…ˆåŠ è½½idï¼Œtitleï¼Œorderä¸‰ä¸ªå­—æ®µå†å®ä¾‹åŒ–<code>IntegerField()</code>å¯¹è±¡&hellip;</p>
<p>æ‰€ä»¥æˆ‘ä»¬å…ˆæ¥çœ‹DRFåˆ›å»ºå­—æ®µå¯¹è±¡çš„æºç å®ç°(ç²¾ç®€ç‰ˆï¼Œç”¨äºç†è§£å®ç°é€»è¾‘)</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Field</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">_creation_counter</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">...</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">_creation_counter</span> <span class="o">=</span> <span class="n">Field</span><span class="o">.</span><span class="n">_creation_counter</span>
</span></span><span class="line"><span class="cl">        <span class="n">Field</span><span class="o">.</span><span class="n">_creation_counter</span> <span class="o">+=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">IntegerField</span><span class="p">(</span><span class="n">Field</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">max_value</span> <span class="o">=</span> <span class="mi">111</span>
</span></span><span class="line"><span class="cl">        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">CharField</span><span class="p">(</span><span class="n">Field</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">allow_blank</span> <span class="o">=</span> <span class="n">Flase</span>
</span></span><span class="line"><span class="cl">        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">InfoSerializer</span><span class="p">(</span><span class="n">serializers</span><span class="o">.</span><span class="n">Serializer</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="nb">id</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">IntegerField</span><span class="p">()</span>  <span class="c1"># {max_value:111, _creation_counter:0}</span>
</span></span><span class="line"><span class="cl">    <span class="n">title</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">CharField</span><span class="p">()</span>  <span class="c1"># {allow_blank:False, _creation_counter:1}</span>
</span></span><span class="line"><span class="cl">    <span class="n">order</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">IntegerField</span>  <span class="c1"># {max_value:111, _creation_counter:2}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>id = serializers.IntegerField()</code>åœ¨æ‰§è¡Œæ—¶ï¼Œä¼šå®ä¾‹åŒ–ä¸€ä¸ª<code>IntegerField</code>å¯¹è±¡ï¼Œå…ˆè°ƒç”¨è‡ªå·±çš„<code>__init__</code>æ–¹æ³•ç»™è‡ªå·±çš„å®ä¾‹ç©ºé—´å†™å…¥å€¼ï¼Œå¦‚<code>max_value</code>ï¼Œå†è°ƒç”¨çˆ¶ç±»<code>Field</code>çš„<code>__init__</code>æ–¹æ³•ï¼Œå®ç°<code>_creation_counter=0</code>ï¼ŒåŒæ—¶å°†<code>Field</code>çš„ç±»å˜é‡+1ï¼Œå³<code>Field._creation_counter = 1</code></p>
<p><code>title = serializers.CharField()</code>åœ¨æ‰§è¡Œæ—¶ï¼Œä¼šå®ä¾‹åŒ–ä¸€ä¸ª<code>CharField</code>å¯¹è±¡ï¼Œé€»è¾‘åŒä¸Šï¼Œä½†æ˜¯ä»–çš„<code>_creation_counter=1</code>ï¼Œ<code>Field._creation_counter = 2</code></p>
<p><code>order = serializers.IntegerField</code>åŒç†ï¼Œ<code>_creation_counter=2</code>ï¼Œ<code>Field._creation_counter = 3</code></p>
<p>å¦‚æœè¿˜æœ‰å…¶ä»–<code>XXSerializer</code>ç±»ï¼Œä»–çš„å­—æ®µä¹Ÿä¼šæ¥ç€ç»™è‡ªå·±çš„<code>_creation_counter</code>èµ‹å€¼å¹¶ä¸”ä½¿ç±»å˜é‡è‡ªå¢</p>
<p>åˆ°è¿™é‡Œæƒ³å¿…å¤§å®¶éƒ½æ„è¯†åˆ°äº†ï¼ŒFieldç±»ç›¸å½“äºç»´æŠ¤äº†ä¸€ä¸ªè®¡æ•°å™¨ï¼Œç»™æ¯ä¸€ä¸ªå­—æ®µèµ‹äºˆäº†åˆ›å»ºçš„é¡ºåºï¼Œæ„ä¹‰ä½•åœ¨ï¼Ÿ</p>
<p>å°±æ˜¯è®©åç»­å¼€å‘æ—¶ï¼Œæ ¹æ®å­—æ®µåˆ›å»ºçš„é¡ºåºï¼Œæ¥å†³å®šæºç å¤„ç†çš„é¡ºåº(python3.6ä¹‹å‰å­—å…¸æ˜¯æ— åºçš„ï¼Œå› æ­¤éœ€è¦è¿™æ ·ä¸€ä¸ªé€»è¾‘)</p>
<p>æ‰€ä»¥æƒ³è®©é‚£ä¸ªå­—æ®µå…ˆå¤„ç†ï¼Œå°±æŠŠä»–çš„ä½ç½®å†™çš„ä¸Šé¢ä¸€äº›ï¼Œä¾‹å¦‚å¯†ç <code>password</code>ä¸ç¡®è®¤å¯†ç <code>confirm_password</code>å°±éœ€è¦è¿™æ ·ä¸€ä¸ªå…ˆåå…³ç³»</p>
<h4 id="åˆ›å»ºç±»">åˆ›å»ºç±»
</h4><p>ä¸Šä¸€å°èŠ‚ä¸­æˆ‘ä»¬å·²ç»äº†è§£äº†å­—æ®µå¯¹è±¡çš„åˆ›å»ºé€»è¾‘ï¼Œé‚£ä¹ˆåœ¨å­—æ®µåŠ è½½å®Œæˆåï¼Œå­—æ®µå°†ä¼šè¢«ä½œä¸ºå‚æ•°ä¼ é€’è¿›å»åˆ›å»º<code>InfoSerializer</code>ç±»</p>
<p><img src="/post/python/DRF/image-20241223185239959.png"
	
	
	
	loading="lazy"
	
		alt="image-20241223185239959"
	
	
></p>
<p><code>InfoSerializer</code>ç±»çš„çˆ¶ç±»æ˜¯<code>Serializer</code>ç±»ï¼Œè¯¥ç±»åœ¨åˆ›å»ºæ—¶æŒ‡å®šäº†<code>metaclass=SerializerMetaclass</code>ï¼Œç”±å…ƒç±»çš„çŸ¥è¯†æˆ‘ä»¬çŸ¥é“ï¼Œä¸€æ—¦<code>Serializer</code>æŒ‡å®šäº†<code>metaclass=SerializerMetaclass</code>ï¼Œé‚£ä¹ˆå…¶æ‰€æœ‰çš„å­ç±»åœ¨åˆ›å»ºæ—¶éƒ½å°†æŒ‡å®šå…ƒç±»ä¸º<code>SerializerMetaclass</code>ï¼Œå› æ­¤ä¸ç®¡æ˜¯ç»§æ‰¿çš„<code>Serializer</code>è¿˜æ˜¯<code>ModelSerializer</code>ï¼Œæœ€ç»ˆéƒ½ç”±å…ƒç±»<code>SerializerMetaclass</code>åˆ›å»º</p>
<p>ä¸‹é¢æˆ‘ä»¬å°±æ¥çœ‹çœ‹<code>SerializerMetaclass</code>æ˜¯æ€ä¹ˆåˆ›å»ºç±»çš„</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">SerializerMetaclass</span><span class="p">(</span><span class="nb">type</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@classmethod</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">_get_declared_fields</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">attrs</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 1.1 åˆ—è¡¨æ¨å¯¼å¼æ„å»ºè‡ªå·±ç±»çš„å­—æ®µå¯¹è±¡åˆ—è¡¨fields</span>
</span></span><span class="line"><span class="cl">        <span class="n">fields</span> <span class="o">=</span> <span class="p">[(</span><span class="n">field_name</span><span class="p">,</span> <span class="n">attrs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">field_name</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                  <span class="k">for</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">obj</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">attrs</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">                  <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">Field</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 1.2 æ’åº</span>
</span></span><span class="line"><span class="cl">        <span class="n">fields</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">_creation_counter</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">known</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">attrs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">def</span> <span class="nf">visit</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">known</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">name</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 1.3 åˆ—è¡¨æ¨å¯¼å¼æ„å»ºçˆ¶ç±»çš„å­—æ®µåˆ—è¡¨base_fields</span>
</span></span><span class="line"><span class="cl">        <span class="n">base_fields</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># å°†æœªé‡å¤çš„å­—æ®µå’Œå®ä¾‹æ·»åŠ åˆ°base_fieldsä¸­ï¼ŒåŒæ—¶å°†å­—æ®µæ ‡è®°ä¸ºå·²æ·»åŠ </span>
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="n">visit</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="n">f</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># éå†çˆ¶ç±»ï¼Œæ‹¿åˆ°å­uä½†åç§°få’Œå­—æ®µå®ä¾‹f</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">base</span> <span class="ow">in</span> <span class="n">bases</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="s1">&#39;_declared_fields&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">base</span><span class="o">.</span><span class="n">_declared_fields</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">known</span>
</span></span><span class="line"><span class="cl">        <span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 1.4 å°†çˆ¶ç±»å­—æ®µä¸è‡ªå·±çš„å­—æ®µåˆå¹¶åˆ—è¡¨è¿”å›</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">OrderedDict</span><span class="p">(</span><span class="n">base_fields</span> <span class="o">+</span> <span class="n">fields</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">attrs</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 1.åœ¨attrsä¸­æ–°å¢_declared_fieldså­—æ®µç”¨äºå­˜å‚¨è‡ªå·±çš„å­—æ®µå¯¹è±¡å’Œçˆ¶ç±»çš„å­—æ®µå¯¹è±¡</span>
</span></span><span class="line"><span class="cl">        <span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;_declared_fields&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_get_declared_fields</span><span class="p">(</span><span class="n">bases</span><span class="p">,</span> <span class="n">attrs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 2.å†è°ƒç”¨typeçš„__new__åˆ›å»ºç±»</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">attrs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># è¯¥ç±»åœ¨åˆ›å»ºæ—¶atträ¸€å…±æ˜¯äº”ä¸ªå€¼ï¼Œä¸€ä¸ªæ•´å‹ä¸‰ä¸ªå­—æ®µå¯¹è±¡å’Œä¸€ä¸ªç±»</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">InfoSerializer</span><span class="p">(</span><span class="n">serializers</span><span class="o">.</span><span class="n">Serializer</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">v1</span> <span class="o">=</span> <span class="mi">123</span>
</span></span><span class="line"><span class="cl">    <span class="nb">id</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">IntegerField</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">title</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">CharField</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">order</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">IntegerField</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>1.1 åˆ—è¡¨æ¨å¯¼å¼æ„å»ºè‡ªå·±ç±»çš„å­—æ®µåˆ—è¡¨fields</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">attrs</span> <span class="o">--&gt;</span>  <span class="p">{</span><span class="s2">&#34;v1&#34;</span><span class="p">:</span><span class="mi">123</span><span class="p">,</span><span class="s2">&#34;id&#34;</span><span class="p">:</span><span class="n">IntegerFieldå¯¹è±¡</span><span class="p">,</span><span class="s2">&#34;title&#34;</span><span class="p">:</span><span class="n">CharFieldå¯¹è±¡</span><span class="p">,</span><span class="o">...</span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>å¾ªç¯è·å–å­—æ®µå<code>field_name</code>å’Œå­—æ®µå€¼<code>obj</code>ï¼Œå¦‚æœ<code>obj</code>æ˜¯<code>Field</code>çš„å­ç±»ï¼Œåˆ™æ„å»ºå…ƒç»„åŠ å…¥fieldsåˆ—è¡¨ï¼ŒåŒæ—¶åœ¨attrsä¸­å‰”é™¤ï¼Œ</p>
<p>å› æ­¤å¾ªç¯ç»“æŸå</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">attrs</span> <span class="o">--&gt;</span>  <span class="p">{</span><span class="s2">&#34;v1&#34;</span><span class="p">:</span><span class="mi">123</span><span class="p">,</span><span class="s2">&#34;Meta&#34;</span><span class="p">:</span><span class="n">å¯¹è±¡</span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="n">fields</span> <span class="o">=</span> <span class="p">[(</span><span class="s2">&#34;id&#34;</span><span class="p">,</span><span class="n">å¯¹è±¡</span><span class="p">),(</span><span class="s2">&#34;title&#34;</span><span class="p">,</span><span class="n">å¯¹è±¡</span><span class="p">),(</span><span class="s2">&#34;order&#34;</span><span class="p">,</span><span class="n">å¯¹è±¡</span><span class="p">)]</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>1.2 æ’åº</li>
</ul>
<p>è¿˜è®°å¾—ä¸Šä¸€èŠ‚åˆ›å»ºå­—æ®µå¯¹è±¡æ—¶çš„é‚£ä¸ªè®¡æ•°å™¨å—ï¼Ÿè¿™ä¸€æ­¥çš„æ’åºä¾¿æ˜¯ä¾æ®å„ä¸ªå­—æ®µå¯¹è±¡å†…çš„<code>_creation_counter</code>å¤§å°è¿›è¡Œæ’åº</p>
<ul>
<li>1.3 åˆ—è¡¨æ¨å¯¼å¼æ„å»ºçˆ¶ç±»çš„å­—æ®µåˆ—è¡¨base_fields</li>
</ul>
<p>å¾ªç¯çˆ¶ç±»çš„<code>_declared_fields</code>ï¼Œå°†å½“å‰ç±»æ²¡æœ‰çš„å­—æ®µæ·»åŠ åˆ°åˆ—è¡¨<code>base_fields</code>ä¸­</p>
<ul>
<li>1.4 å°†çˆ¶ç±»å­—æ®µä¸è‡ªå·±çš„å­—æ®µåˆå¹¶åˆ—è¡¨è¿”å›</li>
</ul>
<p>ç®€å•çš„å°†ä¸¤ä¸ªåˆ—è¡¨ç›¸åŠ è¿”å›ï¼Œå†è°ƒç”¨typeçš„<code>__new__</code>å®ç°ç±»çš„åˆ›å»º</p>
<h4 id="å®ä¾‹åŒ–ç±»">å®ä¾‹åŒ–ç±»
</h4><p>åˆ›å»ºå¯¹è±¡ä»¥åŠå‰ç½®çš„åŠ è½½å­—æ®µéƒ½æ˜¯åœ¨djangoé¡¹ç›®è¿è¡Œæ—¶å°±æ‰§è¡Œçš„ï¼Œè€Œå½“è¯·æ±‚åˆ°æ¥æ—¶ï¼Œè§†å›¾å‡½æ•°ä»æ•°æ®åº“è·å–æ•°æ®å¹¶åºåˆ—åŒ–ï¼Œæ­¤æ—¶å°±æ¥åˆ°äº†å®ä¾‹åŒ–ç±»çš„è¿‡ç¨‹</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">queryset</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">UserInfo</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">ser</span> <span class="o">=</span> <span class="n">UserSerializer</span><span class="p">(</span><span class="n">queryset</span><span class="p">,</span> <span class="n">many</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">instance</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">UserInfo</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">ser</span> <span class="o">=</span> <span class="n">UserSerializer</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">many</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>å…ˆè®²è§£ç¬¬äºŒä¸ªï¼Œå³å•ä¸ªå¯¹è±¡çš„æƒ…å†µ</p>
<p>å®ä¾‹åŒ–ç±»ä¾æ¬¡æ‰§è¡Œ<code>BaseSerializer</code>ç±»çš„<code>__new__</code>ï¼Œæ ¹æ®manyå±æ€§çš„å€¼åˆ†ä¸ºä¸¤è·¯ï¼Œå½“å‰æƒ…å†µæ—¶è°ƒç”¨çˆ¶ç±»å³Fieldçš„<code>__new__</code>æ–¹æ³•ï¼ŒFieldåˆè°ƒç”¨objectåŸºç±»çš„<code>__new__</code>åˆ›å»ºå®ä¾‹</p>
<p>åˆ›å»ºå®ä¾‹åï¼Œä¼šè°ƒç”¨ <code>BaseSerializer</code> çš„ <code>__init__</code> æ–¹æ³•æ¥åˆå§‹åŒ–å®ä¾‹</p>
<p>æ ¹æ®åºåˆ—åŒ–å™¨ç±»ç»§æ‰¿çš„ä¸åŒï¼Œè°ƒç”¨<code>ModelSerializer</code>æˆ–<code>Serializer</code>çš„<code>get_fields</code>æ–¹æ³•ï¼Œè¯¥å¤„è®²è§£å‰ä¸€ä¸ªæƒ…å†µï¼Œæ ¹æ®æ¨¡å‹å­—æ®µç”Ÿæˆåºåˆ—åŒ–å­—æ®µ</p>
<p>è°ƒç”¨get_fields() è·å–åºåˆ—åŒ–å™¨ä¸­å®šä¹‰çš„æ‰€æœ‰å­—æ®µfields</p>
<ul>
<li>æ˜¾ç¤ºå£°æ˜çš„å­—æ®µdeclared_fields</li>
<li>æ ¹æ®æ¨¡å‹å­—æ®µè½¬åŒ–æˆåºåˆ—åŒ–å­—æ®µæ·»åŠ åˆ°fieldsä¸­</li>
</ul>
<p>è°ƒç”¨_init_fields åˆå§‹åŒ–å­—æ®µï¼Œå°†å­—æ®µç»‘å®šåˆ°åºåˆ—åŒ–å™¨å®ä¾‹ä¸Šï¼ˆè°ƒç”¨Fieldç±»çš„bindæ–¹æ³•ï¼‰</p>
<ul>
<li>field_name</li>
<li>parent</li>
<li>sourceå­—æ®µ</li>
<li>source_attrså­—æ®µ</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">BaseSerializer</span><span class="p">(</span><span class="n">Field</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;many&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">many_init</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># many=Flaseåˆ™èµ°è¿™æ¡é€»è¾‘ï¼Œå³åªå¤„ç†å•å¯¹è±¡ï¼Œåˆ™è°ƒç”¨objectåŸºç±»çš„__new__åˆ›å»ºå¯¹è±¡ï¼Œç´§æ¥ç€å¯»æ‰¾__init__æ–¹æ³•</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">empty</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># å­˜å‚¨ä¼ å…¥çš„æ¨¡å‹å®ä¾‹æˆ–æŸ¥è¯¢é›†</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">instance</span> <span class="o">=</span> <span class="n">instance</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># è·å–åºåˆ—åŒ–å™¨ä¸­å®šä¹‰çš„æ‰€æœ‰å­—æ®µ</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">fields</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fields</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># åˆå§‹åŒ–å­—æ®µï¼Œå°†å­—æ®µç»‘å®šåˆ°åºåˆ—åŒ–å™¨å®ä¾‹ä¸Šï¼ˆè°ƒç”¨Fieldç±»çš„bindæ–¹æ³•ï¼‰</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">_init_fields</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">_init_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">            <span class="n">field</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="n">field_name</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">ModelSerializer</span><span class="p">(</span><span class="n">Serializer</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># è·å–åœ¨ç±»å®šä¹‰ä¸­æ˜¾å¼å£°æ˜çš„å­—æ®µï¼Œå³å‰é¢æåˆ°çš„id,title,order</span>
</span></span><span class="line"><span class="cl">        <span class="n">declared_fields</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_declared_fields</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># è·å–æ¨¡å‹çš„å­—æ®µä¿¡æ¯ï¼Œå» UserSerializer ä¸­çš„ Meta ä¸­æ‰¾ model å­—æ®µï¼Œå³ model = models.UserInfo</span>
</span></span><span class="line"><span class="cl">        <span class="n">model</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Meta</span><span class="p">,</span> <span class="s1">&#39;model&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># è¿”å›ä¸€ä¸ªåŒ…å«æ¨¡å‹å­—æ®µå’Œå…³ç³»çš„è¯¦ç»†ä¿¡æ¯çš„å­—å…¸,åŒ…å«äº†æ¯ä¸ªå­—æ®µçš„è¯¦ç»†ä¿¡æ¯ï¼Œä¾‹å¦‚å­—æ®µç±»å‹ã€æ˜¯å¦æ˜¯å…³ç³»å­—æ®µï¼ˆå¦‚å¤–é”®ã€å¤šå¯¹å¤šå­—æ®µç­‰ï¼‰ä»¥åŠå…¶ä»–å…ƒæ•°æ®</span>
</span></span><span class="line"><span class="cl">        <span class="n">info</span> <span class="o">=</span> <span class="n">model_meta</span><span class="o">.</span><span class="n">get_field_info</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># æ ¹æ® declared_fields å’Œ info æ¥ç¡®å®šæœ€ç»ˆçš„å­—æ®µåç§°åˆ—è¡¨ã€‚è¿™ä¸ªæ–¹æ³•å¯èƒ½ä¼šæ ¹æ®åºåˆ—åŒ–å™¨çš„é…ç½®å’Œæ¨¡å‹çš„å­—æ®µä¿¡æ¯æ¥æ’é™¤æˆ–åŒ…å«æŸäº›å­—æ®µ</span>
</span></span><span class="line"><span class="cl">        <span class="n">field_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_field_names</span><span class="p">(</span><span class="n">declared_fields</span><span class="p">,</span> <span class="n">info</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">fields</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="c1"># æ ¹æ®æ¨¡å‹å­—æ®µç”Ÿæˆåºåˆ—åŒ–å­—æ®µ</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">field_name</span> <span class="ow">in</span> <span class="n">field_names</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># æ ¹æ®å­—æ®µçš„ç±»å‹å’Œå±æ€§æ¥å†³å®šä½¿ç”¨å“ªä¸ªåºåˆ—åŒ–å™¨å­—æ®µç±»ï¼Œä»¥åŠå¦‚ä½•é…ç½®è¿™ä¸ªå­—æ®µ</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># ç®€å•æ¥è¯´å°±æ˜¯æŠŠæ•°æ®åº“å­—æ®µè½¬æˆåºåˆ—åŒ–å™¨å­—æ®µç±»å¦‚models.CharFieldç±»è½¬æˆCharFieldç±»ï¼Œç„¶åæ”¾å…¥fieldsä¸­</span>
</span></span><span class="line"><span class="cl">            <span class="n">field_class</span><span class="p">,</span> <span class="n">field_kwargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_field</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="n">source</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">depth</span>
</span></span><span class="line"><span class="cl">            <span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># Create the serializer field.</span>
</span></span><span class="line"><span class="cl">            <span class="n">fields</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">field_class</span><span class="p">(</span><span class="o">**</span><span class="n">field_kwargs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># Add in any hidden fields.</span>
</span></span><span class="line"><span class="cl">        <span class="n">fields</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">hidden_fields</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">fields</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Field</span><span class="p">:</span>    
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">bind</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">parent</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># å­—æ®µçš„åç§°ï¼Œç”¨äºåœ¨åºåˆ—åŒ–å™¨ä¸­æ ‡è¯†å­—æ®µ</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">field_name</span> <span class="o">=</span> <span class="n">field_name</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># å­—æ®µæ‰€å±çš„åºåˆ—åŒ–å™¨å®ä¾‹</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">parent</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># å­—æ®µçš„æºåç§°ï¼Œç”¨äºä»æ¨¡å‹å®ä¾‹ä¸­è·å–æ•°æ®ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œsource ä¸å­—æ®µåç§°ç›¸åŒ</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="n">field_name</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="o">==</span> <span class="s1">&#39;*&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">source_attrs</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># å¦‚æœæ˜¯å¤–é”®è·¨è¡¨çš„å½¢å¼å¦‚depart.titleï¼Œå°±ä¼šè¢«åˆ†å‰²æˆä¸€ä¸ªåˆ—è¡¨</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">source_attrs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¿”å›çš„<code>ser</code>æ˜¯<code>UserSerializer</code>åºåˆ—åŒ–å™¨å®ä¾‹ï¼Œæ˜¯ä¸€ä¸ªå¤æ‚çš„å¯¹è±¡ï¼ŒåŒ…å«ä»¥ä¸‹å†…å®¹</p>
<ul>
<li><code>instance</code>ï¼šä¼ å…¥çš„æ¨¡å‹å®ä¾‹ï¼ˆ<code>UserInfo</code> å¯¹è±¡ï¼‰</li>
<li><code>data</code>ï¼šåºåˆ—åŒ–åçš„æ•°æ®ï¼ˆé€šè¿‡è®¿é—® <code>ser.data</code> è·å¾—ï¼‰</li>
<li><code>fields</code>ï¼šåºåˆ—åŒ–å™¨ä¸­å®šä¹‰çš„æ‰€æœ‰å­—æ®µ
<ul>
<li>æ¯ä¸ªå­—æ®µå®ä¾‹éƒ½æœ‰è‡ªå·±çš„å±æ€§å’Œæ–¹æ³•ï¼Œä¾‹å¦‚ï¼š
<ul>
<li><code>field_name</code>ï¼šå­—æ®µçš„åç§°ã€‚</li>
<li><code>parent</code>ï¼šå­—æ®µæ‰€å±çš„åºåˆ—åŒ–å™¨å®ä¾‹ã€‚</li>
<li><code>source</code>ï¼šå­—æ®µçš„æºåç§°ï¼Œç”¨äºä»æ¨¡å‹å®ä¾‹ä¸­è·å–æ•°æ®ã€‚</li>
<li><code>to_representation</code>ï¼šå°†å­—æ®µå€¼è½¬æ¢ä¸ºå¯åºåˆ—åŒ–çš„æ ¼å¼ã€‚</li>
<li><code>to_internal_value</code>ï¼šå°†è¾“å…¥æ•°æ®è½¬æ¢ä¸º Python æ•°æ®ç±»å‹ã€‚</li>
</ul>
</li>
</ul>
</li>
<li><code>errors</code>ï¼šå¦‚æœåºåˆ—åŒ–è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯ï¼Œå­˜å‚¨é”™è¯¯ä¿¡æ¯</li>
</ul>
<p><code>ser.data</code> æ˜¯åºåˆ—åŒ–åçš„æ•°æ®</p>
<ul>
<li>å½“ä½ è®¿é—® <code>ser.data</code> æ—¶ï¼Œåºåˆ—åŒ–å™¨ä¼šå°†æ¨¡å‹å®ä¾‹è½¬æ¢ä¸ºä¸€ä¸ª Python å­—å…¸</li>
<li>è¿™ä¸ªå­—å…¸å¯ä»¥è¢«è¿›ä¸€æ­¥æ¸²æŸ“ä¸º JSON æ ¼å¼ï¼Œä»¥ä¾¿è¿”å›ç»™å®¢æˆ·ç«¯</li>
</ul>
<p>å¦‚æœæ˜¯ç¬¬ä¸€ä¸ªï¼Œå³å¤šä¸ªå¯¹è±¡çš„querysetçš„æƒ…å†µ</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">BaseSerializer</span><span class="p">(</span><span class="n">Field</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># many=Trueï¼Œå¤„ç†å¤šå¯¹è±¡ï¼Œè¿›å…¥ifå†…éƒ¨ï¼Œæ‰§è¡Œmany_initæ–¹æ³•</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;many&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">many_init</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">empty</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">instance</span> <span class="o">=</span> <span class="n">instance</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@classmethod</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">many_init</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">child_serializer</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>  <span class="c1"># å®ä¾‹åŒ–å½“å‰ç±»ï¼ˆå¦‚ UserSerializerï¼‰çš„å•ä¸ªå¯¹è±¡åºåˆ—åŒ–å™¨</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># åˆ›å»ºä¸€ä¸ªå­—å…¸ï¼Œå°† child_serializer ä½œä¸ºå­åºåˆ—åŒ–å™¨ä¼ é€’ç»™ ListSerializer</span>
</span></span><span class="line"><span class="cl">        <span class="n">list_kwargs</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;child&#39;</span><span class="p">:</span> <span class="n">child_serializer</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">meta</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="s1">&#39;Meta&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">list_serializer_class</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">meta</span><span class="p">,</span> <span class="s1">&#39;list_serializer_class&#39;</span><span class="p">,</span> <span class="n">ListSerializer</span><span class="p">)</span>  <span class="c1"># Metaä¸­å¯ä»¥å®šä¹‰ï¼Œé»˜è®¤ä¸ºListSerializer</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">list_serializer_class</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">list_kwargs</span><span class="p">)</span>  <span class="c1"># å®ä¾‹åŒ–ListSerializer()ï¼Œå¹¶å°†æ¯ä¸€ä¸ªUserSerializerå¯¹è±¡ä¼ å…¥</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">ListSerializer</span><span class="p">(</span><span class="n">BaseSerializer</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># å­åºåˆ—åŒ–å™¨å®ä¾‹ï¼Œç”¨äºåºåˆ—åŒ–æ¯ä¸ªå¯¹è±¡</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">child</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;child&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ­¤æ—¶è¿”å›çš„å°±æ˜¯ä¸æ˜¯<code>UserSerializer</code>å¯¹è±¡äº†ï¼Œè€Œæ˜¯<code>ListSerializer</code>å¯¹è±¡ï¼Œå…¶å®å°±æ˜¯ä¸€ä¸ªåˆ—è¡¨ï¼Œåˆ—è¡¨å†…å…ƒç´ éƒ½æ˜¯<code>UserSerializer</code>å¯¹è±¡</p>
<h4 id="åºåˆ—åŒ–è¿‡ç¨‹">åºåˆ—åŒ–è¿‡ç¨‹
</h4><p>ä¸Šä¸€èŠ‚æˆ‘ä»¬ä»‹ç»çš„å®ä¾‹åŒ–ç±»å¯¹åº”çš„æ˜¯<code>ser = UserSerializer(queryset, many=True)</code>è¿™ä¸€è¡Œä»£ç ï¼Œæ­¤æ—¶åªæ˜¯å°†æ•°æ®å°è£…åˆ°å¯¹è±¡ä¸­ï¼ŒçœŸæ­£è§¦å‘åºåˆ—åŒ–åŠ¨ä½œçš„æ˜¯å½“<code>ser.data</code></p>
<h5 id="userserializerç±»">UserSerializerç±»
</h5><p>æˆ‘ä»¬å…ˆè¯´å½“å‰ç±»ï¼Œå³<code>UserSerializer</code>ç±»è§¦å‘åºåˆ—åŒ–çš„æƒ…å†µ</p>
<p>ser.data &ndash;&gt; Serializerä¸­çš„data &ndash;&gt;  BaseSerializerä¸­çš„data &ndash;&gt; self._data = self.to_representation(self.instance)</p>
<p>äºæ˜¯å…³é”®å°±æ˜¯Serializerçš„to_representationæ–¹æ³•ï¼Œæˆ‘ä»¬ä¸‹é¢æ¥åˆ†æï¼š</p>
<p>è·å–æ‰€æœ‰çš„å­—æ®µfields = Serializer._readable_fields __</p>
<ul>
<li>__self._readable_fieldsè¯»å–Serializer.fieldsçš„å€¼</li>
</ul>
<p>å¾ªç¯æ‰€æœ‰çš„å­—æ®µå¯¹è±¡for field in fields:</p>
<ul>
<li>
<p>å»æ•°æ®åº“å¯¹è±¡ä¸­ä¾æ®å­—æ®µçš„ä¿¡æ¯è·å–æ•°æ®attribute = field.get_attribute(instance)</p>
<ul>
<li>
<p>bindæ–¹æ³•å¤„ç†è¿‡çš„sourceï¼Œå¦‚æœæ˜¯å¤–é”®è·¨è¡¨çš„å½¢å¼å¦‚depart.titleï¼Œå°±ä¼šè¢«åˆ†å‰²æˆä¸€ä¸ªåˆ—è¡¨å­˜å…¥self.source_attrs</p>
<p>Field.get_attributeè°ƒç”¨ get_attribute(instance, self.source_attrs)</p>
</li>
<li>
<p>get_attributeå¾ªç¯source_attrså–å‡ºinstanceå¯¹åº”è¯¥sourceçš„å€¼</p>
</li>
</ul>
</li>
<li>
<p>å°†è·å–åˆ°çš„æ•°æ®é€šè¿‡åºåˆ—åŒ–å™¨ç±»çš„to_representationæ–¹æ³•è½¬å˜ä¸€ä¸‹æ ¼å¼åŠ å…¥retä¸­ï¼Œå¦‚IntegerFieldä¼šå¯¹æ•°æ®è¿›è¡Œint()è½¬æ¢ç­‰ç­‰ret[field.field_name] = field.to_representation(attribute)</p>
</li>
<li>
<p>å°†refè¿”å›</p>
</li>
</ul>
<p>ç²¾ç®€ç‰ˆçš„æºç ï¼Œç»“åˆä¸Šè¿°æ–‡å­—æµç¨‹é£Ÿç”¨</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span><span class="lnt">91
</span><span class="lnt">92
</span><span class="lnt">93
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">django.contrib.gis.gdal.raster</span> <span class="kn">import</span> <span class="n">source</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">BaseSerializer</span><span class="p">(</span><span class="n">Field</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@property</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_data&#39;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">instance</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_errors&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># çœŸæ­£å®ç°åºåˆ—åŒ–çš„æ­¥éª¤</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_representation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_validated_data&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_errors&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_representation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">validated_data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_initial</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Serializer</span><span class="p">(</span><span class="n">BaseSerializer</span><span class="p">,</span> <span class="n">metaclass</span><span class="o">=</span><span class="n">SerializerMetaclass</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@property</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">ret</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">data</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">ReturnDict</span><span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="n">serializer</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">to_representation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">ret</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 1.è·å–æ‰€æœ‰çš„å­—æ®µï¼šå…ˆå‰åŠ è½½çš„ InfoSerializer._declared_fields + Metaä¸­æŒ‡å®šçš„fieldså­—æ®µä¸€ä¸€åˆ›å»ºå¯¹è±¡</span>
</span></span><span class="line"><span class="cl">        <span class="n">fields</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_readable_fields</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 2. å¾ªç¯æ‰€æœ‰çš„å­—æ®µå¯¹è±¡(éƒ½æ˜¯åºåˆ—åŒ–å™¨å­—æ®µå¯¹è±¡)</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># å»å­—æ®µå¯¹è±¡ä¸­ä¾æ®å­—æ®µçš„ä¿¡æ¯è·å–æ•°æ®</span>
</span></span><span class="line"><span class="cl">            <span class="n">attribute</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">get_attribute</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># å°†è·å–åˆ°çš„æ•°æ®é€šè¿‡åºåˆ—åŒ–å™¨ç±»çš„to_representationæ–¹æ³•è½¬æ¢ä¸ºé€‚åˆ JSON åºåˆ—åŒ–çš„æ ¼å¼åŠ å…¥retä¸­ï¼Œå¦‚IntegerFieldä¼šå¯¹æ•°æ®è¿›è¡Œint()è½¬æ¢ç­‰ç­‰</span>
</span></span><span class="line"><span class="cl">            <span class="n">ret</span><span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">field_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">to_representation</span><span class="p">(</span><span class="n">attribute</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">ret</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@property</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">_readable_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">            <span class="k">yield</span> <span class="n">field</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Field</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">...</span><span class="n">source</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="n">source</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get_attribute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># æ­¤å¤„çš„source_attrsæ˜¯sourceç»è¿‡bindå¤„ç†åçš„</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># get_attributeå°±å»instanceä¸­å–å‡ºå¯¹åº”çš„å€¼ï¼Œå¦‚åˆ—è¡¨[&#34;depart&#34;,&#34;title&#34;]ï¼Œä¼šå¾ªç¯å»å–å€¼ï¼Œè¿”å›instance.depart.title</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">get_attribute</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_attrs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># æ ¹æ®sourseå’Œinstanceå–å¾—å¯¹åº”çš„å€¼</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">get_attribute</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">attrs</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">attrs</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">Mapping</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="n">instance</span> <span class="o">=</span> <span class="n">instance</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">instance</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">except</span> <span class="n">ObjectDoesNotExist</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">is_simple_callable</span><span class="p">(</span><span class="n">instance</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">instance</span> <span class="o">=</span> <span class="n">instance</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="k">except</span> <span class="p">(</span><span class="ne">AttributeError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">)</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># If we raised an Attribute or KeyError here it&#39;d get treated</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># as an omitted field in `Field.get_attribute()`. Instead we</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># raise a ValueError to ensure the exception is not masked.</span>
</span></span><span class="line"><span class="cl">                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                    <span class="s1">&#39;Exception raised in callable attribute &#34;</span><span class="si">{}</span><span class="s1">&#34;; original exception was: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">exc</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">instance</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">IntegerField</span><span class="p">(</span><span class="n">Field</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">max_value</span> <span class="o">=</span> <span class="mi">111</span>
</span></span><span class="line"><span class="cl">        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">to_representation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">InfoSerializer</span><span class="p">(</span><span class="n">serializers</span><span class="o">.</span><span class="n">ModelSerializer</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="nb">id</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">IntegerField</span><span class="p">()</span>  <span class="c1"># {max_value:111, _creation_counter:0,source=&#34;id&#34;}sourceæœªå®šä¹‰é»˜è®¤ä¸ºå­—æ®µå</span>
</span></span><span class="line"><span class="cl">    <span class="n">title</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">CharField</span><span class="p">()</span>  <span class="c1"># {allow_blank:False, _creation_counter:1}</span>
</span></span><span class="line"><span class="cl">    <span class="n">order</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">IntegerField</span>  <span class="c1"># {max_value:111, _creation_counter:2}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Depart</span>
</span></span><span class="line"><span class="cl">        <span class="n">fields</span> <span class="o">=</span> <span class="s2">&#34;__all__&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="listserializerç±»">ListSerializerç±»
</h5><p>å¦‚æœå·²ç»äº†è§£äº†UserSerializerç±»çš„åºåˆ—åŒ–è¿‡ç¨‹ï¼Œé‚£ä¹ˆListSerializerç±»çš„åºåˆ—åŒ–åªæ˜¯åœ¨ä»–çš„åŸºç¡€ä¸Šå¤šäº†ä¸€ä¸ªå¾ªç¯</p>
<p>ser.data &ndash;&gt; ListSerializerä¸­çš„data &ndash;&gt;  BaseSerializerä¸­çš„data &ndash;&gt; self._data = self.to_representation(self.instance)</p>
<p>ä½†æ˜¯æ­¤æ—¶çš„to_representationä¼˜å…ˆæ‰¾çš„æ˜¯ListSerializerç±»ä¸­è‡ªå·±å®šä¹‰çš„çš„</p>
<p>æˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹ListSerializerç±»æ˜¯å¦‚ä½•å®ä¾‹åŒ–çš„</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="nd">@classmethod</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">many_init</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">child_serializer</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>  <span class="c1"># å®ä¾‹åŒ–UserSerializerå¯¹è±¡</span>
</span></span><span class="line"><span class="cl">        <span class="n">list_kwargs</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;child&#39;</span><span class="p">:</span> <span class="n">child_serializer</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">meta</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="s1">&#39;Meta&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">list_serializer_class</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">meta</span><span class="p">,</span> <span class="s1">&#39;list_serializer_class&#39;</span><span class="p">,</span> <span class="n">ListSerializer</span><span class="p">)</span>  <span class="c1"># Metaä¸­å¯ä»¥å®šä¹‰ï¼Œé»˜è®¤ä¸ºListSerializer</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">list_serializer_class</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">list_kwargs</span><span class="p">)</span>  <span class="c1"># å®ä¾‹åŒ–ListSerializer()ï¼Œå¹¶å°†æ¯ä¸€ä¸ªUserSerializerå¯¹è±¡ä¼ å…¥</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>å¯ä»¥çœ‹åˆ°ï¼ŒListSerializerç±»ä¸­æ˜¯ä¸€ä¸ªä¸ªUserSerializerå¯¹è±¡</p>
<p>å› æ­¤ListSerializerç±»åœ¨to_representationæ–¹æ³•æ—¶å¾ªç¯æ¯ä¸€ä¸ªUserSerializerå¯¹è±¡å¹¶è°ƒç”¨å®ƒçš„to_representationæ–¹æ³•ï¼Œæ˜¾ç„¶ï¼Œå°±æ˜¯ä¸€éåˆä¸€éçš„é‡å¤æˆ‘ä»¬ä¸Šä¸€å°èŠ‚åˆ†æçš„UserSerializerç±»åºåˆ—åŒ–çš„è¿‡ç¨‹ï¼Œæ­¤å¤„ä¾¿ä¸å†å™è¿°</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl">	    
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">ListSerializer</span><span class="p">(</span><span class="n">BaseSerializer</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">to_representation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">iterable</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">all</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">models</span><span class="o">.</span><span class="n">Manager</span><span class="p">)</span> <span class="k">else</span> <span class="n">data</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">child</span><span class="o">.</span><span class="n">to_representation</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">iterable</span>
</span></span><span class="line"><span class="cl">        <span class="p">]</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="æ•°æ®æ ¡éªŒ">æ•°æ®æ ¡éªŒ
</h3><p>è·¯ç”± -&gt; è§†å›¾ -&gt; request.data -&gt; æ ¡éªŒ(åºåˆ—åŒ–å™¨çš„ç±») -&gt; æ“ä½œæ•°æ®</p>
<p>æ¥å£è®¾è®¡çš„å°è§„èŒƒï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">è·å–æ•°æ®</span><span class="err">ï¼š</span>
</span></span><span class="line"><span class="cl">	<span class="n">api</span><span class="o">/</span><span class="n">v1</span><span class="o">/</span><span class="n">user</span><span class="o">/</span>		<span class="o">-&gt;</span><span class="n">GETè¯·æ±‚</span>		<span class="o">-&gt;</span><span class="n">è·å–æ•°æ®åˆ—è¡¨</span>	<span class="n">models</span><span class="o">.</span><span class="n">UserInfo</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">api</span><span class="o">/</span><span class="n">v1</span><span class="o">/</span><span class="n">user</span><span class="o">/</span><span class="mi">2</span><span class="o">/</span>		<span class="o">-&gt;</span><span class="n">GETè¯·æ±‚</span>		 <span class="o">-&gt;</span><span class="n">è·å–å•ä¸ªæ•°æ®</span>	<span class="n">models</span><span class="o">.</span><span class="n">UserInfo</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="n">api</span><span class="o">/</span><span class="n">v1</span><span class="o">/</span><span class="n">user</span>			<span class="o">-&gt;</span><span class="n">POSTè¯·æ±‚</span> 	 <span class="o">-&gt;</span><span class="n">æ–°å¢æ•°æ®</span>
</span></span><span class="line"><span class="cl">    <span class="n">api</span><span class="o">/</span><span class="n">v1</span><span class="o">/</span><span class="n">user</span><span class="o">/</span><span class="mi">3</span><span class="o">/</span>		 <span class="o">-&gt;</span><span class="n">PUTè¯·æ±‚</span>	  <span class="o">-&gt;</span><span class="n">æ›´æ–°æ•°æ®</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä¸‹é¢æˆ‘ä»¬å°±å…ˆçœ‹çœ‹åºåˆ—åŒ–å™¨çš„æ•°æ®æ ¡éªŒåŠŸèƒ½</p>
<h4 id="åŸºæœ¬æ ¡éªŒ">åŸºæœ¬æ ¡éªŒ
</h4><p>åºåˆ—åŒ–å™¨ä¸­å®šä¹‰å¥½å­—æ®µï¼Œå½“è¯·æ±‚åˆ°è¾¾æ—¶ï¼Œè§†å›¾å‡½æ•°è·å–åˆ°è¯·æ±‚æ•°æ®ï¼Œå°†æ•°æ®ä¼ é€’åˆ°åºåˆ—åŒ–å™¨ä¸­è¿›è¡Œæ ¡éªŒï¼Œåˆ©ç”¨ifè¯­å¥ï¼Œå¦‚æœæ ¡éªŒé€šè¿‡ï¼Œè¿”å›æ•°æ®ï¼Œä¸é€šè¿‡ï¼Œè¿”å›é”™è¯¯ä¿¡æ¯</p>
<p>è¿˜æœ‰ç¬¬äºŒç§å†™æ³•ï¼Œåœ¨æ ¡éªŒæ—¶ä¼ å…¥<code>raise_exception=True</code>å‚æ•°ï¼Œæ ¡éªŒé€šè¿‡åˆ™ç¨‹åºè‡ªåŠ¨å‘ä¸‹æ‰§è¡Œï¼Œä¸é€šè¿‡åˆ™æŠ›å‡ºå¼‚å¸¸ï¼Œç”±APIViewç±»çš„dispatchæ–¹æ³•æ¥æ”¶å¼‚å¸¸å¤„ç†</p>
<p>å»ºè®®é‡‡ç”¨ç¬¬ä¸€ç§æ–¹å¼ï¼Œå› ä¸ºå¯ä»¥è‡ªå·±æ§åˆ¶å¼‚å¸¸çš„å¤„ç†ï¼Œå¦‚æ›´æ”¹é”™è¯¯ä¿¡æ¯ç­‰ï¼Œè€Œæ–¹å¼äºŒä¼šç”±DRFå¤„ç†ï¼Œä¸å¯æ§</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">DepartSerializer</span><span class="p">(</span><span class="n">serializers</span><span class="o">.</span><span class="n">Serializer</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">username</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">password</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">DepartView</span><span class="p">(</span><span class="n">APIView</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 1.è·å–åŸå§‹æ•°æ®</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># print(request.data)</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 2.æ ¡éªŒ(å†™æ³•ä¸€)</span>
</span></span><span class="line"><span class="cl">        <span class="n">ser</span> <span class="o">=</span> <span class="n">DepartSerializer</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">ser</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="n">ser</span><span class="o">.</span><span class="n">validated_data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="n">ser</span><span class="o">.</span><span class="n">errors</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># æ ¡éªŒ(å†™æ³•äºŒ)</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># ser = DepartSerializer(data=request.data)</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># ser.is_valid(raise_exception=True)</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># print(ser.validated_data)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="s2">&#34;...&#34;</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="å†…ç½®å’Œæ­£åˆ™æ ¡éªŒ">å†…ç½®å’Œæ­£åˆ™æ ¡éªŒ
</h4><p>ä¸Šä¸€å°èŠ‚æˆ‘ä»¬å­¦ä¹ äº†æ•°æ®æ ¡éªŒçš„åŸºæœ¬æ ¼å¼ï¼Œä½†å¯¹ä¼ é€’æ¥çš„æ•°æ®çš„é™åˆ¶ä»…ä»…æ˜¯éç©ºï¼Œå½“éœ€æ±‚å¢åŠ æ—¶ï¼Œæˆ‘ä»¬éœ€è¦å¯¹å­—æ®µæœ‰æ›´ä¸¥æ ¼çš„æ§åˆ¶ï¼Œå°±éœ€è¦ç”¨åˆ°æ›´å¤šåºåˆ—åŒ–å™¨å†…ç½®çš„è¦æ±‚ä»¥åŠä½¿ç”¨æ­£åˆ™è‡ªå®šä¹‰æ ¼å¼æ ¡éªŒ</p>
<p>å¦‚ä¸‹ï¼Œtitleå­—æ®µå®šä¹‰äº†æœ€å¤§é•¿åº¦å’Œæœ€å°é•¿åº¦ï¼Œorderå®šä¹‰äº†æœ€å¤§å€¼å’Œæœ€å°å€¼ï¼Œlevelå­—æ®µåˆ™æ˜¯ç»™å‡ºäº†choicesï¼Œåªå¯é€‰æ‹©1æˆ–2(è¾“å…¥æ•´å½¢è¿˜æ˜¯å­—ç¬¦ä¸²å¹¶ä¸å½±å“)ã€‚è¿™å‡ ä¸ªæ ¡éªŒæ˜¯åºåˆ—åŒ–å™¨å†…ç½®çš„</p>
<p>é™¤æ­¤ä¹‹å¤–æˆ‘ä»¬è¿˜å¯ä»¥å­å®šä¹‰æ­£åˆ™æ ¡éªŒï¼Œä»£ç ä¸­email1å’Œemail2ä½¿ç”¨çš„æ­£åˆ™è¡¨è¾¾å¼ç›¸åŒï¼Œæ˜¯DRFç»™æˆ‘ä»¬å°è£…å¥½çš„ï¼Œè€Œemail3å°±æ˜¯æˆ‘ä»¬é€šè¿‡è‡ªå·±å†™æ­£åˆ™è¡¨è¾¾å¼åˆ›å»ºçš„è§„åˆ™ï¼Œå¹¶ä¸”å¯ä»¥å®šåˆ¶é”™è¯¯ä¿¡æ¯</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">django.core.validators</span> <span class="kn">import</span> <span class="n">RegexValidator</span><span class="p">,</span> <span class="n">EmailValidator</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">DepartSerializer</span><span class="p">(</span><span class="n">serializers</span><span class="o">.</span><span class="n">Serializer</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">title</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">min_length</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">order</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">IntegerField</span><span class="p">(</span><span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">max_value</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">min_value</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">level</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">ChoiceField</span><span class="p">(</span><span class="n">choices</span><span class="o">=</span><span class="p">[(</span><span class="s2">&#34;1&#34;</span><span class="p">,</span> <span class="s2">&#34;é«˜çº§&#34;</span><span class="p">),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s2">&#34;ä¸­çº§&#34;</span><span class="p">)])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># email1 = serializers.EmailField()</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># email2 = serializers.CharField(validators=[EmailValidator(message=&#34;é‚®ç®±æ ¼å¼é”™è¯¯&#34;)])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">email3</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">RegexValidator</span><span class="p">(</span><span class="sa">r</span><span class="s2">&#34;\d+&#34;</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s2">&#34;æ ¼å¼é”™è¯¯&#34;</span><span class="p">)])</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="é’©å­æ ¡éªŒ">é’©å­æ ¡éªŒ
</h4><p>å’ŒDjangoä¸­çš„Formå’ŒModelFormç±»ä¼¼ï¼ŒDRFçš„åºåˆ—åŒ–å™¨çš„æ•°æ®æ ¡éªŒä¹Ÿæä¾›äº†æ¯ä¸ªå­—æ®µçš„é’©å­æ–¹æ³•å’Œä¸€ä¸ªå…¨å±€çš„é’©å­æ–¹æ³•</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">rest_framework</span> <span class="kn">import</span> <span class="n">exceptions</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">email</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">RegexValidator</span><span class="p">(</span><span class="sa">r</span><span class="s2">&#34;\d+&#34;</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s2">&#34;æ ¼å¼é”™è¯¯&#34;</span><span class="p">)])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">validate_email</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">6</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">ValidationError</span><span class="p">(</span><span class="s2">&#34;å­—æ®µé’©å­æ ¡éªŒå¤±è´¥&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">value</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attrs</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;validate=&#34;</span><span class="p">,</span> <span class="n">attrs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># api_settings.NON_FIELD_ERRORS_KEY</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># raise exceptions.ValidationError(&#34;å…¨å±€é’©å­æ ¡éªŒå¤±è´¥&#34;)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">attrs</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ¯ä¸ªå­—æ®µçš„é’©å­æ–¹æ³•ä»¥<code>validate_å­—æ®µå</code>å‘½ä»¤ï¼Œè€Œå…¨å±€çš„é’©å­æ–¹æ³•ç›´æ¥æ˜¯<code>validate</code>æ–¹æ³•ï¼Œä»–ä¼šåœ¨å„ä¸ªå­—æ®µçš„é’©å­æ–¹æ³•æ ¡éªŒå®Œæˆåå†å¯¹æ•´ä½“è¿›è¡Œæ ¡éªŒï¼Œå› æ­¤ä¼ å…¥çš„attræ˜¯æ‰€æœ‰å­—æ®µå’Œå€¼ç»„æˆçš„æœ‰åºå­—å…¸ï¼Œè€Œå•ä¸ªå­—æ®µé’©å­æ–¹æ³•çš„valueæ˜¯å•ä¸ªå­—æ®µçš„å€¼</p>
<p><img src="/post/python/DRF/image-20241224232824750.png"
	
	
	
	loading="lazy"
	
		alt="image-20241224232824750"
	
	
></p>
<p>æ€»çš„é’©å­æ–¹æ³•çš„é”™è¯¯ä¿¡æ¯ä¹Ÿä¸å­—æ®µçš„é’©å­ä¸åŒ</p>
<p><img src="/post/python/DRF/image-20241224233043880.png"
	
	
	
	loading="lazy"
	
		alt="image-20241224233043880"
	
	
></p>
<p>å®ƒçš„é”™è¯¯ä¿¡æ¯çš„é”®é»˜è®¤æ˜¯<code>non_field_errors</code>ï¼Œå¯ä»¥é€šè¿‡<code>api_settings.NON_FIELD_ERRORS_KEY</code>è¿›è¡Œé…ç½®ï¼Œå¦‚ï¼š</p>
<p><img src="/post/python/DRF/image-20241224233734229.png"
	
	
	
	loading="lazy"
	
		alt="image-20241224233734229"
	
	
></p>
<p>å³å¯å®ç°è‡ªå®šä¹‰é”™è¯¯ä¿¡æ¯çš„é”®</p>
<h4 id="modelæ ¡éªŒ">Modelæ ¡éªŒ
</h4><p>ä¸Šé¢æˆ‘ä»¬å®ç°æ•°æ®æ ¡éªŒä¸€ç›´æ˜¯ä½¿ç”¨Serializerç±»ï¼Œæ‰€æœ‰çš„å­—æ®µéƒ½éœ€è¦æˆ‘ä»¬è‡ªå·±ç¼–å†™ï¼Œå¦‚æœç”¨åˆ°çš„å­—æ®µå¤§å¤šéƒ½æ˜¯å°†æ•°æ®åº“ä¸­çš„å­—æ®µï¼Œé‚£ä¹ˆå°±å¯ä»¥é‡‡ç”¨ModelSerializeræ¥è‡ªåŠ¨ç”Ÿæˆå­—æ®µ</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">DepartModelSerializer</span><span class="p">(</span><span class="n">serializers</span><span class="o">.</span><span class="n">ModelSerializer</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">email3</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">RegexValidator</span><span class="p">(</span><span class="sa">r</span><span class="s2">&#34;\d+&#34;</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s2">&#34;æ ¼å¼é”™è¯¯&#34;</span><span class="p">)])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Depart</span>
</span></span><span class="line"><span class="cl">        <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="s1">&#39;order&#39;</span><span class="p">,</span> <span class="s1">&#39;count&#39;</span><span class="p">,</span> <span class="s1">&#39;email3&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="n">extra_kwargs</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&#34;max_length&#34;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s2">&#34;min_length&#34;</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;order&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&#34;min_value&#34;</span><span class="p">:</span> <span class="mi">5</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;count&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&#34;validators&#34;</span><span class="p">:</span> <span class="p">[</span><span class="n">RegexValidator</span><span class="p">(</span><span class="sa">r</span><span class="s2">&#34;\d+&#34;</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s2">&#34;æ ¼å¼é”™è¯¯&#34;</span><span class="p">)]}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>åªéœ€è¦åœ¨<code>class Meta</code>çš„<code>fiedls</code>å¡«å…¥éœ€è¦ç”Ÿæˆçš„å­—æ®µå³å¯ï¼Œè‹¥è¿˜éœ€è¦è‡ªå®šä¹‰å­—æ®µå°±åƒSerializerç±»ä¸€æ ·è‡ªå®šä¹‰ï¼Œç„¶ååŠ å…¥åˆ°fieldsåˆ—è¡¨ä¸­å³å¯</p>
<p>é‡‡ç”¨è¿™ç§æ–¹å¼ä¸éœ€è¦æˆ‘ä»¬è‡ªå·±ç¼–å†™å­—æ®µï¼Œé‚£ä¹ˆæ ¡éªŒè§„åˆ™æ€ä¹ˆæ·»åŠ å‘¢ï¼Ÿ</p>
<p>åªéœ€è¦åœ¨<code>class Meta</code>ä¸­<code>extra_kwargs</code>å­—å…¸ä¸­ç¼–å†™å³å¯ï¼Œç¤ºä¾‹å¦‚ä¸Š</p>
<h4 id="ä¿å­˜æ•°æ®ä¹‹æ™®é€šå­—æ®µ">ä¿å­˜æ•°æ®ä¹‹æ™®é€šå­—æ®µ
</h4><p>å¦‚æœé‡‡ç”¨çš„æ˜¯Serializerç±»çš„åºåˆ—åŒ–å™¨ï¼Œé‚£ä¹ˆåœ¨ä¿å­˜æ•°æ®æ—¶éœ€è¦æ‰‹åŠ¨çš„è¿›è¡ŒORMæ“ä½œä¿å­˜æ•°æ®ï¼Œä½†å¦‚æœä½¿ç”¨äº†</p>
<p>ModelSerializerç±»çš„åºåˆ—åŒ–å™¨ï¼Œå°±å¯ä»¥ä½¿ç”¨<code>.save</code>å®ç°ä¾¿æ·æ“ä½œï¼Œä»–ä¼šä¸€é”®ä¿å­˜åˆ°æ•°æ®åº“å¯¹åº”çš„è¡¨ä¸­</p>
<p>ä½†æ˜¯é—®é¢˜æ¥äº†?å¦‚æœç”¨æˆ·ä¼ å…¥çš„å­—æ®µæ•°å¤§äºæˆ–å°äºæ•°æ®è¡¨å¯¹åº”çš„å­—æ®µæ•°ï¼Œæˆ‘ä»¬èƒ½ä¸èƒ½æ‰‹åŠ¨è°ƒæ•´ï¼Ÿç­”æ¡ˆæ˜¯è‚¯å®šçš„</p>
<p><strong>å­—æ®µè¿‡å¤š</strong>ï¼Œå¦‚ä¸‹è¿°ä¾‹å­ï¼Œemail3æ˜¯å¤šä½™å­—æ®µï¼Œä¸éœ€è¦å­˜å…¥æ•°æ®åº“ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨è¿›è¡Œ<code>.save</code>ä¹‹å‰å°†å…¶<code>pop</code>æ‰ï¼Œç”¨ä¸€ä¸ªå˜é‡æ¥æ”¶ï¼Œå¯ç”¨äºåç»­åˆ¤æ–­ã€‚è¯¥æ“ä½œå¯ç”¨äºæ³¨å†Œæ—¶çš„é‡å¤è¾“å…¥å¯†ç æ­¥éª¤</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">DepartModelSerializer</span><span class="p">(</span><span class="n">serializers</span><span class="o">.</span><span class="n">ModelSerializer</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">email3</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">RegexValidator</span><span class="p">(</span><span class="sa">r</span><span class="s2">&#34;\d+&#34;</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s2">&#34;æ ¼å¼é”™è¯¯&#34;</span><span class="p">)])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Depart</span>
</span></span><span class="line"><span class="cl">        <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="s1">&#39;order&#39;</span><span class="p">,</span> <span class="s1">&#39;count&#39;</span><span class="p">,</span> <span class="s1">&#39;email3&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="n">extra_kwargs</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&#34;max_length&#34;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s2">&#34;min_length&#34;</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;order&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&#34;min_value&#34;</span><span class="p">:</span> <span class="mi">5</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;count&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&#34;validators&#34;</span><span class="p">:</span> <span class="p">[</span><span class="n">RegexValidator</span><span class="p">(</span><span class="sa">r</span><span class="s2">&#34;\d+&#34;</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s2">&#34;æ ¼å¼é”™è¯¯&#34;</span><span class="p">)]}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">DepartView</span><span class="p">(</span><span class="n">APIView</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">ser</span> <span class="o">=</span> <span class="n">DepartModelSerializer</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">ser</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;è§†å›¾&#34;</span><span class="p">,</span> <span class="n">ser</span><span class="o">.</span><span class="n">validated_data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">email3</span> <span class="o">=</span> <span class="n">ser</span><span class="o">.</span><span class="n">validated_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;email3&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">ser</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="n">ser</span><span class="o">.</span><span class="n">errors</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="s2">&#34;...&#34;</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>å­—æ®µè¿‡å°‘</strong>ï¼Œæ¯”å¦‚åˆ›å»ºç”¨æˆ·æ—¶æ•°æ®åº“ä¸­è¦æ·»åŠ æ“ä½œäººidï¼Œè¿™æ˜¾ç„¶ä¸æ˜¯ç”¨æˆ·è¾“å…¥çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å°±éœ€è¦æ‰‹åŠ¨æ·»åŠ æ•°æ®</p>
<p>ä¸‹åˆ—ä»£ç ä¸­æ•°æ®åº“æœ‰countå­—æ®µï¼Œä½†å‰ç«¯ç”¨æˆ·å¹¶æœªè¾“å…¥ï¼Œå› æ­¤ä¾¿å¯ä»¥åœ¨<code>.save</code>æ—¶å°†countå­—æ®µä½œä¸ºå‚æ•°ä¼ å…¥</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">DepartModelSerializer</span><span class="p">(</span><span class="n">serializers</span><span class="o">.</span><span class="n">ModelSerializer</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Depart</span>
</span></span><span class="line"><span class="cl">        <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="s1">&#39;order&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="n">extra_kwargs</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&#34;max_length&#34;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s2">&#34;min_length&#34;</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;order&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&#34;min_value&#34;</span><span class="p">:</span> <span class="mi">5</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">DepartView</span><span class="p">(</span><span class="n">APIView</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">ser</span> <span class="o">=</span> <span class="n">DepartModelSerializer</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">ser</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;è§†å›¾&#34;</span><span class="p">,</span> <span class="n">ser</span><span class="o">.</span><span class="n">validated_data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">ser</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">count</span><span class="o">=</span><span class="mi">11</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="n">ser</span><span class="o">.</span><span class="n">errors</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="s2">&#34;...&#34;</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="ä¿å­˜æ•°æ®ä¹‹fkå’Œm2må­—æ®µ">ä¿å­˜æ•°æ®ä¹‹FKå’ŒM2Må­—æ®µ
</h4><p>ä¸Šä¸€å°èŠ‚æˆ‘ä»¬ä»‹ç»äº†æ™®é€šå­—æ®µçš„ä¿å­˜ï¼Œä½†æ˜¯è¿˜æœ‰ä¸¤ç§æ¯”è¾ƒç‰¹æ®Šçš„å­—æ®µï¼Œå¦‚æœæ˜¯ForeignKeyå­—æ®µå’ŒManytoManyå­—æ®µï¼Œè¯¥æ€ä¹ˆè¿›è¡Œä¿å­˜</p>
<p>æˆ‘ä»¬å…ˆçœ‹FK</p>
<p><img src="/post/python/DRF/image-20241225104844380.png"
	
	
	
	loading="lazy"
	
		alt="image-20241225104844380"
	
	
></p>
<p>å¦‚å›¾ï¼Œdepartæ˜¯ä¸€ä¸ªFKï¼Œå…³è”åˆ°èŒä½è¡¨ï¼Œç”¨æˆ·åœ¨è¾“å…¥æ—¶å®é™…ä¸Šè¾“å…¥çš„æ˜¯èŒä½çš„idï¼Œå¦‚æœidä¸å­˜åœ¨å°±ä¼šæŠ¥é”™ã€‚å¦‚æœéœ€æ±‚å‡çº§ï¼Œå°±ç®—è¯¥èŒä½å­˜åœ¨ï¼Œè¿˜è¦åšè¿›ä¸€æ­¥æ ¡éªŒï¼Œå°±éœ€è¦æˆ‘ä»¬çš„é’©å­æ–¹æ³•ï¼Œåœ¨é’©å­ä¸­ï¼Œvalueå€¼å…¶å®å·²ç»æ˜¯ç”¨æˆ·ä¼ å…¥çš„idå¯¹åº”çš„departå¯¹è±¡äº†ï¼Œæˆ‘ä»¬å°±å¯ä»¥å¯¹å¯¹è±¡è¿›è¡Œæ“ä½œã€æ ¡éªŒ</p>
<p>ç„¶åæˆ‘ä»¬æ¥çœ‹M2Mçš„æƒ…å†µ</p>
<p><img src="/post/python/DRF/image-20241225110343348.png"
	
	
	
	loading="lazy"
	
		alt="image-20241225110343348"
	
	
></p>
<p>tagsæ˜¯ä¸€ä¸ªM2Mï¼Œå…³è”userinfoå’Œtagsè¡¨ï¼Œç”¨æˆ·ä¼ å…¥ä¸€ä¸ªåˆ—è¡¨ï¼Œ1å’Œ2å¯¹åº”tagsè¡¨çš„idï¼Œè¡¨ç¤ºå½“å‰åˆ›å»ºç”¨æˆ·ä¸id=1å’Œid=2çš„æ ‡ç­¾éƒ½æœ‰å…³è”ï¼Œäºæ˜¯åœ¨userinfo_tagsè¡¨ä¸­ç”Ÿæˆä¸¤æ¡è®°å½•</p>
<p>æ­¤æ—¶ï¼Œé’©å­æ–¹æ³•ä¸­çš„valueæ˜¯ä¸€ä¸ªåˆ—è¡¨ï¼Œæ¯ä¸€ä¸ªå…ƒç´ éƒ½æ˜¯ä¼ å…¥çš„idå¯¹åº”çš„tagså¯¹è±¡</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">UsModelSerializer</span><span class="p">(</span><span class="n">serializers</span><span class="o">.</span><span class="n">ModelSerializer</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">UserInfo</span>
</span></span><span class="line"><span class="cl">        <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;age&#39;</span><span class="p">,</span> <span class="s1">&#39;gender&#39;</span><span class="p">,</span> <span class="s1">&#39;depart&#39;</span><span class="p">,</span> <span class="s1">&#39;tags&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">USView</span><span class="p">(</span><span class="n">APIView</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">ser</span> <span class="o">=</span> <span class="n">UsModelSerializer</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">ser</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;è§†å›¾&#34;</span><span class="p">,</span> <span class="n">ser</span><span class="o">.</span><span class="n">validated_data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">ser</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="n">ser</span><span class="o">.</span><span class="n">errors</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="s2">&#34;...&#34;</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>åœ¨FKçš„é‚£ä¸ªç¤ºä¾‹ä¸­ï¼Œå­—æ®µåä¸ºdepartï¼Œä½†æˆ‘ä»¬ä¼ å…¥çš„å®é™…ä¸Šæ˜¯depart_idï¼Œé‚£ä¹ˆå¦‚æœç›´æ¥åœ¨fieldsä¸­å†™depart_idè€Œä¸æ˜¯departä¼šå‘ç”Ÿä»€ä¹ˆå‘¢?</p>
<p>ModelSerializeråœ¨å¤„ç†æ•°æ®åº“å­—æ®µæ—¶å…¶å®å¹¶æ²¡æœ‰depart_idè¿™ä¸ªå­—æ®µï¼Œä»–åªæœ‰ä¸€ä¸ªFKå­—æ®µå«departï¼Œæ‰€ä»¥ä»–ä¼šæŠ¥é”™ï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥é€šè¿‡è‡ªå®šä¹‰çš„æ–¹å¼å°±å¯ä»¥å®ç°</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">UsModelSerializer</span><span class="p">(</span><span class="n">serializers</span><span class="o">.</span><span class="n">ModelSerializer</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">depart_id</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">IntegerField</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">UserInfo</span>
</span></span><span class="line"><span class="cl">        <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;age&#39;</span><span class="p">,</span> <span class="s1">&#39;gender&#39;</span><span class="p">,</span> <span class="s1">&#39;depart_id&#39;</span><span class="p">,</span> <span class="s1">&#39;tags&#39;</span><span class="p">]</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>åœ¨M2Må­—æ®µä¸­ï¼Œç”¨æˆ·è¾“å…¥çš„æ˜¯å­˜æ”¾tagså¯¹è±¡çš„idåˆ—è¡¨ï¼Œè€Œåˆ°è¾¾é’©å­æ–¹æ³•æ˜¯å­˜æ”¾tagså¯¹è±¡çš„åˆ—è¡¨ï¼Œé‚£ä¹ˆæˆ‘ä»¬èƒ½ä¸èƒ½è‡ªå®šä¹‰ï¼Œè®©ä»–ä¼ å…¥é’©å­æ—¶å°±æ˜¯ç”¨æˆ·è¾“å…¥çš„å­˜æ”¾tagså¯¹è±¡çš„idåˆ—è¡¨ï¼Œç„¶åå¯ä»¥è¿›ä¸€æ­¥åšæ“ä½œï¼Œæœ€åè¿”å›çš„è¿˜æ˜¯å­˜æ”¾tagså¯¹è±¡çš„åˆ—è¡¨ï¼Œä½¿ä¿å­˜æ•°æ®çš„åŠŸèƒ½ä¸å—å½±å“</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">UsModelSerializer</span><span class="p">(</span><span class="n">serializers</span><span class="o">.</span><span class="n">ModelSerializer</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">tags</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">ListField</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">UserInfo</span>
</span></span><span class="line"><span class="cl">        <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;age&#39;</span><span class="p">,</span> <span class="s1">&#39;gender&#39;</span><span class="p">,</span> <span class="s1">&#39;depart&#39;</span><span class="p">,</span> <span class="s1">&#39;tags&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">validated_tags</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">queryset</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Tag</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">id__in</span><span class="o">=</span><span class="n">value</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">queryset</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">USView</span><span class="p">(</span><span class="n">APIView</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">ser</span> <span class="o">=</span> <span class="n">UsModelSerializer</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">ser</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;è§†å›¾&#34;</span><span class="p">,</span> <span class="n">ser</span><span class="o">.</span><span class="n">validated_data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">ser</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="n">ser</span><span class="o">.</span><span class="n">errors</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="s2">&#34;...&#34;</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="æ•°æ®æ ¡éªŒæ€»ç»“">æ•°æ®æ ¡éªŒæ€»ç»“
</h4><ol>
<li>è‡ªå®šä¹‰ Serializer + å­—æ®µ</li>
<li>è‡ªå®šä¹‰ Serializer + å­—æ®µï¼ˆå†…ç½®åŠ æ­£åˆ™ï¼‰</li>
<li>è‡ªå®šä¹‰ Serializer + å­—æ®µï¼ˆå†…ç½®åŠ æ­£åˆ™ï¼‰+ å­—æ®µé’©å­ + å…¨å±€é’©å­</li>
<li>è‡ªå®šä¹‰ ModelSerializer + è‡ªå®šä¹‰å­—æ®µ + extra_kwargs + saveä¿å­˜æ•°æ®ï¼ˆå­—æ®µå¤šï¼špopï¼›å­—æ®µå°‘ï¼šå‚æ•°ä¼ å…¥ï¼‰</li>
<li>è‡ªå®šä¹‰ ModelSerializer + FK      -&gt;     è‡ªåŠ¨è·å–å…³è”æ•°æ® depart    -&gt;     è‡ªå®šä¹‰depart_idå­—æ®µ</li>
<li>è‡ªå®šä¹‰ ModelSerializer + M2M   -&gt;     è·å–å…³è”æ•°æ®                      -&gt;      ListFieldæˆ–DictField  +  é’©å­</li>
</ol>
<h4 id="æ ¡éªŒå’Œåºåˆ—åŒ–äºŒåˆä¸€">æ ¡éªŒå’Œåºåˆ—åŒ–äºŒåˆä¸€
</h4><p>åºåˆ—åŒ–ä¸æ•°æ®æ ¡éªŒç»“åˆ</p>
<p>åˆ›å»ºç”¨æˆ· : {&ldquo;user&rdquo;:&ldquo;xxx&rdquo;,&ldquo;password&rdquo;:&ldquo;xxx&rdquo;}</p>
<ul>
<li>æ•°æ®æ ¡éªŒ</li>
<li>è¿æ¥æ•°æ®åº“ï¼Œä¿å­˜æ•°æ®ï¼Œå¹¶è¿”å›æ•°æ®åº“å¯¹è±¡
<ul>
<li>ä¸ºä»€ä¹ˆä¸ç›´æ¥è¿”å›åˆ›å»ºç”¨æˆ·æ—¶ä¼ é€’çš„ {&ldquo;user&rdquo;:&ldquo;xxx&rdquo;,&ldquo;password&rdquo;:&ldquo;xxx&rdquo;}</li>
<li>å› ä¸ºæ•°æ®åº“æœ‰äº›å­—æ®µæ—¶è‡ªåŠ¨ç”Ÿæˆçš„ï¼Œåªæœ‰è¿”å›æ•°æ®åº“å¯¹è±¡æ‰èƒ½ä¿è¯æ•°æ®çš„å®Œæ•´</li>
</ul>
</li>
<li>å°†æ•°æ®åº“å¯¹è±¡åºåˆ—åŒ–å†è¿”å›</li>
</ul>
<h5 id="ä¸¤ä¸ªåºåˆ—åŒ–å™¨åˆ†åˆ«å®ç°">ä¸¤ä¸ªåºåˆ—åŒ–å™¨åˆ†åˆ«å®ç°
</h5><p>æˆ‘ä»¬åœ¨æ•°æ®æ ¡éªŒå¼€å¤´éƒ¨åˆ†å°±æå‡ºè¿‡è¿™ç§éœ€æ±‚ï¼Œå½“æ•°æ®æ ¡éªŒé€šè¿‡å­˜å…¥æ•°æ®åº“ï¼Œè¿˜éœ€å°†åˆ›å»ºçš„æ•°æ®åº“å¯¹è±¡ç»è¿‡åºåˆ—åŒ–è¿”å›å›å»ï¼Œç°åœ¨æˆ‘ä»¬å°±æ¥çœ‹çœ‹è¿™ä¸ªå®ç°</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">DpModelSerializer</span><span class="p">(</span><span class="n">serializers</span><span class="o">.</span><span class="n">ModelSerializer</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Depart</span>
</span></span><span class="line"><span class="cl">        <span class="n">fields</span> <span class="o">=</span> <span class="s2">&#34;__all__&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Dp2ModelSerializer</span><span class="p">(</span><span class="n">serializers</span><span class="o">.</span><span class="n">ModelSerializer</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Depart</span>
</span></span><span class="line"><span class="cl">        <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;id&#34;</span><span class="p">,</span> <span class="s2">&#34;title&#34;</span><span class="p">,</span> <span class="s2">&#34;count&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">DpView</span><span class="p">(</span><span class="n">APIView</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">ser</span> <span class="o">=</span> <span class="n">DpModelSerializer</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">ser</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">            <span class="n">instance</span> <span class="o">=</span> <span class="n">ser</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">xx</span> <span class="o">=</span> <span class="n">Dp2ModelSerializer</span><span class="p">(</span><span class="n">instance</span><span class="o">=</span><span class="n">instance</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">xx</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">ser</span><span class="o">.</span><span class="n">errors</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä¸Šè¿°ä»£ç åœ¨æ•°æ®æ ¡éªŒæ—¶ä½¿ç”¨DpModelSerializerï¼Œæ ¡éªŒé€šè¿‡ä¿å­˜åˆ°æ•°æ®åº“ï¼Œ<code>ser.save()</code>ä¼šè¿”å›å­˜å…¥æ•°æ®åº“çš„å¯¹è±¡ï¼Œç”¨instanceæ¥æ”¶ï¼Œå†</p>
<p>ä¼ é€’ç»™å®Œæˆåºåˆ—åŒ–åŠŸèƒ½çš„Dp2ModelSerializerï¼Œå®ç°éœ€æ±‚</p>
<h5 id="ä¸€ä¸ªåºåˆ—åŒ–å™¨å®ç°">ä¸€ä¸ªåºåˆ—åŒ–å™¨å®ç°
</h5><p>è¿™æ ·åˆ†å¼€å†™ä¸¤ä¸ªåºåˆ—åŒ–å™¨æ„Ÿè§‰æœ‰ç‚¹ç¹æ‚ï¼Œå¯ä»¥ä½¿ç”¨ä¸€ä¸ªå—ï¼Ÿç­”æ¡ˆæ˜¯å¯ä»¥çš„ï¼Œä½†æ˜¯è¿”å›åºåˆ—åŒ–æ—¶è¿”å›ç»™ç”¨æˆ·çš„ä¹Ÿæ˜¯æ•°æ®åº“ä¸­çš„æ‰€æœ‰å­—æ®µï¼Œå› ä¸º<code>fields = &quot;__all__&quot;</code></p>
<p>å¯ä»¥åªä½¿ç”¨ä¸€ä¸ªåºåˆ—åŒ–å™¨ï¼Œå®ç°æ•°æ®æ ¡éªŒä¿å­˜æ•°æ®æ—¶æ ¡éªŒä¿å­˜æ‰€æœ‰å­—æ®µï¼Œä½†æ˜¯åºåˆ—åŒ–è¿”å›æ—¶åªè¿”å›ä¸‰ä¸ªå­—æ®µå—ï¼Ÿè¿™æ—¶å€™å°±è¦ç”¨åˆ°å­—æ®µçš„ä¸¤ä¸ªç‰¹æ®Šå‚æ•°<code>read_only</code>å’Œ<code>write_only</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">DpModelSerializer</span><span class="p">(</span><span class="n">serializers</span><span class="o">.</span><span class="n">ModelSerializer</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Depart</span>
</span></span><span class="line"><span class="cl">        <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;id&#34;</span><span class="p">,</span> <span class="s2">&#34;title&#34;</span><span class="p">,</span> <span class="s2">&#34;order&#34;</span><span class="p">,</span> <span class="s2">&#34;count&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="n">extra_kwargs</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;id&#34;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&#34;read_only&#34;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;count&#34;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&#34;write_only&#34;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä¸Šè¿°ä»£ç å®ç°åœ¨è¾“å…¥æ—¶åªéœ€è¦è¾“å…¥titleã€orderã€countä¸‰ä¸ªå­—æ®µï¼Œåœ¨è¿”å›ç»™ç”¨æˆ·æ—¶åªè¿”å›idã€titleã€orderä¸‰ä¸ªå­—æ®µã€‚å®Œæˆå…±ç”¨ä¸€ä¸ªåºåˆ—åŒ–å™¨å®ç°æ•°æ®æ ¡éªŒä¿å­˜å’Œæ•°æ®åºåˆ—åŒ–å­—æ®µçš„çµæ´»è‡ªå®šä¹‰ã€‚å¯ä»¥åº”ç”¨åœ¨ç”¨æˆ·æ³¨å†Œæ—¶ï¼Œåœ¨æ³¨å†Œæ—¶éœ€è¦ç”¨æˆ·è¾“å…¥å¯†ç ï¼Œä½†æ˜¯è¿”å›æ•°æ®å±•ç¤ºæ—¶ä¸ä¼šå°†å¯†ç è¿”å›</p>
<p>ä¸Šé¢æˆ‘ä»¬å·²ç»å®ç°äº†æ§åˆ¶å“ªäº›å­—æ®µè¿”å›ï¼Œä½†æ˜¯è¿”å›çš„æ ¼å¼è¿˜éœ€è¦è¿›ä¸€æ­¥æ“ä½œã€‚ä¾‹å¦‚å¯¹äºä¸€ä¸ªchoicesçš„genderå­—æ®µï¼Œè¿”å›æ—¶æ˜¯è¿”å›æ•°æ®ä¸­çœŸå®å­˜å‚¨çš„1æˆ–2å—ï¼Œæ˜¾ç„¶ä¸æ˜¯ï¼Œè€Œåº”è¯¥æ˜¯å¯¹åº”çš„ç”·å’Œå¥³ã€‚åŒæ ·çš„è¿˜æœ‰FKå­—æ®µdepartï¼Œæˆ‘ä»¬åº”è¯¥å•å•è¿”å›ä¸€ä¸ªdepart_idå—ï¼Ÿæ˜¾ç„¶ä¹Ÿä¸æ˜¯ï¼Œè€Œæ˜¯åº”è¯¥å°†å…¶depart_titleæˆ–å…¶ä»–ä¿¡æ¯è¿”å›ï¼Œè¿™åº”è¯¥æ€ä¹ˆå®ç°å‘¢ï¼Ÿ</p>
<p><img src="/post/python/DRF/image-20241225204254510.png"
	
	
	
	loading="lazy"
	
		alt="image-20241225204254510"
	
	
></p>
<ul>
<li>choiceså­—æ®µ</li>
</ul>
<p>æ–¹å¼ä¸€ï¼šè‡ªå®šä¹‰ä¸€ä¸ªgender_infoå­—æ®µè·å–ç”·æˆ–å¥³çš„æ–‡å­—ä¿¡æ¯ï¼Œç„¶åå°†gender_infoå’Œgenderå­—æ®µåˆ†åˆ«è®¾ç½®read_onlyå’Œwrite_only</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">UusModelSerializer</span><span class="p">(</span><span class="n">serializers</span><span class="o">.</span><span class="n">ModelSerializer</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">gender_info</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="s2">&#34;get_gender_display&#34;</span><span class="p">,</span> <span class="n">read_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">UserInfo</span>
</span></span><span class="line"><span class="cl">        <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;id&#34;</span><span class="p">,</span> <span class="s2">&#34;name&#34;</span><span class="p">,</span> <span class="s2">&#34;age&#34;</span><span class="p">,</span> <span class="s2">&#34;gender&#34;</span><span class="p">,</span> <span class="s2">&#34;depart&#34;</span><span class="p">,</span> <span class="s2">&#34;gender_info&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="n">extra_kwargs</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;id&#34;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&#34;read_only&#34;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;gender&#34;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&#34;write_only&#34;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ–¹å¼äºŒï¼šè‡ªå®šä¹‰ä¸€ä¸ªæ–¹æ³•å­—æ®µï¼ˆè‡ªå¸¦read_onlyï¼‰ï¼Œè¿”å›ä¸€ä¸ªå­—å…¸ï¼ŒåŒ…å«å¤šä¸ªä¿¡æ¯</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">UusModelSerializer</span><span class="p">(</span><span class="n">serializers</span><span class="o">.</span><span class="n">ModelSerializer</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">v1</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">SerializerMethodField</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">UserInfo</span>
</span></span><span class="line"><span class="cl">        <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;id&#34;</span><span class="p">,</span> <span class="s2">&#34;name&#34;</span><span class="p">,</span> <span class="s2">&#34;age&#34;</span><span class="p">,</span> <span class="s2">&#34;gender&#34;</span><span class="p">,</span> <span class="s2">&#34;depart&#34;</span><span class="p">,</span> <span class="s2">&#34;v1&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="n">extra_kwargs</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;id&#34;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&#34;read_only&#34;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;gender&#34;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&#34;write_only&#34;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get_v1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">{</span><span class="s2">&#34;id&#34;</span><span class="p">:</span> <span class="n">obj</span><span class="o">.</span><span class="n">gender</span><span class="p">,</span> <span class="s2">&#34;text&#34;</span><span class="p">:</span> <span class="n">obj</span><span class="o">.</span><span class="n">get_gender_display</span><span class="p">()}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="/post/python/DRF/image-20241225205712042.png"
	
	
	
	loading="lazy"
	
		alt="image-20241225205712042"
	
	
></p>
<ul>
<li>FKå­—æ®µ</li>
</ul>
<p>æ–¹å¼ä¸€ï¼šè‡ªå®šä¹‰å­—æ®µåŠ read_onlyï¼ŒæŒ‡å®šsourceå…³è”å¤–é”®æ•°æ®</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">UusModelSerializer</span><span class="p">(</span><span class="n">serializers</span><span class="o">.</span><span class="n">ModelSerializer</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">v1</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="s2">&#34;depart.title&#34;</span><span class="p">,</span> <span class="n">read_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">UserInfo</span>
</span></span><span class="line"><span class="cl">        <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;id&#34;</span><span class="p">,</span> <span class="s2">&#34;name&#34;</span><span class="p">,</span> <span class="s2">&#34;age&#34;</span><span class="p">,</span> <span class="s2">&#34;gender&#34;</span><span class="p">,</span> <span class="s2">&#34;depart&#34;</span><span class="p">,</span> <span class="s2">&#34;v1&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="n">extra_kwargs</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;id&#34;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&#34;read_only&#34;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;depart&#34;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&#34;write_only&#34;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ–¹å¼äºŒï¼šåˆ©ç”¨åºåˆ—åŒ–å™¨çš„åµŒå¥—</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">P1ModelSerializer</span><span class="p">(</span><span class="n">serializers</span><span class="o">.</span><span class="n">ModelSerializer</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Depart</span>
</span></span><span class="line"><span class="cl">        <span class="n">fields</span> <span class="o">=</span> <span class="s2">&#34;__all__&#34;</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">UusModelSerializer</span><span class="p">(</span><span class="n">serializers</span><span class="o">.</span><span class="n">ModelSerializer</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">v1</span> <span class="o">=</span> <span class="n">P1ModelSerializer</span><span class="p">(</span><span class="n">read_only</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="s2">&#34;depart&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">UserInfo</span>
</span></span><span class="line"><span class="cl">        <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;id&#34;</span><span class="p">,</span> <span class="s2">&#34;name&#34;</span><span class="p">,</span> <span class="s2">&#34;age&#34;</span><span class="p">,</span> <span class="s2">&#34;gender&#34;</span><span class="p">,</span> <span class="s2">&#34;depart&#34;</span><span class="p">,</span> <span class="s2">&#34;v1&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="n">extra_kwargs</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;id&#34;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&#34;read_only&#34;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;depart&#34;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&#34;write_only&#34;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="/post/python/DRF/image-20241225210517195.png"
	
	
	
	loading="lazy"
	
		alt="image-20241225210517195"
	
	
></p>
<p>å¦‚æœæ˜¯äºŒåˆä¸€çš„å½¢å¼ï¼Œè§†å›¾å‡½æ•°ä¸­å¯ä»¥è¿›ä¸€æ­¥ç¼©å†™</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">UusView</span><span class="p">(</span><span class="n">APIView</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">ser</span> <span class="o">=</span> <span class="n">UusModelSerializer</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">ser</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">            <span class="n">ser</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">ser</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">ser</span><span class="o">.</span><span class="n">errors</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä¸éœ€è¦é‡å¤æŒ‡å®šæ•°æ®æ ¡éªŒå’Œåºåˆ—åŒ–æ•°æ®çš„åºåˆ—åŒ–å™¨ï¼Œåªéœ€å¦‚ä¸Šç¼–å†™å³å¯å®ç°åŒæ ·çš„åŠŸèƒ½</p>
<h4 id="æ‹“å±•">æ‹“å±•
</h4><p>ç°åœ¨æœ‰ä¸€ä¸ªéœ€æ±‚ï¼Œè¦æ±‚ç¼–å†™ä¸€ä¸ªåºåˆ—åŒ–ç±»ï¼Œå®ç°åˆ›å»ºç”¨æˆ·</p>
<p>æä¾›ï¼š{&ldquo;name&rdquo;:&ldquo;xsss&rdquo;,&ldquo;age&rdquo;:&ldquo;11&rdquo;,&ldquo;gender&rdquo;:1}</p>
<p>è¿”å›ï¼š{&ldquo;id&rdquo;=1,&ldquo;name&rdquo;:&ldquo;xsss&rdquo;,&ldquo;gender&rdquo;:&ldquo;ç”·&rdquo;}</p>
<p>modelç±»å¦‚ä¸‹</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">NbUserInfo</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">verbose_name</span><span class="o">=</span><span class="s2">&#34;å§“å&#34;</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">32</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">age</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">IntegerField</span><span class="p">(</span><span class="n">verbose_name</span><span class="o">=</span><span class="s2">&#34;å¹´é¾„&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">gender</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">SmallIntegerField</span><span class="p">(</span><span class="n">verbose_name</span><span class="o">=</span><span class="s2">&#34;æ€§åˆ«&#34;</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&#34;ç”·&#34;</span><span class="p">),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s2">&#34;å¥³&#34;</span><span class="p">)))</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>æˆ‘ä»¬ä¸Šé¢å­¦ä¹ çš„å¯¹choicesçš„å¤„ç†ï¼Œéƒ½æ˜¯è¦æ–°å®šä¹‰ä¸€ä¸ªå­—æ®µæ¥å±•ç¤ºç”·/å¥³ï¼Œä½†éœ€æ±‚ä¸­ä¸ç®¡æ˜¯æä¾›çš„å­—æ®µè¿˜æ˜¯è¿”å›çš„å­—æ®µéƒ½å«genderï¼Œæ˜¾ç„¶ä¸æ˜¯æˆ‘ä»¬åŸå…ˆå­¦ä¹ çš„æ–¹æ³•å¯ä»¥å®ç°çš„</p>
<p><img src="/post/python/DRF/image-20241226161015680.png"
	
	
	
	loading="lazy"
	
		alt="image-20241226161015680"
	
	
></p>
<p>é‡ç‚¹å°±æ˜¯è¦å°†è¿”å›çš„genderè®¾ç½®ä¸ºç”·/å¥³</p>
<p>å¦‚æœæˆ‘ä»¬è‡ªå®šä¹‰ä¸€ä¸ªåä¸ºgenderçš„SerializerMethodFieldå­—æ®µï¼Œç„¶ååœ¨é‡Œé¢å»è°ƒç”¨get_gender_displayï¼Œè¾“å‡ºæ˜¯ç¬¦åˆè¦æ±‚äº†ï¼Œä½†æ˜¯SerializerMethodFieldå­—æ®µé»˜è®¤æ˜¯read_onlyï¼Œä¼šå¯¼è‡´ä¼ è¿‡æ¥çš„genderå¤±æ•ˆï¼Œå³ç”¨æˆ·æ— æ³•è¾“å…¥äº†</p>
<p>å¦‚æœå®šä¹‰æˆå…¶ä»–ç±»å‹çš„å­—æ®µï¼Œæ²¡æœ‰read_onlyï¼Œç”¨æˆ·å¯ä»¥è¾“å…¥äº†ï¼Œä½†æ˜¯get_genderçš„é’©å­åˆä¸æ‰§è¡Œäº†ï¼Œå¯¼è‡´è¾“å‡ºè¿˜æ˜¯1/2</p>
<p>å¯ä»¥å‘ç°ï¼Œä¸Šé¢ä¸¤ç§å®ç°éƒ½åªå®ç°äº†ä¸€åŠåŠŸèƒ½ï¼Œé‚£æ²¡æœ‰å¯èƒ½å°†ä»–ä»¬ç»„åˆèµ·æ¥å‘¢ï¼Ÿ</p>
<p>è¿™å°±éœ€è¦æˆ‘ä»¬äº†è§£SerializerMethodFieldå­—æ®µåˆ°åº•æ˜¯å¦‚ä½•å®ç°é’©å­çš„ï¼Ÿ</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># åºåˆ—åŒ–</span>
</span></span><span class="line"><span class="cl"><span class="n">ser</span> <span class="o">=</span> <span class="n">NbModelSerializer</span><span class="p">(</span><span class="n">instance</span><span class="o">=</span><span class="n">å¯¹è±¡</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">ser</span><span class="o">.</span><span class="n">data</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># æ•°æ®æ ¡éªŒ+åºåˆ—åŒ–</span>
</span></span><span class="line"><span class="cl"><span class="n">ser</span> <span class="o">=</span> <span class="n">NbModelSerializer</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="n">ser</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="n">ser</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">ser</span><span class="o">.</span><span class="n">data</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># å…³é”®å°±æ˜¯ser.data</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>çœŸæ­£çš„åºåˆ—åŒ–åŠ¨ä½œå‘ç”Ÿåœ¨ser.dataè§¦å‘æ—¶</p>
<p>SerializerMethodFieldå­—æ®µä¸å…¶ä»–å­—æ®µçš„ä¸åŒåœ¨äºï¼š</p>
<ul>
<li>ç±»å˜é‡ç»´æŠ¤äº†ä¸€ä¸ªmethod_nameé»˜è®¤ç­‰äºNone</li>
<li>åœ¨å®ä¾‹åŒ–å‰æ‰§è¡Œbindæ–¹æ³•method_nameèµ‹å€¼ä¸º&rsquo;get_{field_name}'</li>
<li>æœ€åè°ƒç”¨to_representationæ–¹æ³•å¤„ç†å€¼æ—¶ä¼šæ‰¾åˆ°çˆ¶ç±»çš„get_{field_name}ï¼Œè¿”å›é’©å­æ–¹æ³•çš„è¿”å›å€¼</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">BaseSerializer</span><span class="p">(</span><span class="n">Field</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@property</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_representation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Serializer</span><span class="p">(</span><span class="n">BaseSerializer</span><span class="p">,</span> <span class="n">metaclass</span><span class="o">=</span><span class="n">SerializerMetaclass</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@property</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">ret</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">data</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">ReturnDict</span><span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="n">serializer</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@property</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">_readable_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="ow">not</span> <span class="n">field</span><span class="o">.</span><span class="n">write_only</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">yield</span> <span class="n">field</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">to_representation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">ret</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># [CharFieldå­—æ®µå¯¹è±¡ï¼ŒSerializerMethodFieldå­—æ®µå¯¹è±¡(æ¯”å…¶ä»–æ™®é€šå­—æ®µå¤šç»´æŠ¤äº†ä¸€ä¸ªmethod_name)...]  æœ‰bindæ–¹æ³•ä¼šå…ˆæ‰§è¡Œè¿‡</span>
</span></span><span class="line"><span class="cl">        <span class="n">fields</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_readable_fields</span>  <span class="c1"># æ‰¾åˆ°æ‰€æœ‰å­—æ®µï¼Œç­›é€‰å‡ºå¯è¯»çš„ï¼ˆå¯åºåˆ—åŒ–çš„ï¼‰ ==&gt; æ²¡æœ‰å†™write_only</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">attribute</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">get_attribute</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># CharField.get_attribute(instance) ==&gt; instance.å­—æ®µ.å­—æ®µ (é€šè¿‡å¾ªç¯sourceåˆ—è¡¨)</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># SerializerMethodField.get_attribute(instance) ==&gt; instance.xx ==&gt; None (SerializerMethodFieldçš„sourceé»˜è®¤ä¸º*)</span>
</span></span><span class="line"><span class="cl">            <span class="n">ret</span><span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">field_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">to_representation</span><span class="p">(</span><span class="n">attribute</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># CharField.to_representation å°±æ˜¯ç”¨str()åŒ…è£¹ä¸€ä¸‹</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># SerializerMethodField.to_representation æ ¹æ®method_nameå»çˆ¶ç±»æ‹¿é’©å­æ–¹æ³•</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">ret</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">SerializerMethodField</span><span class="p">(</span><span class="n">Field</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">method_name</span> <span class="o">=</span> <span class="n">method_name</span>
</span></span><span class="line"><span class="cl">        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;source&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;*&#39;</span>
</span></span><span class="line"><span class="cl">        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;read_only&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">bind</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">parent</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># The method name defaults to `get_{field_name}`.</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">method_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">method_name</span> <span class="o">=</span> <span class="s1">&#39;get_</span><span class="si">{field_name}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="n">field_name</span><span class="o">=</span><span class="n">field_name</span><span class="p">)</span>  <span class="c1"># method_nameé»˜è®¤ä¸ºNoneï¼Œåˆ°æ­¤å¤„å¤„ç†ä¸º&#34;get_gender&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="n">field_name</span><span class="p">,</span> <span class="n">parent</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">to_representation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">method</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">method_name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">method</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">NbModelSerializer</span><span class="p">(</span><span class="n">serializers</span><span class="o">.</span><span class="n">ModelSerializer</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">gender</span> <span class="o">=</span> <span class="n">seriallizer</span><span class="o">.</span><span class="n">SerializerMethodField</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">NbUserInfo</span>
</span></span><span class="line"><span class="cl">        <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;id&#34;</span><span class="p">,</span> <span class="s2">&#34;name&#34;</span><span class="p">,</span> <span class="s2">&#34;age&#34;</span><span class="p">,</span> <span class="s2">&#34;gender&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="n">extra_kwargs</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;id&#34;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&#34;read_only&#34;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get_gender</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">obj</span><span class="o">.</span><span class="n">get_gender_display</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ˜ç™½äº†å®ƒæ˜¯å¦‚ä½•å®ç°é’©å­æ–¹æ³•ä¹‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥å°†åŸå…ˆçš„ä¸¤ç§æ–¹å¼è¿›è¡Œç»“åˆï¼Œå…³é”®å°±åœ¨äºå¯¹ä¸‹é¢ä¸¤æ¡è¯­å¥çš„æ‹“å±•ï¼Œå› ä¸ºä»–ä»¬å†³å®šäº†å­—æ®µçš„å®é™…å€¼</p>
<ul>
<li><code>attribute = field.get_attribute(instance)</code></li>
<li><code>ret[field.field_name] = field.to_representation(attribute)</code></li>
</ul>
<h5 id="æ–¹æ³•ä¸€">æ–¹æ³•ä¸€
</h5><p>æˆ‘ä»¬é€šè¿‡è‡ªå®šä¹‰ä¸€ä¸ªNbCharFieldå­—æ®µï¼Œæ¨¡ä»¿SerializerMethodFieldç»´æŠ¤ä¸€ä¸ªmethod_nameï¼Œå¹¶ä¸”æ‰¾æ—¶æœºè®©ä»–æ ¹æ®åå°„æ‰¾åˆ°é’©å­å¹¶æ‰§è¡Œå³å¯</p>
<p>ä¸‹åˆ—å®ç°åœ¨<code>__init__</code>å’Œ<code>__bind__</code>ä¸­ç»´æŠ¤ä¸€ä¸ªé’©å­æ–¹æ³•ï¼Œåä¸º<code>xget_å­—æ®µå</code>ï¼Œç„¶ååœ¨æ‰§è¡Œget_attributeæ—¶è®©ä»–æ‰§è¡Œé’©å­ï¼Œå°†1/2å˜ä¸ºç”·/å¥³ï¼Œå› ä¸ºæˆ‘ä»¬ç»§æ‰¿çš„æ˜¯IntegerFieldï¼Œå®ƒçš„to_representationæ–¹æ³•åº”è¯¥æ˜¯ç”¨int()åŒ…è£¹attributeï¼Œè€Œæˆ‘ä»¬çš„attributeä¸æ˜¯æ•°å­—å­—ç¬¦ä¸²ï¼Œå› æ­¤to_representationä¹Ÿéœ€è¦é‡å†™ï¼Œå¦åˆ™å¼ºåŠ int()ä¼šæŠ¥é”™ï¼Œè‡³æ­¤å°±å®Œæˆäº†åŠŸèƒ½å®ç°</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">NbCharField</span><span class="p">(</span><span class="n">serializers</span><span class="o">.</span><span class="n">IntegerField</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">method_name</span> <span class="o">=</span> <span class="n">method_name</span>
</span></span><span class="line"><span class="cl">        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">bind</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">parent</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">method_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">method_name</span> <span class="o">=</span> <span class="s1">&#39;xget_</span><span class="si">{field_name}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">field_name</span><span class="o">=</span><span class="n">field_name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="n">field_name</span><span class="p">,</span> <span class="n">parent</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get_attribute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">method</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">method_name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">method</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">to_representation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">NbModelSerializer</span><span class="p">(</span><span class="n">serializers</span><span class="o">.</span><span class="n">ModelSerializer</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">gender</span> <span class="o">=</span> <span class="n">NbCharField</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">NbUserInfo</span>
</span></span><span class="line"><span class="cl">        <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;id&#34;</span><span class="p">,</span> <span class="s2">&#34;name&#34;</span><span class="p">,</span> <span class="s2">&#34;age&#34;</span><span class="p">,</span> <span class="s2">&#34;gender&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="n">extra_kwargs</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;id&#34;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&#34;read_only&#34;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">xget_gender</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">obj</span><span class="o">.</span><span class="n">get_gender_display</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">NbView</span><span class="p">(</span><span class="n">APIView</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">ser</span> <span class="o">=</span> <span class="n">NbModelSerializer</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">ser</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">            <span class="n">ser</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">ser</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">ser</span><span class="o">.</span><span class="n">errors</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>å¯ä»¥çœ‹åˆ°ï¼Œé€šè¿‡è‡ªå®šä¹‰ä¸€ä¸ªå­—æ®µçš„æ–¹å¼è¿˜æ˜¯æ¯”è¾ƒç¹ççš„</p>
<h5 id="æ–¹æ³•äºŒ">æ–¹æ³•äºŒ
</h5><p>æ–¹æ³•ä¸€çš„æœ¬è´¨æ˜¯æ”¹å˜å­—æ®µçš„<code>get_attribute</code>å’Œ<code>to_representation</code>æ–¹æ³•æ¥æ”¹å˜è·å–å­—æ®µçš„å€¼ï¼Œè€Œè¿™ä¸¤ä¸ªæ–¹æ³•éƒ½å®šä¹‰Serializerç±»çš„<code>to_representation</code>æ–¹æ³•ä¸­ï¼Œé‚£ä¹ˆæˆ‘ä»¬ä½•ä¸ç›´æ¥é‡å†™ä¸€ä¸ª<code>to_representation</code>æ–¹æ³•ï¼Œä½¿å¾—å½“å­—æ®µå­˜åœ¨åä¸ºnb_å­—æ®µåçš„é’©å­æ–¹æ³•æ—¶ï¼Œèµ°æˆ‘ä»¬è‡ªå·±çš„è·å–æ•°æ®æµç¨‹ï¼Œè€Œæ²¡æœ‰åä¸º<code>nb_å­—æ®µå</code>çš„é’©å­æ–¹æ³•æ—¶ï¼Œå°±æŒ‰åŸæœ¬çš„é€»è¾‘èµ°</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">NbModelSerializer</span><span class="p">(</span><span class="n">serializers</span><span class="o">.</span><span class="n">ModelSerializer</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">NbUserInfo</span>
</span></span><span class="line"><span class="cl">        <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;id&#34;</span><span class="p">,</span> <span class="s2">&#34;name&#34;</span><span class="p">,</span> <span class="s2">&#34;age&#34;</span><span class="p">,</span> <span class="s2">&#34;gender&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="n">extra_kwargs</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;id&#34;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&#34;read_only&#34;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">to_representation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">ret</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">fields</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_readable_fields</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;nb_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">field</span><span class="o">.</span><span class="n">field_name</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="n">value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&#34;nb_</span><span class="si">%s</span><span class="s2">&#34;</span> <span class="o">%</span> <span class="n">field</span><span class="o">.</span><span class="n">field_name</span><span class="p">)(</span><span class="n">instance</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">ret</span><span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">field_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">attribute</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">get_attribute</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">except</span> <span class="n">SkipField</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="k">continue</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="n">check_for_none</span> <span class="o">=</span> <span class="n">attribute</span><span class="o">.</span><span class="n">pk</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attribute</span><span class="p">,</span> <span class="n">PKOnlyObject</span><span class="p">)</span> <span class="k">else</span> <span class="n">attribute</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">check_for_none</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">ret</span><span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">field_name</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">                <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">ret</span><span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">field_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">to_representation</span><span class="p">(</span><span class="n">attribute</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">ret</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">nb_gender</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">obj</span><span class="o">.</span><span class="n">get_gender_display</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">NbView</span><span class="p">(</span><span class="n">APIView</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">ser</span> <span class="o">=</span> <span class="n">NbModelSerializer</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">ser</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">            <span class="n">ser</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">ser</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">ser</span><span class="o">.</span><span class="n">errors</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>å¦‚æœæˆ‘ä»¬è¿˜æœ‰å…¶ä»–éœ€è¦åºåˆ—åŒ–å™¨éœ€è¦å®ç°è¿™ä¸ªåŠŸèƒ½ï¼Œæ˜¯å¦éœ€è¦åœ¨æ¯ä¸€ä¸ªåºåˆ—åŒ–å™¨ä¸­è‡ªå®šä¹‰ä¸€é<code>to_representation</code>ï¼Ÿ</p>
<p>æˆ‘ä»¬å¯ä»¥å°†è‡ªå®šä¹‰çš„æ–¹æ³•æ‰“åŒ…åˆ°ä¸€ä¸ªç±»ä¸­ï¼Œåœ¨éœ€è¦å®ç°è¯¥åŠŸèƒ½çš„åºåˆ—åŒ–å™¨ç±»ä¸­ç»§æ‰¿å³å¯</p>
<p><code>ext/hook.py</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">rest_framework.fields</span> <span class="kn">import</span> <span class="n">SkipField</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">rest_framework.relations</span> <span class="kn">import</span> <span class="n">PKOnlyObject</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">NbHookSerializer</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">to_representation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">ret</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">fields</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_readable_fields</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;nb_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">field</span><span class="o">.</span><span class="n">field_name</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="n">value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&#34;nb_</span><span class="si">%s</span><span class="s2">&#34;</span> <span class="o">%</span> <span class="n">field</span><span class="o">.</span><span class="n">field_name</span><span class="p">)(</span><span class="n">instance</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">ret</span><span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">field_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">attribute</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">get_attribute</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">except</span> <span class="n">SkipField</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="k">continue</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="n">check_for_none</span> <span class="o">=</span> <span class="n">attribute</span><span class="o">.</span><span class="n">pk</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attribute</span><span class="p">,</span> <span class="n">PKOnlyObject</span><span class="p">)</span> <span class="k">else</span> <span class="n">attribute</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">check_for_none</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">ret</span><span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">field_name</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">                <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">ret</span><span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">field_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">to_representation</span><span class="p">(</span><span class="n">attribute</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">ret</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>views.py</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">ext.hook</span> <span class="kn">import</span> <span class="n">NbHookSerializer</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">NbModelSerializer</span><span class="p">(</span><span class="n">NbHookSerializer</span><span class="p">,</span> <span class="n">serializers</span><span class="o">.</span><span class="n">ModelSerializer</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">NbUserInfo</span>
</span></span><span class="line"><span class="cl">        <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;id&#34;</span><span class="p">,</span> <span class="s2">&#34;name&#34;</span><span class="p">,</span> <span class="s2">&#34;age&#34;</span><span class="p">,</span> <span class="s2">&#34;gender&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="n">extra_kwargs</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;id&#34;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&#34;read_only&#34;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">nb_gender</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">obj</span><span class="o">.</span><span class="n">get_gender_display</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">NbView</span><span class="p">(</span><span class="n">APIView</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">ser</span> <span class="o">=</span> <span class="n">NbModelSerializer</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">ser</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">            <span class="n">ser</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">ser</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">ser</span><span class="o">.</span><span class="n">errors</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="åšå®¢ç³»ç»Ÿæ¡ˆä¾‹">åšå®¢ç³»ç»Ÿæ¡ˆä¾‹
</h3><p>å¼€å‘ä¸€ä¸ªåšå®¢ç³»ç»Ÿï¼ŒåŒ…å«ï¼šåšå®¢åˆ—è¡¨ã€è¯¦ç»†ã€ç™»å½•ã€æ³¨å†Œã€è¯„è®ºã€ç‚¹èµã€å‘å¸ƒåšå®¢</p>
<h4 id="è¡¨ç»“æ„">è¡¨ç»“æ„
</h4><p>é¡¹ç›®çš„åˆ›å»ºåœ¨æ­¤ä¸èµ˜è¿°ï¼Œç¿»çœ‹å…ˆå‰æ–‡ç« å³å¯</p>
<p>å…ˆåˆ›å»ºè¡¨ç»“æ„ï¼Œmodels.pyå†…å®¹å¦‚ä¸‹</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">models</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">UserInfo</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">username</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">verbose_name</span><span class="o">=</span><span class="s2">&#34;ç”¨æˆ·å&#34;</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">db_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">password</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">verbose_name</span><span class="o">=</span><span class="s2">&#34;å¯†ç &#34;</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">64</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">token</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">verbose_name</span><span class="o">=</span><span class="s2">&#34;TOKEN&#34;</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">db_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Blog</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">category_choices</span> <span class="o">=</span> <span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&#34;äº‘è®¡ç®—&#34;</span><span class="p">),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s2">&#34;Pythonå…¨æ ˆ&#34;</span><span class="p">),</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s2">&#34;Goå¼€å‘&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">category</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">IntegerField</span><span class="p">(</span><span class="n">verbose_name</span><span class="o">=</span><span class="s2">&#34;åˆ†ç±»&#34;</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="n">category_choices</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">image</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">verbose_name</span><span class="o">=</span><span class="s2">&#34;å°é¢&#34;</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">title</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">verbose_name</span><span class="o">=</span><span class="s2">&#34;æ ‡é¢˜&#34;</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">32</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">summary</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">verbose_name</span><span class="o">=</span><span class="s2">&#34;ç®€ä»‹&#34;</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">256</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">text</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">(</span><span class="n">verbose_name</span><span class="o">=</span><span class="s2">&#34;åšæ–‡&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">ctime</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="n">verbose_name</span><span class="o">=</span><span class="s2">&#34;åˆ›å»ºæ—¶é—´&#34;</span><span class="p">,</span> <span class="n">auto_now_add</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">creator</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">verbose_name</span><span class="o">=</span><span class="s2">&#34;åˆ›å»ºè€…&#34;</span><span class="p">,</span> <span class="n">to</span><span class="o">=</span><span class="s2">&#34;UserInfo&#34;</span><span class="p">,</span> <span class="n">on_delete</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">CASCADE</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">comment_count</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">PositiveIntegerField</span><span class="p">(</span><span class="n">verbose_name</span><span class="o">=</span><span class="s2">&#34;è¯„è®ºæ•°&#34;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">favor_count</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">PositiveIntegerField</span><span class="p">(</span><span class="n">verbose_name</span><span class="o">=</span><span class="s2">&#34;èµæ•°&#34;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Favor</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34; èµ &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">blog</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">verbose_name</span><span class="o">=</span><span class="s2">&#34;åšå®¢&#34;</span><span class="p">,</span> <span class="n">to</span><span class="o">=</span><span class="s2">&#34;Blog&#34;</span><span class="p">,</span> <span class="n">on_delete</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">CASCADE</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">user</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">verbose_name</span><span class="o">=</span><span class="s2">&#34;ç”¨æˆ·&#34;</span><span class="p">,</span> <span class="n">to</span><span class="o">=</span><span class="s2">&#34;UserInfo&#34;</span><span class="p">,</span> <span class="n">on_delete</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">CASCADE</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">create_datetime</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="n">verbose_name</span><span class="o">=</span><span class="s2">&#34;åˆ›å»ºæ—¶é—´&#34;</span><span class="p">,</span> <span class="n">auto_now_add</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">constraints</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="n">models</span><span class="o">.</span><span class="n">UniqueConstraint</span><span class="p">(</span><span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;blog&#39;</span><span class="p">,</span> <span class="s1">&#39;user&#39;</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;uni_favor_blog_user&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Comment</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34; è¯„è®ºè¡¨ &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">blog</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">verbose_name</span><span class="o">=</span><span class="s2">&#34;åšå®¢&#34;</span><span class="p">,</span> <span class="n">to</span><span class="o">=</span><span class="s2">&#34;Blog&#34;</span><span class="p">,</span> <span class="n">on_delete</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">CASCADE</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">user</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">verbose_name</span><span class="o">=</span><span class="s2">&#34;ç”¨æˆ·&#34;</span><span class="p">,</span> <span class="n">to</span><span class="o">=</span><span class="s2">&#34;UserInfo&#34;</span><span class="p">,</span> <span class="n">on_delete</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">CASCADE</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">content</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">verbose_name</span><span class="o">=</span><span class="s2">&#34;å†…å®¹&#34;</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">create_datetime</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="n">verbose_name</span><span class="o">=</span><span class="s2">&#34;åˆ›å»ºæ—¶é—´&#34;</span><span class="p">,</span> <span class="n">auto_now_add</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>åšä¸€ä¸ªæ•°æ®åº“è¿ç§»</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">makemigrations
</span></span><span class="line"><span class="cl">migrate
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ·»åŠ æµ‹è¯•æ•°æ®(å¯ä»¥é‡‡ç”¨ç¦»çº¿è„šæœ¬çš„å½¢å¼ï¼Œæˆ–è€…åˆ›å»ºä¸€ä¸ªå†…å®¹å¦‚ä¸‹çš„æ¥å£ï¼Œé€šè¿‡è®¿é—®æ¥åˆ›å»º)</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">django.shortcuts</span> <span class="kn">import</span> <span class="n">render</span><span class="p">,</span> <span class="n">HttpResponse</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">api</span> <span class="kn">import</span> <span class="n">models</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Create your views here.</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">db</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">v1</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">UserInfo</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s1">&#39;qwj&#39;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s1">&#39;123&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">v2</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">UserInfo</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s1">&#39;xzq&#39;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s1">&#39;123&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">models</span><span class="o">.</span><span class="n">Blog</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">category</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">image</span><span class="o">=</span><span class="s2">&#34;xxx/xxxx.pbg&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">title</span><span class="o">=</span><span class="s1">&#39;éƒ‘ç»ç†&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">summary</span><span class="o">=</span><span class="s1">&#39;...&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">text</span><span class="o">=</span><span class="s1">&#39;è¯´å¤§è¯ç”µè¯å¡æ–‡åŒ–çš„å“‡&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">creator</span><span class="o">=</span><span class="n">v1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">models</span><span class="o">.</span><span class="n">Blog</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">category</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">image</span><span class="o">=</span><span class="s2">&#34;xxx/xxxx.pbg&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">title</span><span class="o">=</span><span class="s1">&#39;è¯æ®&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">summary</span><span class="o">=</span><span class="s1">&#39;...&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">text</span><span class="o">=</span><span class="s1">&#39;å¤§å®¶å•Šæˆ‘åˆ°å®¶å•Šäº”è§’å¤§æ¥¼&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">creator</span><span class="o">=</span><span class="n">v2</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s2">&#34;æˆåŠŸ&#34;</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ•°æ®å¦‚ä¸‹</p>
<p><img src="/post/python/DRF/image-20250109120757629.png"
	
	
	
	loading="lazy"
	
		alt="image-20250109120757629"
	
	
></p>
<h4 id="åŠŸèƒ½å®ç°">åŠŸèƒ½å®ç°
</h4><h5 id="åšå®¢åˆ—è¡¨">åšå®¢åˆ—è¡¨
</h5><p>è·¯ç”±</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">path</span><span class="p">(</span><span class="s1">&#39;api/blog/&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">BlogView</span><span class="o">.</span><span class="n">as_view</span><span class="p">()),</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>è§†å›¾ç±»</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">BlogView</span><span class="p">(</span><span class="n">APIView</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;è·å–åšå®¢åˆ—è¡¨&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 1.è¯»å–æ•°æ®åº“ä¸­çš„åšå®¢ä¿¡æ¯</span>
</span></span><span class="line"><span class="cl">        <span class="n">queryset</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Blog</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s1">&#39;-id&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 2.åºåˆ—åŒ–</span>
</span></span><span class="line"><span class="cl">        <span class="n">ser</span> <span class="o">=</span> <span class="n">BlogSerializer</span><span class="p">(</span><span class="n">queryset</span><span class="p">,</span> <span class="n">many</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 3.è¿”å›</span>
</span></span><span class="line"><span class="cl">        <span class="n">context</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;code&#39;</span><span class="p">:</span> <span class="mi">1000</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="n">ser</span><span class="o">.</span><span class="n">data</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>åºåˆ—åŒ–å™¨</p>
<ul>
<li>å†™æ³•ä¸€ï¼šè‡ªå®šä¹‰å­—æ®µ</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">BlogSerializer</span><span class="p">(</span><span class="n">serializers</span><span class="o">.</span><span class="n">ModelSerializer</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">category</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="s2">&#34;get_category_display&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">ctime</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="nb">format</span><span class="o">=</span><span class="s2">&#34;%Y-%m-</span><span class="si">%d</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">creator_name</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="s2">&#34;creator.username&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Blog</span>
</span></span><span class="line"><span class="cl">        <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;category&#34;</span><span class="p">,</span> <span class="s2">&#34;image&#34;</span><span class="p">,</span> <span class="s2">&#34;title&#34;</span><span class="p">,</span> <span class="s2">&#34;summary&#34;</span><span class="p">,</span> <span class="s2">&#34;ctime&#34;</span><span class="p">,</span> <span class="s2">&#34;comment_count&#34;</span><span class="p">,</span> <span class="s2">&#34;favor_count&#34;</span><span class="p">,</span> <span class="s2">&#34;creator&#34;</span><span class="p">,</span> <span class="s2">&#34;creator_name&#34;</span><span class="p">]</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>å†™æ³•äºŒï¼šè‡ªå®šä¹‰æ–¹æ³•</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">BlogSerializer</span><span class="p">(</span><span class="n">serializers</span><span class="o">.</span><span class="n">ModelSerializer</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">category</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="s2">&#34;get_category_display&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">ctime</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="nb">format</span><span class="o">=</span><span class="s2">&#34;%Y-%m-</span><span class="si">%d</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">creator</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">SerializerMethodField</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Blog</span>
</span></span><span class="line"><span class="cl">        <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;category&#34;</span><span class="p">,</span> <span class="s2">&#34;image&#34;</span><span class="p">,</span> <span class="s2">&#34;title&#34;</span><span class="p">,</span> <span class="s2">&#34;summary&#34;</span><span class="p">,</span> <span class="s2">&#34;ctime&#34;</span><span class="p">,</span> <span class="s2">&#34;comment_count&#34;</span><span class="p">,</span> <span class="s2">&#34;favor_count&#34;</span><span class="p">,</span> <span class="s2">&#34;creator&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get_creator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">{</span><span class="s2">&#34;id&#34;</span><span class="p">:</span> <span class="n">obj</span><span class="o">.</span><span class="n">creator_id</span><span class="p">,</span> <span class="s2">&#34;name&#34;</span><span class="p">:</span> <span class="n">obj</span><span class="o">.</span><span class="n">creator</span><span class="o">.</span><span class="n">username</span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>å†™æ³•ä¸‰ï¼šåµŒå¥—</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">BlogUserSerializers</span><span class="p">(</span><span class="n">serializers</span><span class="o">.</span><span class="n">ModelSerializer</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">UserInfo</span>
</span></span><span class="line"><span class="cl">        <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;id&#34;</span><span class="p">,</span> <span class="s2">&#34;username&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">BlogSerializer</span><span class="p">(</span><span class="n">serializers</span><span class="o">.</span><span class="n">ModelSerializer</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">category</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="s2">&#34;get_category_display&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">ctime</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="nb">format</span><span class="o">=</span><span class="s2">&#34;%Y-%m-</span><span class="si">%d</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">creator</span> <span class="o">=</span> <span class="n">BlogUserSerializers</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Blog</span>
</span></span><span class="line"><span class="cl">        <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;category&#34;</span><span class="p">,</span> <span class="s2">&#34;image&#34;</span><span class="p">,</span> <span class="s2">&#34;title&#34;</span><span class="p">,</span> <span class="s2">&#34;summary&#34;</span><span class="p">,</span> <span class="s2">&#34;ctime&#34;</span><span class="p">,</span> <span class="s2">&#34;comment_count&#34;</span><span class="p">,</span> <span class="s2">&#34;favor_count&#34;</span><span class="p">,</span> <span class="s2">&#34;creator&#34;</span><span class="p">]</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="åšå®¢è¯¦ç»†ä¸è¯„è®º">åšå®¢è¯¦ç»†ä¸è¯„è®º
</h5><p>è·¯ç”±</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">path</span><span class="p">(</span><span class="s1">&#39;api/blog/&lt;int:pk&gt;/&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">BlogDetailView</span><span class="o">.</span><span class="n">as_view</span><span class="p">()),</span>
</span></span><span class="line"><span class="cl"><span class="n">path</span><span class="p">(</span><span class="s1">&#39;api/comment/&lt;int:blog_id&gt;/&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">CommentView</span><span class="o">.</span><span class="n">as_view</span><span class="p">()),</span>
</span></span><span class="line"><span class="cl"><span class="c1"># path(&#39;api/comment/&#39;, views.CommentView.as_view()),</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>è·å–åšå®¢è¯„è®ºçš„æ¥å£å¯ä»¥å†™æˆ<code>api/comment?blog_id=1</code>ï¼Œä½†æ˜¯ä¸å¤ªç¾è§‚ï¼Œå»ºè®®ä½¿ç”¨<code>api/comment/1</code>ç„¶ååœ¨è§†å›¾ä¸­æ¥æ”¶</p></blockquote>
<p>åšå®¢è¯¦ç»†</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">BlogDetailSerializers</span><span class="p">(</span><span class="n">serializers</span><span class="o">.</span><span class="n">ModelSerializer</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">category</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="s2">&#34;get_category_display&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">ctime</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="nb">format</span><span class="o">=</span><span class="s2">&#34;%Y-%m-</span><span class="si">%d</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">creator</span> <span class="o">=</span> <span class="n">BlogUserSerializers</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Blog</span>
</span></span><span class="line"><span class="cl">        <span class="n">fields</span> <span class="o">=</span> <span class="s2">&#34;__all__&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">BlogDetailView</span><span class="p">(</span><span class="n">APIView</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;è·å–åšå®¢è¯¦ç»†&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 1.è·å–ID</span>
</span></span><span class="line"><span class="cl">        <span class="n">pk</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pk&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 2.æ ¹æ®IDè·å–å¯¹è±¡</span>
</span></span><span class="line"><span class="cl">        <span class="n">instance</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Blog</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">pk</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">instance</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s1">&#39;code&#39;</span><span class="p">:</span> <span class="mi">1000</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="s2">&#34;ä¸å­˜åœ¨&#34;</span><span class="p">})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 3.åºåˆ—åŒ–</span>
</span></span><span class="line"><span class="cl">        <span class="n">ser</span> <span class="o">=</span> <span class="n">BlogDetailSerializers</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">many</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 4.è¿”å›</span>
</span></span><span class="line"><span class="cl">        <span class="n">context</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;code&#39;</span><span class="p">:</span> <span class="mi">1000</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="n">ser</span><span class="o">.</span><span class="n">data</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¯„è®º</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">CommentSerializers</span><span class="p">(</span><span class="n">serializers</span><span class="o">.</span><span class="n">ModelSerializer</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">user</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="s2">&#34;user.username&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Comment</span>
</span></span><span class="line"><span class="cl">        <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;id&#34;</span><span class="p">,</span> <span class="s2">&#34;content&#34;</span><span class="p">,</span> <span class="s2">&#34;user&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">CommentView</span><span class="p">(</span><span class="n">APIView</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">blog_id</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;è¯„è®ºåˆ—è¡¨&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 1.æ ¹æ®IDè·å–è¯„è®ºå¯¹è±¡</span>
</span></span><span class="line"><span class="cl">        <span class="n">queryset</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Comment</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">blog_id</span><span class="o">=</span><span class="n">blog_id</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 2.åºåˆ—åŒ–</span>
</span></span><span class="line"><span class="cl">        <span class="n">ser</span> <span class="o">=</span> <span class="n">CommentSerializers</span><span class="p">(</span><span class="n">queryset</span><span class="p">,</span> <span class="n">many</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 3.è¿”å›</span>
</span></span><span class="line"><span class="cl">        <span class="n">context</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;code&#39;</span><span class="p">:</span> <span class="mi">1000</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="n">ser</span><span class="o">.</span><span class="n">data</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>æµ‹è¯•æ•°æ®è¿˜æ˜¯é€šè¿‡è®¿é—®/db/æ¥æ·»åŠ :</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># åœ¨def db(request)ä¸­æ·»åŠ å¦‚ä¸‹æ“ä½œ</span>
</span></span><span class="line"><span class="cl"><span class="n">models</span><span class="o">.</span><span class="n">Comment</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="s2">&#34;yi&#34;</span><span class="p">,</span> <span class="n">blog_id</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">user_id</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">models</span><span class="o">.</span><span class="n">Comment</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="s2">&#34;er&#34;</span><span class="p">,</span> <span class="n">blog_id</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">user_id</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ç»“æœå¦‚ä¸‹</p>
<p><img src="/post/python/DRF/image-20250109164431239.png"
	
	
	
	loading="lazy"
	
		alt="image-20250109164431239"
	
	
></p>
<p>åŸºæœ¬åŠŸèƒ½å·²ç»å®ç°äº†ï¼Œä½†æ˜¯ç°åœ¨åªæ˜¯è¯„è®ºçš„å±•ç¤ºï¼Œåç»­å¦‚æœç”¨æˆ·è¦æ·»åŠ è¯„è®ºæ—¶ï¼Œuserå­—æ®µæ˜¯éœ€è¦ç”¨æˆ·ä¼ å…¥idå€¼çš„ï¼Œè€Œå±•ç¤ºåˆ™æ˜¯å±•ç¤ºç”¨æˆ·åï¼Œæ‰€ä»¥æ­¤å¤„éœ€è¦æˆ‘ä»¬è¿›è¡Œä¸€ä¸ªæ‹“å±•ï¼Œè®©è¯¥å­—æ®µåœ¨æ ¡éªŒæ—¶ä¼ å…¥çš„æ˜¯idï¼Œåœ¨åºåˆ—åŒ–æ—¶æ˜¯è¿”å›ç”¨æˆ·å</p>
<p>ç”¨åˆ°å…ˆå‰æåˆ°çš„è‡ªå®šä¹‰<code>NbHookSerializer</code>ç±»å®ç°</p>
<p>åœ¨<code>etc/hook.py</code>ä¸­å®šä¹‰</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">rest_framework.fields</span> <span class="kn">import</span> <span class="n">SkipField</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">rest_framework.relations</span> <span class="kn">import</span> <span class="n">PKOnlyObject</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">NbHookSerializer</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">to_representation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">ret</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">fields</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_readable_fields</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;nb_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">field</span><span class="o">.</span><span class="n">field_name</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="n">value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&#34;nb_</span><span class="si">%s</span><span class="s2">&#34;</span> <span class="o">%</span> <span class="n">field</span><span class="o">.</span><span class="n">field_name</span><span class="p">)(</span><span class="n">instance</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">ret</span><span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">field_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">attribute</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">get_attribute</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">except</span> <span class="n">SkipField</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="k">continue</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="n">check_for_none</span> <span class="o">=</span> <span class="n">attribute</span><span class="o">.</span><span class="n">pk</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attribute</span><span class="p">,</span> <span class="n">PKOnlyObject</span><span class="p">)</span> <span class="k">else</span> <span class="n">attribute</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">check_for_none</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">ret</span><span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">field_name</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">                <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">ret</span><span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">field_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">to_representation</span><span class="p">(</span><span class="n">attribute</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">ret</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>å¯¹<code>CommentSerializers</code>ç±»åšå¦‚ä¸‹ä¿®æ”¹å³å¯</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">ext.hook</span> <span class="kn">import</span> <span class="n">NbHookSerializer</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">CommentSerializers</span><span class="p">(</span><span class="n">NbHookSerializer</span><span class="p">,</span> <span class="n">serializers</span><span class="o">.</span><span class="n">ModelSerializer</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Comment</span>
</span></span><span class="line"><span class="cl">        <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;id&#34;</span><span class="p">,</span> <span class="s2">&#34;content&#34;</span><span class="p">,</span> <span class="s2">&#34;user&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">nb_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">obj</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">username</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="æ³¨å†Œ">æ³¨å†Œ
</h5><p>è·¯ç”±</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">path</span><span class="p">(</span><span class="s1">&#39;api/register/&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">RegisterView</span><span class="o">.</span><span class="n">as_view</span><span class="p">()),</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>è§†å›¾+åºåˆ—åŒ–</p>
<blockquote>
<p>å­—æ®µçš„é’©å­æ–¹æ³•æ‰§è¡Œé¡ºåºæŒ‰fieldsä¸­å®šä¹‰çš„é¡ºåºæ¥</p>
<p>é€šè¿‡å®šä¹‰read_onlyå’Œwrite_onlyåŒºåˆ«æ•°æ®æ ¡éªŒå’Œåºåˆ—åŒ–å­—æ®µçš„å¼‚åŒ</p>
<p>self.initial_dataå¯ä»¥æ‹¿åˆ°ä¼ å…¥çš„æ‰€æœ‰æ•°æ®</p>
<p>æ•°æ®ä¿å­˜æ—¶å­—æ®µè¿‡å¤šçš„å¤„ç†æ–¹æ³•ï¼špop</p></blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">RegisterSerializers</span><span class="p">(</span><span class="n">serializers</span><span class="o">.</span><span class="n">ModelSerializer</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">confirm_password</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">write_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">UserInfo</span>
</span></span><span class="line"><span class="cl">        <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;id&#34;</span><span class="p">,</span> <span class="s2">&#34;username&#34;</span><span class="p">,</span> <span class="s2">&#34;password&#34;</span><span class="p">,</span> <span class="s2">&#34;confirm_password&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="n">extra_kwargs</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;id&#34;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&#34;read_only&#34;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;password&#34;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&#34;write_only&#34;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">validate_password</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;å¯†ç ï¼š&#34;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">value</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">validate_confirm_password</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;é‡å¤å¯†ç ï¼š&#34;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">password</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;password&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">password</span> <span class="o">!=</span> <span class="n">value</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s2">&#34;å¯†ç ä¸ä¸€è‡´&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">value</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">RegisterView</span><span class="p">(</span><span class="n">APIView</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;æ³¨å†Œ&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 1.æäº¤æ•°æ®</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># {&#34;username&#34;:&#34;qiuwj&#34;,&#34;password&#34;:&#34;123&#34;,&#34;confirm_password&#34;:&#34;123&#34;}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 2.æ•°æ®æ ¡éªŒ+ä¿å­˜</span>
</span></span><span class="line"><span class="cl">        <span class="n">ser</span> <span class="o">=</span> <span class="n">RegisterSerializers</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">ser</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">            <span class="n">confirm_password</span> <span class="o">=</span> <span class="n">ser</span><span class="o">.</span><span class="n">validated_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;confirm_password&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">ser</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s1">&#39;code&#39;</span><span class="p">:</span> <span class="mi">1000</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="n">ser</span><span class="o">.</span><span class="n">data</span><span class="p">})</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s1">&#39;code&#39;</span><span class="p">:</span> <span class="mi">1001</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s2">&#34;æ³¨å†Œå¤±è´¥&#34;</span><span class="p">,</span> <span class="s1">&#39;detail&#39;</span><span class="p">:</span> <span class="n">ser</span><span class="o">.</span><span class="n">errors</span><span class="p">})</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="ç™»å½•">ç™»å½•
</h5><p>è·¯ç”±</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">path</span><span class="p">(</span><span class="s1">&#39;api/login/&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">LoginView</span><span class="o">.</span><span class="n">as_view</span><span class="p">()),</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>è§†å›¾åŠ åºåˆ—åŒ–</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">LoginSerializers</span><span class="p">(</span><span class="n">serializers</span><span class="o">.</span><span class="n">ModelSerializer</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">UserInfo</span>
</span></span><span class="line"><span class="cl">        <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;username&#34;</span><span class="p">,</span> <span class="s2">&#34;password&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">LoginView</span><span class="p">(</span><span class="n">APIView</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;ç™»å½•&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 1.æäº¤æ•°æ®</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># {&#34;username&#34;:&#34;qiuwj&#34;,&#34;password&#34;:&#34;123&#34;}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 2.æ•°æ®æ ¡éªŒ+ä¿å­˜</span>
</span></span><span class="line"><span class="cl">        <span class="n">ser</span> <span class="o">=</span> <span class="n">LoginSerializers</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">ser</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s1">&#39;code&#39;</span><span class="p">:</span> <span class="mi">1001</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s2">&#34;æ ¡éªŒå¤±è´¥&#34;</span><span class="p">,</span> <span class="s1">&#39;detail&#39;</span><span class="p">:</span> <span class="n">ser</span><span class="o">.</span><span class="n">errors</span><span class="p">})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">instance</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">UserInfo</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="o">**</span><span class="n">ser</span><span class="o">.</span><span class="n">validated_data</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">instance</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s1">&#39;code&#39;</span><span class="p">:</span> <span class="mi">1002</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s2">&#34;ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯&#34;</span><span class="p">})</span>
</span></span><span class="line"><span class="cl">        <span class="n">token</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">        <span class="n">instance</span><span class="o">.</span><span class="n">token</span> <span class="o">=</span> <span class="n">token</span>
</span></span><span class="line"><span class="cl">        <span class="n">instance</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s1">&#39;code&#39;</span><span class="p">:</span> <span class="mi">1000</span><span class="p">,</span> <span class="s1">&#39;token&#39;</span><span class="p">:</span> <span class="n">token</span><span class="p">})</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="å‘å¸ƒè¯„è®º">å‘å¸ƒè¯„è®º
</h5><p>å‘è¡¨è¯„è®ºå¯ä»¥é‡‡ç”¨å•ç‹¬å†™ä¸€ä¸ªè§†å›¾ç±»çš„åºåˆ—åŒ–ç±»æ¥å®ç°ï¼Œä½†æ›´è§„èŒƒçš„å†™æ³•æ˜¯æ•´åˆåˆ°ä¸Šé¢çš„åšå®¢è¯„è®ºä¸­ï¼Œå½“GETè¯·æ±‚æ—¶ï¼Œæ˜¯å±•ç¤ºè¯„è®ºï¼Œå½“POSTè¯·æ±‚æ—¶ï¼Œæ˜¯å‘å¸ƒè¯„è®º</p>
<p>å› ä¸ºå‘å¸ƒè¯„è®ºå¿…é¡»å…ˆç™»å½•ï¼Œå› æ­¤è¦ç”¨åˆ°è®¤è¯ç±»ï¼Œä½†æ˜¯å±•ç¤ºè¯„è®ºä¸éœ€è¦ç™»å½•ï¼Œè€Œè¿™ä¸¤ä¸ªåŠŸèƒ½æ˜¯å†™åœ¨ä¸€ä¸ªè§†å›¾ç±»ä¸­çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥é‡‡ç”¨åŒ¿åç”¨æˆ·ï¼Œå½“æœªç™»å½•æ—¶ä¸è®©ä»–æŠ›å‡ºé”™è¯¯è€Œæ˜¯è¿”å›Noneï¼Œæœ€åå¦‚æœrequest.userä¸ä¸ºNoneåˆ™è¯´æ˜ç™»é™†äº†ï¼Œå¦‚æœæ˜¯Noneè¯´æ˜æ˜¯æœªç™»å½•ï¼Œä¸è®©å‘è¡¨ã€‚</p>
<p><img src="/post/python/DRF/image-20250112160054842.png"
	
	
	
	loading="lazy"
	
		alt="image-20250112160054842"
	
	
></p>
<p>åœ¨è¯·æ±‚å‚æ•°ä¸­æºå¸¦tokenä½œèº«ä»½æ ‡è¯†ï¼Œåœ¨è¯·æ±‚ä½“ä¸­ä¼ é€’è¯„è®ºå†…å®¹</p>
<p>è®¤è¯ç±»</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">rest_framework.authentication</span> <span class="kn">import</span> <span class="n">BaseAuthentication</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">api</span> <span class="kn">import</span> <span class="n">models</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">BlogAuthentication</span><span class="p">(</span><span class="n">BaseAuthentication</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">authenticate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">token</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">query_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;token&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">token</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">instance</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">UserInfo</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">token</span><span class="o">=</span><span class="n">token</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">instance</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">instance</span><span class="p">,</span> <span class="n">token</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">authenticate_header</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="s1">&#39;API&#39;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>è§†å›¾ç±»+åºåˆ—åŒ–ç±»</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">CommentSerializers</span><span class="p">(</span><span class="n">NbHookSerializer</span><span class="p">,</span> <span class="n">serializers</span><span class="o">.</span><span class="n">ModelSerializer</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Comment</span>
</span></span><span class="line"><span class="cl">        <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;id&#34;</span><span class="p">,</span> <span class="s2">&#34;content&#34;</span><span class="p">,</span> <span class="s2">&#34;user&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="n">extra_kwargs</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;id&#34;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&#34;read_only&#34;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;user&#34;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&#34;read_only&#34;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">nb_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">obj</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">username</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">CommentView</span><span class="p">(</span><span class="n">APIView</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">authentication_classes</span> <span class="o">=</span> <span class="p">[</span><span class="n">BlogAuthentication</span><span class="p">,</span> <span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">blog_id</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;è¯„è®ºåˆ—è¡¨&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 1.æ ¹æ®IDè·å–è¯„è®ºå¯¹è±¡</span>
</span></span><span class="line"><span class="cl">        <span class="n">queryset</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Comment</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">blog_id</span><span class="o">=</span><span class="n">blog_id</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 2.åºåˆ—åŒ–</span>
</span></span><span class="line"><span class="cl">        <span class="n">ser</span> <span class="o">=</span> <span class="n">CommentSerializers</span><span class="p">(</span><span class="n">queryset</span><span class="p">,</span> <span class="n">many</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 3.è¿”å›</span>
</span></span><span class="line"><span class="cl">        <span class="n">context</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;code&#39;</span><span class="p">:</span> <span class="mi">1000</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="n">ser</span><span class="o">.</span><span class="n">data</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">blog_id</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;å‘å¸ƒè¯„è®º&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s1">&#39;code&#39;</span><span class="p">:</span> <span class="mi">3000</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="s2">&#34;è®¤è¯å¤±è´¥&#34;</span><span class="p">})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">blog_object</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Blog</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">blog_id</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">blog_object</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s1">&#39;code&#39;</span><span class="p">:</span> <span class="mi">2000</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="s2">&#34;åšå®¢ä¸å­˜åœ¨&#34;</span><span class="p">})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">ser</span> <span class="o">=</span> <span class="n">CommentSerializers</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">ser</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s1">&#39;code&#39;</span><span class="p">:</span> <span class="mi">1002</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="s2">&#34;å†…å®¹å®¡æ ¸ä¸é€šè¿‡&#34;</span><span class="p">})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">ser</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">blog</span><span class="o">=</span><span class="n">blog_object</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s1">&#39;code&#39;</span><span class="p">:</span> <span class="mi">1000</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="n">ser</span><span class="o">.</span><span class="n">data</span><span class="p">})</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="ç‚¹èµ">ç‚¹èµ
</h5><p>è·¯ç”±</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">path</span><span class="p">(</span><span class="s1">&#39;api/favor/&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">FavorView</span><span class="o">.</span><span class="n">as_view</span><span class="p">()),</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>å› ä¸ºç‚¹èµåŠŸèƒ½å¿…é¡»ç™»å½•ï¼Œå› æ­¤æ–°å¢<code>NoAuthentication</code>è®¤è¯ç±»ï¼Œå½“<code>BlogAuthentication</code>ç±»ä¸ºæ ¡éªŒé€šè¿‡æ—¶ï¼Œå°±æŠ›å‡ºé”™è¯¯</p>
<p>è®¤è¯ç±»</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">rest_framework.authentication</span> <span class="kn">import</span> <span class="n">BaseAuthentication</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">api</span> <span class="kn">import</span> <span class="n">models</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">rest_framework</span> <span class="kn">import</span> <span class="n">exceptions</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">BlogAuthentication</span><span class="p">(</span><span class="n">BaseAuthentication</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">authenticate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">token</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">query_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;token&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">token</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">instance</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">UserInfo</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">token</span><span class="o">=</span><span class="n">token</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">instance</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">instance</span><span class="p">,</span> <span class="n">token</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">authenticate_header</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="s1">&#39;API&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">NoAuthentication</span><span class="p">(</span><span class="n">BaseAuthentication</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">authenticate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">AuthenticationFailed</span><span class="p">({</span><span class="s2">&#34;code&#34;</span><span class="p">:</span> <span class="mi">2000</span><span class="p">,</span> <span class="s2">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;è®¤è¯å¤±è´¥&#34;</span><span class="p">})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">authenticate_header</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="s1">&#39;API&#39;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>åºåˆ—åŒ–+è§†å›¾å‡½æ•°</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">FavorSerializer</span><span class="p">(</span><span class="n">serializers</span><span class="o">.</span><span class="n">ModelSerializer</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Favor</span>
</span></span><span class="line"><span class="cl">        <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;id&#34;</span><span class="p">,</span> <span class="s2">&#34;blog&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">FavorView</span><span class="p">(</span><span class="n">APIView</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">authentication_classes</span> <span class="o">=</span> <span class="p">[</span><span class="n">BlogAuthentication</span><span class="p">,</span> <span class="n">NoAuthentication</span><span class="p">,</span> <span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">ser</span> <span class="o">=</span> <span class="n">FavorSerializer</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">ser</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s1">&#39;code&#39;</span><span class="p">:</span> <span class="mi">1002</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s2">&#34;æ ¡éªŒå¤±è´¥&#34;</span><span class="p">,</span> <span class="s1">&#39;detail&#39;</span><span class="p">:</span> <span class="n">ser</span><span class="o">.</span><span class="n">errors</span><span class="p">})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 1.å·²å­˜åœ¨ ä¸èµ</span>
</span></span><span class="line"><span class="cl">        <span class="n">exists</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Favor</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">,</span> <span class="o">**</span><span class="n">ser</span><span class="o">.</span><span class="n">validated_data</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">exists</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s1">&#39;code&#39;</span><span class="p">:</span> <span class="mi">1005</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s2">&#34;å·²èµè¿‡ï¼Œä¸å…è®¸é‡å¤ç‚¹èµ&#34;</span><span class="p">})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 2.ä¸å­˜åœ¨</span>
</span></span><span class="line"><span class="cl">        <span class="n">ser</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s1">&#39;code&#39;</span><span class="p">:</span> <span class="mi">1000</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="n">ser</span><span class="o">.</span><span class="n">data</span><span class="p">})</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="æ–°å»ºåšå®¢">æ–°å»ºåšå®¢
</h5><p>å’ŒæŸ¥çœ‹è¯„è®ºä¸å‘å¸ƒè¯„è®ºç›¸åŒï¼Œåšå®¢åˆ—è¡¨ä¸æ–°å»ºåšå®¢ä¹Ÿæ”¾åˆ°ä¸€ä¸ªè§†å›¾ç±»ä¸­</p>
<p>å› ä¸ºæ–°å»ºåšå®¢å¿…é¡»ç™»å½•ï¼Œå¯ä»¥é‡‡å–åŒ¿åç”¨æˆ·+å¯¹<code>request.user</code>åˆ¤æ–­çš„å½¢å¼æ¥åšæƒé™æ ¡éªŒ</p>
<p>è§†å›¾ç±»</p>
<blockquote>
<p>å…³é”®åœ¨äºå¯¹getå’Œpostè¯·æ±‚æ—¶ä¸åŒå­—æ®µçš„éšè—å’Œæ˜¾ç¤ºå¤„ç†</p></blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">BlogSerializer</span><span class="p">(</span><span class="n">NbHookSerializer</span><span class="p">,</span> <span class="n">serializers</span><span class="o">.</span><span class="n">ModelSerializer</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">ctime</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="nb">format</span><span class="o">=</span><span class="s2">&#34;%Y-%m-</span><span class="si">%d</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">read_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">creator</span> <span class="o">=</span> <span class="n">BlogUserSerializers</span><span class="p">(</span><span class="n">read_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Blog</span>
</span></span><span class="line"><span class="cl">        <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;id&#34;</span><span class="p">,</span> <span class="s2">&#34;category&#34;</span><span class="p">,</span> <span class="s2">&#34;image&#34;</span><span class="p">,</span> <span class="s2">&#34;title&#34;</span><span class="p">,</span> <span class="s2">&#34;summary&#34;</span><span class="p">,</span> <span class="s2">&#34;text&#34;</span><span class="p">,</span> <span class="s2">&#34;ctime&#34;</span><span class="p">,</span> <span class="s2">&#34;comment_count&#34;</span><span class="p">,</span> <span class="s2">&#34;favor_count&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                  <span class="s2">&#34;creator&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="n">extra_kwargs</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;comment_count&#34;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&#34;read_only&#34;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;favor_count&#34;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&#34;read_only&#34;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;text&#34;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&#34;write_only&#34;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">nb_category</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">obj</span><span class="o">.</span><span class="n">get_category_display</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">BlogView</span><span class="p">(</span><span class="n">APIView</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">authentication_classes</span> <span class="o">=</span> <span class="p">(</span><span class="n">BlogAuthentication</span><span class="p">,)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;è·å–åšå®¢åˆ—è¡¨&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 1.è¯»å–æ•°æ®åº“ä¸­çš„åšå®¢ä¿¡æ¯</span>
</span></span><span class="line"><span class="cl">        <span class="n">queryset</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Blog</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s1">&#39;-id&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 2.åºåˆ—åŒ–</span>
</span></span><span class="line"><span class="cl">        <span class="n">ser</span> <span class="o">=</span> <span class="n">BlogSerializer</span><span class="p">(</span><span class="n">queryset</span><span class="p">,</span> <span class="n">many</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 3.è¿”å›</span>
</span></span><span class="line"><span class="cl">        <span class="n">context</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;code&#39;</span><span class="p">:</span> <span class="mi">1000</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="n">ser</span><span class="o">.</span><span class="n">data</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s1">&#39;code&#39;</span><span class="p">:</span> <span class="mi">3000</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="s2">&#34;è®¤è¯å¤±è´¥&#34;</span><span class="p">})</span>
</span></span><span class="line"><span class="cl">        <span class="n">ser</span> <span class="o">=</span> <span class="n">BlogSerializer</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">ser</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s1">&#39;code&#39;</span><span class="p">:</span> <span class="mi">1002</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s2">&#34;æ ¡éªŒå¤±è´¥&#34;</span><span class="p">,</span> <span class="s1">&#39;detail&#39;</span><span class="p">:</span> <span class="n">ser</span><span class="o">.</span><span class="n">errors</span><span class="p">})</span>
</span></span><span class="line"><span class="cl">        <span class="n">ser</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">creator</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s1">&#39;code&#39;</span><span class="p">:</span> <span class="mi">1000</span><span class="p">,</span> <span class="s2">&#34;data&#34;</span><span class="p">:</span> <span class="n">ser</span><span class="o">.</span><span class="n">data</span><span class="p">})</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>å®ç°æ•ˆæœ</p>
<p><img src="/post/python/DRF/image-20250120233733760.png"
	
	
	
	loading="lazy"
	
		alt="image-20250120233733760"
	
	
></p>
<h4 id="æ€»ç»“-5">æ€»ç»“
</h4><p>ä¸»è¦æ‹“å±•äº†æƒé™ç±»çš„æˆ–å…³ç³»ä»¥åŠå…³äºåºåˆ—åŒ–å™¨ä¼ å…¥ä¸è¾“å‡ºçš„å­—æ®µåç›¸åŒä½†å†…å®¹ä¸åŒçš„æ‹“å±•</p>
<p>ä½†å­˜åœ¨å‡ ä¸ªé—®é¢˜</p>
<ul>
<li>ç‚¹èµè¯„è®ºååšå®¢å¯¹åº”ç‚¹èµæ•°å’Œè¯„è®ºæ•°æœªå˜åŒ– &ndash;&gt;  fæ“ä½œè‡ªåŠ ä¸€</li>
<li>åšå®¢åˆ—è¡¨å’Œè¯„è®ºåˆ—è¡¨çš„åˆ†é¡µåŠŸèƒ½</li>
</ul>
<p>æ¡ˆä¾‹å®Œæ•´é¡¹ç›®å‘½åä¸ºblog1.zip</p>
<h2 id="åˆ†é¡µ">åˆ†é¡µ
</h2><p>åœ¨djangoä¸­åŸç”Ÿçš„åˆ†é¡µç»„ä»¶ä¸å¤Ÿå¥½ç”¨ï¼Œäºæ˜¯æˆ‘ä»¬è‡ªå®šä¹‰äº†ä¸€ä¸ªç»„ä»¶ï¼Œè€Œåœ¨drfä¸­ï¼Œä»–ä¸ºæˆ‘ä»¬æä¾›äº†ä¸‰ä¸ªè¿˜ä¸é”™çš„åˆ†é¡µç»„ä»¶ï¼Œä¸‹é¢æˆ‘ä»¬æ¥ä»‹ç»ä¸€ä¸‹æ¯”è¾ƒå¸¸ç”¨çš„ä¸¤ä¸ª</p>
<p><code>PageNumberPagination</code>ï¼Œé€‚ç”¨äºæ˜¾ç¤ºé¡µé¢ã€ä¸Šä¸€ä¸‹ã€ä¸‹ä¸€é¡µ</p>
<blockquote>
<p>/accounts/?page=4
/accounts/?page=6
/accounts/?page=7
/accounts/?page=7&amp;page_size=1000000000
/accounts/?page=7&amp;page_size=2
/accounts/?page=7&amp;page_size=4</p></blockquote>
<p>åç«¯ç»™å‰ç«¯è¿”å›çš„æ•°æ®å‚è€ƒï¼Œç”±å‰ç«¯è‡ªå·±åˆ’åˆ†</p>
<pre><code>res = {
	&quot;data&quot;:[xxx,xxxx,xxxx,xxx,xxxx],
	&quot;total&quot;:1000,
	&quot;persize&quot;:20
}
</code></pre>
<hr>
<p><code>LimitOffsetPagination</code>ï¼Œæ»šåŠ¨ç¿»é¡µ</p>
<blockquote>
<p>ä»ç¬¬äºŒæ¡å¼€å§‹,å–åæ¡</p>
<p>/accounts/?offset=2&amp;limit=10
/accounts/?offset=10&amp;limit=10</p>
<p>è¿˜å¯ä»¥æ·»åŠ æ¡ä»¶,å¦‚idå¤§äº10çš„ä¸­ä»ç¬¬0ä¸ªå¼€å§‹,å–åæ¡</p>
<p>/accounts/?lastid=10&amp;offset=0&amp;limit=10
/accounts/?lastid=20&amp;offset=0&amp;limit=10</p></blockquote>
<h3 id="pagenumberpagination">PageNumberPagination
</h3><h4 id="åˆæ­¥ä½¿ç”¨">åˆæ­¥ä½¿ç”¨
</h4><p><img src="/post/python/DRF/image-20250121154003508.png"
	
	
	
	loading="lazy"
	
		alt="image-20250121154003508"
	
	
></p>
<p>åœ¨urlä¸­ä¼ å…¥ä¸åŒçš„page,å¯ä»¥è¿”å›å¯¹åº”é¡µçš„æ•°æ®</p>
<blockquote>
<p>ä¸€å…±æœ‰ä¸‰ç¯‡åšå®¢,page_size=2,å› æ­¤ç¬¬ä¸€é¡µä¸¤æ¡æ•°æ®,ç¬¬äºŒé¡µä¸€æ¡æ•°æ®</p></blockquote>
<p><img src="/post/python/DRF/image-20250121154415485.png"
	
	
	
	loading="lazy"
	
		alt="image-20250121154415485"
	
	
></p>
<p>å°†è¯¥åˆ†é¡µç»„ä»¶åº”ç”¨åˆ°å‰é¢çš„æ¡ˆä¾‹ä¸­,æ–°çš„BlogViewç±»å®ç°å¦‚ä¸‹</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">BlogView</span><span class="p">(</span><span class="n">APIView</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">authentication_classes</span> <span class="o">=</span> <span class="p">(</span><span class="n">BlogAuthentication</span><span class="p">,)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;è·å–åšå®¢åˆ—è¡¨&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 1.è¯»å–æ•°æ®åº“ä¸­çš„åšå®¢ä¿¡æ¯</span>
</span></span><span class="line"><span class="cl">        <span class="n">queryset</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Blog</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s1">&#39;-id&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># åˆ†é¡µ</span>
</span></span><span class="line"><span class="cl">        <span class="kn">from</span> <span class="nn">rest_framework.pagination</span> <span class="kn">import</span> <span class="n">PageNumberPagination</span>
</span></span><span class="line"><span class="cl">        <span class="n">pager</span> <span class="o">=</span> <span class="n">PageNumberPagination</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">result</span> <span class="o">=</span> <span class="n">pager</span><span class="o">.</span><span class="n">paginate_queryset</span><span class="p">(</span><span class="n">queryset</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 2.åºåˆ—åŒ–</span>
</span></span><span class="line"><span class="cl">        <span class="n">ser</span> <span class="o">=</span> <span class="n">BlogSerializer</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">many</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 3.è¿”å›</span>
</span></span><span class="line"><span class="cl">        <span class="n">context</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;code&#39;</span><span class="p">:</span> <span class="mi">1000</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="n">ser</span><span class="o">.</span><span class="n">data</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>å†™äº†ä¸‰è¡Œä»£ç ,æ”¹äº†ä¸€ä¸ªå€¼å°±å®ç°äº†åˆ†é¡µåŠŸèƒ½</p>
<h4 id="1212-è‡ªå®šä¹‰pagenumberpaginationç±»">12.1.2 è‡ªå®šä¹‰PageNumberPaginationç±»
</h4><p>é€šè¿‡ç»§æ‰¿PageNumberPaginationç±»,è‡ªå®šä¹‰ä¸€äº›å­—æ®µçš„å€¼å®ç°å®šåˆ¶</p>
<p><img src="/post/python/DRF/image-20250121155536954.png"
	
	
	
	loading="lazy"
	
		alt="image-20250121155536954"
	
	
></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">MyPageNumberPagination</span><span class="p">(</span><span class="n">PageNumberPagination</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">page_size_query_param</span> <span class="o">=</span> <span class="s1">&#39;size&#39;</span>
</span></span><span class="line"><span class="cl">    <span class="n">page_query_param</span> <span class="o">=</span> <span class="s1">&#39;p&#39;</span>
</span></span><span class="line"><span class="cl">    <span class="n">max_page_size</span> <span class="o">=</span> <span class="mi">2</span>
</span></span><span class="line"><span class="cl">    <span class="n">page_size</span> <span class="o">=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">BlogView</span><span class="p">(</span><span class="n">APIView</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">authentication_classes</span> <span class="o">=</span> <span class="p">(</span><span class="n">BlogAuthentication</span><span class="p">,)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;è·å–åšå®¢åˆ—è¡¨&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 1.è¯»å–æ•°æ®åº“ä¸­çš„åšå®¢ä¿¡æ¯</span>
</span></span><span class="line"><span class="cl">        <span class="n">queryset</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Blog</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s1">&#39;-id&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># åˆ†é¡µ</span>
</span></span><span class="line"><span class="cl">        <span class="n">pager</span> <span class="o">=</span> <span class="n">MyPageNumberPagination</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">result</span> <span class="o">=</span> <span class="n">pager</span><span class="o">.</span><span class="n">paginate_queryset</span><span class="p">(</span><span class="n">queryset</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 2.åºåˆ—åŒ–</span>
</span></span><span class="line"><span class="cl">        <span class="n">ser</span> <span class="o">=</span> <span class="n">BlogSerializer</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">many</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 3.è¿”å›</span>
</span></span><span class="line"><span class="cl">        <span class="n">context</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;code&#39;</span><span class="p">:</span> <span class="mi">1000</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="n">ser</span><span class="o">.</span><span class="n">data</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="1213-åˆ†é¡µçš„è¿”å›å€¼å¤„ç†">12.1.3 åˆ†é¡µçš„è¿”å›å€¼å¤„ç†
</h4><p>å°†åºåˆ—åŒ–åçš„æ•°æ®ä¸¢å…¥<code>get_paginated_response</code>å‡½æ•°,å°è£…è¿”å›å€¼</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">BlogView</span><span class="p">(</span><span class="n">APIView</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">authentication_classes</span> <span class="o">=</span> <span class="p">(</span><span class="n">BlogAuthentication</span><span class="p">,)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;è·å–åšå®¢åˆ—è¡¨&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 1.è¯»å–æ•°æ®åº“ä¸­çš„åšå®¢ä¿¡æ¯</span>
</span></span><span class="line"><span class="cl">        <span class="n">queryset</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Blog</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 2.å¤„ç†å¾—åˆ°åˆ†é¡µåçš„queryset</span>
</span></span><span class="line"><span class="cl">        <span class="kn">from</span> <span class="nn">rest_framework.pagination</span> <span class="kn">import</span> <span class="n">PageNumberPagination</span>
</span></span><span class="line"><span class="cl">        <span class="n">pager</span> <span class="o">=</span> <span class="n">PageNumberPagination</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">result</span> <span class="o">=</span> <span class="n">pager</span><span class="o">.</span><span class="n">paginate_queryset</span><span class="p">(</span><span class="n">queryset</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 3.åºåˆ—åŒ–</span>
</span></span><span class="line"><span class="cl">        <span class="n">ser</span> <span class="o">=</span> <span class="n">BlogSerializer</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">many</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 4.è·å–åˆ†é¡µè¿”å›ç»“æœ</span>
</span></span><span class="line"><span class="cl">        <span class="n">response</span> <span class="o">=</span> <span class="n">pager</span><span class="o">.</span><span class="n">get_paginated_response</span><span class="p">(</span><span class="n">ser</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">response</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>get_paginated_response</code>å‡½æ•°å®ç°é€»è¾‘</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">PageNumberPagination</span><span class="p">(</span><span class="n">BasePagination</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get_paginated_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">OrderedDict</span><span class="p">([</span>
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="s1">&#39;count&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">paginator</span><span class="o">.</span><span class="n">count</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="s1">&#39;next&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_next_link</span><span class="p">()),</span>
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="s1">&#39;previous&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_previous_link</span><span class="p">()),</span>
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="s1">&#39;results&#39;</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">]))</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>å°±æ˜¯å°è£…äº†ä¸€ä¸ªæœ‰åºå­—å…¸å¹¶æ”¾åˆ°responseä¸­,å¦‚æœä¸æ»¡æ„å®ƒçš„å†…å®¹å¯ä»¥è‡ªå®šä¹‰<code>PageNumberPagination</code>ç±»é‡å†™<code>get_paginated_response</code>æ–¹æ³•,æ‰‹åŠ¨å°è£…</p>
<h4 id="1214-ç»ˆæä½¿ç”¨">12.1.4 ç»ˆæä½¿ç”¨
</h4><p>ä¾‹å­</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">BlogView</span><span class="p">(</span><span class="n">APIView</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">authentication_classes</span> <span class="o">=</span> <span class="p">(</span><span class="n">BlogAuthentication</span><span class="p">,)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;è·å–åšå®¢åˆ—è¡¨&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 1.è¯»å–æ•°æ®åº“ä¸­çš„åšå®¢ä¿¡æ¯</span>
</span></span><span class="line"><span class="cl">        <span class="n">queryset</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Blog</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 2.å¤„ç†å¾—åˆ°åˆ†é¡µåçš„queryset</span>
</span></span><span class="line"><span class="cl">        <span class="kn">from</span> <span class="nn">rest_framework.pagination</span> <span class="kn">import</span> <span class="n">PageNumberPagination</span>
</span></span><span class="line"><span class="cl">        <span class="n">pager</span> <span class="o">=</span> <span class="n">PageNumberPagination</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">result</span> <span class="o">=</span> <span class="n">pager</span><span class="o">.</span><span class="n">paginate_queryset</span><span class="p">(</span><span class="n">queryset</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 3.åºåˆ—åŒ–</span>
</span></span><span class="line"><span class="cl">        <span class="n">ser</span> <span class="o">=</span> <span class="n">BlogSerializer</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">many</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 4.è·å–åˆ†é¡µè¿”å›ç»“æœ</span>
</span></span><span class="line"><span class="cl">        <span class="n">response</span> <span class="o">=</span> <span class="n">pager</span><span class="o">.</span><span class="n">get_paginated_response</span><span class="p">(</span><span class="n">ser</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">response</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="limitoffsetpagination">LimitOffsetPagination
</h3><h4 id="åŸºæœ¬ä½¿ç”¨åŠæ‹“å±•">åŸºæœ¬ä½¿ç”¨åŠæ‹“å±•
</h4><p><code>LimitOffsetPagination</code>ä¸<code>PageNumberPagination</code>çš„ä½¿ç”¨ç›¸åŒï¼Œå”¯ä¸€çš„åŒºåˆ«å°±æ˜¯å®ä¾‹åŒ–çš„ç±»ä¸åŒï¼Œè¿˜æœ‰urlä¸­ä¼ å…¥çš„å‚æ•°ä¸åŒ</p>
<p>ä¹Ÿå¯ä»¥é€šè¿‡ç»§æ‰¿ï¼Œè‡ªå®šä¹‰ä¸€ä¸ªç±»ï¼Œä¿®æ”¹å…¶ä¸­çš„å‚æ•°ï¼Œä¾‹å¦‚ä¸‹åˆ—</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">default_limit = api_settings.PAGE_SIZE
</span></span><span class="line"><span class="cl">limit_query_param = &#39;limit&#39;
</span></span><span class="line"><span class="cl">offset_query_param = &#39;offset&#39;
</span></span><span class="line"><span class="cl">max_limit = None
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä½¿ç”¨æ–¹æ³•å¦‚ä¸‹</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">BlogView</span><span class="p">(</span><span class="n">APIView</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">authentication_classes</span> <span class="o">=</span> <span class="p">(</span><span class="n">BlogAuthentication</span><span class="p">,)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;è·å–åšå®¢åˆ—è¡¨&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 1.è¯»å–æ•°æ®åº“ä¸­çš„åšå®¢ä¿¡æ¯</span>
</span></span><span class="line"><span class="cl">        <span class="n">queryset</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Blog</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 2.å¤„ç†å¾—åˆ°åˆ†é¡µåçš„queryset</span>
</span></span><span class="line"><span class="cl">        <span class="kn">from</span> <span class="nn">rest_framework.pagination</span> <span class="kn">import</span> <span class="n">LimitOffsetPagination</span>
</span></span><span class="line"><span class="cl">        <span class="n">pager</span> <span class="o">=</span> <span class="n">LimitOffsetPagination</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">result</span> <span class="o">=</span> <span class="n">pager</span><span class="o">.</span><span class="n">paginate_queryset</span><span class="p">(</span><span class="n">queryset</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 3.åºåˆ—åŒ–</span>
</span></span><span class="line"><span class="cl">        <span class="n">ser</span> <span class="o">=</span> <span class="n">BlogSerializer</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">many</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 4.è·å–åˆ†é¡µè¿”å›ç»“æœ</span>
</span></span><span class="line"><span class="cl">        <span class="n">response</span> <span class="o">=</span> <span class="n">pager</span><span class="o">.</span><span class="n">get_paginated_response</span><span class="p">(</span><span class="n">ser</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">response</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="å®é™…ä½¿ç”¨">å®é™…ä½¿ç”¨
</h4><p>åœ¨é¡¹ç›®ä¸­ï¼Œå¾ˆå°‘å°†<code>LimitOffsetPagination</code>ç”¨äºæ™®é€šçš„åˆ†é¡µéœ€æ±‚ä¸­ï¼Œè€Œæ˜¯ä¸»è¦ç”¨æ¥å®ç°æ»šåŠ¨ç¿»é¡µï¼Œæ¯”å¦‚é¡µé¢é»˜è®¤æ˜¾ç¤º10æ¡ï¼Œå½“æ»šåˆ°åº•éƒ¨æ—¶æ‰åŠ è½½å10æ¡ï¼Œä»¥æ­¤ç±»æ¨</p>
<p>ä¸ºä»€ä¹ˆä¸ä½¿ç”¨<code>PageNumberPagination</code>å‘¢ï¼Ÿæˆ‘ä»¬ä¸¾ä¸ªä¾‹å­æ¥ç†è§£</p>
<p>æ¯”å¦‚ä¸€ç»„å€’åºæ’åˆ—çš„æ•°10,9,8&hellip;1</p>
<p>ç¬¬ä¸€æ¬¡offset=0&amp;limit=2å–åˆ°10ï¼Œ9</p>
<p>ç¬¬äºŒæ¬¡offset=2&amp;limit=2å–åˆ°8ï¼Œ7</p>
<p>æ­£å¸¸æ¥è®²å‰ç«¯è®°å½•å–å‡ºçš„ä¸ªæ•°ç„¶åä½œä¸ºoffsetä¸ä¼šå‡ºé”™ï¼Œä½†å¦‚æœæ’å…¥äº†æ–°çš„æ•°æ®åˆ°æœ€å‰ç«¯</p>
<p>ç¬¬ä¸‰æ¬¡offset=0&amp;limit=2å–åˆ°7ï¼Œ6å°±ä¼šå‡ºç°é‡å¤</p>
<p>è§£å†³åŠæ³•å°±æ˜¯å‰ç«¯è®°å½•å–å‡ºçš„æœ€åä¸€ä¸ªæ•°æ®çš„idä½œä¸ºmax_idï¼Œè¿™æ ·å°±åªä¼šä»æœªå–å‡ºçš„æ•°æ®ä¸­æŸ¥æ‰¾ï¼Œoffset=0&amp;limit=2æ— éœ€æ›´æ”¹</p>
<p>è¦æ‹¿æœ€æ–°æ•°æ®åªéœ€è¦é™åˆ¶æ¡ä»¶ä¸ºidå¤§äºæœ€ä¸Šé¢çš„ä¸€æ¡æ•°æ®çš„idå³å¯ï¼Œå³å¯å®ç°å‘ä¸Šæ»šåŠ¨ç¿»é¡µå’Œå‘ä¸‹æ»šåŠ¨ç¿»é¡µ</p>
<blockquote>
<p>/accounts/?offset=0&amp;limit=2&amp;lastid=0
13	æ­¦æ²›é½
12	æ­¦æ²›é½     max_id=12</p>
<p>/accounts/?offset=0&amp;limit=2&amp;lastid=12
11	æ­¦æ²›é½
10	æ­¦æ²›é½      max_id=10</p>
<p>/accounts/?offset=0&amp;limit=2&amp;lastid=10
9	æ­¦æ²›é½
8	æ­¦æ²›é½</p></blockquote>
<p>æ¡ˆä¾‹</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">BlogView</span><span class="p">(</span><span class="n">APIView</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">authentication_classes</span> <span class="o">=</span> <span class="p">(</span><span class="n">BlogAuthentication</span><span class="p">,)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;è·å–åšå®¢åˆ—è¡¨&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 1.è¯»å–æ•°æ®åº“ä¸­çš„åšå®¢ä¿¡æ¯</span>
</span></span><span class="line"><span class="cl">        <span class="n">queryset</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Blog</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s1">&#39;-id&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># ?max_id=1</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># ?min_id=13</span>
</span></span><span class="line"><span class="cl">        <span class="n">max_id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">query_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;max_id&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">max_id</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">queryset</span> <span class="o">=</span> <span class="n">queryset</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">id__lt</span><span class="o">=</span><span class="n">max_id</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 2.å¤„ç†å¾—åˆ°åˆ†é¡µåçš„queryset</span>
</span></span><span class="line"><span class="cl">        <span class="kn">from</span> <span class="nn">rest_framework.pagination</span> <span class="kn">import</span> <span class="n">LimitOffsetPagination</span>
</span></span><span class="line"><span class="cl">        <span class="n">pager</span> <span class="o">=</span> <span class="n">LimitOffsetPagination</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">result</span> <span class="o">=</span> <span class="n">pager</span><span class="o">.</span><span class="n">paginate_queryset</span><span class="p">(</span><span class="n">queryset</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 3.åºåˆ—åŒ–</span>
</span></span><span class="line"><span class="cl">        <span class="n">ser</span> <span class="o">=</span> <span class="n">BlogSerializer</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">many</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 4.è·å–åˆ†é¡µè¿”å›ç»“æœ</span>
</span></span><span class="line"><span class="cl">        <span class="n">response</span> <span class="o">=</span> <span class="n">pager</span><span class="o">.</span><span class="n">get_paginated_response</span><span class="p">(</span><span class="n">ser</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">response</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="è§†å›¾">è§†å›¾
</h2><h3 id="viewapiviewå›é¡¾">Viewã€APIViewå›é¡¾
</h3><p>å…·ä½“çœ‹ä¹‹å‰ä»‹ç»djangoä¸­çš„requestçš„æ–‡ç« ä»¥åŠè®¤è¯ç»„ä»¶ï¼Œç‰ˆæœ¬ç»„ä»¶ç­‰çš„æ–‡ç« ï¼Œè¯¦ç»†çš„ä»‹ç»äº†æ•´ä¸ªè¯·æ±‚ç”Ÿå‘½æµç¨‹</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">path</span><span class="p">(</span><span class="s1">&#39;api/blog/&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">BlogView</span><span class="o">.</span><span class="n">as_view</span><span class="p">()),</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">View</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="k">def</span> <span class="nf">as_view</span><span class="p">(</span><span class="o">...</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">		<span class="k">def</span> <span class="nf">view</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">			<span class="o">...</span><span class="n">dispatch</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="n">view</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">def</span> <span class="nf">dispatch</span><span class="p">(</span><span class="o">...</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">		<span class="n">func</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">è¯·æ±‚çš„Method</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="n">func</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">APIView</span><span class="p">(</span><span class="n">View</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="k">def</span> <span class="nf">as_view</span><span class="p">(</span><span class="o">...</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">		<span class="c1"># 1.è‡ªå®šä¹‰åŠŸèƒ½  -&gt; å…é™¤csrf token</span>
</span></span><span class="line"><span class="cl">		<span class="c1"># 2.çˆ¶ç±»as_view</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">def</span> <span class="nf">dispatch</span><span class="p">(</span><span class="o">...</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">		<span class="c1"># 1.è¯·æ±‚çš„å°è£…</span>
</span></span><span class="line"><span class="cl">		<span class="c1"># 2.ç‰ˆæœ¬ã€è®¤è¯ã€æƒé™ã€é™æµ</span>
</span></span><span class="line"><span class="cl">		<span class="c1"># 3.åå°„getattr(self,è¯·æ±‚çš„Method)</span>
</span></span><span class="line"><span class="cl">		<span class="c1"># 4.è¿”å›</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">BlogView</span><span class="p">(</span><span class="n">APIView</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">	<span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="n">request</span><span class="p">,</span><span class="o">...</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">		<span class="k">pass</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="n">request</span><span class="p">,</span><span class="o">...</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">		<span class="k">pass</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">def</span> <span class="nf">put</span><span class="p">(</span><span class="n">request</span><span class="p">,</span><span class="o">...</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">		<span class="k">pass</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="genericapiview">GenericAPIVIew
</h3><p>åœ¨drfä¸­ï¼Œä¸åªæœ‰APIViewï¼Œå…¶å®è¿˜æœ‰å¥½å¤šå¥½ç”¨çš„Viewï¼Œè¿™ä¸€èŠ‚æˆ‘ä»¬å…ˆæ¥ä»‹ç»ä¸€ä¸ªä¸­é—´ç±»GenericAPIVIewï¼Œä¸ºä»€ä¹ˆå«ä»–ä¸­é—´ç±»å‘¢ï¼Ÿ</p>
<p>å› ä¸ºæˆ‘ä»¬ä¸€èˆ¬ä¸ç›´æ¥ä½¿ç”¨å®ƒï¼Œè€Œæ˜¯ä½¿ç”¨å®ƒçš„å„ç§å­ç±»ï¼Œè¯´ç™½äº†è¿™ä¸ªä¸­é—´ç±»æ˜¯ç»™å­ç±»ç”¨çš„ï¼Œæˆ‘ä»¬å…ˆæ¥å­¦ä¹ ä¸€ä¸‹è¿™ä¸ªç±»éƒ½æä¾›äº†ä»€ä¹ˆåŠŸèƒ½</p>
<ul>
<li>è·å–querysetå¹¶ç»Ÿä¸€æ ¼å¼<code>get_queryset()</code></li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl">    <span class="n">queryset</span> <span class="o">=</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get_queryset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># æ–­è¨€è¯­å¥ï¼Œç¡®ä¿querysetéç©ºï¼Œå¦åˆ™ä¸å‘ä¸‹æ‰§è¡Œ</span>
</span></span><span class="line"><span class="cl">        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">queryset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;&#39;</span><span class="si">%s</span><span class="s2">&#39; should either include a `queryset` attribute, &#34;</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;or override the `get_queryset()` method.&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">queryset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">queryset</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># ç¡®ä¿æ ¼å¼</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">queryset</span><span class="p">,</span> <span class="n">QuerySet</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">queryset</span> <span class="o">=</span> <span class="n">queryset</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">queryset</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>åˆ†é¡µ<code>paginate_queryset()</code></li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl">	<span class="c1"># å»é…ç½®ä¸­è¯»å–é»˜è®¤çš„åˆ†é¡µç»„ä»¶</span>
</span></span><span class="line"><span class="cl">    <span class="n">pagination_class</span> <span class="o">=</span> <span class="n">api_settings</span><span class="o">.</span><span class="n">DEFAULT_PAGINATION_CLASS</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">	<span class="c1"># è¿”å›åˆ†é¡µç»„ä»¶ç±»çš„å®ä¾‹åŒ–å¯¹è±¡</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@property</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">paginator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">        The paginator instance associated with the view, or `None`.
</span></span></span><span class="line"><span class="cl"><span class="s2">        &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_paginator&#39;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pagination_class</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">_paginator</span> <span class="o">=</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">_paginator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pagination_class</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_paginator</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">paginate_queryset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">queryset</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">        Return a single page of results, or `None` if pagination is disabled.
</span></span></span><span class="line"><span class="cl"><span class="s2">        &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">paginator</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># è°ƒç”¨åˆ†é¡µç»„ä»¶ç±»è‡ªå·±çš„paginate_querysetæ–¹æ³•</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">paginator</span><span class="o">.</span><span class="n">paginate_queryset</span><span class="p">(</span><span class="n">queryset</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="n">view</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>settings.pyæ–‡ä»¶é…ç½®é»˜è®¤åˆ†é¡µç»„ä»¶</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">REST_FRAMEWORK</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;UNAUTHENTICATED_USER&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;DEFAULT_PAGINATION_CLASS&#39;</span><span class="p">:</span> <span class="s1">&#39;rest_framework.pagination.PageNumberPagination&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>åºåˆ—åŒ–<code>get_serializer()</code></li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"> 	<span class="n">serializer_class</span> <span class="o">=</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get_serializer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># è·å–åºåˆ—åŒ–å™¨</span>
</span></span><span class="line"><span class="cl">        <span class="n">serializer_class</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_serializer_class</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># å°è£…å†…å®¹</span>
</span></span><span class="line"><span class="cl">        <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;context&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_serializer_context</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># å®ä¾‹åŒ–åºåˆ—åŒ–å™¨ç±»å¹¶ä¼ å…¥å‚æ•°</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">serializer_class</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get_serializer_class</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">serializer_class</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;&#39;</span><span class="si">%s</span><span class="s2">&#39; should either include a `serializer_class` attribute, &#34;</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;or override the `get_serializer_class()` method.&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">serializer_class</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get_serializer_context</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;request&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;format&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">format_kwarg</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;view&#39;</span><span class="p">:</span> <span class="bp">self</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>è¿”å›<code>get_paginated_response()</code></li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get_paginated_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">paginator</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">paginator</span><span class="o">.</span><span class="n">get_paginated_response</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä½¿ç”¨æ•ˆæœ</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">DemoView</span><span class="p">(</span><span class="n">GenericAPIView</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">queryset</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">UserInfo</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">DemoSerializer</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 1.è¯»å–æ•°æ®åº“ä¸­çš„åšå®¢ä¿¡æ¯</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># queryset = models.Blog.objects.all()</span>
</span></span><span class="line"><span class="cl">        <span class="n">queryset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_queryset</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 2.åˆ†é¡µ</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># from rest_framework.pagination import PageNumberPagination</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># pager = PageNumberPagination()</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># result = pager.paginate_queryset(queryset, request, self)</span>
</span></span><span class="line"><span class="cl">        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">paginate_queryset</span><span class="p">(</span><span class="n">queryset</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 3.åºåˆ—åŒ–</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># ser = DemoSerializer(instance=result, many=True)</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># print(ser.data)</span>
</span></span><span class="line"><span class="cl">        <span class="n">ser</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_serializer</span><span class="p">(</span><span class="n">instance</span><span class="o">=</span><span class="n">result</span><span class="p">,</span> <span class="n">many</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 4.è¿”å›</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># return Response(&#34;...&#34;)</span>
</span></span><span class="line"><span class="cl">        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_paginated_response</span><span class="p">(</span><span class="n">ser</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">response</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>è·å–å•ä¸ªå¯¹è±¡<code>get_object()</code></li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get_object</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># å¯¹æŸ¥è¯¢é›†è¿›è¡Œç­›é€‰ï¼Œä¾‹å¦‚åº”ç”¨è¿‡æ»¤å™¨ã€åˆ†é¡µç­‰</span>
</span></span><span class="line"><span class="cl">        <span class="n">queryset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter_queryset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_queryset</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">	   <span class="c1"># lookup_url_kwargï¼šURL ä¸­ç”¨äºæŸ¥æ‰¾å¯¹è±¡çš„å‚æ•°åç§°</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># lookup_fieldï¼šé»˜è®¤çš„æŸ¥æ‰¾å­—æ®µåç§°</span>
</span></span><span class="line"><span class="cl">        <span class="n">lookup_url_kwarg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookup_url_kwarg</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookup_field</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">assert</span> <span class="n">lookup_url_kwarg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">,</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;Expected view </span><span class="si">%s</span><span class="s1"> to be called with a URL keyword argument &#39;</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;named &#34;</span><span class="si">%s</span><span class="s1">&#34;. Fix your URL conf, or set the `.lookup_field` &#39;</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;attribute on the view correctly.&#39;</span> <span class="o">%</span>
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">lookup_url_kwarg</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span>
</span></span><span class="line"><span class="cl">	    <span class="c1"># å°è£…ç­›é€‰çš„æ¡ä»¶</span>
</span></span><span class="line"><span class="cl">        <span class="n">filter_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">lookup_field</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="n">lookup_url_kwarg</span><span class="p">]}</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># æ ¹æ®æ¡ä»¶å»querysetä¸­ç­›é€‰å‡ºæ¥</span>
</span></span><span class="line"><span class="cl">        <span class="n">obj</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">queryset</span><span class="p">,</span> <span class="o">**</span><span class="n">filter_kwargs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	    <span class="c1"># åˆ¤æ–­æƒé™ has_object_permission</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">check_object_permissions</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">obj</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># è·å–åŸå§‹queryset</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get_queryset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">queryset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;&#39;</span><span class="si">%s</span><span class="s2">&#39; should either include a `queryset` attribute, &#34;</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;or override the `get_queryset()` method.&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">queryset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">queryset</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">queryset</span><span class="p">,</span> <span class="n">QuerySet</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># Ensure queryset is re-evaluated on each request.</span>
</span></span><span class="line"><span class="cl">            <span class="n">queryset</span> <span class="o">=</span> <span class="n">queryset</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">queryset</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># æ ¹æ®æ¡ä»¶ç­›é€‰å‡ºç›®æ ‡æ•°æ®å¯¹è±¡</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get_object_or_404</span><span class="p">(</span><span class="n">queryset</span><span class="p">,</span> <span class="o">*</span><span class="n">filter_args</span><span class="p">,</span> <span class="o">**</span><span class="n">filter_kwargs</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">_get_object_or_404</span><span class="p">(</span><span class="n">queryset</span><span class="p">,</span> <span class="o">*</span><span class="n">filter_args</span><span class="p">,</span> <span class="o">**</span><span class="n">filter_kwargs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">,</span> <span class="n">ValidationError</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">raise</span> <span class="n">Http404</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">    <span class="c1"># æœ¬è´¨å°±æ˜¯ queryset.get(*args, **kwargs)</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">_get_object_or_404</span><span class="p">(</span><span class="n">klass</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">queryset</span> <span class="o">=</span> <span class="n">_get_queryset</span><span class="p">(</span><span class="n">klass</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">queryset</span><span class="p">,</span> <span class="s1">&#39;get&#39;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">klass__name</span> <span class="o">=</span> <span class="n">klass</span><span class="o">.</span><span class="vm">__name__</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">klass</span><span class="p">,</span> <span class="nb">type</span><span class="p">)</span> <span class="k">else</span> <span class="n">klass</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
</span></span><span class="line"><span class="cl">            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;First argument to get_object_or_404() must be a Model, Manager, &#34;</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;or QuerySet, not &#39;</span><span class="si">%s</span><span class="s2">&#39;.&#34;</span> <span class="o">%</span> <span class="n">klass__name</span>
</span></span><span class="line"><span class="cl">            <span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">queryset</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">except</span> <span class="n">queryset</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">raise</span> <span class="n">Http404</span><span class="p">(</span><span class="s1">&#39;No </span><span class="si">%s</span><span class="s1"> matches the given query.&#39;</span> <span class="o">%</span> <span class="n">queryset</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">object_name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># é€ä¸€åˆ¤æ–­æƒé™ï¼Œå¯ä»¥åœ¨æƒé™ç±»ä¸­å¯¹æ“ä½œè€…è§’è‰²è¿›è¡Œåˆ¤å®š</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">check_object_permissions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">permission</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_permissions</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="ow">not</span> <span class="n">permission</span><span class="o">.</span><span class="n">has_object_permission</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">permission_denied</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                    <span class="n">request</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">message</span><span class="o">=</span><span class="nb">getattr</span><span class="p">(</span><span class="n">permission</span><span class="p">,</span> <span class="s1">&#39;message&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                    <span class="n">code</span><span class="o">=</span><span class="nb">getattr</span><span class="p">(</span><span class="n">permission</span><span class="p">,</span> <span class="s1">&#39;code&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="p">)</span>
</span></span><span class="line"><span class="cl">                
</span></span></code></pre></td></tr></table>
</div>
</div><p>lookup_url_kwargå’Œlookup_fieldä½¿ç”¨ç¤ºä¾‹</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">UserDetailView</span><span class="p">(</span><span class="n">RetrieveAPIView</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">queryset</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">UserSerializer</span>
</span></span><span class="line"><span class="cl">    <span class="n">lookup_field</span> <span class="o">=</span> <span class="s1">&#39;username&#39;</span>  <span class="c1"># æŒ‡å®šæ¨¡å‹å­—æ®µ</span>
</span></span><span class="line"><span class="cl">    <span class="n">lookup_url_kwarg</span> <span class="o">=</span> <span class="s1">&#39;username&#39;</span>  <span class="c1"># æŒ‡å®š URL å‚æ•°åç§°</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl"><span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="n">path</span><span class="p">(</span><span class="s1">&#39;users/&lt;str:username&gt;/&#39;</span><span class="p">,</span> <span class="n">UserDetailView</span><span class="o">.</span><span class="n">as_view</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;user-detail&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl"><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="c1"># urlä¸­ä¼ é€’usernameå‚æ•°ï¼Œç”¨å®ƒçš„å€¼ä½œä¸ºæ¨¡å‹å­—æ®µusernameçš„å€¼è¿›è¡Œç­›é€‰</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>å…³äºfilter_querysetçš„ä½œç”¨ï¼Ÿ</p>
<p>å®ƒæ˜¯ç”¨æ¥å¯¹querysetåšç­›é€‰çš„</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">æ¯”å¦‚è¦åœ¨ä¸‹åˆ—è¯­å¥çš„åŸºç¡€ä¸Šæ·»åŠ æ¡ä»¶</span>
</span></span><span class="line"><span class="cl"><span class="n">obj</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">UserInfo</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">å¯ä»¥ç›´æ¥å†å†™ä¸€ä¸ªfilter</span>
</span></span><span class="line"><span class="cl"><span class="n">obj</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">UserInfo</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="n">xx</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">æˆ–è€…</span>
</span></span><span class="line"><span class="cl"><span class="n">queryset</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">UserInfo</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="n">xx</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_object</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä½†æ˜¯å¦‚æœstatusè¦åŠ¨æ€å˜åŒ–ï¼Œå°±æ— æ³•ç”¨è¿™ä¸¤ç§æ–¹å¼å®ç°äº†</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl">    <span class="n">filter_backends</span> <span class="o">=</span> <span class="n">api_settings</span><span class="o">.</span><span class="n">DEFAULT_FILTER_BACKENDS</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">filter_queryset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">queryset</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">        Given a queryset, filter it with whichever filter backend is in use.
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">        You are unlikely to want to override this method, although you may need
</span></span></span><span class="line"><span class="cl"><span class="s2">        to call it either from a list view, or from a custom `get_object`
</span></span></span><span class="line"><span class="cl"><span class="s2">        method if you want to apply the configured filtering backend to the
</span></span></span><span class="line"><span class="cl"><span class="s2">        default queryset.
</span></span></span><span class="line"><span class="cl"><span class="s2">        &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">backend</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filter_backends</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">queryset</span> <span class="o">=</span> <span class="n">backend</span><span class="p">()</span><span class="o">.</span><span class="n">filter_queryset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="n">queryset</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">queryset</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>é˜…è¯»ä¸Šé¢æºç å¯çŸ¥ï¼Œå®ƒä»ä¸€ä¸ªç±»åˆ—è¡¨filter_backendsä¸­å¾ªç¯æ¯ä¸€ä¸ªç±»ï¼Œç„¶åè°ƒç”¨ä»–ä»¬çš„filter_querysetæ–¹æ³•ï¼Œä¸‹é¢æˆ‘ä»¬è¿›å…¥å®æ“ç¯èŠ‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">rest_framework.filters</span> <span class="kn">import</span> <span class="n">BaseFilterBackend</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">MyFilterBackend</span><span class="p">(</span><span class="n">BaseFilterBackend</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">filter_queryset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">queryset</span><span class="p">,</span> <span class="n">view</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">xx</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">query_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&#34;xx&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">queryset</span> <span class="o">=</span> <span class="n">queryset</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="n">xx</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">queryset</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">MyFilterBackend2</span><span class="p">(</span><span class="n">BaseFilterBackend</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">filter_queryset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">queryset</span><span class="p">,</span> <span class="n">view</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">queryset</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">DemoDetailView</span><span class="p">(</span><span class="n">GenericAPIView</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">queryset</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">UserInfo</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">filter_backends</span> <span class="o">=</span> <span class="p">[</span><span class="n">MyFilterBackend</span><span class="p">,</span> <span class="n">MyFilterBackend2</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">pk</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="n">pk</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 1.å–æ•°æ®</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># obj = models.UserInfo.objects.filter(pk=10).first()</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># obj = models.UserInfo.objects.get(id=10)  # id=10å¿…é¡»æ‰¾åˆ°ä¸”åªèƒ½æœ‰ä¸€æ¡</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># å–æ•°æ® + æ•°æ®æ ¡éªŒ as_object_permission</span>
</span></span><span class="line"><span class="cl">        <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_object</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 2.åºåˆ—åŒ–</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># ser = DemoSerializer(instance=obj, many=False)</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># print(ser.data)</span>
</span></span><span class="line"><span class="cl">        <span class="n">ser</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_serializer</span><span class="p">(</span><span class="n">instance</span><span class="o">=</span><span class="n">obj</span><span class="p">,</span> <span class="n">many</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">ser</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ³¨æ„ï¼šæœ€å¤§çš„æ„ä¹‰ï¼Œå°†æ•°æ®åº“æŸ¥è¯¢ã€åºåˆ—åŒ–ç±»æå–åˆ°ç±»å˜é‡ä¸­ï¼ŒåæœŸå†æä¾›å…¬å…±çš„get/post/put/deleteç­‰æ–¹æ³•ï¼Œè®©å¼€å‘è€…åªå®šä¹‰ç±»å˜é‡ï¼Œè‡ªåŠ¨å®ç°å¢åˆ æ”¹æŸ¥</p>
<p>æˆ‘ä»¬å·²ç»å¤§è‡´å­¦å®Œäº†GenericViewçš„æ‰€æœ‰åŠŸèƒ½ï¼Œä¼šå‘ç°ä»–åŸºæœ¬åªæ˜¯å¯¹åŸæœ¬æˆ‘ä»¬çš„æ“ä½œåšäº†ä¸€ä¸ªå°è£…ï¼Œå¹¶æ²¡æœ‰è®©æˆ‘ä»¬çš„å¼€å‘ç®€ä¾¿å¤šå°‘ã€‚æ­£å¦‚æˆ‘ä»¬å‰é¢æ‰€è¯´ï¼Œä»–æ˜¯ç”¨æ¥æœåŠ¡å…¶ä»–ç±»çš„ï¼Œä¸‹é¢æˆ‘ä»¬å°±æ¥çœ‹çœ‹å…¶ä»–çš„è§†å›¾ç±»é€šè¿‡GenericViewæ˜¯å¦‚ä½•ç®€åŒ–æˆ‘ä»¬çš„æ“ä½œçš„</p>
<blockquote>
<p>ä¸Šè¿°ä»£ç æ‰“åŒ…å‘½åä¸ºdrf3.zip</p></blockquote>
<h3 id="genericviewset">GenericViewSet
</h3><p><img src="/post/python/DRF/image-20250122230642274.png"
	
	
	
	loading="lazy"
	
		alt="image-20250122230642274"
	
	
></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">GenericViewSet</span><span class="p">(</span><span class="n">ViewSetMixin</span><span class="p">,</span> <span class="n">generics</span><span class="o">.</span><span class="n">GenericAPIView</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">pass</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>å¯è§GenericViewSetç±»åªæ˜¯ç®€å•ç»§æ‰¿äº†ViewSetMixinç±»å’ŒGenericAPIViewç±»ï¼Œä¸‹é¢æˆ‘ä»¬æ¥çœ‹çœ‹ViewSetMixinç±»æä¾›äº†ä»€ä¹ˆåŠŸèƒ½</p>
<p><img src="/post/python/DRF/image-20250122232449040.png"
	
	
	
	loading="lazy"
	
		alt="image-20250122232449040"
	
	
></p>
<p>å…³é”®å°±æ˜¯åœ¨äºè¿™ä¸ª<code>as_view()</code>æ–¹æ³•ï¼Œä»¥å‰æˆ‘ä»¬ä½¿ç”¨çš„è§†å›¾ç»§æ‰¿VIewæˆ–æ˜¯APIViewï¼Œå› ä¸ºéƒ½ä¸ä¼šè‡ªå®šä¹‰as_viewï¼Œæ‰€ä»¥éƒ½æ˜¯èµ°åˆ°VIewè§†å›¾ç±»çš„as_view()æ–¹æ³•ï¼Œä½†ViewSetMixinç±»æä¾›äº†as_viewæ–¹æ³•ï¼Œä»–ä¸ºæˆ‘ä»¬æä¾›äº†ä»€ä¹ˆåŠŸèƒ½å‘¢ï¼Ÿ</p>
<p>ä»¥å‰æˆ‘ä»¬çš„è§†å›¾</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">ç»§æ‰¿</span> <span class="n">APIView</span><span class="err">ã€</span><span class="n">GenericAPIView</span>
</span></span><span class="line"><span class="cl">	<span class="n">è·¯ç”±</span><span class="err">ï¼š</span>
</span></span><span class="line"><span class="cl">    	<span class="n">path</span><span class="p">(</span><span class="s1">&#39;api/demo/&#39;</span><span class="p">,</span> <span class="n">demo</span><span class="o">.</span><span class="n">DemoView</span><span class="o">.</span><span class="n">as_view</span><span class="p">()),</span>
</span></span><span class="line"><span class="cl">    	<span class="n">path</span><span class="p">(</span><span class="s1">&#39;api/demo/&lt;int:pk&gt;/&#39;</span><span class="p">,</span> <span class="n">demo</span><span class="o">.</span><span class="n">DemoDetailView</span><span class="o">.</span><span class="n">as_view</span><span class="p">()),</span>
</span></span><span class="line"><span class="cl">    <span class="n">è§†å›¾</span><span class="err">ï¼š</span>
</span></span><span class="line"><span class="cl">    	<span class="k">class</span> <span class="nc">DemoView</span><span class="p">(</span><span class="n">GenericAPIView</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    		<span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    			<span class="k">pass</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    		<span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    			<span class="k">pass</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    	<span class="k">class</span> <span class="nc">DemoDetailView</span><span class="p">(</span><span class="n">GenericAPIView</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    		<span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span><span class="n">pk</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    			<span class="k">pass</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    		<span class="k">def</span> <span class="nf">put</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span><span class="n">pk</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    			<span class="k">pass</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    		<span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span><span class="n">pk</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    			<span class="k">pass</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">DRF</span> <span class="n">çš„APIè®¾è®¡æ€è·¯</span><span class="err">ï¼š</span>
</span></span><span class="line"><span class="cl">    	<span class="n">api</span><span class="o">/</span><span class="n">demo</span><span class="o">/</span>        <span class="n">GET</span>          <span class="n">æ•°æ®åˆ—è¡¨</span> 
</span></span><span class="line"><span class="cl">		<span class="n">api</span><span class="o">/</span><span class="n">demo</span><span class="o">/</span>        <span class="n">POST</span>         <span class="n">æ–°å»ºæ•°æ®</span>
</span></span><span class="line"><span class="cl">		<span class="n">api</span><span class="o">/</span><span class="n">demo</span><span class="o">/</span><span class="mi">10</span><span class="o">/</span>     <span class="n">GET</span>          <span class="n">è·å–æŒ‡å®šä¸€æ¡æ•°æ®è¯¦ç»†</span>
</span></span><span class="line"><span class="cl">		<span class="n">api</span><span class="o">/</span><span class="n">demo</span><span class="o">/</span><span class="mi">10</span><span class="o">/</span>     <span class="n">PUT</span>          <span class="n">ä¿®æ”¹æ•°æ®</span>
</span></span><span class="line"><span class="cl">		<span class="n">api</span><span class="o">/</span><span class="n">demo</span><span class="o">/</span><span class="mi">10</span><span class="o">/</span>     <span class="n">DELETE</span>       <span class="n">åˆ é™¤æ•°æ®</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>å°†ä¸¤ä¸ªè§†å›¾åˆäºŒä¸ºä¸€</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">è§†å›¾ç»§æ‰¿</span> <span class="n">APIView</span><span class="err">ã€</span><span class="n">GenericAPIView</span>
</span></span><span class="line"><span class="cl">	<span class="n">è·¯ç”±</span><span class="err">ï¼š</span>
</span></span><span class="line"><span class="cl">    	<span class="n">path</span><span class="p">(</span><span class="s1">&#39;api/demo/&#39;</span><span class="p">,</span> <span class="n">demo</span><span class="o">.</span><span class="n">DemoView</span><span class="o">.</span><span class="n">as_view</span><span class="p">()),</span>
</span></span><span class="line"><span class="cl">    	<span class="n">path</span><span class="p">(</span><span class="s1">&#39;api/demo/&lt;int:pk&gt;/&#39;</span><span class="p">,</span> <span class="n">demo</span><span class="o">.</span><span class="n">DemoView</span><span class="o">.</span><span class="n">as_view</span><span class="p">()),</span>
</span></span><span class="line"><span class="cl">    <span class="n">è§†å›¾</span><span class="err">ï¼š</span>
</span></span><span class="line"><span class="cl">    	<span class="k">class</span> <span class="nc">DemoView</span><span class="p">(</span><span class="n">GenericAPIView</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    		<span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span><span class="n">pk</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    			<span class="k">if</span> <span class="n">pk</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    				<span class="n">è·å–å•æ¡æ•°æ®</span>
</span></span><span class="line"><span class="cl">    			<span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    				<span class="n">è·å–æ•°æ®åˆ—è¡¨æ•°æ®</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    		<span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    			<span class="k">pass</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    		<span class="k">def</span> <span class="nf">put</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span><span class="n">pk</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    			<span class="k">pass</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    		<span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span><span class="n">pk</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    			<span class="k">pass</span>
</span></span><span class="line"><span class="cl">    			
</span></span><span class="line"><span class="cl">    <span class="n">DRF</span> <span class="n">çš„APIè®¾è®¡æ€è·¯</span><span class="err">ï¼š</span>
</span></span><span class="line"><span class="cl">    	<span class="n">api</span><span class="o">/</span><span class="n">demo</span><span class="o">/</span>        <span class="n">GET</span>          <span class="n">æ•°æ®åˆ—è¡¨</span> 
</span></span><span class="line"><span class="cl">		<span class="n">api</span><span class="o">/</span><span class="n">demo</span><span class="o">/</span>        <span class="n">POST</span>         <span class="n">æ–°å»ºæ•°æ®</span>
</span></span><span class="line"><span class="cl">		<span class="n">api</span><span class="o">/</span><span class="n">demo</span><span class="o">/</span><span class="mi">10</span><span class="o">/</span>     <span class="n">GET</span>          <span class="n">è·å–æŒ‡å®šä¸€æ¡æ•°æ®è¯¦ç»†</span>
</span></span><span class="line"><span class="cl">		<span class="n">api</span><span class="o">/</span><span class="n">demo</span><span class="o">/</span><span class="mi">10</span><span class="o">/</span>     <span class="n">PUT</span>          <span class="n">ä¿®æ”¹æ•°æ®</span>
</span></span><span class="line"><span class="cl">		<span class="n">api</span><span class="o">/</span><span class="n">demo</span><span class="o">/</span><span class="mi">10</span><span class="o">/</span>     <span class="n">DELETE</span>       <span class="n">åˆ é™¤æ•°æ®</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>æœ‰äº†ViewSetMixinå</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">ViewSetMixin</span>
</span></span><span class="line"><span class="cl">  <span class="n">å¯¹è¯·æ±‚è¿›è¡Œåˆ†å‘</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">DRF</span> <span class="n">çš„APIè®¾è®¡æ€è·¯</span><span class="err">ï¼š</span>
</span></span><span class="line"><span class="cl">	<span class="n">api</span><span class="o">/</span><span class="n">demo</span><span class="o">/</span>        <span class="n">GET</span>          <span class="n">æ•°æ®åˆ—è¡¨</span> 
</span></span><span class="line"><span class="cl">	<span class="n">api</span><span class="o">/</span><span class="n">demo</span><span class="o">/</span>        <span class="n">POST</span>         <span class="n">æ–°å»ºæ•°æ®</span>
</span></span><span class="line"><span class="cl">	<span class="n">api</span><span class="o">/</span><span class="n">demo</span><span class="o">/</span><span class="mi">10</span><span class="o">/</span>     <span class="n">GET</span>          <span class="n">è·å–æŒ‡å®šä¸€æ¡æ•°æ®è¯¦ç»†</span>
</span></span><span class="line"><span class="cl">	<span class="n">api</span><span class="o">/</span><span class="n">demo</span><span class="o">/</span><span class="mi">10</span><span class="o">/</span>     <span class="n">PUT</span>          <span class="n">ä¿®æ”¹æ•°æ®</span>
</span></span><span class="line"><span class="cl">	<span class="n">api</span><span class="o">/</span><span class="n">demo</span><span class="o">/</span><span class="mi">10</span><span class="o">/</span>     <span class="n">DELETE</span>       <span class="n">åˆ é™¤æ•°æ®</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">api</span><span class="o">/</span><span class="n">demo</span><span class="o">/</span><span class="err">?</span><span class="n">gender</span><span class="o">=</span><span class="mi">1</span><span class="o">&amp;</span><span class="n">age</span><span class="o">=</span><span class="mi">19</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">è·¯ç”±</span>
</span></span><span class="line"><span class="cl">	<span class="n">path</span><span class="p">(</span><span class="s1">&#39;api/demo/&#39;</span><span class="p">,</span> <span class="n">demo</span><span class="o">.</span><span class="n">GvsView</span><span class="o">.</span><span class="n">as_view</span><span class="p">({</span><span class="s2">&#34;get&#34;</span><span class="p">:</span><span class="s2">&#34;list&#34;</span><span class="p">,</span><span class="s2">&#34;post&#34;</span><span class="p">:</span><span class="s2">&#34;create&#34;</span><span class="p">})),</span>
</span></span><span class="line"><span class="cl">    <span class="n">path</span><span class="p">(</span><span class="s1">&#39;api/demo/&lt;int:pk&gt;/&#39;</span><span class="p">,</span> <span class="n">demo</span><span class="o">.</span><span class="n">GvsView</span><span class="o">.</span><span class="n">as_view</span><span class="p">({</span><span class="s2">&#34;get&#34;</span><span class="p">:</span><span class="s2">&#34;retrieve&#34;</span><span class="p">,</span><span class="s2">&#34;delete&#34;</span><span class="p">:</span><span class="s2">&#34;destroy&#34;</span><span class="p">,</span><span class="s2">&#34;put&#34;</span><span class="p">:</span><span class="s2">&#34;update&#34;</span><span class="p">})),</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">è§†å›¾</span><span class="err">ï¼š</span>
</span></span><span class="line"><span class="cl">    	<span class="k">class</span> <span class="nc">GvsView</span><span class="p">(</span><span class="n">ViewSetMixin</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    		<span class="k">def</span> <span class="nf">list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">request</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    			<span class="k">pass</span> <span class="c1"># è·å–æ•°æ®åˆ—è¡¨</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    		<span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">request</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    			<span class="k">pass</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    		<span class="k">def</span> <span class="nf">retrive</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">request</span><span class="p">,</span><span class="n">pk</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    			<span class="k">pass</span> <span class="c1"># è·å–æ•°æ®è¯¦ç»†</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    		<span class="k">def</span> <span class="nf">destroy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">request</span><span class="p">,</span><span class="n">pk</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    			<span class="k">pass</span> <span class="c1"># åˆ é™¤</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    		<span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">request</span><span class="p">,</span><span class="n">pk</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    			<span class="k">pass</span> <span class="c1"># ä¿®æ”¹</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>æœ‰äº†å…¨æ–°çš„ä¸€å¥—è·¯ç”±åŒ¹é…è§†å›¾ç±»çš„è§„åˆ™ï¼Œè€Œä¸æ˜¯åŸæ¥çš„é åå°„æ¥è·å–åˆ°å¯¹åº”çš„getæˆ–postæ–¹æ³•</p>
<p>å®æ“ç¯èŠ‚</p>
<ul>
<li>è·¯ç”±</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="n">path</span><span class="p">(</span><span class="s1">&#39;api/gvs/&#39;</span><span class="p">,</span> <span class="n">gvs</span><span class="o">.</span><span class="n">GvsView</span><span class="o">.</span><span class="n">as_view</span><span class="p">({</span><span class="s2">&#34;get&#34;</span><span class="p">:</span> <span class="s2">&#34;list&#34;</span><span class="p">,</span> <span class="s2">&#34;post&#34;</span><span class="p">:</span> <span class="s2">&#34;create&#34;</span><span class="p">})),</span>
</span></span><span class="line"><span class="cl">    <span class="n">path</span><span class="p">(</span><span class="s1">&#39;api/gvs/&lt;int:pk&gt;/&#39;</span><span class="p">,</span> <span class="n">gvs</span><span class="o">.</span><span class="n">GvsView</span><span class="o">.</span><span class="n">as_view</span><span class="p">({</span><span class="s2">&#34;get&#34;</span><span class="p">:</span> <span class="s2">&#34;retrieve&#34;</span><span class="p">})),</span>
</span></span><span class="line"><span class="cl"><span class="p">]</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>è§†å›¾</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">GvsView</span><span class="p">(</span><span class="n">ViewSetMixin</span><span class="p">,</span> <span class="n">GenericAPIView</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="s1">&#39;list&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="s1">&#39;create&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">retrieve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="s1">&#39;retrieve&#39;</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="äº”å¤§ç±»">äº”å¤§ç±»
</h3><h4 id="listmodelmixin">ListModelMixin
</h4><p>å…ˆä½¿ç”¨GenericViewSetå®ç°ä¸€ä¸ªæŸ¥çœ‹ç”¨æˆ·ä¿¡æ¯åˆ—è¡¨çš„åŠŸèƒ½</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">rest_framework.viewsets</span> <span class="kn">import</span> <span class="n">GenericViewSet</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">rest_framework.response</span> <span class="kn">import</span> <span class="n">Response</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">api</span> <span class="kn">import</span> <span class="n">models</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">rest_framework.serializers</span> <span class="kn">import</span> <span class="n">ModelSerializer</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">BlogSerializer</span><span class="p">(</span><span class="n">ModelSerializer</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Blog</span>
</span></span><span class="line"><span class="cl">        <span class="n">fields</span> <span class="o">=</span> <span class="s1">&#39;__all__&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">BlogView</span><span class="p">(</span><span class="n">GenericViewSet</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">queryset</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Blog</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">BlogSerializer</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 1.è·å–æ•°æ®</span>
</span></span><span class="line"><span class="cl">        <span class="n">queryset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_queryset</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 2.åˆ†é¡µ</span>
</span></span><span class="line"><span class="cl">        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">paginate_queryset</span><span class="p">(</span><span class="n">queryset</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 3.åºåˆ—åŒ–</span>
</span></span><span class="line"><span class="cl">        <span class="n">ser</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_serializer</span><span class="p">(</span><span class="n">instance</span><span class="o">=</span><span class="n">result</span><span class="p">,</span> <span class="n">many</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="n">ser</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="s2">&#34;....&#34;</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>å¦‚æœæˆ‘ä»¬è¦å°†è¿™ä¸ªæ¥å£æ”¹ä¸ºæŸ¥è¯¢åšå®¢åˆ—è¡¨ï¼Œé‚£ä¹ˆåªéœ€è¦å°†è§†å›¾ç±»ä¸­çš„querysetå’Œserializer_classä¿®æ”¹ä¸ºåšå®¢ç›¸å…³çš„å³å¯ï¼Œè€Œæ— éœ€é‡å†™listæ–¹æ³•ï¼Œå› æ­¤å¯ä»¥çœ‹åˆ°ï¼Œè¿™ä¸ªlistæ–¹æ³•æ˜¯å…¬å…±çš„</p>
<p>ç„¶è€Œï¼Œdrfä¹Ÿæ„è¯†åˆ°äº†è¿™ä¸€ç‚¹ï¼Œä»–ç»™æˆ‘ä»¬æä¾›äº†ä¸€ä¸ªå«åšListModelMixinçš„è§†å›¾ç±»</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">ListModelMixin</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    List a queryset.
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">queryset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter_queryset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_queryset</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">page</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">paginate_queryset</span><span class="p">(</span><span class="n">queryset</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">page</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">serializer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_serializer</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="n">many</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_paginated_response</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">serializer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_serializer</span><span class="p">(</span><span class="n">queryset</span><span class="p">,</span> <span class="n">many</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>å¯ä»¥çœ‹åˆ°ï¼Œå®ƒä¸ºæˆ‘ä»¬å†™å¥½äº†listæ–¹æ³•ï¼Œå› æ­¤ä¸‹æ¬¡æˆ‘ä»¬è¦å®ç°æŸ¥æ‰¾åŠŸèƒ½æ˜¯ï¼Œåªéœ€è¦è‡ªå·±å®šä¹‰querysetå’Œserializer_classå³å¯ï¼Œè€Œæ— éœ€ç¼–å†™listæ–¹æ³•</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">rest_framework.mixins</span> <span class="kn">import</span> <span class="n">ListModelMixin</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">BlogSerializer</span><span class="p">(</span><span class="n">ModelSerializer</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Blog</span>
</span></span><span class="line"><span class="cl">        <span class="n">fields</span> <span class="o">=</span> <span class="s1">&#39;__all__&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">BlogView</span><span class="p">(</span><span class="n">ListModelMixin</span><span class="p">,</span> <span class="n">GenericViewSet</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">queryset</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Blog</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">BlogSerializer</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="retrievemodelmixin">RetrieveModelMixin
</h4><p>ListModelMixinè§†å›¾ç±»å®šä¹‰äº†listæ–¹æ³•ç”¨äºè·å–æ•°æ®åˆ—è¡¨ï¼Œé‚£å¦‚æœè¦è·å–å•æ¡æ•°æ®å‘¢ï¼Ÿ</p>
<p>drfç»™æˆ‘ä»¬æä¾›äº†RetrieveModelMixinæ–¹æ³•</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">RetrieveModelMixin</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    Retrieve a model instance.
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">retrieve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">instance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_object</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">serializer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_serializer</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä½¿ç”¨æ–¹æ³•åŒä¸Šï¼Œåªéœ€è¦ç»§æ‰¿RetrieveModelMixinï¼Œç„¶åæä¾›querysetå’Œserializer_classå³å¯</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="n">path</span><span class="p">(</span><span class="s1">&#39;api/blog/&#39;</span><span class="p">,</span> <span class="n">five</span><span class="o">.</span><span class="n">BlogView</span><span class="o">.</span><span class="n">as_view</span><span class="p">({</span><span class="s2">&#34;get&#34;</span><span class="p">:</span> <span class="s2">&#34;list&#34;</span><span class="p">})),</span>
</span></span><span class="line"><span class="cl">    <span class="n">path</span><span class="p">(</span><span class="s1">&#39;api/blog/&lt;int:pk&gt;/&#39;</span><span class="p">,</span> <span class="n">five</span><span class="o">.</span><span class="n">BlogView</span><span class="o">.</span><span class="n">as_view</span><span class="p">({</span><span class="s2">&#34;get&#34;</span><span class="p">:</span> <span class="s2">&#34;retrieve&#34;</span><span class="p">})),</span>
</span></span><span class="line"><span class="cl"><span class="p">]</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">rest_framework.mixins</span> <span class="kn">import</span> <span class="n">ListModelMixin</span><span class="p">,</span> <span class="n">RetrieveModelMixin</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">BlogSerializer</span><span class="p">(</span><span class="n">ModelSerializer</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Blog</span>
</span></span><span class="line"><span class="cl">        <span class="n">fields</span> <span class="o">=</span> <span class="s1">&#39;__all__&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">BlogView</span><span class="p">(</span><span class="n">ListModelMixin</span><span class="p">,</span> <span class="n">RetrieveModelMixin</span><span class="p">,</span> <span class="n">GenericViewSet</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">queryset</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Blog</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">BlogSerializer</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="åºåˆ—åŒ–å™¨çš„åˆ‡æ¢">åºåˆ—åŒ–å™¨çš„åˆ‡æ¢
</h4><p>è¿™ä¸ªéœ€æ±‚çš„æå‡ºåœ¨äºï¼Œæˆ‘ä»¬ä¸Šé¢å­¦ä¹ äº†ä¸¤ä¸ªè§†å›¾ç±»ï¼ŒListModelMixinå’ŒRetrieveModelMixinã€‚ä¸€ä¸ªå¯¹åº”è·å–æ•°æ®åˆ—è¡¨ï¼Œä¸€ä¸ªå¯¹åº”è·å–å•æ¡æ•°æ®ï¼Œä½†æ˜¯ä½¿ç”¨çš„æ˜¯åŒä¸€ä¸ªç±»ï¼Œæ„å‘³ç€ç±»å˜é‡serializer_classæ˜¯å”¯ä¸€çš„ã€‚å¦‚æœè·å–æ•°æ®åˆ—è¡¨ä¸å•æ¡æ•°æ®å¯¹åº”çš„åºåˆ—åŒ–å™¨ä¸ä¸€æ ·ï¼Œè¯¥å¦‚ä½•åˆ‡æ¢å‘¢ï¼Ÿ
ä»æºç å¯ä»¥çŸ¥é“</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get_serializer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">serializer_class</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_serializer_class</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;context&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_serializer_context</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">serializer_class</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get_serializer_class</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">serializer_class</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;&#39;</span><span class="si">%s</span><span class="s2">&#39; should either include a `serializer_class` attribute, &#34;</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;or override the `get_serializer_class()` method.&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">serializer_class</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get_serializer_context</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;request&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;format&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">format_kwarg</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;view&#39;</span><span class="p">:</span> <span class="bp">self</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>æºç æ˜¯è°ƒç”¨get_serializer_classæ–¹æ³•æ¥é€‰æ‹©åºåˆ—åŒ–å™¨çš„ï¼Œæˆ‘ä»¬åªéœ€è¦åœ¨è‡ªå·±çš„ç±»ä¸­é‡å†™å³å¯</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">BlogSerializer</span><span class="p">(</span><span class="n">ModelSerializer</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Blog</span>
</span></span><span class="line"><span class="cl">        <span class="n">fields</span> <span class="o">=</span> <span class="s1">&#39;__all__&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">BlogDetailSerializer</span><span class="p">(</span><span class="n">ModelSerializer</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BLog</span>
</span></span><span class="line"><span class="cl">        <span class="n">fields</span> <span class="o">=</span> <span class="s1">&#39;__all__&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">BlogView</span><span class="p">(</span><span class="n">ListModelMixin</span><span class="p">,</span> <span class="n">RetrieveModelMixin</span><span class="p">,</span> <span class="n">GenericViewSet</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">queryset</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Blog</span><span class="o">.</span><span class="n">objects</span>
</span></span><span class="line"><span class="cl">    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">BlogSerializer</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get_serializer_class</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># æ ¹æ®ä¸¤ä¸ªè¯·æ±‚çš„ä¸åŒæ¥åšåŒºåˆ†ï¼Œåˆ†å‘ä¸åŒçš„åºåˆ—åŒ–å™¨</span>
</span></span><span class="line"><span class="cl">        <span class="n">pk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pk&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">pk</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">serializer_class</span> <span class="o">=</span> <span class="n">BlogDetailSerializer</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">serializer_class</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¿™é‡Œä¸¤ä¸ªè¯·æ±‚éƒ½æ˜¯GETè¯·æ±‚ï¼Œå¯ä»¥é€šè¿‡æœ‰æ— pkæ¥åˆ¤æ–­</p>
<p>åé¢å­¦ä¹ äº†å…¶ä»–çš„å‡ ä¸ªè§†å›¾ç±»åï¼Œè¯·æ±‚æ–¹å¼çš„ä¸åŒå¯ä»¥é€šè¿‡ä»<code>self.request.method</code>ä¸­æ‹¿åˆ°è¯·æ±‚æ–¹æ³•è¿›è¡Œåˆ¤æ–­ï¼Œæ˜¯putã€patchã€postè¿˜æ˜¯get</p>
<h4 id="createmodelmixin">CreateModelMixin
</h4><p>æ–°å¢æ•°æ®drfä¹Ÿä¸ºæˆ‘ä»¬æä¾›äº†å¯¹åº”çš„è§†å›¾ç±»</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">CreateModelMixin</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    Create a model instance.
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">serializer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_serializer</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">serializer</span><span class="o">.</span><span class="n">is_valid</span><span class="p">(</span><span class="n">raise_exception</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">perform_create</span><span class="p">(</span><span class="n">serializer</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">headers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_success_headers</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_201_CREATED</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">perform_create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">serializer</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">serializer</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get_success_headers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;Location&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">api_settings</span><span class="o">.</span><span class="n">URL_FIELD_NAME</span><span class="p">])}</span>
</span></span><span class="line"><span class="cl">        <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="p">{}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>å¦‚æœè¦åœ¨serializer.save()æ—¶æ‰‹åŠ¨æ’å…¥ä¸€äº›æ•°æ®ï¼Œåªéœ€é‡å†™perform_createæ–¹æ³•å³å¯</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">path</span><span class="p">(</span><span class="s1">&#39;api/user/&#39;</span><span class="p">,</span> <span class="n">five</span><span class="o">.</span><span class="n">UserView</span><span class="o">.</span><span class="n">as_view</span><span class="p">({</span><span class="s2">&#34;post&#34;</span><span class="p">:</span> <span class="s2">&#34;create&#34;</span><span class="p">})),</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">UserSerializer</span><span class="p">(</span><span class="n">ModelSerializer</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">UserInfo</span>
</span></span><span class="line"><span class="cl">        <span class="n">fields</span> <span class="o">=</span> <span class="s1">&#39;__all__&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">UserView</span><span class="p">(</span><span class="n">ListModelMixin</span><span class="p">,</span> <span class="n">RetrieveModelMixin</span><span class="p">,</span> <span class="n">CreateModelMixin</span><span class="p">,</span> <span class="n">GenericViewSet</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">queryset</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">UserInfo</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">UserSerializer</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">perform_create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">serializer</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">serializer</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="updatemodelmixin">UpdateModelMixin
</h4><p>è¿™æ˜¯ä¸€ä¸ªç”¨äºå®ç°æ›´æ–°çš„è§†å›¾ç±»ï¼Œæä¾›äº†å±€éƒ¨æ›´æ–°å’Œå…¨å±€æ›´æ–°ä¸¤ç§å½¢å¼ï¼Œå› ä¸ºæˆ‘ä»¬çŸ¥é“ï¼Œåœ¨åºåˆ—åŒ–å™¨ä¸­</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">ser</span> <span class="o">=</span> <span class="n">UserSerializer</span><span class="p">(</span><span class="n">instance</span><span class="o">=</span><span class="s2">&#34;å¯¹è±¡&#34;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">request</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¿™ä¸€è¯­å¥å®ç°æ›´æ–°å¿…é¡»æ˜¯å…¨å±€æ›´æ–°ï¼Œå³è¦å°†æ— éœ€å˜åŠ¨çš„å­—æ®µå€¼ä¹Ÿè¦å¸¦ä¸Šï¼Œå±€éƒ¨æ›´æ–°çš„è¯å°±åªéœ€è¦å‘é€å˜åŠ¨çš„å­—æ®µå³å¯</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">UpdateModelMixin</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    Update a model instance.
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">partial</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;partial&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">instance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_object</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">serializer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_serializer</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">partial</span><span class="o">=</span><span class="n">partial</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">serializer</span><span class="o">.</span><span class="n">is_valid</span><span class="p">(</span><span class="n">raise_exception</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">perform_update</span><span class="p">(</span><span class="n">serializer</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="s1">&#39;_prefetched_objects_cache&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># If &#39;prefetch_related&#39; has been applied to a queryset, we need to</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># forcibly invalidate the prefetch cache on the instance.</span>
</span></span><span class="line"><span class="cl">            <span class="n">instance</span><span class="o">.</span><span class="n">_prefetched_objects_cache</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">perform_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">serializer</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">serializer</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">partial_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;partial&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>åŒæ ·çš„ï¼Œä¿å­˜æ“ä½œperform_updateæ”¯æŒæ‹“å±•</p>
<p>ä½¿ç”¨ç¤ºä¾‹</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">path</span><span class="p">(</span><span class="s1">&#39;api/user/&#39;</span><span class="p">,</span> <span class="n">five</span><span class="o">.</span><span class="n">UserView</span><span class="o">.</span><span class="n">as_view</span><span class="p">({</span><span class="s2">&#34;get&#34;</span><span class="p">:</span> <span class="s2">&#34;list&#34;</span><span class="p">,</span> <span class="s2">&#34;post&#34;</span><span class="p">:</span> <span class="s2">&#34;create&#34;</span><span class="p">})),</span>
</span></span><span class="line"><span class="cl"><span class="n">path</span><span class="p">(</span><span class="s1">&#39;api/user/&lt;int:pk&gt;/&#39;</span><span class="p">,</span> <span class="n">five</span><span class="o">.</span><span class="n">UserView</span><span class="o">.</span><span class="n">as_view</span><span class="p">({</span><span class="s2">&#34;get&#34;</span><span class="p">:</span> <span class="s2">&#34;retrieve&#34;</span><span class="p">,</span> <span class="s2">&#34;put&#34;</span><span class="p">:</span> <span class="s2">&#34;update&#34;</span><span class="p">,</span> <span class="s2">&#34;patch&#34;</span><span class="p">:</span> <span class="s2">&#34;partial_update&#34;</span><span class="p">})),</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">rest_framework.mixins</span> <span class="kn">import</span> <span class="n">ListModelMixin</span><span class="p">,</span> <span class="n">RetrieveModelMixin</span><span class="p">,</span> <span class="n">CreateModelMixin</span><span class="p">,</span> <span class="n">UpdateModelMixin</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">UserSerializer</span><span class="p">(</span><span class="n">ModelSerializer</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">UserInfo</span>
</span></span><span class="line"><span class="cl">        <span class="n">fields</span> <span class="o">=</span> <span class="s1">&#39;__all__&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">UserView</span><span class="p">(</span><span class="n">ListModelMixin</span><span class="p">,</span> <span class="n">RetrieveModelMixin</span><span class="p">,</span> <span class="n">CreateModelMixin</span><span class="p">,</span> <span class="n">UpdateModelMixin</span><span class="p">,</span> <span class="n">GenericViewSet</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">queryset</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">UserInfo</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">UserSerializer</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="/post/python/DRF/image-20250123141034289.png"
	
	
	
	loading="lazy"
	
		alt="image-20250123141034289"
	
	
></p>
<h4 id="destroymodelmixin">DestroyModelMixin
</h4><p>æä¾›åˆ é™¤è§†å›¾çš„ç±»</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">DestroyModelMixin</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    Destroy a model instance.
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">destroy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">instance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_object</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">perform_destroy</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_204_NO_CONTENT</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">perform_destroy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">instance</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>é»˜è®¤æ˜¯ç‰©ç†åˆ é™¤ï¼Œå³åœ¨æ•°æ®åº“ä¸­æŠ¹å»è¯¥æ•°æ®</p>
<p>å¦‚æœæƒ³å®ç°é€»è¾‘åˆ é™¤ï¼Œé‡å†™perform_destroyæ–¹æ³•å³å¯</p>
<h4 id="æ’åˆ—ç»„åˆç±»">æ’åˆ—ç»„åˆç±»
</h4><p>è¦å®ç°å¢åˆ æ”¹æŸ¥éœ€è¦æ‰‹åŠ¨ç»§æ‰¿ä¸Šé¢æåˆ°çš„è¿™ä¹ˆå¤šç±»å—ï¼Ÿdrfä¸ºæˆ‘ä»¬æƒ³åˆ°äº†è¿™ä¸€ç‚¹ï¼Œä»–æä¾›äº†ä¸€äº›ç»„åˆç±»ä¾›æˆ‘ä»¬å¿«é€Ÿç»§æ‰¿</p>
<p>viewsets.py</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">rest_framework.viewsets</span> <span class="kn">import</span> <span class="n">ModelViewSet</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">ModelViewSet</span><span class="p">(</span><span class="n">mixins</span><span class="o">.</span><span class="n">CreateModelMixin</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                   <span class="n">mixins</span><span class="o">.</span><span class="n">RetrieveModelMixin</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                   <span class="n">mixins</span><span class="o">.</span><span class="n">UpdateModelMixin</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                   <span class="n">mixins</span><span class="o">.</span><span class="n">DestroyModelMixin</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                   <span class="n">mixins</span><span class="o">.</span><span class="n">ListModelMixin</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                   <span class="n">GenericViewSet</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">ReadOnlyModelViewSet</span><span class="p">(</span><span class="n">mixins</span><span class="o">.</span><span class="n">RetrieveModelMixin</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                           <span class="n">mixins</span><span class="o">.</span><span class="n">ListModelMixin</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                           <span class="n">GenericViewSet</span><span class="p">):</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>generics.py</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">rest_framework.generics</span> <span class="kn">import</span> <span class="n">GenericAPIView</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">CreateAPIView</span><span class="p">(</span><span class="n">mixins</span><span class="o">.</span><span class="n">CreateModelMixin</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">GenericAPIView</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">ListAPIView</span><span class="p">(</span><span class="n">mixins</span><span class="o">.</span><span class="n">ListModelMixin</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                  <span class="n">GenericAPIView</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">RetrieveAPIView</span><span class="p">(</span><span class="n">mixins</span><span class="o">.</span><span class="n">RetrieveModelMixin</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                      <span class="n">GenericAPIView</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">retrieve</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">DestroyAPIView</span><span class="p">(</span><span class="n">mixins</span><span class="o">.</span><span class="n">DestroyModelMixin</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                     <span class="n">GenericAPIView</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">destroy</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">UpdateAPIView</span><span class="p">(</span><span class="n">mixins</span><span class="o">.</span><span class="n">UpdateModelMixin</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">GenericAPIView</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">put</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">patch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">partial_update</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">ListCreateAPIView</span><span class="p">(</span><span class="n">mixins</span><span class="o">.</span><span class="n">ListModelMixin</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="n">mixins</span><span class="o">.</span><span class="n">CreateModelMixin</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="n">GenericAPIView</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">RetrieveUpdateAPIView</span><span class="p">(</span><span class="n">mixins</span><span class="o">.</span><span class="n">RetrieveModelMixin</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                            <span class="n">mixins</span><span class="o">.</span><span class="n">UpdateModelMixin</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                            <span class="n">GenericAPIView</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">retrieve</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">put</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">patch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">partial_update</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">RetrieveDestroyAPIView</span><span class="p">(</span><span class="n">mixins</span><span class="o">.</span><span class="n">RetrieveModelMixin</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                             <span class="n">mixins</span><span class="o">.</span><span class="n">DestroyModelMixin</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                             <span class="n">GenericAPIView</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">retrieve</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">destroy</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">RetrieveUpdateDestroyAPIView</span><span class="p">(</span><span class="n">mixins</span><span class="o">.</span><span class="n">RetrieveModelMixin</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                   <span class="n">mixins</span><span class="o">.</span><span class="n">UpdateModelMixin</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                   <span class="n">mixins</span><span class="o">.</span><span class="n">DestroyModelMixin</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                   <span class="n">GenericAPIView</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">retrieve</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">put</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">patch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">partial_update</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">destroy</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="è§†å›¾æ€»ç»“">è§†å›¾æ€»ç»“
</h3><p>å­¦äº†é‚£ä¹ˆå¤šè§†å›¾ç±»ï¼Œè¯¥å¦‚ä½•é€‰æ‹©ç»§æ‰¿å‘¢ï¼Ÿ</p>
<ul>
<li>ç»§æ‰¿APIViewï¼Œæ ¸å¿ƒåŠŸèƒ½+è‡ªå·±å®ç°ä¸šåŠ¡ -&gt; è‡ªå®šä¹‰æ“ä½œï¼ˆè¯»å–redisï¼Œæ–‡ä»¶ï¼‰</li>
<li>ModelViewSetæˆ–äº”å¤§ç±»+GenericViewSet
<ul>
<li>è·¯ç”±çš„as_viewéœ€è¦å‚æ•°ï¼Œå»ºç«‹get-&gt;listçš„å…³ç³»</li>
</ul>
</li>
<li>GenericAPIView+äº”å¤§ç±»
<ul>
<li>è·¯ç”±çš„as_viewä¸éœ€è¦å‚æ•°ï¼Œç›´æ¥æ˜¯GET/POST/PUTç­‰ç­‰</li>
</ul>
</li>
</ul>
<h2 id="è·¯ç”±">è·¯ç”±
</h2><h3 id="è‡ªåŠ¨ç”Ÿæˆå¯¹åº”å…³ç³»">è‡ªåŠ¨ç”Ÿæˆå¯¹åº”å…³ç³»
</h3><p>åœ¨ä¸Šé¢çš„è§†å›¾ä¸­å½“æˆ‘ä»¬ç»§æ‰¿äº†ViewSetMixinç±»ï¼Œé‚£ä¹ˆas_viewå°±ä¼šå‘ç”Ÿå˜åŒ–ï¼Œåœ¨è·¯ç”±ä¸­å°±éœ€è¦è‡ªå·±å†™å‚æ•°æ¥å»ºç«‹get -&gt; listï¼Œpost -&gt; createç­‰å…³ç³»ï¼Œè¿˜æ˜¯æ¯”è¾ƒéº»çƒ¦çš„ï¼Œå…¶å®drfä¸ºæˆ‘ä»¬æä¾›äº†è‡ªåŠ¨ç”Ÿæˆçš„åŠŸèƒ½</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">rest_framework</span> <span class="kn">import</span> <span class="n">routers</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">router</span> <span class="o">=</span> <span class="n">routers</span><span class="o">.</span><span class="n">SimpleRouter</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">router</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;api/user&#39;</span><span class="p">,</span> <span class="n">five</span><span class="o">.</span><span class="n">UserView</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># path(&#39;admin/&#39;, admin.site.urls),</span>
</span></span><span class="line"><span class="cl">    <span class="n">path</span><span class="p">(</span><span class="s1">&#39;api/demo/&#39;</span><span class="p">,</span> <span class="n">demo</span><span class="o">.</span><span class="n">DemoView</span><span class="o">.</span><span class="n">as_view</span><span class="p">()),</span>
</span></span><span class="line"><span class="cl">    <span class="n">path</span><span class="p">(</span><span class="s1">&#39;api/demo/&lt;int:pk&gt;/&#39;</span><span class="p">,</span> <span class="n">demo</span><span class="o">.</span><span class="n">DemoDetailView</span><span class="o">.</span><span class="n">as_view</span><span class="p">()),</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">path</span><span class="p">(</span><span class="s1">&#39;api/gvs/&#39;</span><span class="p">,</span> <span class="n">gvs</span><span class="o">.</span><span class="n">GvsView</span><span class="o">.</span><span class="n">as_view</span><span class="p">({</span><span class="s2">&#34;get&#34;</span><span class="p">:</span> <span class="s2">&#34;list&#34;</span><span class="p">,</span> <span class="s2">&#34;post&#34;</span><span class="p">:</span> <span class="s2">&#34;create&#34;</span><span class="p">})),</span>
</span></span><span class="line"><span class="cl">    <span class="n">path</span><span class="p">(</span><span class="s1">&#39;api/gvs/&lt;int:pk&gt;/&#39;</span><span class="p">,</span> <span class="n">gvs</span><span class="o">.</span><span class="n">GvsView</span><span class="o">.</span><span class="n">as_view</span><span class="p">({</span><span class="s2">&#34;get&#34;</span><span class="p">:</span> <span class="s2">&#34;retrieve&#34;</span><span class="p">})),</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">    <span class="o">....</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># path(&#39;api/user/&#39;, five.UserView.as_view({&#34;get&#34;: &#34;list&#34;, &#34;post&#34;: &#34;create&#34;})),</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># path(&#39;api/user/&lt;int:pk&gt;/&#39;, five.UserView.as_view({&#34;get&#34;: &#34;retrieve&#34;, &#34;put&#34;: &#34;update&#34;, &#34;patch&#34;: &#34;partial_update&#34;, &#34;delete&#34;: &#34;destroy&#34;})),</span>
</span></span><span class="line"><span class="cl"><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">urlpatterns</span> <span class="o">+=</span> <span class="n">router</span><span class="o">.</span><span class="n">urls</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>å¦‚ä¸Šè¿°ä»£ç ï¼Œåªéœ€å®ä¾‹åŒ–ä¸€ä¸ªrouterç±»å¹¶æŒ‡å®šapi/userå’Œå¯¹åº”çš„è§†å›¾ç±»å³å¯ï¼Œä»–ä¼šè‡ªåŠ¨ç”Ÿæˆæ³¨é‡Šéƒ¨åˆ†çš„å¯¹åº”å…³ç³»</p>
<p>UserViewä¸­ç»§æ‰¿äº†å‡ ä¸ªäº”å¤§ç±»ï¼Œä»–å°±ä¼šç”Ÿæˆä¸€ä¸€å¯¹åº”çš„è·¯ç”±</p>
<h3 id="è·¯ç”±æ€»ç»“">è·¯ç”±æ€»ç»“
</h3><ul>
<li>è§†å›¾ç»§æ‰¿APIView</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">django.urls</span> <span class="kn">import</span> <span class="n">path</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">app01</span> <span class="kn">import</span> <span class="n">views</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="n">path</span><span class="p">(</span><span class="s1">&#39;api/users/&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">UserView</span><span class="o">.</span><span class="n">as_view</span><span class="p">()),</span>  <span class="c1"># APIView</span>
</span></span><span class="line"><span class="cl"><span class="p">]</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>è§†å›¾ç»§æ‰¿ <code>ViewSetMixin</code>ï¼ˆGenericViewSetã€ModelViewSetï¼‰</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">django.urls</span> <span class="kn">import</span> <span class="n">path</span><span class="p">,</span> <span class="n">re_path</span><span class="p">,</span> <span class="n">include</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">app01</span> <span class="kn">import</span> <span class="n">views</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="n">path</span><span class="p">(</span><span class="s1">&#39;api/users/&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">UserView</span><span class="o">.</span><span class="n">as_view</span><span class="p">({</span><span class="s2">&#34;get&#34;</span><span class="p">:</span><span class="s2">&#34;list&#34;</span><span class="p">,</span><span class="s2">&#34;post&#34;</span><span class="p">:</span><span class="s2">&#34;create&#34;</span><span class="p">})),</span>
</span></span><span class="line"><span class="cl">    <span class="n">path</span><span class="p">(</span><span class="s1">&#39;api/users/&lt;int:pk&gt;/&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">UserView</span><span class="o">.</span><span class="n">as_view</span><span class="p">({</span><span class="s2">&#34;get&#34;</span><span class="p">:</span><span class="s2">&#34;retrieve&#34;</span><span class="p">,</span><span class="s2">&#34;put&#34;</span><span class="p">:</span><span class="s2">&#34;update&#34;</span><span class="p">,</span><span class="s2">&#34;patch&#34;</span><span class="p">:</span><span class="s2">&#34;partial_update&#34;</span><span class="p">,</span><span class="s2">&#34;delete&#34;</span><span class="p">:</span><span class="s2">&#34;destory&#34;</span><span class="p">})),</span>
</span></span><span class="line"><span class="cl"><span class="p">]</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>ç»§æ‰¿ViewSetMixinå½¢å¼çš„è‡ªåŠ¨åˆ†å‘</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">rest_framework</span> <span class="kn">import</span> <span class="n">routers</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">app01</span> <span class="kn">import</span> <span class="n">views</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">router</span> <span class="o">=</span> <span class="n">routers</span><span class="o">.</span><span class="n">SimpleRouter</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">router</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;api/users&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">UserView</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># å…¶ä»–URL</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># path(&#39;xxxx/&#39;, xxxx.as_view()),</span>
</span></span><span class="line"><span class="cl"><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">urlpatterns</span> <span class="o">+=</span> <span class="n">router</span><span class="o">.</span><span class="n">urls</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¿˜å¯ä»¥åˆ©ç”¨includeç»™URLåŠ å‰ç¼€</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">django.urls</span> <span class="kn">import</span> <span class="n">path</span><span class="p">,</span> <span class="n">include</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">rest_framework</span> <span class="kn">import</span> <span class="n">routers</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">app01</span> <span class="kn">import</span> <span class="n">views</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">router</span> <span class="o">=</span> <span class="n">routers</span><span class="o">.</span><span class="n">SimpleRouter</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">router</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;users&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">UserView</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="n">path</span><span class="p">(</span><span class="s1">&#39;api/&#39;</span><span class="p">,</span> <span class="n">include</span><span class="p">((</span><span class="n">router</span><span class="o">.</span><span class="n">urls</span><span class="p">,</span> <span class="s1">&#39;app_name&#39;</span><span class="p">),</span> <span class="n">namespace</span><span class="o">=</span><span class="s1">&#39;instance_name&#39;</span><span class="p">)),</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># å…¶ä»–URL</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># path(&#39;forgot-password/&#39;, ForgotPasswordFormView.as_view()),</span>
</span></span><span class="line"><span class="cl"><span class="p">]</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="æ‹“å±•url">æ‹“å±•URL
</h3><p>ä¸Šè¿°ä»‹ç»äº†è‡ªåŠ¨ç”Ÿæˆå¯¹åº”å…³ç³»ï¼Œå®ç°getè¯·æ±‚è®¿é—®api/user/æ˜¯æŸ¥è¯¢åˆ—è¡¨ï¼Œè®¿é—®api/user/1/æ˜¯æŸ¥è¯¢å•æ¡æ•°æ®ï¼Œpostè®¿é—®api/user/æ˜¯åˆ›å»ºæ•°æ®ç­‰ç­‰ï¼Œå¦‚æœè¦å°†api/user/xxx/1/å¯¹åº”çš„è¯·æ±‚ä¹Ÿå›Šæ‹¬è¿›æ¥ï¼Œæˆ‘ä»¬å°±éœ€è¦åœ¨SimpleRouterçš„åŸºç¡€ä¸Šè¿›è¡Œæ‹“å±•</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">rest_framework.decorators</span> <span class="kn">import</span> <span class="n">action</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">UserView</span><span class="p">(</span><span class="n">ListModelMixin</span><span class="p">,</span> <span class="n">RetrieveModelMixin</span><span class="p">,</span> <span class="n">CreateModelMixin</span><span class="p">,</span> <span class="n">UpdateModelMixin</span><span class="p">,</span> <span class="n">DestroyModelMixin</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">               <span class="n">GenericViewSet</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">queryset</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">UserInfo</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">UserSerializer</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@action</span><span class="p">(</span><span class="n">detail</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;get&#39;</span><span class="p">],</span> <span class="n">url_path</span><span class="o">=</span><span class="s1">&#39;yyy/(?P&lt;xx&gt;\d+)/xxx&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">yyy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">xx</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;yyyæ¥äº†&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="s1">&#39;yyy&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@action</span><span class="p">(</span><span class="n">detail</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;get&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;get_infoæ¥äº†&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="s1">&#39;get_info&#39;</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>å½“è¯·æ±‚ä¸º<code>api/user/yyy/123/xxx/</code>æ—¶åŒ¹é…ç¬¬ä¸€ä¸ªyyyå‡½æ•°ï¼Œdetail=Falseè¡¨ç¤ºå¯¹åº”çš„è·å–æ•°æ®åˆ—è¡¨æ ¼å¼ï¼Œå³è‡ªå·±æ‹“å±•çš„urlæ—¶æ‹¼æ¥åœ¨api/user/åé¢çš„ï¼Œè€Œä¸æ˜¯api/user/1/</p>
<p>å½“è¯·æ±‚ä¸º<code>api/user/1/get_info/</code>æ—¶åŒ¹é…ç¬¬äºŒä¸ªget_infoå‡½æ•°ï¼Œdetail=Trueè¡¨ç¤ºæ‹“å±•çš„urlæ‹¼è£…ç±»ä¼¼api/user/1/åé¢ï¼Œå› ä¸ºè‡ªå·±æ²¡æœ‰å®šä¹‰url_pathï¼Œå› æ­¤å°±ä»¥å‡½æ•°åä¸ºæ‹“å±•çš„urlå†…å®¹</p>
<h2 id="ç­›é€‰å™¨">ç­›é€‰å™¨
</h2><p>æˆ‘ä»¬åœ¨ä»‹ç»GenericAPIViewæ—¶å…¶å®å·²ç»æåˆ°äº†ç­›é€‰å™¨ï¼Œå°±æ˜¯é‚£ä¸ªfilter_querysetæ–¹æ³•</p>
<p>åœ¨è¯¦ç»†ä»‹ç»å…¶ä½¿ç”¨ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥åˆ—ä¸¾ä¸€ä¸‹ä»€ä¹ˆæ—¶å€™ä¼šæœ‰ç”¨åˆ°è¿™ä¸ªç­›é€‰å™¨</p>
<h3 id="ç­›é€‰å™¨çš„ä½¿ç”¨åœºæ™¯">ç­›é€‰å™¨çš„ä½¿ç”¨åœºæ™¯
</h3><p>æƒ…å†µä¸€ï¼šç»§æ‰¿GenericAPIView æˆ– GenericViewSet</p>
<ul>
<li>åˆ—è¡¨
<ul>
<li>queryset = self.get_queryset()</li>
</ul>
</li>
<li>è¯¦ç»†
<ul>
<li>obj = self.get_object()
<ul>
<li>queryset = self.get_queryset()</li>
<li>queryset = self.filter_queryset(queryset)</li>
<li>obj = queryset.get(pk=1)</li>
</ul>
</li>
</ul>
</li>
<li>ä¿®æ”¹
<ul>
<li>obj = self.get_object()</li>
</ul>
</li>
<li>åˆ é™¤
<ul>
<li>obj = self.get_object()</li>
</ul>
</li>
</ul>
<p>æƒ…å†µäºŒï¼šç»§æ‰¿ï¼šListModelMixin, CreateModelMixin, GenericViewSet)</p>
<ul>
<li>åˆ—è¡¨
<ul>
<li>queryset = self.get_queryset()</li>
<li>queryset = self.filter_queryset(queryset)</li>
</ul>
</li>
<li>è¯¦ç»†
<ul>
<li>obj = self.get_object()
<ul>
<li>queryset = self.get_queryset()</li>
<li>queryset = self.filter_queryset(queryset)</li>
<li>obj = queryset.get(pk=1)</li>
</ul>
</li>
</ul>
</li>
<li>ä¿®æ”¹
<ul>
<li>obj = self.get_object()</li>
</ul>
</li>
<li>åˆ é™¤
<ul>
<li>obj = self.get_object()</li>
</ul>
</li>
</ul>
<p>ä¹Ÿå°±æ˜¯è¯´ï¼Œå½“ç»§æ‰¿çš„æ˜¯ç¬¬äºŒç§æ—¶ï¼Œä¸ç®¡æ˜¯å¢åˆ æ”¹æŸ¥éƒ½ä¼šæœ‰ç­›é€‰å™¨çš„å‚ä¸</p>
<p>å®ƒå¯ä»¥å¸®æˆ‘ä»¬è¿›ä¸€æ­¥å¯¹querysetåšç­›é€‰ï¼Œä¸€èˆ¬ç”¨äºæ„å»ºåŠ¨æ€æ¡ä»¶ï¼Œå› ä¸ºé™æ€çš„æ¡ä»¶å¯ä»¥ç›´æ¥åœ¨querysetèµ‹å€¼æ—¶å†™å…¥</p>
<h3 id="å¦‚ä½•ä½¿ç”¨">å¦‚ä½•ä½¿ç”¨
</h3><p>è§‚å¯Ÿæºç å¯ä»¥å‘ç°ï¼Œå…¶å®å°±æ˜¯å»ç±»åˆ—è¡¨filter_backendsä¸­å¾ªç¯è·å–æ¯ä¸€ä¸ªç±»ï¼Œè°ƒç”¨å®ƒçš„filter_querysetæ–¹æ³•æ¥åšç­›é€‰</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">filter_queryset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">queryset</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">backend</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filter_backends</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">queryset</span> <span class="o">=</span> <span class="n">backend</span><span class="p">()</span><span class="o">.</span><span class="n">filter_queryset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="n">queryset</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">queryset</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä½¿ç”¨ç¤ºä¾‹</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">rest_framework.filters</span> <span class="kn">import</span> <span class="n">BaseFilterBackend</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">MyFilterBackend</span><span class="p">(</span><span class="n">BaseFilterBackend</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">filter_queryset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">queryset</span><span class="p">,</span> <span class="n">view</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># request.query_params.get(&#34;xxx&#34;)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">queryset</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">MyFilterBackend2</span><span class="p">(</span><span class="n">BaseFilterBackend</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">filter_queryset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">queryset</span><span class="p">,</span> <span class="n">view</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">queryset</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">UserView</span><span class="p">(</span><span class="n">ListModelMixin</span><span class="p">,</span> <span class="n">RetrieveModelMixin</span><span class="p">,</span> <span class="n">CreateModelMixin</span><span class="p">,</span> <span class="n">UpdateModelMixin</span><span class="p">,</span> <span class="n">DestroyModelMixin</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">               <span class="n">GenericViewSet</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="n">filter_backends</span> <span class="o">=</span> <span class="p">[</span><span class="n">MyFilterBackend</span><span class="p">,</span> <span class="n">MyFilterBackend2</span><span class="p">]</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>åœ¨filter_querysetä¸­ï¼Œå¯ä»¥ç›´æ¥è·å–urlä¸­æºå¸¦çš„å‚æ•°ï¼Œç„¶åè¿›è¡Œæ•°æ®ç­›é€‰ï¼Œè€Œä¸éœ€è¦åœ¨è§†å›¾å‡½æ•°ä¸­å†å®ç°è¯¥åŠ¨ä½œ</p>
<p>api/user/?age=10&amp;height&gt;180</p>
<h3 id="ç¬¬ä¸‰æ–¹filter">ç¬¬ä¸‰æ–¹filter
</h3><p>åœ¨drfå¼€å‘æ—¶æœ‰ä¸€ä¸ªå¸¸ç”¨çš„ç¬¬ä¸‰æ–¹è¿‡æ»¤å™¨ï¼šDjangoFilterBackend</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">pip</span> <span class="n">install</span> <span class="n">django</span><span class="o">-</span><span class="nb">filter</span>
</span></span><span class="line"><span class="cl"><span class="c1"># ä¸ºäº†ä¸django3.2å…¼å®¹ï¼Œéœ€è¦æŒ‡å®šç‰ˆæœ¬ä¸‹è½½</span>
</span></span><span class="line"><span class="cl"><span class="n">pip</span> <span class="n">install</span> <span class="n">django</span><span class="o">-</span><span class="nb">filter</span><span class="o">==</span><span class="mf">21.1</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ³¨å†Œapp</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">INSTALLED_APPS</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;django_filters&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="p">]</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="å¦‚ä½•ä½¿ç”¨-1">å¦‚ä½•ä½¿ç”¨
</h3><h4 id="æ¡ˆä¾‹ä¸€">æ¡ˆä¾‹ä¸€
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">rest_framework.viewsets</span> <span class="kn">import</span> <span class="n">ModelViewSet</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">rest_framework.serializers</span> <span class="kn">import</span> <span class="n">ModelSerializer</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">django_filters.rest_framework</span> <span class="kn">import</span> <span class="n">DjangoFilterBackend</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">api</span> <span class="kn">import</span> <span class="n">models</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">FtSerializer</span><span class="p">(</span><span class="n">ModelSerializer</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">UserInfo</span>
</span></span><span class="line"><span class="cl">        <span class="n">fields</span> <span class="o">=</span> <span class="s1">&#39;__all__&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">FtView</span><span class="p">(</span><span class="n">ModelViewSet</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">FtSerializer</span>
</span></span><span class="line"><span class="cl">    <span class="n">queryset</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">UserInfo</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s1">&#39;-id&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">filter_backends</span> <span class="o">=</span> <span class="p">[</span><span class="n">DjangoFilterBackend</span><span class="p">,</span> <span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">filterset_fields</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;id&#34;</span><span class="p">,</span> <span class="s2">&#34;username&#34;</span><span class="p">]</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>filterset_fieldsæ˜¯å­˜æ”¾éœ€è¦ç”¨äºç­›é€‰çš„å­—æ®µçš„åˆ—è¡¨ï¼Œå¦‚ä¸Šé¢filterset_fieldsä¸­æœ‰idå’Œusernameï¼Œé‚£ä¹ˆå½“è¯·æ±‚çš„URLä¸­æºå¸¦idï¼Œä»–å°±ä¼šè¿›è¡Œç­›é€‰ï¼Œè¿”å›ç¬¦åˆæ¡ä»¶çš„</p>
<p><img src="/post/python/DRF/image-20250124024712756.png"
	
	
	
	loading="lazy"
	
		alt="image-20250124024712756"
	
	
></p>
<p>ç„¶è€Œè¿™ç§ç­›é€‰åªæ”¯æŒåˆ¤æ–­ç›¸ç­‰ï¼Œå³id=1ï¼Œè€Œæ— æ³•å®ç°ç­›é€‰å‡ºid&gt;1çš„æ•°æ®</p>
<h4 id="æ¡ˆä¾‹äºŒ">æ¡ˆä¾‹äºŒ
</h4><p>è¦æƒ³è§£å†³æ¡ˆä¾‹ä¸€çš„é—®é¢˜ï¼Œæˆ‘ä»¬å°±éœ€è¦è‡ªå®šä¹‰</p>
<p>ä¸å†æ˜¯ç›´æ¥å°†æ•°æ®åº“å­—æ®µèµ‹å€¼ç»™filterset_fieldsï¼Œè€Œæ˜¯ç»™filterset_classèµ‹å€¼ä¸€ä¸ªç±»ï¼Œåœ¨ç±»ä¸­å®šä¹‰ç­›é€‰æ¡ä»¶</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">rest_framework.viewsets</span> <span class="kn">import</span> <span class="n">ModelViewSet</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">rest_framework.serializers</span> <span class="kn">import</span> <span class="n">ModelSerializer</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">django_filters.rest_framework</span> <span class="kn">import</span> <span class="n">DjangoFilterBackend</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">django_filters</span> <span class="kn">import</span> <span class="n">FilterSet</span><span class="p">,</span> <span class="n">filters</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">api</span> <span class="kn">import</span> <span class="n">models</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">FtSerializer</span><span class="p">(</span><span class="n">ModelSerializer</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">UserInfo</span>
</span></span><span class="line"><span class="cl">        <span class="n">fields</span> <span class="o">=</span> <span class="s1">&#39;__all__&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">MyFilterSet</span><span class="p">(</span><span class="n">FilterSet</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">min_id</span> <span class="o">=</span> <span class="n">filters</span><span class="o">.</span><span class="n">NumberFilter</span><span class="p">(</span><span class="n">field_name</span><span class="o">=</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="n">lookup_expr</span><span class="o">=</span><span class="s1">&#39;gte&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">us</span> <span class="o">=</span> <span class="n">filters</span><span class="o">.</span><span class="n">CharFilter</span><span class="p">(</span><span class="n">field_name</span><span class="o">=</span><span class="s1">&#39;username&#39;</span><span class="p">,</span> <span class="n">lookup_expr</span><span class="o">=</span><span class="s1">&#39;startswith&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">UserInfo</span>
</span></span><span class="line"><span class="cl">        <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;min_id&#39;</span><span class="p">,</span> <span class="s1">&#39;us&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">FtView</span><span class="p">(</span><span class="n">ModelViewSet</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">FtSerializer</span>
</span></span><span class="line"><span class="cl">    <span class="n">queryset</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">UserInfo</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s1">&#39;-id&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">filter_backends</span> <span class="o">=</span> <span class="p">[</span><span class="n">DjangoFilterBackend</span><span class="p">,</span> <span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">filterset_class</span> <span class="o">=</span> <span class="n">MyFilterSet</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>å¦‚ä¸Šè¿°ä»£ç ï¼Œå®šä¹‰äº†å­—æ®µmin_idå’Œusï¼Œé‚£ä¹ˆåœ¨urlä¸­ä¼ å‚å°±åº”è¯¥ä¼ é€’api/user/?min_id=2&amp;us=v</p>
<p>è€Œåœ¨å­—æ®µçš„å®šä¹‰ä¸­ï¼Œfield_nameä»£è¡¨çš„æ˜¯ä¸ä¹‹æ ¡éªŒçš„æ•°æ®åº“å­—æ®µåï¼Œlookup_expræ˜¯è¡¨è¾¾å¼</p>
<h4 id="æ¡ˆä¾‹ä¸‰">æ¡ˆä¾‹ä¸‰
</h4><p>ä¸Šä¸€ä¸ªæ¡ˆä¾‹æåˆ°ï¼Œlookup_expræ˜¯æ¡ä»¶ç­›é€‰çš„è¡¨è¾¾å¼ï¼Œé‚£ä¹ˆå¸¸è§çš„æœ‰å“ªäº›</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">rest_framework</span> <span class="kn">import</span> <span class="n">serializers</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">rest_framework.viewsets</span> <span class="kn">import</span> <span class="n">ModelViewSet</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">django_filters.rest_framework</span> <span class="kn">import</span> <span class="n">DjangoFilterBackend</span><span class="p">,</span> <span class="n">OrderingFilter</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">django_filters</span> <span class="kn">import</span> <span class="n">FilterSet</span><span class="p">,</span> <span class="n">filters</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">app01</span> <span class="kn">import</span> <span class="n">models</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">UserModelSerializer</span><span class="p">(</span><span class="n">serializers</span><span class="o">.</span><span class="n">ModelSerializer</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">level_text</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">source</span><span class="o">=</span><span class="s2">&#34;get_level_display&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">read_only</span><span class="o">=</span><span class="kc">True</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">depart_title</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">source</span><span class="o">=</span><span class="s2">&#34;depart.title&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">read_only</span><span class="o">=</span><span class="kc">True</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">extra</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">SerializerMethodField</span><span class="p">(</span><span class="n">read_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">UserInfo</span>
</span></span><span class="line"><span class="cl">        <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;id&#34;</span><span class="p">,</span> <span class="s2">&#34;username&#34;</span><span class="p">,</span> <span class="s2">&#34;age&#34;</span><span class="p">,</span> <span class="s2">&#34;email&#34;</span><span class="p">,</span> <span class="s2">&#34;level_text&#34;</span><span class="p">,</span> <span class="s2">&#34;extra&#34;</span><span class="p">,</span> <span class="s2">&#34;depart_title&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get_extra</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="mi">666</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">MyFilterSet</span><span class="p">(</span><span class="n">FilterSet</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># /api/users/?min_id=2  -&gt; id&gt;=2</span>
</span></span><span class="line"><span class="cl">    <span class="n">min_id</span> <span class="o">=</span> <span class="n">filters</span><span class="o">.</span><span class="n">NumberFilter</span><span class="p">(</span><span class="n">field_name</span><span class="o">=</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="n">lookup_expr</span><span class="o">=</span><span class="s1">&#39;gte&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># /api/users/?name=wupeiqi  -&gt; not ( username=wupeiqi )</span>
</span></span><span class="line"><span class="cl">    <span class="n">name</span> <span class="o">=</span> <span class="n">filters</span><span class="o">.</span><span class="n">CharFilter</span><span class="p">(</span><span class="n">field_name</span><span class="o">=</span><span class="s2">&#34;username&#34;</span><span class="p">,</span> <span class="n">lookup_expr</span><span class="o">=</span><span class="s2">&#34;exact&#34;</span><span class="p">,</span> <span class="n">exclude</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># /api/users/?depart=xx     -&gt; depart__title like %xx%</span>
</span></span><span class="line"><span class="cl">    <span class="n">depart</span> <span class="o">=</span> <span class="n">filters</span><span class="o">.</span><span class="n">CharFilter</span><span class="p">(</span><span class="n">field_name</span><span class="o">=</span><span class="s2">&#34;depart__title&#34;</span><span class="p">,</span> <span class="n">lookup_expr</span><span class="o">=</span><span class="s2">&#34;contains&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># /api/users/?token=true      -&gt; &#34;token&#34; IS NULL</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># /api/users/?token=false     -&gt; &#34;token&#34; IS NOT NULL</span>
</span></span><span class="line"><span class="cl">    <span class="n">token</span> <span class="o">=</span> <span class="n">filters</span><span class="o">.</span><span class="n">BooleanFilter</span><span class="p">(</span><span class="n">field_name</span><span class="o">=</span><span class="s2">&#34;token&#34;</span><span class="p">,</span> <span class="n">lookup_expr</span><span class="o">=</span><span class="s2">&#34;isnull&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># /api/users/?email=xx     -&gt; email like xx%</span>
</span></span><span class="line"><span class="cl">    <span class="n">email</span> <span class="o">=</span> <span class="n">filters</span><span class="o">.</span><span class="n">CharFilter</span><span class="p">(</span><span class="n">field_name</span><span class="o">=</span><span class="s2">&#34;email&#34;</span><span class="p">,</span> <span class="n">lookup_expr</span><span class="o">=</span><span class="s2">&#34;startswith&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># /api/users/?level=2&amp;level=1   -&gt; &#34;level&#34; = 1 OR &#34;level&#34; = 2ï¼ˆå¿…é¡»çš„æ˜¯å­˜åœ¨çš„æ•°æ®ï¼Œå¦åˆ™æŠ¥é”™--&gt;å†…éƒ¨æœ‰æ ¡éªŒæœºåˆ¶ï¼‰</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># level = filters.AllValuesMultipleFilter(field_name=&#34;level&#34;, lookup_expr=&#34;exact&#34;)</span>
</span></span><span class="line"><span class="cl">    <span class="n">level</span> <span class="o">=</span> <span class="n">filters</span><span class="o">.</span><span class="n">MultipleChoiceFilter</span><span class="p">(</span><span class="n">field_name</span><span class="o">=</span><span class="s2">&#34;level&#34;</span><span class="p">,</span> <span class="n">lookup_expr</span><span class="o">=</span><span class="s2">&#34;exact&#34;</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">UserInfo</span><span class="o">.</span><span class="n">level_choices</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># /api/users/?age=18,20     -&gt; age in [18,20]</span>
</span></span><span class="line"><span class="cl">    <span class="n">age</span> <span class="o">=</span> <span class="n">filters</span><span class="o">.</span><span class="n">BaseInFilter</span><span class="p">(</span><span class="n">field_name</span><span class="o">=</span><span class="s1">&#39;age&#39;</span><span class="p">,</span> <span class="n">lookup_expr</span><span class="o">=</span><span class="s2">&#34;in&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># /api/users/?range_id_max=10&amp;range_id_min=1    -&gt; id BETWEEN 1 AND 10</span>
</span></span><span class="line"><span class="cl">    <span class="n">range_id</span> <span class="o">=</span> <span class="n">filters</span><span class="o">.</span><span class="n">NumericRangeFilter</span><span class="p">(</span><span class="n">field_name</span><span class="o">=</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="n">lookup_expr</span><span class="o">=</span><span class="s1">&#39;range&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># /api/users/?ordering=id     -&gt; order by id asc</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># /api/users/?ordering=-id     -&gt; order by id desc</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># /api/users/?ordering=age     -&gt; order by age asc</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># /api/users/?ordering=-age     -&gt; order by age desc</span>
</span></span><span class="line"><span class="cl">    <span class="n">ordering</span> <span class="o">=</span> <span class="n">filters</span><span class="o">.</span><span class="n">OrderingFilter</span><span class="p">(</span><span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s2">&#34;id&#34;</span><span class="p">,</span> <span class="s2">&#34;age&#34;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># /api/users/?size=1     -&gt; limit 1ï¼ˆè‡ªå®šä¹‰æœç´¢ï¼‰</span>
</span></span><span class="line"><span class="cl">    <span class="n">size</span> <span class="o">=</span> <span class="n">filters</span><span class="o">.</span><span class="n">CharFilter</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;filter_size&#39;</span><span class="p">,</span> <span class="n">distinct</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">UserInfo</span>
</span></span><span class="line"><span class="cl">        <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;id&#34;</span><span class="p">,</span> <span class="s2">&#34;min_id&#34;</span><span class="p">,</span> <span class="s2">&#34;name&#34;</span><span class="p">,</span> <span class="s2">&#34;depart&#34;</span><span class="p">,</span> <span class="s2">&#34;email&#34;</span><span class="p">,</span> <span class="s2">&#34;level&#34;</span><span class="p">,</span> <span class="s2">&#34;age&#34;</span><span class="p">,</span> <span class="s1">&#39;range_id&#39;</span><span class="p">,</span> <span class="s2">&#34;size&#34;</span><span class="p">,</span> <span class="s2">&#34;ordering&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">filter_size</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">queryset</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">int_value</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">queryset</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">int_value</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">UserView</span><span class="p">(</span><span class="n">ModelViewSet</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">filter_backends</span> <span class="o">=</span> <span class="p">[</span><span class="n">DjangoFilterBackend</span><span class="p">,</span> <span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">filterset_class</span> <span class="o">=</span> <span class="n">MyFilterSet</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">queryset</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">UserInfo</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">UserModelSerializer</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">perform_create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">serializer</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34; åºåˆ—åŒ–ï¼šå¯¹è¯·æ±‚çš„æ•°æ®æ ¡éªŒæˆåŠŸåï¼Œæ‰§è¡Œä¿å­˜ã€‚&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">serializer</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">depart_id</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s2">&#34;123&#34;</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="s1">&#39;exact&#39;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl"><span class="s1">&#39;iexact&#39;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="s1">&#39;contains&#39;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;contains&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl"><span class="s1">&#39;icontains&#39;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;contains&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl"><span class="s1">&#39;startswith&#39;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;starts with&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl"><span class="s1">&#39;istartswith&#39;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;starts with&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl"><span class="s1">&#39;endswith&#39;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;ends with&#39;</span><span class="p">),</span>  
</span></span><span class="line"><span class="cl"><span class="s1">&#39;iendswith&#39;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;ends with&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl"><span class="s1">&#39;gt&#39;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;is greater than&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl"><span class="s1">&#39;gte&#39;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;is greater than or equal to&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl"><span class="s1">&#39;lt&#39;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;is less than&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl"><span class="s1">&#39;lte&#39;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;is less than or equal to&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="s1">&#39;in&#39;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;is in&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl"><span class="s1">&#39;range&#39;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;is in range&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl"><span class="s1">&#39;isnull&#39;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">),</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>å…¨å±€é…ç½®</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># settings.py å…¨å±€é…ç½®</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">REST_FRAMEWORK</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;DEFAULT_FILTER_BACKENDS&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;django_filters.rest_framework.DjangoFilterBackend&#39;</span><span class="p">,]</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>è™½ç„¶ç¬¬ä¸‰æ–¹ç­›é€‰å™¨ç»™æˆ‘ä»¬æä¾›äº†è‡ªå®šä¹‰çš„åŠŸèƒ½ï¼Œè®©æˆ‘ä»¬å¯ä»¥çµæ´»æ‹“å±•ã€‚ä½†æ˜¯å¦‚æœç­›é€‰æ¡ä»¶çœŸçš„å¾ˆå¤æ‚ï¼Œè¿˜æ˜¯å»ºè®®ä½¿ç”¨è‡ªå¸¦çš„ç­›é€‰å™¨è‡ªå®šä¹‰</p>
</section>


    <footer class="article-footer">
    
    <section class="article-tags">
        
            <a href="/tags/django/">Django</a>
        
            <a href="/tags/drf/">DRF</a>
        
            <a href="/tags/python/">Python</a>
        
    </section>


    
    <section class="article-copyright">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <path d="M14.5 9a3.5 4 0 1 0 0 6" />
</svg>



        <span>Licensed under CC BY-NC-SA 4.0</span>
    </section>
    </footer>


    
</article>

    

    

<aside class="related-content--wrapper">
    <h2 class="section-title">ç›¸å…³æ–‡ç« </h2>
    <div class="related-content">
        <div class="flex article-list--tile">
            
                
<article class="">
    <a href="/p/order_trading_platform/">
        
        

        <div class="article-details">
            <h2 class="article-title">é¡¹ç›®ï¼šè®¢å•äº¤æ˜“å¹³å°</h2>
        </div>
    </a>
</article>

            
                
<article class="">
    <a href="/p/django/">
        
        

        <div class="article-details">
            <h2 class="article-title">Django</h2>
        </div>
    </a>
</article>

            
        </div>
    </div>
</aside>

     
    
        
    <script src="https://utteranc.es/client.js" 
        repo="yn0t1me/blog-commnet"
        issue-term="pathname"
        
        label="utterances"
        
        crossorigin="anonymous"
        async
        >
</script>

<style>
    .utterances {
        max-width: unset;
    }
</style>

<script>
    let utterancesLoaded = false;

    function setUtterancesTheme(theme) {
        let utterances = document.querySelector('.utterances iframe');
        if (utterances) {
            utterances.contentWindow.postMessage(
                {
                    type: 'set-theme',
                    theme: `github-${theme}`
                },
                'https://utteranc.es'
            );
        }
    }

    addEventListener('message', event => {
        if (event.origin !== 'https://utteranc.es') return;

        
        utterancesLoaded = true;
        setUtterancesTheme(document.documentElement.dataset.scheme)
    });

    window.addEventListener('onColorSchemeChange', (e) => {
        if (!utterancesLoaded) return;
        setUtterancesTheme(e.detail)
    })
</script>


    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
            2020 - 
        
        2025 yn0t1me
    </section>
    
    <section class="powerby">
        ä½¿ç”¨ <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> æ„å»º <br />
        ä¸»é¢˜ <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.30.0">Stack</a></b> ç”± <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a> è®¾è®¡
    </section>
</footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css"crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css"crossorigin="anonymous"
            >

            </main>
        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js"integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z&#43;KMkF24hUW8WePSA9HM="crossorigin="anonymous"
                
                >
            </script><script type="text/javascript" src="/ts/main.1e9a3bafd846ced4c345d084b355fb8c7bae75701c338f8a1f8a82c780137826.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>

    </body>
</html>
